/**
 * ğŸ  DoupÄ› - Hra o pÅ™eÅ¾itÃ­ a craftovÃ¡nÃ­ by Ondrex
 * ZaÄÃ­nÃ¡me pomalu, s citem...
 */

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ”§ KONFIGURACE - VYPLÅ‡ SVOJE HODNOTY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const GA4_MEASUREMENT_ID = 'G-SZJL9L81VE'; // Tvoje GA4 Measurement ID
const GA4_API_SECRET = 'VLOZ_SVUJ_API_SECRET_ZDE'; // VytvoÅ™ v GA4 Admin â†’ Data Streams â†’ Measurement Protocol API secrets

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“Š GOOGLE ANALYTICS 4 - SERVER-SIDE TRACKING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/**
 * Server-side tracking do GA4 pomocÃ­ Measurement Protocol
 * @param {string} clientId - Unique user ID
 * @param {string} eventName - NÃ¡zev eventu
 * @param {object} eventParams - Parametry eventu
 */
function trackEvent(clientId, eventName, eventParams = {}) {
  try {
    // Endpoint pro GA4 Measurement Protocol
    const url = `https://www.google-analytics.com/mp/collect?measurement_id=${GA4_MEASUREMENT_ID}&api_secret=${GA4_API_SECRET}`;
    
    // Payload podle GA4 Measurement Protocol specifikace
    const payload = {
      client_id: clientId,
      events: [{
        name: eventName,
        params: {
          ...eventParams,
          // AutomatickÃ© pridani engagement_time_msec (povinne pro lepsi metriky)
          engagement_time_msec: eventParams.engagement_time_msec || '100'
        }
      }]
    };
    
    // Odeslat do GA4
    const options = {
      method: 'post',
      contentType: 'application/json',
      payload: JSON.stringify(payload),
      muteHttpExceptions: true
    };
    
    const response = UrlFetchApp.fetch(url, options);
    const responseCode = response.getResponseCode();
    
    // GA4 MP vraci 204 No Content pri uspechu
    if (responseCode === 204) {
      return { success: true };
    } else {
      Logger.log('GA4 Tracking Error: ' + responseCode + ' - ' + response.getContentText());
      return { success: false, error: 'HTTP ' + responseCode };
    }
    
  } catch(e) {
    Logger.log('GA4 Tracking Exception: ' + e.toString());
    return { success: false, error: e.toString() };
  }
}

/**
 * Batch tracking - poÅ¡le vÃ­ce eventÅ¯ najednou (optimalizace)
 * @param {string} clientId - Unique user ID  
 * @param {array} events - Array of {name, params} objects
 */
function trackEventsBatch(clientId, events) {
  try {
    const url = `https://www.google-analytics.com/mp/collect?measurement_id=${GA4_MEASUREMENT_ID}&api_secret=${GA4_API_SECRET}`;
    
    // PÅ™idej engagement_time ke vÅ¡em eventÅ¯m
    const formattedEvents = events.map(event => ({
      name: event.name,
      params: {
        ...event.params,
        engagement_time_msec: event.params.engagement_time_msec || '100'
      }
    }));
    
    const payload = {
      client_id: clientId,
      events: formattedEvents
    };
    
    const options = {
      method: 'post',
      contentType: 'application/json',
      payload: JSON.stringify(payload),
      muteHttpExceptions: true
    };
    
    const response = UrlFetchApp.fetch(url, options);
    const responseCode = response.getResponseCode();
    
    if (responseCode === 204) {
      return { success: true, eventsTracked: events.length };
    } else {
      Logger.log('GA4 Batch Tracking Error: ' + responseCode);
      return { success: false, error: 'HTTP ' + responseCode };
    }
    
  } catch(e) {
    Logger.log('GA4 Batch Tracking Exception: ' + e.toString());
    return { success: false, error: e.toString() };
  }
}

function doGet() {
  return HtmlService.createHtmlOutputFromFile('index')
    .setTitle('DoupÄ› 2 by Ondrexs Ember')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸŒ API ENDPOINT - Pro volÃ¡nÃ­ z GitHub Pages
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/**
 * Handle POST requests from external sources (GitHub Pages)
 * Enables CORS and routes to appropriate functions
 */
function doPost(e) {return handleRequest(e);
}

function handleRequest(e) {
  // CORS Headers - povolÃ­ pÅ™Ã­stup z libovolnÃ© domÃ©ny
  const output = ContentService.createTextOutput();
  output.setMimeType(ContentService.MimeType.JSON);
  
  try {
    const params = e.parameter;
    const postData = e.postData ? JSON.parse(e.postData.contents) : {};
    const action = params.action || postData.action;
    const data = postData.data || {};
    
    let result = { success: false, message: 'Unknown action' };
    
    switch(action) {
      case 'getLeaderboard':
        result = getLeaderboard();
        break;
      case 'saveHighScore':
        result = saveHighScore(data);
        break;
      case 'trackEvent':
        result = trackEvent(data);
        break;
      case 'logTransaction':
        result = logTransaction(data);
        break;
      default:
        result = { success: false, message: 'Invalid action: ' + action };
    }
    
    output.setContent(JSON.stringify(result));
    
  } catch(error) {
    output.setContent(JSON.stringify({
      success: false,
      error: error.toString(),
      message: 'Server error: ' + error.message
    }));
  }
  
  return output;
}

// UloÅ¾enÃ­ stavu hry - zatÃ­m jednoduÅ¡e
function saveGameState(stateJson) {
  try {
    PropertiesService.getUserProperties().setProperty('gameState', stateJson);
    return { success: true, message: 'TvÅ¯j svÄ›t byl uloÅ¾en...' };
  } catch(e) {
    return { success: false, message: 'NÄ›co se pokazilo pÅ™i uklÃ¡dÃ¡nÃ­' };
  }
}

// NaÄtenÃ­ stavu
function loadGameState() {
  const saved = PropertiesService.getUserProperties().getProperty('gameState');
  if (saved) {
    return { success: true, data: saved };
  }
  return { success: false, message: 'ZaÄÃ­nÃ¡Å¡ novÃ½ pÅ™Ã­bÄ›h...' };
}

// Reset hry
function resetGame() {
  PropertiesService.getUserProperties().deleteProperty('gameState');
  return { success: true, message: 'SvÄ›t byl obnoven...' };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ† LEADERBOARD SYSTÃ‰M
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const SHEET_URL = 'https://docs.google.com/spreadsheets/d/118qrQ_vu1pqYuTefpoIJUKMcr7x7tE5RysCHlghGD8Y/edit';

// UloÅ¾enÃ­ high score do Google Sheets
function saveHighScore(data) {
  try {
    const sheet = SpreadsheetApp.openByUrl(SHEET_URL).getSheetByName('Leaderboard');
    
    // Zkontroluj jestli uÅ¾ existuje zÃ¡znam pro tohoto hrÃ¡Äe
    const allData = sheet.getDataRange().getValues();
    let playerRow = -1;
    
    for (let i = 1; i < allData.length; i++) {
      if (allData[i][0] === data.playerId) {
        playerRow = i + 1; // +1 protoÅ¾e Å™Ã¡dky jsou 1-indexed
        break;
      }
    }
    
    const rowData = [
      data.playerId,
      data.nickname || 'Anonymous',
      data.days,
      data.season,
      data.population,
      new Date(),
      data.temperature || 0,
      data.foodLeft || 0,
      data.waterLeft || 0
    ];
    
    if (playerRow > 0) {
      // Update existujÃ­cÃ­ zÃ¡znam (jen pokud je novÃ½ run lepÅ¡Ã­)
      const currentBest = allData[playerRow - 1][2]; // Best Days je sloupec C (index 2)
      if (data.days > currentBest) {
        sheet.getRange(playerRow, 1, 1, 9).setValues([rowData]);
        return { success: true, message: 'NovÃ½ osobnÃ­ rekord!', isNewRecord: true };
      } else {
        return { success: true, message: 'NeuloÅ¾eno - nemÃ¡Å¡ lepÅ¡Ã­ skÃ³re', isNewRecord: false };
      }
    } else {
      // NovÃ½ hrÃ¡Ä - pÅ™idej novÃ½ Å™Ã¡dek
      sheet.appendRow(rowData);
      return { success: true, message: 'PrvnÃ­ zÃ¡znam uloÅ¾en!', isNewRecord: true };
    }
    
  } catch(e) {
    Logger.log('Error saving high score: ' + e.toString());
    return { success: false, message: 'Chyba pÅ™i uklÃ¡dÃ¡nÃ­: ' + e.toString() };
  }
}

// Test funkce - spusÅ¥ tuhle mÃ­sto saveHighScore
function testSaveHighScore() {
  const testData = {
    playerId: 'test_player_123',
    nickname: 'TestHero',
    days: 2,
    season: 'Jaro',
    population: 5,
    temperature: 15,
    foodLeft: 100,
    waterLeft: 100
  };
  
  const result = saveHighScore(testData);
  Logger.log(result);
  
  return result;
}

// NaÄtenÃ­ TOP 10 z leaderboardu
function getLeaderboard() {
  try {
    const sheet = SpreadsheetApp.openByUrl(SHEET_URL).getSheetByName('Leaderboard');
    const data = sheet.getDataRange().getValues();
    
    if (data.length <= 1) {
      return { success: true, data: [] }; // PrÃ¡zdnÃ½ leaderboard
    }
    
    // SeÅ™aÄ podle dnÃ­ (sloupec C, index 2) sestupnÄ›
    const sorted = data.slice(1).sort((a, b) => b[2] - a[2]);
    
    // Vezmi TOP 10
    const top10 = sorted.slice(0, 10).map((row, index) => ({
      rank: index + 1,
      playerId: row[0],
      nickname: row[1],
      days: row[2],
      season: row[3],
      population: row[4]
    }));
    
    return { success: true, data: top10 };
    
  } catch(e) {
    Logger.log('Error loading leaderboard: ' + e.toString());
    return { success: false, message: 'Chyba pÅ™i naÄÃ­tÃ¡nÃ­ Å¾ebÅ™Ã­Äku: ' + e.toString() };
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ§ª TEST FUNKCE PRO GA4
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function testGA4Tracking() {
  const testClientId = 'test_user_' + new Date().getTime();
  
  // Test 1: Single event
  Logger.log('Testing single event...');
  const result1 = trackEvent(testClientId, 'test_event', {
    test_param: 'test_value',
    days_survived: 10
  });
  Logger.log('Single event result: ' + JSON.stringify(result1));
  
  // Test 2: Batch events
  Logger.log('Testing batch events...');
  const result2 = trackEventsBatch(testClientId, [
    { name: 'game_start', params: { starting_food: 60 } },
    { name: 'craft_item', params: { item_name: 'Test Item', day: 1 } }
  ]);
  Logger.log('Batch events result: ' + JSON.stringify(result2));
  
  return {
    singleEvent: result1,
    batchEvents: result2
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ’° ECONOMY SYSTEM - Backend Functions
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/**
 * Log economy transaction to Sheets
 * @param {object} transaction - Transaction data
 */
function logTransaction(transaction) {
  try {
    const sheet = SpreadsheetApp.openByUrl(SHEET_URL).getSheetByName('Transactions');
    
    // Pokud tab neexistuje, vytvoÅ™ ho
    if (!sheet) {
      const ss = SpreadsheetApp.openByUrl(SHEET_URL);
      const newSheet = ss.insertSheet('Transactions');
      newSheet.appendRow([
        'Timestamp', 'PlayerId', 'Type', 'ItemId', 'ItemName', 
        'Quantity', 'GoldAmount', 'NewBalance', 'Day'
      ]);
      return; // PrvnÃ­ volÃ¡nÃ­ vytvoÅ™Ã­ header
    }
    
    sheet.appendRow([
      new Date(),
      transaction.playerId,
      transaction.type, // 'sell' or 'buy'
      transaction.itemId,
      transaction.itemName,
      transaction.quantity,
      transaction.goldAmount,
      transaction.newBalance,
      transaction.day
    ]);
    
    return { success: true };
    
  } catch(e) {
    Logger.log('Error logging transaction: ' + e.toString());
    return { success: false, error: e.toString() };
  }
}

/**
 * Get economy config (prices)
 * V FASE 1 to jen returne success, v budoucnu mÅ¯Å¾eme ÄÃ­st z Sheets
 */
function getEconomyConfig() {
  try {
    // V FASE 1 jsou ceny hardcoded v JS
    // V FASE 2 mÅ¯Å¾eme pÅ™idat Google Sheet s dynamickÃ½mi cenami
    return {
      success: true,
      message: 'Economy config loaded (hardcoded prices)'
    };
  } catch(e) {
    Logger.log('Error loading economy config: ' + e.toString());
    return { success: false, error: e.toString() };
  }
}

/**
 * Test funkce pro economy
 */
function testEconomy() {
  const testTransaction = {
    playerId: 'test_player_123',
    type: 'sell',
    itemId: 'wood',
    itemName: 'DÅ™evo',
    quantity: 5,
    goldAmount: 10,
    newBalance: 25,
    day: 3
  };
  
  const result = logTransaction(testTransaction);
  Logger.log('Transaction log result: ' + JSON.stringify(result));
  
  return result;
}

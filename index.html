<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>üè† Doupƒõ 2 - Survival Crafting</title>
  
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-SZJL9L81VE"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-SZJL9L81VE');
</script>

<script type="text/javascript">
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "vct90i7r4t");
</script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600;700&family=Space+Mono:wght@400;700&display=swap');

* { 
  box-sizing: border-box; 
  margin: 0; 
  padding: 0; 
  -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
  -webkit-touch-callout: none;
}

html {
  -webkit-text-size-adjust: 100%;
  text-size-adjust: 100%;
  scroll-behavior: smooth;
  padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
}

body {
  margin: 0;
  background: linear-gradient(135deg, #1a1410 0%, #2d2416 50%, #1a1410 100%);
  font-family: 'Crimson Pro', serif;
  color: #e8d5b7;
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  min-height: -webkit-fill-available;
  padding: 20px;
  position: relative;
  overflow-x: hidden;
  -webkit-overflow-scrolling: touch;
  overscroll-behavior-y: contain;
}

body.modal-open {
  overflow: hidden;
  position: fixed;
  width: 100%;
  height: 100%;
}

@media (max-width: 768px) {
  body {
    padding: 10px 5px;
    align-items: flex-start;
    padding-top: 20px;
  }
}

body::before {
  content: '';
  position: fixed;
  inset: 0;
  background: 
    radial-gradient(circle at 20% 30%, rgba(139, 90, 43, 0.1) 0%, transparent 50%),
    radial-gradient(circle at 80% 70%, rgba(87, 62, 38, 0.1) 0%, transparent 50%);
  pointer-events: none;
  animation: ambientGlow 15s ease-in-out infinite;
}

@keyframes ambientGlow {
  0%, 100% { opacity: 0.5; }
  50% { opacity: 0.8; }
}

#game-container {
  width: 100%;
  max-width: 1000px;
  background: linear-gradient(145deg, rgba(44, 35, 25, 0.95), rgba(55, 42, 30, 0.95));
  border-radius: 24px;
  padding: 24px;
  box-shadow: 
    0 30px 80px rgba(0, 0, 0, 0.8),
    inset 0 1px 0 rgba(255, 255, 255, 0.05);
  border: 2px solid rgba(139, 90, 43, 0.3);
  position: relative;
  z-index: 1;
  animation: containerAppear 0.6s ease-out;
  touch-action: pan-y;
  -webkit-tap-highlight-color: transparent;
}

@media (max-width: 768px) {
  #game-container {
    padding: 16px;
    border-radius: 16px;
    max-width: 100%;
    margin: 0 10px;
    -webkit-overflow-scrolling: touch;
  }
}

@keyframes containerAppear {
  from {
    opacity: 0;
    transform: translateY(30px) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

#header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 2px solid rgba(139, 90, 43, 0.3);
  padding-bottom: 12px;
  margin-bottom: 16px;
}

@media (max-width: 768px) {
  #header {
    flex-wrap: wrap;
    gap: 10px;
  }
  
  #header h2 {
    font-size: 20px !important;
  }
  
  #header h3 {
    font-size: 11px !important;
    order: 3;
    flex-basis: 100%;
  }
}

#header h2 {
  font-family: 'Space Mono', monospace;
  font-size: 24px;
  color: #d4a574;
  text-shadow: 0 2px 8px rgba(212, 165, 116, 0.3);
  letter-spacing: 2px;
}

#header h3 {
  font-family: 'Crimson Pro', serif;
  font-size: 14px;
  color: #9a8670;
  font-style: italic;
  display: flex;
  align-items: center;
  gap: 6px;
}

.ember-icon {
  width: 28px;
  height: 28px;
  object-fit: contain;
  filter: drop-shadow(0 0 8px rgba(255, 120, 40, 0.6));
  animation: emberGlow 3s ease-in-out infinite;
}

@keyframes emberGlow {
  0%, 100% { filter: drop-shadow(0 0 8px rgba(255, 120, 40, 0.6)); }
  50% { filter: drop-shadow(0 0 12px rgba(255, 100, 20, 0.9)); }
}

#season-info {
  text-align: right;
  font-family: 'Space Mono', monospace;
}

@media (max-width: 768px) {
  #season-info {
    text-align: center;
  }
  
  #season-info .big {
    font-size: 18px !important;
  }
  
  #season-info .small {
    font-size: 11px !important;
  }
}

#season-info .big {
  font-size: 20px;
  font-weight: 700;
  color: #d4a574;
  display: block;
}

#season-info .small {
  font-size: 12px;
  color: #a08060;
  opacity: 0.8;
}

.fire-indicator {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  margin-top: 6px;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 11px;
  font-family: 'Space Mono', monospace;
  transition: all 0.3s ease;
}

.fire-indicator.active {
  background: rgba(255, 120, 40, 0.2);
  border: 1px solid rgba(255, 120, 40, 0.4);
}

.fire-indicator.active .fire-icon {
  animation: fireFlicker 1.5s ease-in-out infinite;
  filter: drop-shadow(0 0 6px rgba(255, 120, 40, 0.8));
}

.fire-indicator.active .fire-status {
  color: #ff9944;
  font-weight: 700;
}

.fire-indicator.inactive {
  background: rgba(60, 50, 40, 0.3);
  border: 1px solid rgba(100, 80, 60, 0.2);
  opacity: 0.5;
}

.fire-indicator.inactive .fire-icon {
  filter: grayscale(100%) brightness(0.7);
}

.fire-indicator.inactive .fire-status {
  color: #6a5d4f;
}

@keyframes fireFlicker {
  0%, 100% { 
    opacity: 1; 
    transform: scale(1);
  }
  50% { 
    opacity: 0.85;
    transform: scale(1.05);
  }
}

@media (max-width: 768px) {
  .fire-indicator {
    font-size: 10px;
    padding: 3px 8px;
  }
}

.gold-display {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  margin-top: 6px;
  padding: 5px 12px;
  border-radius: 12px;
  font-size: 12px;
  font-family: 'Space Mono', monospace;
  background: rgba(212, 165, 116, 0.15);
  border: 1px solid rgba(212, 165, 116, 0.4);
  transition: all 0.3s ease;
}

.gold-display:hover {
  background: rgba(212, 165, 116, 0.25);
  transform: translateY(-1px);
}

.gold-icon {
  font-size: 14px;
  animation: goldShine 3s ease-in-out infinite;
}

@keyframes goldShine {
  0%, 100% { 
    filter: drop-shadow(0 0 4px rgba(255, 215, 0, 0.6));
  }
  50% { 
    filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.9));
  }
}

.gold-amount {
  color: #d4a574;
  font-weight: 700;
  font-size: 13px;
}

@media (max-width: 768px) {
  .gold-display {
    font-size: 11px;
    padding: 4px 10px;
  }
  
  .gold-amount {
    font-size: 12px;
  }
}

#status-bars {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 12px;
  margin: 16px 0;
}

@media (max-width: 768px) {
  #status-bars {
    grid-template-columns: 1fr;
  }
}

.bar {
  background: rgba(30, 24, 18, 0.6);
  border-radius: 10px;
  padding: 10px 12px;
  border: 1px solid rgba(139, 90, 43, 0.2);
  transition: all 0.3s ease;
}

.bar:hover {
  border-color: rgba(139, 90, 43, 0.4);
  transform: translateY(-2px);
}

.bar-label {
  font-size: 13px;
  margin-bottom: 6px;
  font-weight: 600;
  color: #b89968;
}

@media (max-width: 768px) {
  .bar-label {
    font-size: 14px;
  }
  
  .bar {
    padding: 12px 14px !important;
  }
  
  .fill-container {
    height: 28px !important;
  }
  
  .fill {
    font-size: 13px !important;
  }
}

.fill-container {
  background: rgba(0, 0, 0, 0.3);
  border-radius: 8px;
  height: 24px;
  overflow: hidden;
  position: relative;
  box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.4);
}

.fill {
  height: 100%;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  font-family: 'Space Mono', monospace;
}

.fill::after {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(180deg, rgba(255, 255, 255, 0.2) 0%, transparent 50%);
  border-radius: 6px;
}

.hunger {
  background: linear-gradient(90deg, #c0504d 0%, #e67e7b 100%);
  color: #fff;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
}

.water {
  background: linear-gradient(90deg, #4a90a4 0%, #6fb4c5 100%);
  color: #fff;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
}

.temperature {
  background: linear-gradient(90deg, #4a90e4 0%, #6fb4c5 35%, #7bc876 50%, #e8c547 65%, #e67e7b 100%);
  color: #fff;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
  font-weight: 700;
}

#log {
  background: rgba(20, 16, 12, 0.7);
  border-radius: 12px;
  padding: 12px;
  height: 140px;
  overflow-y: auto;
  margin-bottom: 16px;
  border: 1px solid rgba(139, 90, 43, 0.2);
  font-family: 'Space Mono', monospace;
  font-size: 12px;
  line-height: 1.5;
  box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.5);
  -webkit-overflow-scrolling: touch;
  overscroll-behavior: contain;
}

@media (max-width: 768px) {
  #log {
    height: 120px;
    font-size: 11px;
    padding: 10px;
    scroll-behavior: smooth;
  }
}

#log::-webkit-scrollbar {
  width: 8px;
}

#log::-webkit-scrollbar-track {
  background: rgba(0, 0, 0, 0.2);
  border-radius: 4px;
}

#log::-webkit-scrollbar-thumb {
  background: rgba(139, 90, 43, 0.4);
  border-radius: 4px;
}

#log::-webkit-scrollbar-thumb:hover {
  background: rgba(139, 90, 43, 0.6);
}

.log-entry {
  margin-bottom: 6px;
  padding: 3px 6px;
  border-radius: 3px;
  animation: logAppear 0.3s ease-out;
}

@keyframes logAppear {
  from {
    opacity: 0;
    transform: translateX(-10px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

.log-info { color: #b8b0a0; background: rgba(184, 176, 160, 0.05); }
.log-warning { color: #e8c547; background: rgba(232, 197, 71, 0.1); }
.log-danger { color: #e67e7b; background: rgba(230, 126, 123, 0.1); }
.log-item { color: #6fb4c5; background: rgba(111, 180, 197, 0.1); }
.log-success { color: #7bc876; background: rgba(123, 200, 118, 0.1); }

.two-column-layout {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 15px;
  margin-bottom: 15px;
}

.two-column-layout .section {
  margin-bottom: 0;
}

@media (max-width: 768px) {
  .two-column-layout {
    grid-template-columns: 1fr;
  }
}

.section {
  background: rgba(40, 32, 24, 0.5);
  border-radius: 12px;
  padding: 12px;
  margin-bottom: 15px;
  border: 1px solid rgba(139, 90, 43, 0.2);
}

.section-title {
  font-size: 16px;
  font-weight: 700;
  color: #d4a574;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 6px;
}

@media (max-width: 768px) {
  .section-title {
    font-size: 17px;
  }
  
  .section {
    padding: 14px !important;
  }
}

.section-title .icon {
  font-size: 18px;
}

.section-content {
  display: grid;
  gap: 6px;
}

#recipes {
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
}

@media (max-width: 1024px) {
  #recipes {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (max-width: 768px) {
  #recipes {
    grid-template-columns: 1fr;
  }
}

.item-card {
  display: flex;
  align-items: center;
  gap: 10px;
  background: rgba(20, 16, 12, 0.6);
  padding: 10px 12px;
  border-radius: 8px;
  border: 1px solid rgba(139, 90, 43, 0.15);
  transition: all 0.2s ease;
  animation: itemAppear 0.4s ease-out;
}

@media (max-width: 768px) {
  .item-card {
    padding: 12px 14px;
    gap: 12px;
  }
  
  .item-icon {
    font-size: 28px !important;
  }
  
  .item-name {
    font-size: 15px !important;
  }
  
  .item-count {
    font-size: 16px !important;
  }
}

@keyframes itemAppear {
  from {
    opacity: 0;
    transform: scale(0.95);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

.item-card:hover {
  border-color: rgba(139, 90, 43, 0.4);
  transform: translateX(4px);
  background: rgba(30, 24, 18, 0.7);
}

.item-icon {
  font-size: 24px;
  line-height: 1;
  flex-shrink: 0;
}

.item-details {
  flex: 1;
  min-width: 0;
}

.item-name {
  font-weight: 700;
  font-size: 14px;
  color: #d4a574;
  margin-bottom: 2px;
}

.item-desc {
  font-size: 11px;
  color: #9a8670;
  font-style: italic;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.item-count {
  font-weight: 700;
  font-size: 15px;
  color: #b89968;
  font-family: 'Space Mono', monospace;
  margin-left: auto;
  flex-shrink: 0;
}

.item-action-btn {
  padding: 5px 10px;
  font-size: 11px;
  font-weight: 700;
  font-family: 'Space Mono', monospace;
  border: none;
  border-radius: 6px;
  margin-left: 8px;
  transition: all 0.2s ease;
  cursor: pointer;
  flex-shrink: 0;
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
}

.item-sell-btn {
  background: linear-gradient(135deg, #d4a574, #c9a576);
  color: #1a1410;
  border: 1px solid rgba(212, 165, 116, 0.6);
  box-shadow: 0 2px 4px rgba(212, 165, 116, 0.3);
}

.item-sell-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(212, 165, 116, 0.5);
}

.item-sell-btn:active {
  transform: translateY(0);
  opacity: 0.8;
}

.item-buy-btn {
  background: linear-gradient(135deg, #7bc876, #6fb865);
  color: #fff;
  border: 1px solid rgba(123, 200, 118, 0.6);
  box-shadow: 0 2px 4px rgba(123, 200, 118, 0.3);
}

.item-buy-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(123, 200, 118, 0.5);
}

.item-buy-btn:active {
  transform: translateY(0);
  opacity: 0.8;
}

.item-action-btn:disabled {
  opacity: 0.3;
  cursor: not-allowed;
  transform: none;
}

.item-action-btn .price-tag {
  font-size: 10px;
  opacity: 0.9;
}

@media (max-width: 768px) {
  .item-action-btn {
    padding: 6px 12px;
    font-size: 12px;
    min-height: 32px;
  }
}

.recipe-card {
  background: rgba(20, 16, 12, 0.6);
  padding: 12px;
  border-radius: 10px;
  border: 1px solid rgba(139, 90, 43, 0.15);
  transition: all 0.2s ease;
  cursor: pointer;
  min-height: 90px;
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  justify-content: space-between;
}

@media (max-width: 768px) {
  .recipe-card {
    padding: 10px;
    min-height: 80px;
  }
  
  .recipe-icon {
    font-size: 20px !important;
  }
  
  .recipe-name {
    font-size: 13px !important;
  }
  
  .recipe-materials {
    font-size: 10px !important;
  }
}

.recipe-card.can-craft {
  border-color: rgba(123, 200, 118, 0.4);
}

.recipe-card.can-craft:hover {
  border-color: rgba(123, 200, 118, 0.6);
  transform: translateY(-3px) scale(1.02);
  background: rgba(123, 200, 118, 0.1);
  box-shadow: 0 6px 12px rgba(123, 200, 118, 0.2);
}

.recipe-card.cannot-craft {
  opacity: 0.4;
  cursor: default;
}

.recipe-header {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 6px;
  margin-bottom: 6px;
}

.recipe-icon {
  font-size: 24px;
  flex-shrink: 0;
}

.recipe-name {
  font-weight: 700;
  font-size: 13px;
  color: #d4a574;
}

.recipe-materials {
  font-size: 10px;
  color: #9a8670;
  font-family: 'Space Mono', monospace;
  padding: 0;
  margin-top: auto;
}

.entity-card {
  background: rgba(20, 16, 12, 0.6);
  padding: 12px;
  border-radius: 8px;
  border: 1px solid rgba(139, 90, 43, 0.15);
  animation: entityAppear 0.5s ease-out;
}

@keyframes entityAppear {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.entity-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 8px;
}

.entity-icon {
  font-size: 28px;
  flex-shrink: 0;
}

.entity-info {
  flex: 1;
  min-width: 0;
}

.entity-name {
  font-weight: 700;
  font-size: 15px;
  color: #d4a574;
}

.entity-status {
  font-size: 11px;
  color: #9a8670;
  font-family: 'Space Mono', monospace;
}

.entity-actions {
  display: flex;
  gap: 6px;
  margin-top: 8px;
}

.entity-action-btn {
  flex: 1;
  padding: 5px 10px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 11px;
  font-family: 'Space Mono', monospace;
  font-weight: 700;
  transition: all 0.2s ease;
  background: rgba(139, 90, 43, 0.3);
  color: #d4a574;
  border: 1px solid rgba(139, 90, 43, 0.4);
}

@media (max-width: 768px) {
  .entity-action-btn {
    padding: 10px 12px;
    font-size: 12px;
    min-height: 42px;
  }
  
  .entity-actions {
    flex-wrap: wrap;
    gap: 8px !important;
  }
  
  .entity-action-btn {
    flex: 1 1 calc(50% - 4px);
    min-width: 120px;
  }
}

.entity-action-btn:hover {
  background: rgba(139, 90, 43, 0.5);
  transform: translateY(-2px);
}

.entity-action-btn:disabled {
  opacity: 0.3;
  cursor: not-allowed;
  transform: none;
}

.controls {
  display: flex;
  gap: 12px;
  justify-content: center;
  margin-top: 15px;
  flex-wrap: wrap;
}

@media (max-width: 768px) {
  .controls {
    gap: 8px;
  }
  
  .controls button {
    flex: 1 1 auto;
    min-width: 140px;
  }
}

button {
  padding: 12px 22px;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 700;
  font-family: 'Space Mono', monospace;
  transition: all 0.2s ease;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
  user-select: none;
  -webkit-user-select: none;
}

@media (max-width: 768px) {
  button {
    padding: 14px 20px;
    font-size: 15px;
    min-height: 48px;
    min-width: 48px;
  }
}

button:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
}

button:active {
  transform: translateY(-1px);
  opacity: 0.8;
}

.primary {
  background: linear-gradient(135deg, #8b5a2b 0%, #a67c52 100%);
  color: #fff;
  border: 1px solid rgba(212, 165, 116, 0.3);
}

.primary:hover {
  background: linear-gradient(135deg, #a67c52 0%, #c9a576 100%);
}

.danger {
  background: linear-gradient(135deg, #c0504d 0%, #e67e7b 100%);
  color: #fff;
  border: 1px solid rgba(230, 126, 123, 0.3);
}

.danger:hover {
  background: linear-gradient(135deg, #e67e7b 0%, #f29b98 100%);
}

.event-notification {
  position: fixed;
  top: 20px;
  right: 20px;
  background: linear-gradient(135deg, rgba(139, 90, 43, 0.95), rgba(166, 124, 82, 0.95));
  border-radius: 12px;
  padding: 16px 20px;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
  border: 2px solid rgba(212, 165, 116, 0.4);
  animation: slideIn 0.5s ease-out;
  z-index: 1000;
  max-width: 300px;
  font-family: 'Space Mono', monospace;
  font-size: 14px;
  color: #fff;
}

@media (max-width: 768px) {
  .event-notification {
    top: 10px;
    right: 10px;
    left: 10px;
    max-width: none;
    font-size: 13px;
    padding: 12px 16px;
  }
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateX(100%);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

.empty-state {
  text-align: center;
  padding: 15px;
  color: #6a5d4f;
  font-style: italic;
  font-size: 13px;
}

.season-indicator {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 700;
  margin-left: 8px;
}

.season-spring { background: rgba(123, 200, 118, 0.2); color: #7bc876; }
.season-summer { background: rgba(232, 197, 71, 0.2); color: #e8c547; }
.season-autumn { background: rgba(212, 165, 116, 0.2); color: #d4a574; }
.season-winter { background: rgba(111, 180, 197, 0.2); color: #6fb4c5; }

.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.9);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  animation: fadeIn 0.3s ease-out;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  overscroll-behavior: contain;
}

.modal-content {
  background: linear-gradient(145deg, #2c231a, #372a1e);
  border-radius: 20px;
  padding: 30px;
  max-width: 600px;
  width: 90%;
  border: 2px solid rgba(139, 90, 43, 0.4);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.9);
  animation: scaleIn 0.4s ease-out;
  max-height: 90vh;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  position: relative;
}

@media (max-width: 768px) {
  .modal-content {
    padding: 20px;
    width: 95%;
    border-radius: 16px;
  }
  
  .modal-title {
    font-size: 22px !important;
  }
  
  .leaderboard-table {
    font-size: 13px !important;
  }
  
  .leaderboard-table th,
  .leaderboard-table td {
    padding: 8px 6px !important;
  }
  
  .rank-badge {
    width: 26px !important;
    height: 26px !important;
    line-height: 26px !important;
    font-size: 12px !important;
  }
  
  .modal-btn {
    padding: 12px 18px !important;
    font-size: 13px !important;
  }
  
  .nickname-input {
    font-size: 15px !important;
  }
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes scaleIn {
  from { transform: scale(0.8); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}

.modal-title {
  font-family: 'Space Mono', monospace;
  font-size: 28px;
  color: #d4a574;
  text-align: center;
  margin-bottom: 20px;
  text-shadow: 0 2px 8px rgba(212, 165, 116, 0.3);
}

.nickname-input {
  width: 100%;
  padding: 12px 16px;
  font-size: 16px;
  font-family: 'Crimson Pro', serif;
  background: rgba(20, 16, 12, 0.8);
  border: 2px solid rgba(139, 90, 43, 0.3);
  border-radius: 10px;
  color: #e8d5b7;
  margin: 15px 0;
  transition: border-color 0.2s;
}

.nickname-input:focus {
  outline: none;
  border-color: rgba(139, 90, 43, 0.6);
}

.nickname-info {
  text-align: center;
  color: #b89968;
  font-size: 14px;
  margin: 10px 0;
}

.leaderboard-table {
  width: 100%;
  border-collapse: collapse;
  margin: 20px 0;
}

.leaderboard-table th {
  background: rgba(139, 90, 43, 0.2);
  padding: 12px;
  text-align: left;
  font-family: 'Space Mono', monospace;
  font-size: 13px;
  color: #d4a574;
  border-bottom: 2px solid rgba(139, 90, 43, 0.3);
}

.leaderboard-table td {
  padding: 10px 12px;
  border-bottom: 1px solid rgba(139, 90, 43, 0.1);
  font-size: 14px;
}

.leaderboard-table tr:hover {
  background: rgba(139, 90, 43, 0.1);
}

.rank-badge {
  display: inline-block;
  width: 30px;
  height: 30px;
  line-height: 30px;
  text-align: center;
  border-radius: 50%;
  font-weight: 700;
  font-family: 'Space Mono', monospace;
}

.rank-1 { background: linear-gradient(135deg, #FFD700, #FFA500); color: #000; }
.rank-2 { background: linear-gradient(135deg, #C0C0C0, #808080); color: #000; }
.rank-3 { background: linear-gradient(135deg, #CD7F32, #8B4513); color: #fff; }
.rank-other { background: rgba(139, 90, 43, 0.2); color: #b89968; }

.modal-buttons {
  display: flex;
  gap: 12px;
  justify-content: center;
  margin-top: 20px;
}

.modal-btn {
  padding: 12px 24px;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 700;
  font-family: 'Space Mono', monospace;
  transition: all 0.2s ease;
}

.modal-btn-primary {
  background: linear-gradient(135deg, #8b5a2b, #a67c52);
  color: #fff;
  border: 1px solid rgba(212, 165, 116, 0.3);
}

.modal-btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
}

.modal-btn-secondary {
  background: rgba(139, 90, 43, 0.2);
  color: #d4a574;
  border: 1px solid rgba(139, 90, 43, 0.3);
}

.modal-btn-secondary:hover {
  background: rgba(139, 90, 43, 0.3);
}

.your-rank {
  background: rgba(123, 200, 118, 0.2) !important;
  border-left: 3px solid #7bc876;
}
</style>
</head>

<body>
<div id="game-container">

  <div id="header">
    <h2>üè† DOUPƒö</h2>
    <h3>...by Ondrex's Emberüî•</h3>
    <div id="season-info">
      <span class="big">Den <span id="day">1</span></span>
      <span class="small"><span id="season">Jaro</span></span>
      <span class="fire-indicator inactive" id="fire-indicator">
        <span class="fire-icon">üî•</span>
        <span class="fire-status">Bez ohnƒõ</span>
      </span>
      <span class="gold-display" id="gold-display">
        <span class="gold-icon">üí∞</span>
        <span class="gold-amount" id="gold-amount">0</span>
      </span>
    </div>
  </div>

  <div id="status-bars">
    <div class="bar">
      <div class="bar-label">üçñ Z√°soby j√≠dla</div>
      <div class="fill-container">
        <div class="fill hunger" id="hunger-fill" style="width: 100%;">50 (10d)</div>
      </div>
    </div>
    <div class="bar">
      <div class="bar-label">üíß Z√°soby vody</div>
      <div class="fill-container">
        <div class="fill water" id="water-fill" style="width: 100%;">50 (16d)</div>
      </div>
    </div>
    <div class="bar">
      <div class="bar-label"><span id="temp-emoji">üå°Ô∏è</span> Teplota doupƒõte</div>
      <div class="fill-container">
        <div class="fill temperature" id="temp-fill" style="width: 50%;">15¬∞C</div>
      </div>
    </div>
  </div>

  <div id="log"></div>

  <div class="two-column-layout">
    <div class="section">
      <div class="section-title">
        <span class="icon">üì¶</span>
        <span>Invent√°≈ô</span>
      </div>
      <div class="section-content" id="inventory"></div>
    </div>

    <div class="section">
      <div class="section-title">
        <span class="icon">üî®</span>
        <span>Crafting recepty</span>
      </div>
      <div class="section-content" id="recipes"></div>
    </div>
  </div>

  <div class="section" id="entities-section" style="display: none;">
    <div class="section-title">
      <span class="icon">üë•</span>
      <span>Obyvatel√© doupƒõte</span>
    </div>
    <div class="section-content" id="entities"></div>
  </div>

  <div class="controls">
    <button class="primary" onclick="game.nextDay()">‚è∞ Dal≈°√≠ den</button>
    <button class="primary" onclick="game.saveGame()">üíæ Ulo≈æit hru</button>
    <button class="primary" onclick="game.showLeaderboard()">üèÜ ≈Ωeb≈ô√≠ƒçek</button>
    <button class="danger" onclick="game.showResetConfirmation()">üîÑ Nov√Ω zaƒç√°tek</button>
  </div>

</div>

<script>
const game = {

  openModal() {
    document.body.classList.add('modal-open');
    this._scrollY = window.scrollY;
    document.body.style.top = `-${this._scrollY}px`;
  },

  closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) modal.remove();
    
    document.body.classList.remove('modal-open');
    document.body.style.top = '';
    
    if (this._scrollY !== undefined) {
      window.scrollTo(0, this._scrollY);
      this._scrollY = undefined;
    }
  },

  BACKEND_API_URL: 'https://script.google.com/macros/s/AKfycbxccmovB6aNsLFBaG09DHFUpezvgNkVDgcLEBf25rQ7O9QItCvM49iL13m3IUJMG83V/exec',
  
  get isAppsScript() {
    return typeof google !== 'undefined' && 
           google.script && 
           google.script.run;
  },

  async backend(functionName, data = null) {
    if (this.isAppsScript) {
      return new Promise((resolve, reject) => {
        try {
          const runner = google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject);
          
          if (data !== null) {
            runner[functionName](data);
          } else {
            runner[functionName]();
          }
        } catch(error) {
          reject(error);
        }
      });
    }
    
    return new Promise((resolve, reject) => {
      try {
        console.log(`üåê API call: ${functionName}`);
        
        const callbackName = 'jsonp_callback_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        
        window[callbackName] = function(response) {
          console.log(`‚úÖ API response:`, response);
          delete window[callbackName];
          document.body.removeChild(script);
          resolve(response);
        };
        
        const params = new URLSearchParams({
          action: functionName,
          data: JSON.stringify(data || {}),
          callback: callbackName
        });
        
        const script = document.createElement('script');
        script.src = `${this.BACKEND_API_URL}?${params}`;
        script.onerror = function() {
          console.error(`‚ùå API call failed: ${functionName}`);
          delete window[callbackName];
          document.body.removeChild(script);
          
          if (functionName === 'trackEvent') {
            resolve({ success: true, message: 'Tracking skipped (API unavailable)' });
          } else if (functionName === 'logTransaction') {
            resolve({ success: true, message: 'Transaction logging skipped (API unavailable)' });
          } else {
            reject(new Error('API call failed'));
          }
        };
        
        document.body.appendChild(script);
        
      } catch(error) {
        console.error(`‚ùå API call failed:`, error);
        reject(error);
      }
    });
  },

  state: {
    day: 1,
    season: 0,
    dead: false,
    inventory: {},
    entities: [],
    unlockedRecipes: [],
    eventChance: 0.5,
    temperature: 15,
    shelterLevel: 1,
    heating: 0,
    guaranteedStones: 0,
    playerId: null,
    playerNickname: null,
    bestRun: 0,
    fireActive: false,
    fireFuel: 0,
    gold: 0
  },

  seasons: [
    { 
      name: 'Jaro', 
      hungerDrain: 4, 
      waterDrain: 3,
      baseTemp: 15,
      tempVariance: 5,
      icon: 'üå±',
      desc: 'ƒåas r≈Østu a sbƒõru. V√≠c materi√°l≈Ø, m√©nƒõ j√≠dla.'
    },
    { 
      name: 'L√©to', 
      hungerDrain: 3, 
      waterDrain: 6,
      baseTemp: 26,
      tempVariance: 4,
      icon: '‚òÄÔ∏è',
      desc: 'Horko a sucho. Voda je vz√°cn√°!'
    },
    { 
      name: 'Podzim', 
      hungerDrain: 6, 
      waterDrain: 4,
      baseTemp: 10,
      tempVariance: 6,
      icon: 'üçÇ',
      desc: 'ƒåas skliznƒõ. P≈ôiprav se na zimu.'
    },
    { 
      name: 'Zima', 
      hungerDrain: 10, 
      waterDrain: 3,
      baseTemp: -5,
      tempVariance: 8,
      icon: '‚ùÑÔ∏è',
      desc: 'Drsn√° zima. P≈ôe≈æije≈° jen s dostatkem z√°sob.'
    }
  ],

  items: {
    wood: { name: 'D≈ôevo', icon: 'üå≥', desc: 'Z√°kladn√≠ stavebn√≠ materi√°l', sellPrice: 2 },
    stone: { name: 'K√°men', icon: '‚õ∞Ô∏è', desc: 'Tvrd√Ω materi√°l pro n√°stroje', sellPrice: 3 },
    fiber: { name: 'Vl√°kna', icon: 'üåæ', desc: 'Pro v√Ωrobu provaz≈Ø', sellPrice: 1 },
    mushroom: { name: 'Houba', icon: 'üçÑ', desc: 'Jedl√° nebo nejedl√°', sellPrice: 4 },
    bark: { name: 'K≈Øra', icon: 'üü´', desc: 'Such√° k≈Øra na zap√°len√≠', sellPrice: 2 },
    stick: { name: 'H≈Øl', icon: 'ü¶Ø', desc: 'U≈æiteƒçn√° tyƒç', sellPrice: 4 },
    rope: { name: 'Provaz', icon: '‚û∞', desc: 'Pevn√© vl√°kno', sellPrice: 6 },
    trap: { name: 'Past', icon: 'üêÄ', desc: 'Chyt√° zvƒõ≈ô', sellPrice: 15 },
    basket: { name: 'Ko≈°', icon: 'üß∫', desc: 'Pro sbƒõr bobul√≠', sellPrice: 12 },
    knife: { name: 'N≈Ø≈æ', icon: 'üî™', desc: 'Z√°kladn√≠ n√°stroj pro ≈ôez√°n√≠', sellPrice: 30 },
    axe: { name: 'Sekyrka', icon: 'ü™ì', desc: 'Pro k√°cen√≠ d≈ôeva', sellPrice: 45 },
    bowl: { name: 'Miska', icon: 'ü•£', desc: 'N√°doba na vodu', sellPrice: 8 },
    leather: { name: 'K≈Ø≈æe', icon: 'ü¶∫', desc: 'Zpracovan√° k≈Ø≈æe', sellPrice: 20 },
    plank: { name: 'Prkno', icon: 'üìè', desc: 'Opracovan√© d≈ôevo', sellPrice: 5 },
    bow: { name: 'Luk', icon: 'üèπ', desc: 'Pro lov', sellPrice: 60 },
    seeds: { name: 'Semena', icon: 'üå±', desc: 'Pro pƒõstov√°n√≠ j√≠dla', sellPrice: 3 },
    food: { name: 'J√≠dlo', icon: 'üçñ', desc: 'Udr≈æuje ≈æivot', buyPrice: 5 },
    water_supply: { name: 'Voda', icon: 'üíß', desc: 'Udr≈æuje ≈æivot', buyPrice: 4 },
    storage: { name: 'Sklad', icon: 'üì¶', desc: 'Uchov√°v√° z√°soby p≈ôes zimu', sellPrice: 50 },
    insulation: { name: 'Izolace', icon: 'üß±', desc: 'Zlep≈°uje tepelnou izolaci', sellPrice: 80 },
    fireplace: { name: 'Krb', icon: 'üî•', desc: 'Vyt√°p√≠ doupƒõ', sellPrice: 100 },
    dried_meat: { name: 'Su≈°en√© maso', icon: 'ü•©', desc: 'Vydr≈æ√≠ p≈ôes zimu', sellPrice: 25 }
  },

  recipes: [
    {
      id: 'stick',
      name: 'H≈Øl',
      icon: 'ü¶Ø',
      materials: { wood: 1 },
      result: { stick: 2 },
      tier: 1
    },
    {
      id: 'rope',
      name: 'Provaz',
      icon: '‚û∞',
      materials: { fiber: 3 },
      result: { rope: 1 },
      tier: 1
    },
    {
      id: 'bowl',
      name: 'Miska',
      icon: 'ü•£',
      materials: { wood: 2 },
      result: { bowl: 1 },
      tier: 1
    },
    {
      id: 'trap',
      name: 'Past na zvƒõ≈ô',
      icon: 'üêÄ',
      materials: { rope: 2, stick: 3 },
      result: { trap: 1 },
      tier: 1,
      desc: 'Chyt√° malou zvƒõ≈ô p≈ôes noc'
    },
    {
      id: 'basket',
      name: 'Sbƒõrac√≠ ko≈°',
      icon: 'üß∫',
      materials: { fiber: 5, stick: 2 },
      result: { basket: 1 },
      tier: 1,
      desc: 'Pro sbƒõr bobul√≠ a hub'
    },
    {
      id: 'knife',
      name: 'Kamenn√Ω n≈Ø≈æ',
      icon: 'üî™',
      materials: { stone: 2, stick: 1 },
      result: { knife: 1 },
      tier: 2,
      unlock: 'first_entity'
    },
    {
      id: 'axe',
      name: 'Sekyrka',
      icon: 'ü™ì',
      materials: { stone: 3, stick: 2, rope: 1 },
      result: { axe: 1 },
      tier: 2,
      unlock: 'first_entity'
    },
    {
      id: 'start_fire_drill',
      name: 'Zalo≈æit ohe≈à (Bow Drill)',
      icon: 'üî•',
      materials: { stick: 2, fiber: 3, bark: 1 },
      requires: { bow: 1 },
      tier: 2,
      desc: '80% ≈°ance na √∫spƒõch',
      isFireStarter: true,
      fireChance: 0.8,
      fireMethod: 'bow_drill'
    },
    {
      id: 'plank',
      name: 'Prkno',
      icon: 'üìè',
      materials: { wood: 2 },
      result: { plank: 1 },
      requires: { axe: 1 },
      tier: 3
    },
    {
      id: 'leather',
      name: 'K≈Ø≈æe',
      icon: 'ü¶∫',
      materials: { food: 2 },
      result: { leather: 1 },
      requires: { knife: 1 },
      tier: 3
    },
    {
      id: 'bow',
      name: 'Luk',
      icon: 'üèπ',
      materials: { stick: 3, rope: 2 },
      result: { bow: 1 },
      tier: 3,
      unlock: 'hunter_entity'
    },
    {
      id: 'start_fire_flint',
      name: 'Zalo≈æit ohe≈à (K≈ôesadlo)',
      icon: '‚ö°',
      materials: { stone: 3 },
      requires: { knife: 1 },
      tier: 3,
      desc: '100% √∫spƒõch',
      isFireStarter: true,
      fireChance: 1.0,
      fireMethod: 'flint_steel'
    },
    {
      id: 'dried_meat',
      name: 'Su≈°en√© maso',
      icon: 'ü•©',
      materials: { food: 5 },
      requiresFire: true,
      result: { dried_meat: 3 },
      tier: 3,
      desc: 'Vydr≈æ√≠ p≈ôes zimu, neskaz√≠ se'
    },
    {
      id: 'storage',
      name: 'Sklad na zimu',
      icon: 'üì¶',
      materials: { plank: 5, rope: 3 },
      result: { storage: 1 },
      tier: 4
    },
    {
      id: 'fireplace',
      name: 'Krb',
      icon: 'üî•',
      materials: { stone: 8, plank: 3 },
      result: { fireplace: 1 },
      tier: 4,
      desc: 'Umo≈æ≈àuje topit d≈ôevem'
    },
    {
      id: 'insulation',
      name: 'Tepeln√° izolace',
      icon: 'üß±',
      materials: { fiber: 10, plank: 5, leather: 2 },
      result: { insulation: 1 },
      tier: 4,
      desc: 'Zlep≈°uje izolaci doupƒõte'
    }
  ],

  randomEvents: [
    {
      id: 'wood_fall',
      chance: 0.4,
      items: { wood: [2, 4] },
      message: 'üå≥ Nƒõkolik vƒõtv√≠ spadlo ze stropu'
    },
    {
      id: 'stone_fall',
      chance: 0.3,
      items: { stone: [1, 3] },
      message: '‚õ∞Ô∏è Kameny se uvolnily ze stƒõny'
    },
    {
      id: 'fiber_find',
      chance: 0.35,
      items: { fiber: [3, 5] },
      message: 'üåæ Na≈°el jsi svazky vl√°ken'
    },
    {
      id: 'bark_find',
      chance: 0.35,
      items: { bark: [2, 6] },
      message: 'üü´ K≈Øra spadla ze stromu'
    },
    {
      id: 'water_drip',
      chance: 0.8,
      items: { water_supply: [6, 12] },
      message: 'üíß Voda kape ze stropu do misek'
    },
    {
      id: 'mushroom_find',
      chance: 0.65,
      items: { food: [2, 4] },
      message: 'üçÑ Na≈°el jsi jedl√© houby'
    },
    {
      id: 'seed_find',
      chance: 0.3,
      season: [0],
      items: { seeds: [2, 4] },
      message: 'üå± V√≠tr p≈ôinesl semena'
    },
    {
      id: 'nothing',
      chance: 0.15,
      message: '...ticho a pr√°zdnota...'
    }
  ],

  entityTypes: [
    {
      id: 'gatherer',
      name: 'Sbƒõraƒç',
      icon: 'üë§',
      actions: [
        {
          name: 'üî™Sb√≠rat materi√°ly',
          duration: 1,
          requires: { knife: 1 },
          result: () => {
            const items = ['wood', 'stone', 'fiber', 'mushroom'];
            const item = items[Math.floor(Math.random() * items.length)];
            return { [item]: Math.floor(Math.random() * 3) + 8 };
          }
        },
        {
          name: 'üß∫Sb√≠rat bobule',
          duration: 1,
          requires: { basket: 1 },
          result: () => ({ 
            food: Math.floor(Math.random() * 3) + 3,
            water_supply: Math.random() > 0.5 ? Math.floor(Math.random() * 2) + 6 : 0
          })
        },
        {
          name: 'üï∏Ô∏èNastra≈æit past',
          duration: 2,
          requires: { trap: 1 },
          result: () => ({ 
            food: Math.floor(Math.random() * 5) + 4
          })
        },
        {
          name: 'ü•£Sb√≠rat vodu',
          duration: 1,
          requires: { bowl: 1 },
          result: () => ({ water_supply: Math.floor(Math.random() * 5) + 10 })
        },
        {
          name: 'üå≥Topit v krbu',
          icon: 'üå≥',
          duration: 1,
          requires: { fireplace: 1 },
          isHeating: true,
          result: () => ({ heating: 1 })
        },
        {
          name: 'üå≥P≈ôilo≈æit do ohnƒõ',
          duration: 1,
          requiresFire: true,
          isFuelAction: true,
          result: () => ({ fireFuel: 2 })
        }
      ]
    },
    {
      id: 'hunter',
      name: 'Lovec',
      icon: 'üèπ',
      unlockRequires: { bow: 1 },
      actions: [
        {
          name: 'Lovit',
          duration: 2,
          requires: { bow: 1 },
          result: () => ({ 
            food: Math.floor(Math.random() * 6) + 5,
            leather: Math.random() > 0.5 ? 1 : 0
          })
        }
      ]
    }
  ],

  track(eventName, params = {}) {
    try {
      const clientId = this.state.playerId;
      
      if (clientId) {
        this.backend('trackEvent', { clientId, eventName, params })
          .then(() => {
            console.log('‚úì GA4 tracked:', eventName);
          })
          .catch((error) => {
            console.warn('GA4 tracking failed:', error);
          });
      }
    } catch(e) {
      console.warn('GA4 tracking error:', e);
    }
  },

  calculateTemperature() {
    const season = this.seasons[this.state.season];
    
    const variance = (Math.random() - 0.5) * 2 * season.tempVariance;
    let targetTemp = season.baseTemp + variance;
    
    const heatingBonus = Math.min(this.state.heating, 3) * 5;
    
    const insulations = this.state.inventory.insulation || 0;
    const shelterLevel = 1 + (insulations * 0.5);
    
    const idealTemp = 15;
    const diff = targetTemp - idealTemp;
    const shelteredDiff = diff / shelterLevel;
    
    targetTemp = idealTemp + shelteredDiff + heatingBonus;
    
    this.state.temperature = Math.round(targetTemp * 10) / 10;
    this.state.shelterLevel = shelterLevel;
  },

  getTemperatureEmoji(temp) {
    if (temp < -5) return 'ü•∂';
    if (temp < 5) return '‚ùÑÔ∏è';
    if (temp < 12) return 'üå°Ô∏è';
    if (temp < 20) return 'üå§Ô∏è';
    if (temp < 28) return '‚òÄÔ∏è';
    return 'üî•';
  },

  getTemperatureEffects() {
    const temp = this.state.temperature;
    let hungerMultiplier = 1;
    let waterMultiplier = 1;
    let efficiency = 1;
    
    if (temp < 5) {
      hungerMultiplier = 1.5;
      efficiency = 0.7;
    } else if (temp < 10) {
      hungerMultiplier = 1.2;
      efficiency = 0.85;
    }
    
    if (temp > 28) {
      waterMultiplier = 1.5;
      efficiency = 0.7;
    } else if (temp > 23) {
      waterMultiplier = 1.2;
      efficiency = 0.85;
    }
    
    if (temp >= 10 && temp <= 20) {
      efficiency = 1.1;
    }
    
    return { hungerMultiplier, waterMultiplier, efficiency };
  },

  updateFireIndicator() {
    const indicator = document.getElementById('fire-indicator');
    const statusText = indicator.querySelector('.fire-status');
    
    if (this.state.fireActive && this.state.fireFuel > 0) {
      indicator.classList.remove('inactive');
      indicator.classList.add('active');
      statusText.textContent = `Ho≈ô√≠ (${this.state.fireFuel}d)`;
    } else {
      indicator.classList.remove('active');
      indicator.classList.add('inactive');
      statusText.textContent = 'Bez ohnƒõ';
    }
  },

  // üíæ SAVE/LOAD SYSTEM
  checkForSavedGame() {
    this.backend('loadGameState')
      .then((response) => {
        if (response.success && response.data) {
          this._savedGameData = response.data;
          this.showLoadGameModal();
        }
      })
      .catch((error) => {
        console.warn('Save check failed:', error);
      });
  },

  showLoadGameModal() {
    this.openModal();
    
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.id = 'load-game-modal';
    
    const savedState = JSON.parse(this._savedGameData);
    
    modal.innerHTML = `
      <div class="modal-content">
        <div class="modal-title">üíæ NALEZENA ULO≈ΩEN√Å HRA</div>
        
        <div style="
          background: rgba(139, 90, 43, 0.15);
          border: 1px solid rgba(139, 90, 43, 0.3);
          border-radius: 10px;
          padding: 15px;
          margin: 20px 0;
          text-align: left;
        ">
          <div style="color: #d4a574; margin-bottom: 8px; font-weight: 600;">üìä Ulo≈æen√° hra:</div>
          <div style="color: #b89968; font-size: 14px; line-height: 1.8;">
            ‚Ä¢ <strong>Den ${savedState.day}</strong> (${this.seasons[savedState.season].name})<br>
            ‚Ä¢ <strong>${savedState.entities.length + 1} obyvatel</strong><br>
            ‚Ä¢ <strong>${savedState.inventory.food || 0} j√≠dla</strong>, 
              <strong>${savedState.inventory.water_supply || 0} vody</strong><br>
            ‚Ä¢ <strong>${savedState.gold || 0}g zlata</strong>
          </div>
        </div>
        
        <div class="modal-buttons">
          <button class="modal-btn modal-btn-primary" onclick="game.loadSavedGame()">
            ‚ñ∂Ô∏è Pokraƒçovat
          </button>
          <button class="modal-btn modal-btn-secondary" onclick="game.startNewGame()">
            üÜï Nov√° hra
          </button>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
  },

  loadSavedGame() {
    const savedState = JSON.parse(this._savedGameData);
    this.state = savedState;
    
    this.closeModal('load-game-modal');
    
    this.log('üíæ Hra naƒçtena!', 'success');
    this.showNotification('üíæ Hra naƒçtena!');
    
    this.track('game_loaded', {
      day: this.state.day,
      season: this.seasons[this.state.season].name
    });
    
    this.render();
  },

  startNewGame() {
    this.closeModal('load-game-modal');
    delete this._savedGameData;
  },

  saveGame() {
    const dataToSave = JSON.stringify(this.state);
    
    this.backend('saveGameState', dataToSave)
      .then((response) => {
        if (response.success) {
          this.log('‚úÖ Hra ulo≈æena', 'success');
          this.showNotification('üíæ Hra ulo≈æena!');
          
          this.track('game_saved', {
            day: this.state.day,
            season: this.seasons[this.state.season].name
          });
        } else {
          this.log('‚ùå Chyba p≈ôi ukl√°d√°n√≠', 'danger');
        }
      })
      .catch((error) => {
        console.error('Save error:', error);
        this.log('‚ùå Chyba p≈ôi ukl√°d√°n√≠', 'danger');
      });
  },

  init() {
    this.checkForSavedGame();
    
    let playerId = localStorage.getItem('doupe_player_id');
    if (!playerId) {
      playerId = 'player_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      localStorage.setItem('doupe_player_id', playerId);
    }
    this.state.playerId = playerId;
    
    this.state.bestRun = parseInt(localStorage.getItem('doupe_best_run') || '0');
    this.state.playerNickname = localStorage.getItem('doupe_nickname') || null;
    
    this.state.inventory = { 
      wood: 5,
      fiber: 8,
      food: 60,
      water_supply: 60
    };
    this.state.temperature = 15;
    this.state.shelterLevel = 1;
    this.state.heating = 0;
    this.state.guaranteedStones = 0;
    this.state.fireActive = false;
    this.state.fireFuel = 0;
    this.state.unlockedRecipes = ['stick', 'rope', 'bowl', 'trap', 'basket'];
    
    const environment = this.isAppsScript ? 'Apps Script (Full Features)' : 'Standalone (Local Save)';
    console.log(`üéÆ Doupƒõ 2 - Running in: ${environment}`);
    
    this.track('page_view', {
      page_title: 'Doupƒõ - Survival Crafting',
      page_location: window.location.href,
      engagement_time_msec: '100',
      environment: environment
    });
    
    this.track('game_start', {
      starting_food: 60,
      starting_water: 60,
      starting_temperature: 15,
      is_returning_player: this.state.bestRun > 0,
      environment: environment
    });
    
    this.log('üå≤ Probouz√≠≈° se v tich√©m doupƒõti, kdesi hluboko v temn√Ωch vla≈æn√Ωch les√≠ch... V√≠≈°, ≈æe kolem to v≈ôe, ale tobƒõ je p≈ô√≠jemnƒõ chladno.', 'info');
    this.log('Vzduch je ale tƒõ≈æk√Ω. Kolonie str√°d√° a nach√°z√≠ se na pokraji z√°niku. Hlad, ≈æ√≠ze≈à, mr√°z - tvoji vƒõƒçn√≠ nep≈ô√°tel√©.', 'warning');
    this.log('L√©ta sucha vysu≈°ila prameny. Zimy jsou krut√©, j√≠dlo vz√°cn√©. P≈ôe≈æit√≠ nen√≠ zaruƒçeno. Sp√≠≈°e vyvr√°ceno. M√°≈° na to?', 'warning');
    this.log('', 'info');
    this.log('üí° JAK ZAƒå√çT: Vytvo≈ô si n√°stroje (h≈Øl, provaz, misku). Postavte past na zvƒõ≈ô. Tvoje role je tvo≈ôit vƒõci. Pro kolonii. Obchodn√≠ci je r√°di vykoup√≠, nebo pomohou kolonii k p≈ôe≈æit√≠. V√Ωhodnou je, ≈æe je m≈Ø≈æe≈° prodat. A za pen√≠ze pak m≈Ø≈æe≈° podpo≈ôit j√≠dlem a vodou celou kolonii. Zajist√≠≈° si i tak sv√© p≈ôe≈æit√≠? Ven se ti moc zat√≠m nechce, ani na to nem√°≈° pr√°vo, tvoje role je craftov√°n√≠.', 'success');
    this.log('üí° PRVN√ç KROKY: Craftuj n≈Ø≈æ ‚Üí p≈ôijde obyvatel ‚Üí p≈ôi≈ôaƒè mu pr√°ci.', 'success');
    this.log('üí° KL√çƒå K P≈òE≈ΩIT√ç: Sledujte z√°soby kolonie! Obdob√≠ se mƒõn√≠ ka≈æd√Ωch 15 dn√≠ a jejich dopady jsou nemilosrdn√©.', 'danger');
    this.log('üí° TEPLOTA: V l√©tƒõ je vedro k omdlen√≠. V mrazu spot≈ôebujete v√≠c j√≠dla. Rozdƒõlejte ohe≈à, postavte krb, zatopte, nebo budete mrznout. Mo≈æn√° p≈ôe≈æijete zimu a dal≈°√≠ bude lehƒç√≠?', 'danger');
    this.log('üî• OHE≈á: Luk ‚Üí Bow Drill (80%) nebo K≈ôesadlo (100%). Pot≈ôebn√Ω pro su≈°en√≠ masa!', 'success');
    this.log('üí∞ EKONOMIKA: Prod√°vej suroviny üü° za zlato ‚Üí Kup j√≠dlo/vodu üè∑Ô∏è. Risk vs. reward!', 'success');
    this.log('üíæ SAVE: Klikni "üíæ Ulo≈æit hru" kdykoliv. P≈ôi p≈ô√≠≈°t√≠m naƒçten√≠ se zept√°m, jestli chce≈° pokraƒçovat!', 'success');
    
    if (!this.isAppsScript) {
      this.log('‚ö†Ô∏è Public message: ≈Ωeb≈ô√≠ƒçek funguje. Pln√© funkce, enjoy:-)', 'warning');
    }
    
    this.log('', 'info');
    
    this.render();
  },

  log(text, type = 'info') {
    const div = document.createElement('div');
    div.className = `log-entry log-${type}`;
    div.textContent = text;
    const logEl = document.getElementById('log');
    logEl.appendChild(div);
    logEl.scrollTop = logEl.scrollHeight;
  },

  showNotification(text) {
    const notif = document.createElement('div');
    notif.className = 'event-notification';
    notif.textContent = text;
    document.body.appendChild(notif);
    
    setTimeout(() => {
      notif.style.animation = 'slideIn 0.5s ease-out reverse';
      setTimeout(() => notif.remove(), 500);
    }, 3000);
  },

  sellItem(itemId, quantity = 1) {
    const item = this.items[itemId];
    if (!item) return;
    
    const have = this.state.inventory[itemId] || 0;
    if (have < quantity) {
      this.log('‚ùå Nem√°≈° dost na prodej', 'warning');
      return;
    }
    
    if (!item.sellPrice) {
      this.log('‚ùå Toto nelze prodat', 'warning');
      return;
    }
    
    const goldEarned = item.sellPrice * quantity;
    
    this.removeItem(itemId, quantity);
    this.state.gold += goldEarned;
    
    this.log(`üü° Prodal jsi ${item.icon} ${item.name} √ó${quantity} za ${goldEarned}g`, 'success');
    this.showNotification(`üü° +${goldEarned}g`);
    
    this.track('item_sold', {
      item_id: itemId,
      item_name: item.name,
      quantity: quantity,
      gold_earned: goldEarned,
      new_gold_balance: this.state.gold,
      day: this.state.day
    });
    
    this.backend('logTransaction', {
      playerId: this.state.playerId,
      type: 'sell',
      itemId: itemId,
      itemName: item.name,
      quantity: quantity,
      goldAmount: goldEarned,
      newBalance: this.state.gold,
      day: this.state.day
    }).catch((error) => {
      console.warn('Transaction log failed:', error);
    });
    
    this.render();
  },

  buyItem(itemId, quantity = 1) {
    const item = this.items[itemId];
    if (!item) return;
    
    if (!item.buyPrice) {
      this.log('‚ùå Toto nelze koupit', 'warning');
      return;
    }
    
    const goldNeeded = item.buyPrice * quantity;
    
    if (this.state.gold < goldNeeded) {
      this.log(`‚ùå Nem√°≈° dost zlata (pot≈ôeba ${goldNeeded}g)`, 'warning');
      return;
    }
    
    this.state.gold -= goldNeeded;
    this.addItem(itemId, quantity);
    
    this.log(`üè∑Ô∏è Koupil jsi ${item.icon} ${item.name} √ó${quantity} za ${goldNeeded}g`, 'success');
    this.showNotification(`üè∑Ô∏è -${goldNeeded}g`);
    
    this.track('item_bought', {
      item_id: itemId,
      item_name: item.name,
      quantity: quantity,
      gold_spent: goldNeeded,
      new_gold_balance: this.state.gold,
      day: this.state.day
    });
    
    this.backend('logTransaction', {
      playerId: this.state.playerId,
      type: 'buy',
      itemId: itemId,
      itemName: item.name,
      quantity: quantity,
      goldAmount: goldNeeded,
      newBalance: this.state.gold,
      day: this.state.day
    }).catch((error) => {
      console.warn('Transaction log failed:', error);
    });
    
    this.render();
  },

  hasMaterials(materials) {
    return Object.entries(materials).every(
      ([id, count]) => (this.state.inventory[id] || 0) >= count
    );
  },

  hasTools(tools) {
    if (!tools) return true;
    return Object.entries(tools).every(
      ([id, count]) => (this.state.inventory[id] || 0) >= count
    );
  },

  addItem(id, count) {
    this.state.inventory[id] = (this.state.inventory[id] || 0) + count;
  },

  removeItem(id, count) {
    this.state.inventory[id] = (this.state.inventory[id] || 0) - count;
    if (this.state.inventory[id] <= 0) delete this.state.inventory[id];
  },

  craft(recipeId) {
    const recipe = this.recipes.find(r => r.id === recipeId);
    if (!recipe) return;

    if (!this.hasMaterials(recipe.materials)) {
      this.log('‚ùå Nem√°≈° dost materi√°l≈Ø', 'warning');
      return;
    }

    if (recipe.requires && !this.hasTools(recipe.requires)) {
      this.log('‚ùå Pot≈ôebuje≈° spr√°vn√© n√°stroje', 'warning');
      return;
    }

    if (recipe.requiresFire && !this.state.fireActive) {
      this.log('‚ùå Pot≈ôebuje≈° ho≈ô√≠c√≠ ohe≈à', 'warning');
      return;
    }

    if (recipe.isFireStarter) {
      for (const [id, count] of Object.entries(recipe.materials)) {
        this.removeItem(id, count);
      }

      if (Math.random() < recipe.fireChance) {
        this.state.fireActive = true;
        this.state.fireFuel = 0;
        this.log(`üî• Ohe≈à vzplanul! (${recipe.fireMethod})`, 'success');
        this.showNotification('üî• Ohe≈à ho≈ô√≠!');
        
        this.track('fire_started', {
          method: recipe.fireMethod,
          day: this.state.day,
          chance: recipe.fireChance
        });
      } else {
        this.log('üí® Nepoda≈ôilo se... zkus znovu', 'warning');
        
        this.track('fire_failed', {
          method: recipe.fireMethod,
          day: this.state.day
        });
      }
      
      this.render();
      return;
    }

    for (const [id, count] of Object.entries(recipe.materials)) {
      this.removeItem(id, count);
    }

    for (const [id, count] of Object.entries(recipe.result)) {
      this.addItem(id, count);
    }

    this.log(`‚úÖ Vytvo≈ôil jsi ${recipe.icon} ${recipe.name}`, 'success');

    this.track('craft_item', {
      item_name: recipe.name,
      item_id: recipe.id,
      item_tier: recipe.tier,
      day: this.state.day,
      season: this.seasons[this.state.season].name
    });

    if (recipe.unlock === 'first_entity' && this.state.entities.length === 0) {
      this.spawnEntity('gatherer');
      this.log('üë§ Do doupƒõte dorazil prvn√≠ obyvatel - Sbƒõraƒç!', 'success');
      this.showNotification('üéâ Nov√Ω obyvatel se p≈ôipojil!');
    }

    if (recipe.unlock === 'hunter_entity') {
      const hasHunter = this.state.entities.some(e => e.type === 'hunter');
      if (!hasHunter) {
        this.spawnEntity('hunter');
        this.log('üèπ Lovec se p≈ôipojil k doupƒõti!', 'success');
        this.showNotification('üéâ Lovec se p≈ôipojil!');
      }
    }

    this.render();
  },

  spawnEntity(typeId) {
    const type = this.entityTypes.find(t => t.id === typeId);
    if (!type) return;

    const entity = {
      id: Date.now(),
      type: typeId,
      name: type.name,
      icon: type.icon,
      status: 'idle',
      action: null,
      daysLeft: 0
    };

    this.state.entities.push(entity);
    
    this.track('entity_joined', {
      entity_type: typeId,
      entity_name: type.name,
      day: this.state.day,
      total_entities: this.state.entities.length
    });
  },

  assignAction(entityId, actionIndex) {
    const entity = this.state.entities.find(e => e.id === entityId);
    if (!entity) return;

    const type = this.entityTypes.find(t => t.id === entity.type);
    const action = type.actions[actionIndex];

    if (!this.hasTools(action.requires)) {
      this.log('‚ùå Entita nem√° pot≈ôebn√© n√°stroje', 'warning');
      return;
    }

    if (action.requiresFire && !this.state.fireActive) {
      this.log('‚ùå Nen√≠ zalo≈æen√Ω ohe≈à', 'warning');
      return;
    }

    entity.status = 'working';
    entity.action = action;
    entity.daysLeft = action.duration;

    this.log(`${entity.icon} ${entity.name} zaƒçal: ${action.name}`, 'info');
    
    this.track('entity_action', {
      entity_type: entity.type,
      action_name: action.name,
      action_duration: action.duration,
      day: this.state.day
    });
    
    this.render();
  },

  processEntities() {
    this.state.entities.forEach(entity => {
      if (entity.status === 'working' && entity.daysLeft > 0) {
        entity.daysLeft--;

        if (entity.daysLeft === 0) {
          if (entity.action.isFuelAction) {
            const woodAvailable = this.state.inventory.wood || 0;
            if (woodAvailable >= 3) {
              this.removeItem('wood', 3);
              this.state.fireFuel += 2;
              this.log(`${entity.icon} ${entity.name} p≈ôilo≈æil do ohnƒõ (+2 dny, -3 ü™µ)`, 'success');
              
              this.track('fire_fueled', {
                wood_used: 3,
                fuel_added: 2,
                total_fuel: this.state.fireFuel,
                day: this.state.day
              });
            } else {
              this.log(`${entity.icon} ${entity.name} nem√° d≈ôevo (pot≈ôeba 3)`, 'warning');
            }
            entity.status = 'idle';
            entity.action = null;
            return;
          }

          if (entity.action.isHeating) {
            const woodAvailable = this.state.inventory.wood || 0;
            if (woodAvailable >= 3) {
              this.removeItem('wood', 3);
              this.state.heating = Math.min(this.state.heating + 1, 3);
              this.log(`${entity.icon} ${entity.name} zatopil v krbu (+5¬∞C po 1 den)`, 'success');
              
              this.track('heating_action', {
                success: true,
                heating_level: this.state.heating,
                temperature: this.state.temperature,
                day: this.state.day
              });
            } else {
              this.log(`${entity.icon} ${entity.name} nem√° d≈ôevo na topen√≠ (pot≈ôeba 3)`, 'warning');
              
              this.track('heating_action', {
                success: false,
                wood_available: woodAvailable,
                temperature: this.state.temperature,
                day: this.state.day
              });
            }
            entity.status = 'idle';
            entity.action = null;
            return;
          }
          
          const result = entity.action.result();
          
          let resultText = [];
          for (const [itemId, count] of Object.entries(result)) {
            if (count > 0) {
              this.addItem(itemId, count);
              const item = this.items[itemId];
              resultText.push(`${item.icon} ${item.name} √ó${count}`);
            }
          }

          if (resultText.length > 0) {
            this.log(`${entity.icon} ${entity.name} p≈ôinesl: ${resultText.join(', ')}`, 'item');
          } else {
            this.log(`${entity.icon} ${entity.name} se vr√°til s pr√°zdnou`, 'warning');
          }

          entity.status = 'idle';
          entity.action = null;
        }
      }
    });
  },

  triggerRandomEvent() {
    const currentSeason = this.seasons[this.state.season];
    
    const availableEvents = this.randomEvents.filter(event => {
      if (event.season && !event.season.includes(this.state.season)) {
        return false;
      }
      return true;
    });

    if (Math.random() > this.state.eventChance) return;

    const totalChance = availableEvents.reduce((sum, e) => sum + e.chance, 0);
    let roll = Math.random() * totalChance;

    for (const event of availableEvents) {
      roll -= event.chance;
      if (roll <= 0) {
        if (event.items) {
          for (const [itemId, range] of Object.entries(event.items)) {
            const count = Math.floor(Math.random() * (range[1] - range[0] + 1)) + range[0];
            this.addItem(itemId, count);
            const item = this.items[itemId];
            this.log(event.message + ` (+${count} ${item.icon})`, 'item');
          }
        } else {
          this.log(event.message, 'info');
        }
        break;
      }
    }
  },

  nextDay() {
    if (this.state.dead) return;

    this.state.day++;

    const newSeason = Math.floor((this.state.day - 1) / 15) % 4;
    if (newSeason !== this.state.season) {
      this.state.season = newSeason;
      const season = this.seasons[this.state.season];
      this.log(`${season.icon} Nast√°v√° ${season.name}! ${season.desc}`, 'warning');
      this.showNotification(`${season.icon} ${season.name} zaƒç√≠n√°!`);
      
      this.track('season_change', {
        new_season: season.name,
        day: this.state.day,
        population: this.state.entities.length + 1,
        food_reserves: this.state.inventory.food || 0,
        water_reserves: this.state.inventory.water_supply || 0
      });
    }

    if (this.state.day % 10 === 0) {
      this.track('milestone_reached', {
        days_survived: this.state.day,
        season: this.seasons[this.state.season].name,
        population: this.state.entities.length + 1,
        temperature: this.state.temperature,
        food_supply: this.state.inventory.food || 0,
        water_supply: this.state.inventory.water_supply || 0
      });
    }

    const season = this.seasons[this.state.season];

    this.log(`--- Den ${this.state.day} ---`, 'info');

    if (this.state.fireFuel > 0) {
      this.state.fireFuel--;
      if (this.state.fireFuel === 0) {
        this.state.fireActive = false;
        this.log('üå´Ô∏è Ohe≈à vyhasl!', 'warning');
        this.showNotification('üí® Ohe≈à vyhasl!');
        
        this.track('fire_extinguished', {
          day: this.state.day,
          reason: 'no_fuel'
        });
      } else {
        this.log(`üî• Ohe≈à ho≈ô√≠ (zb√Ωv√° ${this.state.fireFuel} dn√≠)`, 'info');
      }
    }

    this.calculateTemperature();
    const tempEffects = this.getTemperatureEffects();
    const tempEmoji = this.getTemperatureEmoji(this.state.temperature);
    
    if (this.state.temperature < 5) {
      this.log(`${tempEmoji} Je mrazivƒõ! (${this.state.temperature}¬∞C) Spot≈ôeba j√≠dla +50%`, 'danger');
      this.track('extreme_temperature', {
        type: 'freezing',
        temperature: this.state.temperature,
        day: this.state.day,
        heating_active: this.state.heating > 0
      });
    } else if (this.state.temperature < 10) {
      this.log(`${tempEmoji} Je chladno (${this.state.temperature}¬∞C) Spot≈ôeba j√≠dla +20%`, 'warning');
    } else if (this.state.temperature > 28) {
      this.log(`${tempEmoji} Je vedro! (${this.state.temperature}¬∞C) Spot≈ôeba vody +50%`, 'danger');
      this.track('extreme_temperature', {
        type: 'heatwave',
        temperature: this.state.temperature,
        day: this.state.day
      });
    } else if (this.state.temperature > 23) {
      this.log(`${tempEmoji} Je horko (${this.state.temperature}¬∞C) Spot≈ôeba vody +20%`, 'warning');
    } else if (this.state.temperature >= 10 && this.state.temperature <= 20) {
      this.log(`${tempEmoji} P≈ô√≠jemn√° teplota (${this.state.temperature}¬∞C) Efektivita +10%!`, 'success');
    } else {
      this.log(`${tempEmoji} Teplota: ${this.state.temperature}¬∞C`, 'info');
    }
    
    if (this.state.heating > 0) {
      this.state.heating--;
      if (this.state.heating === 0) {
        this.log('üî• Krb vychladl', 'info');
      }
    }

    this.processEntities();

    if (this.state.day <= 5) {
      const stonesGiven = this.state.guaranteedStones || 0;
      
      if (stonesGiven < 2) {
        this.addItem('stone', 1);
        this.log(`ü™® Na≈°el jsi k√°men! (+1)`, 'item');
        this.state.guaranteedStones = stonesGiven + 1;
      } else if (stonesGiven === 2 && Math.random() < 0.5) {
        this.addItem('stone', 1);
        this.log(`ü™® Na≈°el jsi k√°men! (+1)`, 'item');
        this.state.guaranteedStones = 3;
      }
    }

    this.triggerRandomEvent();

    const effectivePopulation = Math.max(0, this.state.entities.length - 1);
    const populationMultiplier = 1 + (effectivePopulation * 0.4);
    
    const hungerNeeded = Math.ceil(season.hungerDrain * populationMultiplier * tempEffects.hungerMultiplier);
    const waterNeeded = Math.ceil(season.waterDrain * populationMultiplier * tempEffects.waterMultiplier);
    
    const foodAvailable = this.state.inventory.food || 0;
    const waterAvailable = this.state.inventory.water_supply || 0;

    if (this.state.entities.length > 0) {
      this.log(`üë• Kolonie: ${this.state.entities.length + 1} obyvatel (spot≈ôeba: √ó${populationMultiplier.toFixed(1)})`, 'info');
    }

    if (foodAvailable >= hungerNeeded) {
      this.removeItem('food', hungerNeeded);
      this.log(`üçñ Spot≈ôebov√°no ${hungerNeeded} j√≠dla`, 'info');
    } else {
      if (foodAvailable > 0) {
        this.removeItem('food', foodAvailable);
        this.log(`‚ö†Ô∏è Spot≈ôebov√°no jen ${foodAvailable} j√≠dla, chyb√≠ ${hungerNeeded - foodAvailable}`, 'warning');
      }
      this.gameOver('üçñ Kolonie um≈ôela hlady');
      return;
    }

    if (waterAvailable >= waterNeeded) {
      this.removeItem('water_supply', waterNeeded);
      this.log(`üíß Spot≈ôebov√°no ${waterNeeded} vody`, 'info');
    } else {
      if (waterAvailable > 0) {
        this.removeItem('water_supply', waterAvailable);
        this.log(`‚ö†Ô∏è Spot≈ôebov√°na jen ${waterAvailable} voda, chyb√≠ ${waterNeeded - waterAvailable}`, 'warning');
      }
      this.gameOver('üíß Kolonie um≈ôela ≈æ√≠zn√≠');
      return;
    }

    this.render();
  },

  gameOver(reason = 'Nep≈ôe≈æil jsi') {
    this.state.dead = true;
    
    const isNewBestRun = this.state.day > this.state.bestRun;
    
    this.track('game_over', {
      death_reason: reason,
      days_survived: this.state.day,
      final_season: this.seasons[this.state.season].name,
      population: this.state.entities.length + 1,
      final_temperature: this.state.temperature,
      food_remaining: this.state.inventory.food || 0,
      water_remaining: this.state.inventory.water_supply || 0,
      had_fireplace: (this.state.inventory.fireplace || 0) > 0,
      had_insulation: (this.state.inventory.insulation || 0) > 0,
      shelter_level: this.state.shelterLevel,
      fire_was_active: this.state.fireActive,
      is_new_best: isNewBestRun
    });
    
    if (isNewBestRun) {
      this.showNicknameModal(reason);
      return;
    }
    
    const overlay = document.createElement('div');
    overlay.style.cssText = `
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      animation: fadeIn 0.5s ease-out;
    `;
    overlay.innerHTML = `
      <div style="
        background: linear-gradient(145deg, #1a1410, #2d2416);
        padding: 50px;
        border-radius: 24px;
        text-align: center;
        border: 2px solid rgba(192, 80, 77, 0.5);
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.9);
        animation: scaleIn 0.5s ease-out 0.2s both;
      ">
        <h1 style="
          color: #e67e7b;
          font-size: 48px;
          margin-bottom: 20px;
          font-family: 'Space Mono', monospace;
          text-shadow: 0 4px 12px rgba(230, 126, 123, 0.5);
        ">üíÄ GAME OVER</h1>
        <p style="
          color: #d4a574;
          font-size: 20px;
          margin-bottom: 30px;
          font-family: 'Crimson Pro', serif;
        ">${reason}</p>
        <p style="
          color: #9a8670;
          font-size: 16px;
          margin-bottom: 30px;
          font-family: 'Space Mono', monospace;
        ">P≈ôe≈æil jsi ${this.state.day} dn√≠</p>
        <button onclick="game.reset()" style="
          padding: 16px 32px;
          font-size: 18px;
          background: linear-gradient(135deg, #8b5a2b, #a67c52);
          color: white;
          border: none;
          border-radius: 12px;
          cursor: pointer;
          font-family: 'Space Mono', monospace;
          font-weight: 700;
          box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
        ">üîÑ Zkusit znovu</button>
      </div>
    `;
    
    const style = document.createElement('style');
    style.textContent = `
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      @keyframes scaleIn {
        from { transform: scale(0.8); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
      }
    `;
    document.head.appendChild(style);
    
    document.body.appendChild(overlay);
  },

  showNicknameModal(reason) {
    this.openModal();
    
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.id = 'nickname-modal';
    
    modal.innerHTML = `
      <div class="modal-content">
        <div class="modal-title">üéâ NOV√ù OSOBN√ç REKORD!</div>
        <p class="nickname-info">P≈ôe≈æil jsi <strong>${this.state.day} dn√≠</strong></p>
        <p class="nickname-info" style="font-size: 12px; color: #9a8670; margin-top: -5px;">
          P≈ôedchoz√≠ rekord: ${this.state.bestRun} dn√≠
        </p>
        <p class="nickname-info" style="margin-top: 15px;">Zadej svou p≈ôezd√≠vku pro ≈æeb≈ô√≠ƒçek:</p>
        <input 
          type="text" 
          class="nickname-input" 
          id="nickname-input"
          placeholder="Tvoje p≈ôezd√≠vka..." 
          maxlength="20"
          value="${this.state.playerNickname || ''}"
        />
        <div class="modal-buttons">
          <button class="modal-btn modal-btn-primary" onclick="game.saveHighScoreToSheet()">
            üíæ Ulo≈æit do ≈æeb≈ô√≠ƒçku
          </button>
          <button class="modal-btn modal-btn-secondary" onclick="game.skipNickname()">
            P≈ôeskoƒçit
          </button>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    setTimeout(() => {
      document.getElementById('nickname-input').focus();
    }, 100);
    
    document.getElementById('nickname-input').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        this.saveHighScoreToSheet();
      }
    });
  },

  saveHighScoreToSheet() {
    const nicknameInput = document.getElementById('nickname-input');
    const nickname = nicknameInput.value.trim() || 'Anonymous';
    
    this.state.playerNickname = nickname;
    localStorage.setItem('doupe_nickname', nickname);
    
    this.state.bestRun = this.state.day;
    localStorage.setItem('doupe_best_run', this.state.day.toString());
    
    const data = {
      playerId: this.state.playerId,
      nickname: nickname,
      days: this.state.day,
      season: this.seasons[this.state.season].name,
      population: this.state.entities.length + 1,
      temperature: this.state.temperature,
      foodLeft: this.state.inventory.food || 0,
      waterLeft: this.state.inventory.water_supply || 0
    };
    
    nicknameInput.disabled = true;
    nicknameInput.value = 'Ukl√°d√°m...';
    
    this.backend('saveHighScore', data)
      .then((response) => {
        if (response.success) {
          console.log('High score saved:', response);
          this.closeModal('nickname-modal');
          this.showGameOverScreen(`üèÜ ${response.message}`);
        } else if (response.standalone) {
          console.log('Standalone mode - saved locally');
          this.closeModal('nickname-modal');
          this.showGameOverScreen('üíÄ GAME OVER (Local save)');
        } else {
          throw new Error(response.message || 'Unknown error');
        }
      })
      .catch((error) => {
        console.error('Error saving high score:', error);
        alert('Chyba p≈ôi ukl√°d√°n√≠: ' + (error.message || error));
        nicknameInput.disabled = false;
        nicknameInput.value = nickname;
      });
  },

  skipNickname() {
    this.state.bestRun = this.state.day;
    localStorage.setItem('doupe_best_run', this.state.day.toString());
    
    this.closeModal('nickname-modal');
    this.showGameOverScreen('üíÄ GAME OVER');
  },

  showGameOverScreen(title) {
    const overlay = document.createElement('div');
    overlay.style.cssText = `
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      animation: fadeIn 0.5s ease-out;
    `;
    overlay.innerHTML = `
      <div style="
        background: linear-gradient(145deg, #1a1410, #2d2416);
        padding: 50px;
        border-radius: 24px;
        text-align: center;
        border: 2px solid rgba(192, 80, 77, 0.5);
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.9);
        animation: scaleIn 0.5s ease-out 0.2s both;
      ">
        <h1 style="
          color: #e67e7b;
          font-size: 48px;
          margin-bottom: 20px;
          font-family: 'Space Mono', monospace;
          text-shadow: 0 4px 12px rgba(230, 126, 123, 0.5);
        ">${title}</h1>
        <p style="
          color: #9a8670;
          font-size: 16px;
          margin-bottom: 30px;
          font-family: 'Space Mono', monospace;
        ">P≈ôe≈æil jsi ${this.state.day} dn√≠</p>
        <button onclick="game.reset()" style="
          padding: 16px 32px;
          font-size: 18px;
          background: linear-gradient(135deg, #8b5a2b, #a67c52);
          color: white;
          border: none;
          border-radius: 12px;
          cursor: pointer;
          font-family: 'Space Mono', monospace;
          font-weight: 700;
          box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
        ">üîÑ Zkusit znovu</button>
      </div>
    `;
    
    document.body.appendChild(overlay);
  },

  showLeaderboard() {
    this.openModal();
    
    const loadingModal = document.createElement('div');
    loadingModal.className = 'modal-overlay';
    loadingModal.id = 'leaderboard-modal';
    loadingModal.innerHTML = `
      <div class="modal-content">
        <div class="modal-title">üèÜ ≈ΩEB≈ò√çƒåEK</div>
        <p class="nickname-info">Naƒç√≠t√°m data...</p>
      </div>
    `;
    document.body.appendChild(loadingModal);
    
    this.backend('getLeaderboard')
      .then((response) => {
        if (response.success) {
          this.renderLeaderboard(response.data);
        } else {
          console.error('Leaderboard load failed:', response);
          alert('Chyba p≈ôi naƒç√≠t√°n√≠ ≈æeb≈ô√≠ƒçku: ' + (response.message || response.error));
          this.closeModal('leaderboard-modal');
        }
      })
      .catch((error) => {
        console.error('Leaderboard error:', error);
        alert('Chyba p≈ôi naƒç√≠t√°n√≠ ≈æeb≈ô√≠ƒçku: ' + error.message);
        this.closeModal('leaderboard-modal');
      });
  },

  renderLeaderboard(data) {
    const modal = document.getElementById('leaderboard-modal');
    
    let tableRows = '';
    if (data.length === 0) {
      tableRows = '<tr><td colspan="4" style="text-align: center; padding: 30px; color: #9a8670;">≈Ωeb≈ô√≠ƒçek je zat√≠m pr√°zdn√Ω...</td></tr>';
    } else {
      tableRows = data.map(entry => {
        const rankClass = entry.rank <= 3 ? `rank-${entry.rank}` : 'rank-other';
        const isYou = entry.playerId === this.state.playerId;
        const rowClass = isYou ? 'your-rank' : '';
        
        return `
          <tr class="${rowClass}">
            <td><span class="rank-badge ${rankClass}">${entry.rank}</span></td>
            <td>${entry.nickname}${isYou ? ' <strong>(ty)</strong>' : ''}</td>
            <td><strong>${entry.days}d</strong></td>
            <td>${this.getSeasonIcon(entry.season)} ${entry.population}üë•</td>
          </tr>
        `;
      }).join('');
    }
    
    modal.innerHTML = `
      <div class="modal-content">
        <div class="modal-title">üèÜ TOP 10 KOLONI√ç</div>
        <table class="leaderboard-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Jm√©no</th>
              <th>Dny</th>
              <th>Info</th>
            </tr>
          </thead>
          <tbody>
            ${tableRows}
          </tbody>
        </table>
        <div class="modal-buttons">
          <button class="modal-btn modal-btn-secondary" onclick="game.closeModal('leaderboard-modal')">
            Zav≈ô√≠t
          </button>
        </div>
      </div>
    `;
  },

  getSeasonIcon(seasonName) {
    const icons = {
      'Jaro': 'üå±',
      'L√©to': '‚òÄÔ∏è',
      'Podzim': 'üçÇ',
      'Zima': '‚ùÑÔ∏è'
    };
    return icons[seasonName] || 'üåç';
  },

  showResetConfirmation() {
    this.openModal();
    
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.id = 'reset-confirmation-modal';
    
    modal.innerHTML = `
      <div class="modal-content">
        <div class="modal-title">‚ö†Ô∏è ZAƒå√çT ZNOVU?</div>
        <p class="nickname-info" style="color: #e67e7b; font-weight: 600; margin: 20px 0;">
          V≈°echen postup bude ztracen!
        </p>
        <div style="
          background: rgba(230, 126, 123, 0.1); 
          border: 1px solid rgba(230, 126, 123, 0.3);
          border-radius: 10px;
          padding: 15px;
          margin: 20px 0;
          text-align: left;
        ">
          <div style="color: #d4a574; margin-bottom: 8px;">üìä Tv≈Øj postup:</div>
          <div style="color: #b89968; font-size: 14px; line-height: 1.6;">
            ‚Ä¢ <strong>Den ${this.state.day}</strong> (${this.seasons[this.state.season].name})<br>
            ‚Ä¢ <strong>${this.state.entities.length + 1} obyvatel</strong><br>
            ‚Ä¢ <strong>${this.state.inventory.food || 0} j√≠dla</strong>, 
              <strong>${this.state.inventory.water_supply || 0} vody</strong><br>
            ‚Ä¢ <strong>${this.state.gold}g zlata</strong>
          </div>
        </div>
        <p class="nickname-info" style="font-size: 12px; color: #9a8670;">
          Tv≈Øj nejlep≈°√≠ bƒõh (${this.state.bestRun} dn√≠) z≈Østane ulo≈æen√Ω.
        </p>
        <div class="modal-buttons">
          <button class="modal-btn modal-btn-secondary" onclick="game.closeModal('reset-confirmation-modal')">
            ‚ùå Zru≈°it
          </button>
          <button class="modal-btn modal-btn-primary" 
                  style="background: linear-gradient(135deg, #c0504d, #e67e7b);" 
                  onclick="game.confirmReset()">
            üîÑ Ano, zaƒç√≠t znovu
          </button>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
  },

  confirmReset() {
    this.closeModal('reset-confirmation-modal');
    this.reset();
  },

  reset() {
    const overlay = document.querySelector('div[style*="position: fixed"]');
    if (overlay) overlay.remove();
    
    const modal = document.getElementById('leaderboard-modal') || document.getElementById('nickname-modal');
    if (modal) modal.remove();

    const wasDead = this.state.dead;
    const finalDay = this.state.day;
    
    this.track('game_reset', {
      was_dead: wasDead,
      previous_days: finalDay,
      reset_type: wasDead ? 'after_death' : 'manual_restart'
    });
    
    const savedPlayerId = this.state.playerId;
    const savedNickname = this.state.playerNickname;
    const savedBestRun = this.state.bestRun;

    this.state = {
      day: 1,
      season: 0,
      dead: false,
      inventory: {},
      entities: [],
      unlockedRecipes: [],
      eventChance: 0.5,
      temperature: 15,
      shelterLevel: 1,
      heating: 0,
      guaranteedStones: 0,
      playerId: savedPlayerId,
      playerNickname: savedNickname,
      bestRun: savedBestRun,
      fireActive: false,
      fireFuel: 0,
      gold: 0
    };

    document.getElementById('log').innerHTML = '';
    this.init();
  },

  renderInventory() {
    const el = document.getElementById('inventory');
    el.innerHTML = '';

    const entries = Object.entries(this.state.inventory ?? {});

    if (entries.length === 0) {
      el.innerHTML = '<div class="empty-state">Invent√°≈ô je pr√°zdn√Ω...</div>';
      return;
    }

    entries.forEach(([id, count]) => {
      const item = this.items[id];
      if (!item) return;

      const card = document.createElement('div');
      card.className = 'item-card';
      
      let actionButton = '';
      if (item.sellPrice && id !== 'food' && id !== 'water_supply') {
        actionButton = `
          <button class="item-action-btn item-sell-btn" onclick="game.sellItem('${id}', 1)">
            üü° ${item.sellPrice}g
          </button>
        `;
      }
      
      if (item.buyPrice && (id === 'food' || id === 'water_supply')) {
        actionButton = `
          <button class="item-action-btn item-buy-btn" onclick="game.buyItem('${id}', 1)">
            üè∑Ô∏è ${item.buyPrice}g
          </button>
        `;
      }
      
      card.innerHTML = `
        <div class="item-icon">${item.icon}</div>
        <div class="item-details">
          <div class="item-name">${item.name}</div>
          <div class="item-desc">${item.desc}</div>
        </div>
        <div class="item-count">√ó${count}</div>
        ${actionButton}
      `;

      el.appendChild(card);
    });
  },

  renderRecipes() {
    const el = document.getElementById('recipes');
    el.innerHTML = '';

    const availableRecipes = this.recipes.filter(r => 
      this.state.unlockedRecipes.includes(r.id)
    );

    if (availableRecipes.length === 0) {
      el.innerHTML = '<div class="empty-state">Zat√≠m ≈æ√°dn√© recepty...</div>';
      return;
    }

    availableRecipes.forEach(recipe => {
      const canCraft = this.hasMaterials(recipe.materials) && 
                       this.hasTools(recipe.requires);

      const card = document.createElement('div');
      card.className = `recipe-card ${canCraft ? 'can-craft' : 'cannot-craft'}`;

      const mats = Object.entries(recipe.materials)
        .map(([id, needed]) => {
          const have = this.state.inventory[id] || 0;
          const item = this.items[id];
          return `${item.icon} ${have}/${needed}`;
        })
        .join(' ‚Ä¢ ');

      let requiresText = '';
      if (recipe.requires) {
        requiresText = ' | Vy≈æaduje: ' + Object.keys(recipe.requires)
          .map(id => this.items[id].icon)
          .join(' ');
      }

      card.innerHTML = `
        <div class="recipe-header">
          <div class="recipe-icon">${recipe.icon}</div>
          <div class="recipe-name">${recipe.name}</div>
        </div>
        <div class="recipe-materials">${mats}${requiresText}</div>
      `;

      if (canCraft) {
        card.onclick = () => this.craft(recipe.id);
      }

      el.appendChild(card);
    });
  },

  renderEntities() {
    const section = document.getElementById('entities-section');
    const el = document.getElementById('entities');

    if (this.state.entities.length === 0) {
      section.style.display = 'none';
      return;
    }

    section.style.display = 'block';
    el.innerHTML = '';

    this.state.entities.forEach(entity => {
      const type = this.entityTypes.find(t => t.id === entity.type);
      
      const card = document.createElement('div');
      card.className = 'entity-card';

      let statusText = 'Neƒçinn√Ω';
      if (entity.status === 'working') {
        statusText = `${entity.action.name} (${entity.daysLeft} dn√≠)`;
      }

      card.innerHTML = `
        <div class="entity-header">
          <div class="entity-icon">${entity.icon}</div>
          <div class="entity-info">
            <div class="entity-name">${entity.name}</div>
            <div class="entity-status">${statusText}</div>
          </div>
        </div>
      `;

      if (entity.status === 'idle') {
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'entity-actions';

        type.actions.forEach((action, index) => {
          const canDo = this.hasTools(action.requires);
          const btn = document.createElement('button');
          btn.className = 'entity-action-btn';
          btn.textContent = action.name;
          btn.disabled = !canDo;
          btn.onclick = () => this.assignAction(entity.id, index);
          actionsDiv.appendChild(btn);
        });

        card.appendChild(actionsDiv);
      }

      el.appendChild(card);
    });
  },

  render() {
    document.getElementById('day').textContent = this.state.day;
    const season = this.seasons[this.state.season];
    document.getElementById('season').textContent = season.name;

    const effectivePopulation = Math.max(0, this.state.entities.length - 1);
    const populationMultiplier = 1 + (effectivePopulation * 0.4);
    const tempEffects = this.getTemperatureEffects();

    const hungerNeeded = Math.ceil(season.hungerDrain * populationMultiplier * tempEffects.hungerMultiplier);
    const waterNeeded = Math.ceil(season.waterDrain * populationMultiplier * tempEffects.waterMultiplier);
    
    const foodHave = this.state.inventory.food || 0;
    const waterHave = this.state.inventory.water_supply || 0;
    
    const foodDays = hungerNeeded > 0 ? Math.floor(foodHave / hungerNeeded) : 0;
    const waterDays = waterNeeded > 0 ? Math.floor(waterHave / waterNeeded) : 0;
    
    const hungerPercent = Math.min(100, (foodDays / 20) * 100);
    const waterPercent = Math.min(100, (waterDays / 20) * 100);

    document.getElementById('hunger-fill').style.width = hungerPercent + '%';
    document.getElementById('hunger-fill').textContent = `${foodHave} (${foodDays}d)`;

    document.getElementById('water-fill').style.width = waterPercent + '%';
    document.getElementById('water-fill').textContent = `${waterHave} (${waterDays}d)`;

    const temp = this.state.temperature;
    const tempEmoji = this.getTemperatureEmoji(temp);
    document.getElementById('temp-emoji').textContent = tempEmoji;
    
    const tempPercent = Math.max(0, Math.min(100, ((temp + 10) / 50) * 100));
    document.getElementById('temp-fill').style.width = tempPercent + '%';
    
    let tempText = `${temp}¬∞C`;
    if (this.state.heating > 0) {
      tempText += ` üî•√ó${this.state.heating}`;
    }
    if (this.state.shelterLevel > 1) {
      tempText += ` üß±√ó${Math.round((this.state.shelterLevel - 1) * 2)}`;
    }
    document.getElementById('temp-fill').textContent = tempText;

    this.renderInventory();
    this.renderRecipes();
    this.renderEntities();

    this.autoUnlockRecipes();
    this.updateFireIndicator();
    document.getElementById('gold-amount').textContent = this.state.gold;
  },

  autoUnlockRecipes() {
    let unlocked = false;
    
    this.recipes.forEach(recipe => {
      if (this.state.unlockedRecipes.includes(recipe.id)) return;
      
      const hasSomeMaterials = Object.keys(recipe.materials).some(
        matId => (this.state.inventory[matId] || 0) > 0
      );

      if (hasSomeMaterials && recipe.tier <= 2) {
        this.state.unlockedRecipes.push(recipe.id);
        unlocked = true;
      }

      if (recipe.tier >= 3 && recipe.requires) {
        if (this.hasTools(recipe.requires)) {
          this.state.unlockedRecipes.push(recipe.id);
          unlocked = true;
        }
      }
      
      if (recipe.tier >= 3 && !recipe.requires && hasSomeMaterials) {
        this.state.unlockedRecipes.push(recipe.id);
        unlocked = true;
      }
    });

    if (unlocked) {
      this.renderRecipes();
    }
  }
};

window.onload = () => game.init();
</script>
</body>
</html>

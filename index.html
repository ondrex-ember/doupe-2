<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <!-- SEO Meta Tags -->
<title>ğŸ  DoupÄ› 2 - Survival Crafting</title>
<meta name="description" content="Ondrex's Ember Nidus - Doupe. Survival crafting game with real world assets features">
<meta name="keywords" content="doupe, doupÄ›, survival crafting game, ondrex, ondrex ember">
<meta name="author" content="Ondrex Ember">
<meta name="robots" content="index, follow">
<link rel="canonical" href="https://ondrex-ember.github.io/doupe-2/">

<link rel="icon" href="favicon.ico">
  
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-SZJL9L81VE"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-SZJL9L81VE');
</script>
<!-- Google Analytics -->
<!-- 
  âš ï¸ CLIENT-SIDE GA4 NEFUNGUJE V APPS SCRIPT (iframe + cross-origin issues)
  PouÅ¾Ã­vÃ¡me SERVER-SIDE tracking pÅ™es Measurement Protocol API
  viz kod.gs -> trackEvent() funkce
-->
<!-- End Google Analytics -->

<script type="text/javascript">
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "vct90i7r4t");
</script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600;700&family=Space+Mono:wght@400;700&display=swap');

* { 
  box-sizing: border-box; 
  margin: 0; 
  padding: 0; 
  -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
  -webkit-touch-callout: none;
}

html {
  /* Prevent iOS zoom on input focus */
  -webkit-text-size-adjust: 100%;
  text-size-adjust: 100%;
  /* Smooth scrolling for better UX */
  scroll-behavior: smooth;
  /* iOS safe area support */
  padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
}

body {
  margin: 0;
  background: linear-gradient(135deg, #1a1410 0%, #2d2416 50%, #1a1410 100%);
  font-family: 'Crimson Pro', serif;
  color: #e8d5b7;
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  min-height: -webkit-fill-available; /* iOS Safari fix */
  padding: 20px;
  position: relative;
  overflow-x: hidden;
  /* Better touch scrolling on iOS */
  -webkit-overflow-scrolling: touch;
  /* Prevent pull-to-refresh on mobile */
  overscroll-behavior-y: contain;
}

/* Prevent body scroll when modal is open */
body.modal-open {
  overflow: hidden;
  position: fixed;
  width: 100%;
  height: 100%;
}

@media (max-width: 768px) {
  body {
    padding: 10px 5px;
    align-items: flex-start;
    padding-top: 20px;
  }
}

body::before {
  content: '';
  position: fixed;
  inset: 0;
  background: 
    radial-gradient(circle at 20% 30%, rgba(139, 90, 43, 0.1) 0%, transparent 50%),
    radial-gradient(circle at 80% 70%, rgba(87, 62, 38, 0.1) 0%, transparent 50%);
  pointer-events: none;
  animation: ambientGlow 15s ease-in-out infinite;
}

@keyframes ambientGlow {
  0%, 100% { opacity: 0.5; }
  50% { opacity: 0.8; }
}

/* ğŸ”¥ EMBER LINK STYLING */
a {
  color: #d4a574;
  text-decoration: none;
  transition: all 0.3s ease;
  text-shadow: 0 0 8px rgba(255, 120, 40, 0.3);
  position: relative;
}

a:hover {
  color: #ff9944;
  text-shadow: 0 0 12px rgba(255, 120, 40, 0.8);
  animation: emberLinkGlow 1.5s ease-in-out infinite;
}

a:active {
  color: #ff7828;
}

@keyframes emberLinkGlow {
  0%, 100% { 
    text-shadow: 0 0 12px rgba(255, 120, 40, 0.8);
  }
  50% { 
    text-shadow: 0 0 16px rgba(255, 100, 20, 1);
  }
}

#game-container {
  width: 100%;
  max-width: 1000px;
  background: linear-gradient(145deg, rgba(44, 35, 25, 0.95), rgba(55, 42, 30, 0.95));
  border-radius: 24px;
  padding: 24px;
  box-shadow: 
    0 30px 80px rgba(0, 0, 0, 0.8),
    inset 0 1px 0 rgba(255, 255, 255, 0.05);
  border: 2px solid rgba(139, 90, 43, 0.3);
  position: relative;
  z-index: 1;
  animation: containerAppear 0.6s ease-out;
  /* Better touch handling */
  touch-action: pan-y;
  -webkit-tap-highlight-color: transparent;
}

@media (max-width: 768px) {
  #game-container {
    padding: 16px;
    border-radius: 16px;
    max-width: 100%;
    margin: 0 10px;
    /* Ensure proper touch scrolling */
    -webkit-overflow-scrolling: touch;
  }
}

@keyframes containerAppear {
  from {
    opacity: 0;
    transform: translateY(30px) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

#header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 2px solid rgba(139, 90, 43, 0.3);
  padding-bottom: 12px;
  margin-bottom: 16px;
}

@media (max-width: 768px) {
  #header {
    flex-wrap: wrap;
    gap: 10px;
  }
  
  #header h2 {
    font-size: 20px !important;
  }
  
  #header h3 {
    font-size: 11px !important;
    order: 3;
    flex-basis: 100%;
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FOOTER - PatiÄka (mirror of header)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

#footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-top: 2px solid rgba(139, 90, 43, 0.3);
  padding-top: 12px;
  margin-top: 16px;
}

@media (max-width: 768px) {
  #footer {
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
    text-align: center;
  }
  
  #footer .footer-info {
    order: 3;
    flex-basis: 100%;
  }
  
  /* ğŸµ Mobile-friendly volume controls */
  #footer #music-toggle-btn {
    padding: 8px 12px !important;
    font-size: 18px !important;
  }
  
  #footer #volume-slider {
    width: 60px !important;
  }
  
  #footer #track-name {
    font-size: 11px !important;
  }
}

.footer-title {
  font-family: 'Space Mono', monospace;
  font-size: 14px;
  color: #d4a574;
  letter-spacing: 1px;
}

@media (max-width: 768px) {
  .footer-title {
    font-size: 13px;
  }
}

.footer-version {
  font-family: 'Crimson Pro', serif;
  font-size: 12px;
  color: #9a8670;
  font-style: italic;
}

@media (max-width: 768px) {
  .footer-version {
    font-size: 11px;
  }
}

.footer-info {
  text-align: right;
  font-family: 'Space Mono', monospace;
  font-size: 11px;
  color: #9a8670;
}

@media (max-width: 768px) {
  .footer-info {
    text-align: center;
    font-size: 10px;
  }
}

.footer-link {
  color: #d4a574;
  text-decoration: none;
  transition: color 0.2s ease;
  cursor: pointer;
}

.footer-link:hover {
  color: #e8c547;
  text-decoration: underline;
}

/* ğŸŒ¤ï¸ WEATHER WIDGET */
.weather-widget {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  margin-top: 8px;
  padding: 6px 12px;
  border-radius: 12px;
  font-size: 12px;
  font-family: 'Space Mono', monospace;
  background: rgba(111, 180, 197, 0.15);
  border: 1px solid rgba(111, 180, 197, 0.3);
  transition: all 0.3s ease;
}

.weather-widget:hover {
  background: rgba(111, 180, 197, 0.25);
  transform: translateY(-1px);
}

.weather-icon {
  font-size: 16px;
  animation: weatherPulse 4s ease-in-out infinite;
}

@keyframes weatherPulse {
  0%, 100% { 
    opacity: 1;
    transform: scale(1);
  }
  50% { 
    opacity: 0.9;
    transform: scale(1.05);
  }
}

.weather-info {
  color: #b89968;
  font-size: 11px;
  font-weight: 600;
}

@media (max-width: 768px) {
  .weather-widget {
    font-size: 11px;
    padding: 5px 10px;
    margin-top: 6px;
  }
  
  .weather-icon {
    font-size: 14px;
  }
  
  .weather-info {
    font-size: 10px;
  }
}

/* Weather mode selector - minimÃ¡lnÃ­ styl */
.weather-mode-selector{display:inline-flex;gap:3px;margin-left:8px;padding:2px 4px;border-radius:6px;background:rgba(139,90,43,0.1);border:1px solid rgba(139,90,43,0.2)}
.weather-mode-btn{padding:3px 6px;border:none;border-radius:4px;background:transparent;color:#9a8670;font-size:16px;cursor:pointer;transition:all .2s;opacity:.5}
.weather-mode-btn:hover{opacity:.8;background:rgba(139,90,43,0.15)}
.weather-mode-btn.active{opacity:1;background:rgba(139,90,43,0.25)}
@media(max-width:768px){.weather-mode-selector{margin-left:4px;padding:2px 3px}.weather-mode-btn{font-size:14px;padding:2px 4px}}

#header h2 {
  font-family: 'Space Mono', monospace;
  font-size: 24px;
  color: #d4a574;
  text-shadow: 0 2px 8px rgba(212, 165, 116, 0.3);
  letter-spacing: 2px;
}

#header h3 {
  font-family: 'Crimson Pro', serif;
  font-size: 14px;
  color: #9a8670;
  font-style: italic;
  display: flex;
  align-items: center;
  gap: 6px;
}

.ember-icon {
  width: 28px;
  height: 28px;
  object-fit: contain;
  filter: drop-shadow(0 0 8px rgba(255, 120, 40, 0.6));
  animation: emberGlow 3s ease-in-out infinite;
}

@keyframes emberGlow {
  0%, 100% { filter: drop-shadow(0 0 8px rgba(255, 120, 40, 0.6)); }
  50% { filter: drop-shadow(0 0 12px rgba(255, 100, 20, 0.9)); }
}

.ember-icon-small {
  display: inline-block;
  font-size: 14px;
  filter: drop-shadow(0 0 6px rgba(255, 120, 40, 0.6));
  animation: emberGlow 3s ease-in-out infinite;
}

@media (max-width: 768px) {
  .ember-icon-small {
    font-size: 13px;
  }
}

#season-info {
  text-align: right;
  font-family: 'Space Mono', monospace;
}

@media (max-width: 768px) {
  #season-info {
    text-align: center;
  }
  
  #season-info .big {
    font-size: 18px !important;
  }
  
  #season-info .small {
    font-size: 11px !important;
  }
}

#season-info .big {
  font-size: 20px;
  font-weight: 700;
  color: #d4a574;
  display: block;
}

#season-info .small {
  font-size: 12px;
  color: #a08060;
  opacity: 0.8;
}
/* ğŸ”¥ FIRE INDICATOR STYLES */
.fire-indicator {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  margin-top: 6px;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 11px;
  font-family: 'Space Mono', monospace;
  transition: all 0.3s ease;
}

.fire-indicator.active {
  background: rgba(255, 120, 40, 0.2);
  border: 1px solid rgba(255, 120, 40, 0.4);
}

.fire-indicator.active .fire-icon {
  animation: fireFlicker 1.5s ease-in-out infinite;
  filter: drop-shadow(0 0 6px rgba(255, 120, 40, 0.8));
}

.fire-indicator.active .fire-status {
  color: #ff9944;
  font-weight: 700;
}

.fire-indicator.inactive {
  background: rgba(60, 50, 40, 0.3);
  border: 1px solid rgba(100, 80, 60, 0.2);
  opacity: 0.5;
}

.fire-indicator.inactive .fire-icon {
  filter: grayscale(100%) brightness(0.7);
}

.fire-indicator.inactive .fire-status {
  color: #6a5d4f;
}

@keyframes fireFlicker {
  0%, 100% { 
    opacity: 1; 
    transform: scale(1);
  }
  50% { 
    opacity: 0.85;
    transform: scale(1.05);
  }
}

@media (max-width: 768px) {
  .fire-indicator {
    font-size: 10px;
    padding: 3px 8px;
  }
}

/* ğŸ’° GOLD DISPLAY STYLES */
.gold-display {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  margin-top: 6px;
  padding: 5px 12px;
  border-radius: 12px;
  font-size: 12px;
  font-family: 'Space Mono', monospace;
  background: rgba(212, 165, 116, 0.15);
  border: 1px solid rgba(212, 165, 116, 0.4);
  transition: all 0.3s ease;
}

.gold-display:hover {
  background: rgba(212, 165, 116, 0.25);
  transform: translateY(-1px);
}

.gold-icon {
  font-size: 14px;
  animation: goldShine 3s ease-in-out infinite;
}

@keyframes goldShine {
  0%, 100% { 
    filter: drop-shadow(0 0 4px rgba(255, 215, 0, 0.6));
  }
  50% { 
    filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.9));
  }
}

.gold-amount {
  color: #d4a574;
  font-weight: 700;
  font-size: 13px;
}

@media (max-width: 768px) {
  .gold-display {
    font-size: 11px;
    padding: 4px 10px;
  }
  
  .gold-amount {
    font-size: 12px;
  }
}

#status-bars {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 12px;
  margin: 16px 0;
}

@media (max-width: 768px) {
  #status-bars {
    grid-template-columns: 1fr;
  }
}

.bar {
  background: rgba(30, 24, 18, 0.6);
  border-radius: 10px;
  padding: 10px 12px;
  border: 1px solid rgba(139, 90, 43, 0.2);
  transition: all 0.3s ease;
}

.bar:hover {
  border-color: rgba(139, 90, 43, 0.4);
  transform: translateY(-2px);
}

.bar-label {
  font-size: 13px;
  margin-bottom: 6px;
  font-weight: 600;
  color: #b89968;
}

@media (max-width: 768px) {
  .bar-label {
    font-size: 14px;
  }
  
  .bar {
    padding: 12px 14px !important;
  }
  
  .fill-container {
    height: 28px !important;
  }
  
  .fill {
    font-size: 13px !important;
  }
}

.fill-container {
  background: rgba(0, 0, 0, 0.3);
  border-radius: 8px;
  height: 24px;
  overflow: hidden;
  position: relative;
  box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.4);
}

.fill {
  height: 100%;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  font-family: 'Space Mono', monospace;
}

.fill::after {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(180deg, rgba(255, 255, 255, 0.2) 0%, transparent 50%);
  border-radius: 6px;
}

.hunger {
  background: linear-gradient(90deg, #c0504d 0%, #e67e7b 100%);
  color: #fff;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
}

.water {
  background: linear-gradient(90deg, #4a90a4 0%, #6fb4c5 100%);
  color: #fff;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
}

.temperature {
  background: linear-gradient(90deg, #4a90e4 0%, #6fb4c5 35%, #7bc876 50%, #e8c547 65%, #e67e7b 100%);
  color: #fff;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
  font-weight: 700;
}

#log {
  background: rgba(20, 16, 12, 0.7);
  border-radius: 12px;
  padding: 12px;
  height: 140px;
  overflow-y: auto;
  margin-bottom: 16px;
  border: 1px solid rgba(139, 90, 43, 0.2);
  font-family: 'Space Mono', monospace;
  font-size: 12px;
  line-height: 1.5;
  box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.5);
  /* Better touch scrolling */
  -webkit-overflow-scrolling: touch;
  overscroll-behavior: contain;
}

@media (max-width: 768px) {
  #log {
    height: 120px;
    font-size: 11px;
    padding: 10px;
    /* Ensure smooth scrolling on touch */
    scroll-behavior: smooth;
  }
}

#log::-webkit-scrollbar {
  width: 8px;
}

#log::-webkit-scrollbar-track {
  background: rgba(0, 0, 0, 0.2);
  border-radius: 4px;
}

#log::-webkit-scrollbar-thumb {
  background: rgba(139, 90, 43, 0.4);
  border-radius: 4px;
}

#log::-webkit-scrollbar-thumb:hover {
  background: rgba(139, 90, 43, 0.6);
}

.log-entry {
  margin-bottom: 6px;
  padding: 3px 6px;
  border-radius: 3px;
  animation: logAppear 0.3s ease-out;
}

@keyframes logAppear {
  from {
    opacity: 0;
    transform: translateX(-10px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

.log-info { color: #b8b0a0; background: rgba(184, 176, 160, 0.05); }
.log-warning { color: #e8c547; background: rgba(232, 197, 71, 0.1); }
.log-danger { color: #e67e7b; background: rgba(230, 126, 123, 0.1); }
.log-item { color: #6fb4c5; background: rgba(111, 180, 197, 0.1); }
.log-success { color: #7bc876; background: rgba(123, 200, 118, 0.1); }

.two-column-layout {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 15px;
  margin-bottom: 15px;
}

.two-column-layout .section {
  margin-bottom: 0;
}

@media (max-width: 768px) {
  .two-column-layout {
    grid-template-columns: 1fr;
  }
}

.section {
  background: rgba(40, 32, 24, 0.5);
  border-radius: 12px;
  padding: 12px;
  margin-bottom: 15px;
  border: 1px solid rgba(139, 90, 43, 0.2);
}

.section-title {
  font-size: 16px;
  font-weight: 700;
  color: #d4a574;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 6px;
}

@media (max-width: 768px) {
  .section-title {
    font-size: 17px;
  }
  
  .section {
    padding: 14px !important;
  }
}

.section-title .icon {
  font-size: 18px;
}

.section-content {
  display: grid;
  gap: 6px;
}

/* Crafting recipes: 3-column tile layout */
#recipes {
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
}

@media (max-width: 1024px) {
  #recipes {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (max-width: 768px) {
  #recipes {
    /* ğŸ¨ MOBILE: 3 dlaÅ¾dice vedle sebe mÃ­sto 1 sloupce */
    grid-template-columns: repeat(3, 1fr);
    gap: 8px; /* MenÅ¡Ã­ mezery na mobilu */
  }
}

/* ğŸ“± EXTRA SMALL: Pro velmi malÃ© displeje (iPhone SE, atd.) */
@media (max-width: 375px) {
  #recipes {
    grid-template-columns: repeat(2, 1fr); /* 2 sloupce na mini displejÃ­ch */
    gap: 6px;
  }
}

.item-card {
  display: flex;
  align-items: center;
  gap: 10px;
  background: rgba(20, 16, 12, 0.6);
  padding: 10px 12px;
  border-radius: 8px;
  border: 1px solid rgba(139, 90, 43, 0.15);
  transition: all 0.2s ease;
  animation: itemAppear 0.4s ease-out;
}

@media (max-width: 768px) {
  .item-card {
    padding: 12px 14px;
    gap: 12px;
  }
  
  .item-icon {
    font-size: 28px !important;
  }
  
  .item-name {
    font-size: 15px !important;
  }
  
  .item-count {
    font-size: 16px !important;
  }
}

@keyframes itemAppear {
  from {
    opacity: 0;
    transform: scale(0.95);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

.item-card:hover {
  border-color: rgba(139, 90, 43, 0.4);
  transform: translateX(4px);
  background: rgba(30, 24, 18, 0.7);
}

.item-icon {
  font-size: 24px;
  line-height: 1;
  flex-shrink: 0;
}

.item-details {
  flex: 1;
  min-width: 0;
}

.item-name {
  font-weight: 700;
  font-size: 14px;
  color: #d4a574;
  margin-bottom: 2px;
}

.item-desc {
  font-size: 11px;
  color: #9a8670;
  font-style: italic;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.item-count {
  font-weight: 700;
  font-size: 15px;
  color: #b89968;
  font-family: 'Space Mono', monospace;
  margin-left: auto;
  flex-shrink: 0;
}

/* ğŸ’° ECONOMY: Sell & Buy Buttons */
.item-action-btn {
  padding: 5px 10px;
  font-size: 11px;
  font-weight: 700;
  font-family: 'Space Mono', monospace;
  border: none;
  border-radius: 6px;
  margin-left: 8px;
  transition: all 0.2s ease;
  cursor: pointer;
  flex-shrink: 0;
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
}

.item-sell-btn {
  background: linear-gradient(135deg, #d4a574, #c9a576);
  color: #1a1410;
  border: 1px solid rgba(212, 165, 116, 0.6);
  box-shadow: 0 2px 4px rgba(212, 165, 116, 0.3);
}

.item-sell-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(212, 165, 116, 0.5);
}

.item-sell-btn:active {
  transform: translateY(0);
  opacity: 0.8;
}

.item-buy-btn {
  background: linear-gradient(135deg, #7bc876, #6fb865);
  color: #fff;
  border: 1px solid rgba(123, 200, 118, 0.6);
  box-shadow: 0 2px 4px rgba(123, 200, 118, 0.3);
}

.item-buy-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(123, 200, 118, 0.5);
}

.item-buy-btn:active {
  transform: translateY(0);
  opacity: 0.8;
}

.item-action-btn:disabled {
  opacity: 0.3;
  cursor: not-allowed;
  transform: none;
}

.item-action-btn .price-tag {
  font-size: 10px;
  opacity: 0.9;
}

@media (max-width: 768px) {
  .item-action-btn {
    padding: 6px 12px;
    font-size: 12px;
    min-height: 32px;
  }
}

.recipe-card {
  background: rgba(20, 16, 12, 0.6);
  padding: 12px;
  border-radius: 10px;
  border: 1px solid rgba(139, 90, 43, 0.15);
  transition: all 0.2s ease;
  cursor: pointer;
  min-height: 90px;
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  justify-content: space-between;
}

@media (max-width: 768px) {
  .recipe-card {
    padding: 8px 6px; /* KompaktnÄ›jÅ¡Ã­ padding */
    min-height: 90px; /* Zachovat min vÃ½Å¡ku */
    font-size: 11px; /* MenÅ¡Ã­ text */
  }
  
  .recipe-icon {
    font-size: 24px !important; /* VÄ›tÅ¡Ã­ ikona pro lepÅ¡Ã­ Äitelnost */
  }
  
  .recipe-name {
    font-size: 11px !important; /* MenÅ¡Ã­ nÃ¡zev */
    line-height: 1.2;
  }
  
  .recipe-materials {
    font-size: 9px !important; /* MenÅ¡Ã­ materiÃ¡ly */
    line-height: 1.3;
  }
}

.recipe-card.can-craft {
  border-color: rgba(123, 200, 118, 0.4);
}

.recipe-card.can-craft:hover {
  border-color: rgba(123, 200, 118, 0.6);
  transform: translateY(-3px) scale(1.02);
  background: rgba(123, 200, 118, 0.1);
  box-shadow: 0 6px 12px rgba(123, 200, 118, 0.2);
}

.recipe-card.cannot-craft {
  opacity: 0.4;
  cursor: default;
}

.recipe-header {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 6px;
  margin-bottom: 6px;
}

.recipe-icon {
  font-size: 24px;
  flex-shrink: 0;
}

.recipe-name {
  font-weight: 700;
  font-size: 13px;
  color: #d4a574;
}

.recipe-materials {
  font-size: 10px;
  color: #9a8670;
  font-family: 'Space Mono', monospace;
  padding: 0;
  margin-top: auto;
}

.entity-card {
  background: rgba(20, 16, 12, 0.6);
  padding: 12px;
  border-radius: 8px;
  border: 1px solid rgba(139, 90, 43, 0.15);
  animation: entityAppear 0.5s ease-out;
}

@keyframes entityAppear {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.entity-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 8px;
}

.entity-icon {
  font-size: 28px;
  flex-shrink: 0;
}

.entity-info {
  flex: 1;
  min-width: 0;
}

.entity-name {
  font-weight: 700;
  font-size: 15px;
  color: #d4a574;
}

.entity-status {
  font-size: 11px;
  color: #9a8670;
  font-family: 'Space Mono', monospace;
}

.entity-actions {
  display: flex;
  gap: 6px;
  margin-top: 8px;
}

.entity-action-btn {
  flex: 1;
  padding: 5px 10px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 11px;
  font-family: 'Space Mono', monospace;
  font-weight: 700;
  transition: all 0.2s ease;
  background: rgba(139, 90, 43, 0.3);
  color: #d4a574;
  border: 1px solid rgba(139, 90, 43, 0.4);
}

@media (max-width: 768px) {
  .entity-action-btn {
    padding: 10px 12px;
    font-size: 12px;
    min-height: 42px;
  }
  
  .entity-actions {
    flex-wrap: wrap;
    gap: 8px !important;
  }
  
  .entity-action-btn {
    flex: 1 1 calc(50% - 4px);
    min-width: 120px;
  }
}

.entity-action-btn:hover {
  background: rgba(139, 90, 43, 0.5);
  transform: translateY(-2px);
}

.entity-action-btn:disabled {
  opacity: 0.3;
  cursor: not-allowed;
  transform: none;
}

.controls {
  display: flex;
  gap: 12px;
  justify-content: center;
  margin-top: 15px;
  flex-wrap: wrap;
}

@media (max-width: 768px) {
  .controls {
    gap: 8px;
  }
  
  .controls button {
    flex: 1 1 auto;
    min-width: 140px;
  }
}

button {
  padding: 12px 22px;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 700;
  font-family: 'Space Mono', monospace;
  transition: all 0.2s ease;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  /* Better touch handling */
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
  user-select: none;
  -webkit-user-select: none;
}

@media (max-width: 768px) {
  button {
    padding: 14px 20px;
    font-size: 15px;
    min-height: 48px;
    /* Increase touch target size */
    min-width: 48px;
  }
}

button:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
}

button:active {
  transform: translateY(-1px);
  /* Visual feedback on touch */
  opacity: 0.8;
}

.primary {
  background: linear-gradient(135deg, #8b5a2b 0%, #a67c52 100%);
  color: #fff;
  border: 1px solid rgba(212, 165, 116, 0.3);
}

.primary:hover {
  background: linear-gradient(135deg, #a67c52 0%, #c9a576 100%);
}

.danger {
  background: linear-gradient(135deg, #c0504d 0%, #e67e7b 100%);
  color: #fff;
  border: 1px solid rgba(230, 126, 123, 0.3);
}

.danger:hover {
  background: linear-gradient(135deg, #e67e7b 0%, #f29b98 100%);
}

.event-notification {
  position: fixed;
  top: 20px;
  right: 20px;
  background: linear-gradient(135deg, rgba(139, 90, 43, 0.95), rgba(166, 124, 82, 0.95));
  border-radius: 12px;
  padding: 16px 20px;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
  border: 2px solid rgba(212, 165, 116, 0.4);
  animation: slideIn 0.5s ease-out;
  z-index: 1000;
  max-width: 300px;
  font-family: 'Space Mono', monospace;
  font-size: 14px;
  color: #fff;
}

@media (max-width: 768px) {
  .event-notification {
    top: 10px;
    right: 10px;
    left: 10px;
    max-width: none;
    font-size: 13px;
    padding: 12px 16px;
  }
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateX(100%);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

.empty-state {
  text-align: center;
  padding: 15px;
  color: #6a5d4f;
  font-style: italic;
  font-size: 13px;
}

.season-indicator {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 700;
  margin-left: 8px;
}

.season-spring { background: rgba(123, 200, 118, 0.2); color: #7bc876; }
.season-summer { background: rgba(232, 197, 71, 0.2); color: #e8c547; }
.season-autumn { background: rgba(212, 165, 116, 0.2); color: #d4a574; }
.season-winter { background: rgba(111, 180, 197, 0.2); color: #6fb4c5; }

/* Leaderboard & Nickname Modals */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.9);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  animation: fadeIn 0.3s ease-out;
  /* Prevent scroll behind modal */
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  /* Prevent body scroll leak */
  overscroll-behavior: contain;
}

.modal-content {
  background: linear-gradient(145deg, #2c231a, #372a1e);
  border-radius: 20px;
  padding: 30px;
  max-width: 600px;
  width: 90%;
  border: 2px solid rgba(139, 90, 43, 0.4);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.9);
  animation: scaleIn 0.4s ease-out;
  max-height: 90vh;
  overflow-y: auto;
  /* Better scrolling on touch devices */
  -webkit-overflow-scrolling: touch;
  /* Prevent margin collapse */
  position: relative;
}

@media (max-width: 768px) {
  .modal-content {
    padding: 20px;
    width: 95%;
    border-radius: 16px;
  }
  
  .modal-title {
    font-size: 22px !important;
  }
  
  .leaderboard-table {
    font-size: 13px !important;
  }
  
  .leaderboard-table th,
  .leaderboard-table td {
    padding: 8px 6px !important;
  }
  
  .rank-badge {
    width: 26px !important;
    height: 26px !important;
    line-height: 26px !important;
    font-size: 12px !important;
  }
  
  .modal-btn {
    padding: 12px 18px !important;
    font-size: 13px !important;
  }
  
  .nickname-input {
    font-size: 15px !important;
  }
}

.modal-title {
  font-family: 'Space Mono', monospace;
  font-size: 28px;
  color: #d4a574;
  text-align: center;
  margin-bottom: 20px;
  text-shadow: 0 2px 8px rgba(212, 165, 116, 0.3);
}

.nickname-input {
  width: 100%;
  padding: 12px 16px;
  font-size: 16px; /* iOS needs 16px+ to prevent auto-zoom */
  font-family: 'Crimson Pro', serif;
  background: rgba(20, 16, 12, 0.8);
  border: 2px solid rgba(139, 90, 43, 0.3);
  border-radius: 10px;
  color: #e8d5b7;
  margin: 15px 0;
  transition: border-color 0.2s;
}

.nickname-input:focus {
  outline: none;
  border-color: rgba(139, 90, 43, 0.6);
}

.nickname-info {
  text-align: center;
  color: #b89968;
  font-size: 14px;
  margin: 10px 0;
}

.leaderboard-table {
  width: 100%;
  border-collapse: collapse;
  margin: 20px 0;
}

.leaderboard-table th {
  background: rgba(139, 90, 43, 0.2);
  padding: 12px;
  text-align: left;
  font-family: 'Space Mono', monospace;
  font-size: 13px;
  color: #d4a574;
  border-bottom: 2px solid rgba(139, 90, 43, 0.3);
}

.leaderboard-table td {
  padding: 10px 12px;
  border-bottom: 1px solid rgba(139, 90, 43, 0.1);
  font-size: 14px;
}

.leaderboard-table tr:hover {
  background: rgba(139, 90, 43, 0.1);
}

.rank-badge {
  display: inline-block;
  width: 30px;
  height: 30px;
  line-height: 30px;
  text-align: center;
  border-radius: 50%;
  font-weight: 700;
  font-family: 'Space Mono', monospace;
}

.rank-1 { background: linear-gradient(135deg, #FFD700, #FFA500); color: #000; }
.rank-2 { background: linear-gradient(135deg, #C0C0C0, #808080); color: #000; }
.rank-3 { background: linear-gradient(135deg, #CD7F32, #8B4513); color: #fff; }
.rank-other { background: rgba(139, 90, 43, 0.2); color: #b89968; }

.modal-buttons {
  display: flex;
  gap: 12px;
  justify-content: center;
  margin-top: 20px;
}

.modal-btn {
  padding: 12px 24px;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 700;
  font-family: 'Space Mono', monospace;
  transition: all 0.2s ease;
}

.modal-btn-primary {
  background: linear-gradient(135deg, #8b5a2b, #a67c52);
  color: #fff;
  border: 1px solid rgba(212, 165, 116, 0.3);
}

.modal-btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
}
.modal-btn-secondary {
  background: rgba(139, 90, 43, 0.2);
  color: #d4a574;
  border: 1px solid rgba(139, 90, 43, 0.3);
}

.modal-btn-secondary:hover {
  background: rgba(139, 90, 43, 0.3);
}

.your-rank {
  background: rgba(123, 200, 118, 0.2) !important;
  border-left: 3px solid #7bc876;
}
/* Music toggle button styles */
#music-toggle {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 10000;
}

/* ğŸµ Scroll animation for track name */
@keyframes scrollText {
  0% { transform: translateX(0); }
  100% { transform: translateX(-50%); }
}

</style>
</head>

<body>
<div id="game-container">

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       âš ï¸ CRITICAL SECTION - HEADER
       HlaviÄka s nÃ¡zvem, sezÃ³nou, fire indicator a gold display
       Required: day, season, fire-indicator, gold-display
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="header">
    <h1>ğŸ  DOUPÄš</h1>
    <h3></h3>
    <div id="season-info">
      <span class="big">Den <span id="day">1</span></span>
      <span class="small"><span id="season">Jaro</span></span>
      <!-- Weather mode selector -->
      <span class="weather-mode-selector">
        <button class="weather-mode-btn active" data-mode="game" onclick="game.setWeatherMode('game')" title="Hra">ğŸ®</button>
        <button class="weather-mode-btn" data-mode="openmeteo" onclick="game.setWeatherMode('openmeteo')" title="Open-Meteo">ğŸŒ</button>
        <button class="weather-mode-btn" data-mode="weatherxm" onclick="game.setWeatherMode('weatherxm')" title="WeatherXM">ğŸ“¡</button>
      </span>
      <!-- ğŸ”¥ FIRE INDICATOR -->
      <span class="fire-indicator inactive" id="fire-indicator">
        <span class="fire-icon">ğŸ”¥</span>
        <span class="fire-status">Bez ohnÄ›</span>
      </span>
      <!-- ğŸ’° GOLD DISPLAY -->
      <span class="gold-display" id="gold-display">
        <span class="gold-icon">ğŸ’°</span>
        <span class="gold-amount" id="gold-amount">0</span>
      </span>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       âš ï¸ CRITICAL SECTION - STATUS BARS
       ZÃ¡soby jÃ­dla, vody a teplota - CORE gameplay mechanic
       Required: hunger-fill, water-fill, temp-fill
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="status-bars">
    <div class="bar">
      <div class="bar-label">ğŸ– ZÃ¡soby jÃ­dla</div>
      <div class="fill-container">
        <div class="fill hunger" id="hunger-fill" style="width: 100%;">50 (10d)</div>
      </div>
    </div>
    <div class="bar">
      <div class="bar-label">ğŸ’§ ZÃ¡soby vody</div>
      <div class="fill-container">
        <div class="fill water" id="water-fill" style="width: 100%;">50 (16d)</div>
      </div>
    </div>
    <div class="bar">
      <div class="fill-container">
        <div class="fill temperature" id="temp-fill" style="width: 50%;">15Â°C</div>
      </div>
      <div class="bar-label"><span id="temp-emoji">ğŸŒ¡ï¸</span> Teplota doupÄ›te</div>
    </div>
  </div>

  <div id="log"></div>

  <div class="two-column-layout">
    <div class="section">
      <div class="section-title">
        <span class="icon">ğŸ“¦</span>
        <span>InventÃ¡Å™</span>
      </div>
      <div class="section-content" id="inventory"></div>
    </div>

    <div class="section">
      <div class="section-title">
        <span class="icon">ğŸ”¨</span>
        <span>Crafting recepty</span>
      </div>
      <div class="section-content" id="recipes"></div>
    </div>
  </div>

  <div class="section" id="entities-section" style="display: none;">
    <div class="section-title">
      <span class="icon">ğŸ‘¥</span>
      <span>ObyvatelÃ© doupÄ›te</span>
    </div>
    <div class="section-content" id="entities"></div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       âš ï¸ CRITICAL SECTION - MAIN CONTROLS
       HlavnÃ­ hernÃ­ tlaÄÃ­tka - NESMÃ ZMIZET!
       Required: nextDay, saveGame, showLeaderboard, reset
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="controls">
    <button class="primary" onclick="game.nextDay()">â° DalÅ¡Ã­ den</button>
    <button class="primary" onclick="game.saveGame()">ğŸ’¾ UloÅ¾it hru</button>
    <button class="primary" onclick="game.showLeaderboard()">ğŸ† Å½ebÅ™Ã­Äek</button>
    <button class="danger" onclick="game.reset()">ğŸ”„ NovÃ½ zaÄÃ¡tek</button>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       âš ï¸ CRITICAL SECTION - FOOTER
       PatiÄka s live statistikami a dÅ¯leÅ¾itÃ½mi odkazy
       Required: footer-stats, loadGame, showLeaderboard, showAbout
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="footer">
    <div>
      <span class="footer-title">ğŸ  DOUPÄš v2.12m</span>
      <br>
      <!-- ğŸŒ¤ï¸ WEATHER WIDGET -->
      <span class="weather-widget" id="weather-widget">
        <span class="weather-icon">ğŸŒ¤ï¸</span>
        <span class="weather-info">NaÄÃ­tÃ¡m poÄasÃ­...</span>
      </span>
      <p></p>
      <span class="footer-version"> â€¢ by Ondrex's <a href="https://www.ember-pa.cz">Ember<span class="ember-icon-small">ğŸ”¥</span></a></span>
      <br>
      <span class="footer-version"><a href="https://ondrex-ember.github.io/tech-1000-piv/"> â€¢ TÄ›ch 1000 piv ğŸº s Ondrexem</a></span>
      
      <!-- ğŸµ SOUND CONTROL -->
      <div style="display: flex; align-items: center; gap: 10px; margin: 10px 0;">
        <button id="music-toggle-btn" 
          onclick="if(window.atmosphericMusic) atmosphericMusic.toggle()"
          style="
            background: rgba(139, 90, 43, 0.3);
            border: 1px solid rgba(212, 165, 116, 0.4);
            color: #d4a574;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
          "
          onmouseover="this.style.background='rgba(139, 90, 43, 0.5)'"
          onmouseout="this.style.background='rgba(139, 90, 43, 0.3)'"
        >
          ğŸ”Š
        </button>
        
        <div style="
          flex: 1;
          overflow: hidden;
          background: rgba(40, 32, 24, 0.4);
          border-radius: 6px;
          padding: 6px 10px;
          border: 1px solid rgba(139, 90, 43, 0.3);
          min-width: 150px;
          max-width: 300px;
        ">
          <div id="track-name" style="
            color: #d4a574;
            font-size: 12px;
            white-space: nowrap;
            animation: scrollText 15s linear infinite;
          ">
            ğŸµ ZatÃ­m ticho...
          </div>
        </div>
        
        <input 
          type="range" 
          id="volume-slider"
          min="0" 
          max="100" 
          value="30"
          oninput="if(window.atmosphericMusic) atmosphericMusic.setVolume(this.value)"
          style="
            width: 80px;
            accent-color: #d4a574;
          "
        >
        <span id="volume-label" style="color: #9a8670; font-size: 12px; min-width: 35px;">30%</span>
      </div>
    </div>
    <div class="footer-info">
      <span id="footer-stats">Kolonie: 1 ğŸ‘¥ | Rekord: <span id="footer-best-run">0</span>d</span>
      <br>
      <span class="footer-link" onclick="game.loadGame()">ğŸ“‚ NaÄÃ­st</span>
      <span style="opacity: 0.5;"> â€¢ </span>
      <span class="footer-link" onclick="game.showLeaderboard()">ğŸ“Š Å½ebÅ™Ã­Äek</span>
      <span style="opacity: 0.5;"> â€¢ </span>
      <span class="footer-link" onclick="game.showAbout()">â„¹ï¸ O hÅ™e</span>
    </div>
  </div>

</div>

<script>
var game = {

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // âš ï¸ CRITICAL FUNCTION - MODAL MANAGEMENT
  // VÅ¡echny modal funkce MUSÃ volat openModal() a closeModal()!
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  /**
   * ğŸ”’ OPEN MODAL
   * 
   * Zamkne body scroll a uloÅ¾Ã­ pozici scrollu.
   * âš ï¸ MUSÃ bÃ½t volÃ¡no pÅ™ed zobrazenÃ­m kaÅ¾dÃ©ho modalu!
   * 
   * @returns {void}
   * @sideeffects Adds 'modal-open' class, locks scroll, stores scroll position
   * 
   * @example
   * game.openModal(); // VÅ¾dy prvnÃ­ Å™Ã¡dek v show*Modal() funkci
   * 
   * @see closeModal() - Pro odemknutÃ­ scrollu
   */
  openModal: function() {
    // Lock body scroll when modal opens
    document.body.classList.add('modal-open');
    // Store scroll position
    this._scrollY = window.scrollY;
    document.body.style.top = '-' + (this._scrollY) + 'px';
  },

  /**
   * ğŸ”“ CLOSE MODAL
   * 
   * OdstranÃ­ modal z DOM a odemkne body scroll.
   * âš ï¸ MUSÃ bÃ½t volÃ¡no pÅ™i zavÃ­rÃ¡nÃ­ kaÅ¾dÃ©ho modalu!
   * 
   * @param {string} modalId - ID modalu k odstranÄ›nÃ­ (bez #)
   * @returns {void}
   * @sideeffects Removes modal, unlocks scroll, restores scroll position
   * 
   * @example
   * game.closeModal('leaderboard-modal');
   * 
   * @see openModal() - Pro zamknutÃ­ scrollu
   */
  closeModal: function(modalId) {
    // Remove modal
    var modal = document.getElementById(modalId);
    if (modal) modal.remove();
    
    // Unlock body scroll
    document.body.classList.remove('modal-open');
    document.body.style.top = '';
    
    // Restore scroll position
    if (this._scrollY !== undefined) {
      window.scrollTo(0, this._scrollY);
      this._scrollY = undefined;
    }
  },

  // ğŸŒ HYBRID BACKEND ADAPTER
  // Automatically detects environment and uses appropriate backend method
  
  // âš ï¸ IMPORTANT: Replace with your actual Apps Script Web App URL
  BACKEND_API_URL: 'https://script.google.com/macros/s/AKfycbwWqpMUKiT6iS6NwVYP7GM2MBD1IqCMhLToAhVVPtsl2IIvuk6IoHuFlzlTtVVY551v/exec',
  
  isAppsScript: function() {
    // Check if we're running in Apps Script environment
    return typeof google !== 'undefined' && 
           google.script && 
           google.script.run;
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ”§ UPDATED BACKEND FUNCTION - PouÅ¾ij GET mÃ­sto POST (CORS fix)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Najdi v index.html funkci backend() (cca Å™Ã¡dek 1360)
// a NAHRAÄ JI tÃ­mto:

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ”§ UPDATED BACKEND FUNCTION - JSONP pro CORS fix
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// V index.html najdi funkci backend() a NAHRAÄ JI celou tÃ­mto:

backend: function(functionName, data) {
  data = data || null;
  // Apps Script environment - use google.script.run (direct)
  if (this.isAppsScript()) {
    return new Promise(function(resolve, reject) {
      try {
        var runner = google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject);
        
        if (data !== null) {
          runner[functionName](data);
        } else {
          runner[functionName]();
        }
      } catch(error) {
        reject(error);
      }
    });
  }
  
  // GitHub environment - USE JSONP (CORS workaround)
  return new Promise(function(resolve, reject) {
    try {
      console.log('ğŸŒ JSONP call: ' + (functionName) + '', data ? 'with data' : 'no data');
      
      // Timeout pro detekci zatuhlÃ©ho volÃ¡nÃ­
      var timeout = setTimeout(function() {
        console.error('â±ï¸ JSONP timeout after 30s: ' + (functionName) + '');
        cleanup();
        reject(new Error('API timeout after 30s: ' + (functionName) + ''));
      }, 30000); // 30s timeout
      
      // Generate unique callback name
      var callbackName = 'jsonp_callback_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      
      var script;
      
      var cleanup = function() {
        clearTimeout(timeout);
        if (window[callbackName]) {
          delete window[callbackName];
        }
        if (script && script.parentNode) {
          document.body.removeChild(script);
        }
      };
      
      // Create global callback function
      window[callbackName] = function(response) {
        console.log('âœ… JSONP response from ' + (functionName) + ':', response);
        cleanup();
        resolve(response);
      };
      
      // Build URL with params
      var params = new URLSearchParams({
        action: functionName,
        data: JSON.stringify(data || {}),
        callback: callbackName
      });
      
      var url = '' + (this.BACKEND_API_URL) + '?' + (params) + '';
      console.log('ğŸ“¡ JSONP URL:', url.substring(0, 150) + '...');
      
      // Create script tag for JSONP
      script = document.createElement('script');
      script.src = url;
      script.onerror = function(e) {
        console.error('âŒ JSONP script load failed: ' + (functionName) + '', e);
        cleanup();
        
        // Return mock success for non-critical functions
        if (functionName === 'trackEvent') {
          resolve({ success: true, message: 'Tracking skipped (API unavailable)' });
        } else if (functionName === 'logTransaction') {
          resolve({ success: true, message: 'Transaction logging skipped (API unavailable)' });
        } else {
          reject(new Error('JSONP script load failed: ' + (functionName) + ''));
        }
      };
      
      // Add script to page
      document.body.appendChild(script);
      
    } catch(error) {
      console.error('âŒ JSONP call exception:', error);
      reject(error);
    }
  });
},
  state: {
    day: 1,
    season: 0,
    dead: false,
    inventory: {},
    entities: [],
    unlockedRecipes: [],
    eventChance: 0.5,
    temperature: 15,
    shelterLevel: 1,
    heating: 0,
    guaranteedStones: 0,
    playerId: null,
    playerNickname: null,
    bestRun: 0,
    // ğŸ”¥ FIRE SYSTEM
    fireActive: false,
    fireFuel: 0,
    // ğŸ’° ECONOMY SYSTEM
    gold: 0,
    // ğŸŒ¤ï¸ WEATHER MODE
    weatherMode: 'game',
    weatherData: null,
    lastWeatherFetch: 0
  },

  seasons: [
    { 
      name: 'Jaro', 
      hungerDrain: 4, 
      waterDrain: 3,
      baseTemp: 15,
      tempVariance: 5,
      icon: 'ğŸŒ±',
      desc: 'ÄŒas rÅ¯stu a sbÄ›ru. VÃ­c materiÃ¡lÅ¯, mÃ©nÄ› jÃ­dla.'
    },
    { 
      name: 'LÃ©to', 
      hungerDrain: 3, 
      waterDrain: 6,
      baseTemp: 26,
      tempVariance: 4,
      icon: 'â˜€ï¸',
      desc: 'Horko a sucho. Voda je vzÃ¡cnÃ¡!'
    },
    { 
      name: 'Podzim', 
      hungerDrain: 6, 
      waterDrain: 4,
      baseTemp: 10,
      tempVariance: 6,
      icon: 'ğŸ‚',
      desc: 'ÄŒas skliznÄ›. PÅ™iprav se na zimu.'
    },
    { 
      name: 'Zima', 
      hungerDrain: 10, 
      waterDrain: 3,
      baseTemp: -5,
      tempVariance: 8,
      icon: 'â„ï¸',
      desc: 'DrsnÃ¡ zima. PÅ™eÅ¾ijeÅ¡ jen s dostatkem zÃ¡sob.'
    }
  ],

  items: {
    // ğŸ’° ECONOMY: sellPrice = co dostanu za prodej, buyPrice = co musÃ­m zaplatit
    wood: { name: 'DÅ™evo', icon: 'ğŸŒ³', desc: 'ZÃ¡kladnÃ­ stavebnÃ­ materiÃ¡l', sellPrice: 2 },
    stone: { name: 'KÃ¡men', icon: 'â›°ï¸', desc: 'TvrdÃ½ materiÃ¡l pro nÃ¡stroje', sellPrice: 3 },
    fiber: { name: 'VlÃ¡kna', icon: 'ğŸŒ¾', desc: 'Pro vÃ½robu provazÅ¯', sellPrice: 1 },
    mushroom: { name: 'Houba', icon: 'ğŸ„', desc: 'JedlÃ¡ nebo nejedlÃ¡', sellPrice: 4 },
    bark: { name: 'KÅ¯ra', icon: 'ğŸŸ«', desc: 'SuchÃ¡ kÅ¯ra na zapÃ¡lenÃ­', sellPrice: 2 },
    stick: { name: 'HÅ¯l', icon: 'ğŸ¦¯', desc: 'UÅ¾iteÄnÃ¡ tyÄ', sellPrice: 4 },
    rope: { name: 'Provaz', icon: 'â°', desc: 'PevnÃ© vlÃ¡kno', sellPrice: 6 },
    trap: { name: 'Past', icon: 'ğŸ€', desc: 'ChytÃ¡ zvÄ›Å™', sellPrice: 15 },
    basket: { name: 'KoÅ¡', icon: 'ğŸ§º', desc: 'Pro sbÄ›r bobulÃ­', sellPrice: 12 },
    knife: { name: 'NÅ¯Å¾', icon: 'ğŸ”ª', desc: 'ZÃ¡kladnÃ­ nÃ¡stroj pro Å™ezÃ¡nÃ­', sellPrice: 30 },
    axe: { name: 'Sekyrka', icon: 'ğŸª“', desc: 'Pro kÃ¡cenÃ­ dÅ™eva', sellPrice: 45 },
    bowl: { name: 'Miska', icon: 'ğŸ¥£', desc: 'NÃ¡doba na vodu', sellPrice: 8 },
    leather: { name: 'KÅ¯Å¾e', icon: 'ğŸ¦º', desc: 'ZpracovanÃ¡ kÅ¯Å¾e', sellPrice: 20 },
    plank: { name: 'Prkno', icon: 'ğŸ“', desc: 'OpracovanÃ© dÅ™evo', sellPrice: 5 },
    bow: { name: 'Luk', icon: 'ğŸ¹', desc: 'Pro lov', sellPrice: 60 },
    seeds: { name: 'Semena', icon: 'ğŸŒ±', desc: 'Pro pÄ›stovÃ¡nÃ­ jÃ­dla', sellPrice: 3 },
    food: { name: 'JÃ­dlo', icon: 'ğŸ–', desc: 'UdrÅ¾uje Å¾ivot', buyPrice: 5 },
    water_supply: { name: 'Voda', icon: 'ğŸ’§', desc: 'UdrÅ¾uje Å¾ivot', buyPrice: 4 },
    storage: { name: 'Sklad', icon: 'ğŸ“¦', desc: 'UchovÃ¡vÃ¡ zÃ¡soby pÅ™es zimu', sellPrice: 50 },
    insulation: { name: 'Izolace', icon: 'ğŸ§±', desc: 'ZlepÅ¡uje tepelnou izolaci', sellPrice: 80 },
    fireplace: { name: 'Krb', icon: 'ğŸ”¥', desc: 'VytÃ¡pÃ­ doupÄ›', sellPrice: 100 },
    dried_meat: { name: 'SuÅ¡enÃ© maso', icon: 'ğŸ¥©', desc: 'VydrÅ¾Ã­ pÅ™es zimu', sellPrice: 25 },
    wall: { name: 'DÅ™evÄ›nÃ¡ hradba', icon: 'ğŸ›¡ï¸', desc: 'ChrÃ¡nÃ­ pÅ™ed Ãºtoky', sellPrice: 120 },
    guard_tower: { name: 'StrÃ¡Å¾nÃ­ vÄ›Å¾', icon: 'ğŸ‘ï¸', desc: 'OdhalÃ­ nepÅ™Ã¡tele', sellPrice: 100 },
    medicine_hut: { name: 'LÃ©kÃ¡rna', icon: 'ğŸ’Š', desc: 'LÃ©ÄÃ­ zranÄ›nÃ­', sellPrice: 80 },
    },

  recipes: [
    // Tier 1 - ZÃ¡klady
    {
      id: 'stick',
      name: 'HÅ¯l',
      icon: 'ğŸ¦¯',
      materials: { wood: 1 },
      result: { stick: 2 },
      tier: 1
    },
    {
      id: 'rope',
      name: 'Provaz',
      icon: 'â°',
      materials: { fiber: 3 },
      result: { rope: 1 },
      tier: 1
    },
    {
      id: 'bowl',
      name: 'Miska',
      icon: 'ğŸ¥£',
      materials: { wood: 2 },
      result: { bowl: 1 },
      tier: 1
    },
    {
      id: 'trap',
      name: 'Past na zvÄ›Å™',
      icon: 'ğŸ€',
      materials: { rope: 2, stick: 3 },
      result: { trap: 1 },
      tier: 1,
      desc: 'ChytÃ¡ malou zvÄ›Å™ pÅ™es noc'
    },
    {
      id: 'basket',
      name: 'SbÄ›racÃ­ koÅ¡',
      icon: 'ğŸ§º',
      materials: { fiber: 5, stick: 2 },
      result: { basket: 1 },
      tier: 1,
      desc: 'Pro sbÄ›r bobulÃ­ a hub'
    },
    
    // Tier 2 - ZÃ¡kladnÃ­ nÃ¡stroje
    {
      id: 'knife',
      name: 'KamennÃ½ nÅ¯Å¾',
      icon: 'ğŸ”ª',
      materials: { stone: 2, stick: 1 },
      result: { knife: 1 },
      tier: 2,
      unlock: 'first_entity'
    },
    {
      id: 'axe',
      name: 'Sekyrka',
      icon: 'ğŸª“',
      materials: { stone: 3, stick: 2, rope: 1 },
      result: { axe: 1 },
      tier: 2,
      unlock: 'first_entity'
    },
    // ğŸ”¥ FIRE SYSTEM - Bow Drill (Tier 2)
    {
      id: 'start_fire_drill',
      name: 'ZaloÅ¾it oheÅˆ (Bow Drill)',
      icon: 'ğŸ”¥',
      materials: { stick: 2, fiber: 3, bark: 1 },
      requires: { bow: 1 },
      tier: 2,
      desc: '80% Å¡ance na ÃºspÄ›ch',
      isFireStarter: true,
      fireChance: 0.8,
      fireMethod: 'bow_drill'
    },

    // Tier 3 - PokroÄilÃ©
    {
      id: 'plank',
      name: 'Prkno',
      icon: 'ğŸ“',
      materials: { wood: 2 },
      result: { plank: 1 },
      requires: { axe: 1 },
      tier: 3
    },
    {
      id: 'leather',
      name: 'KÅ¯Å¾e',
      icon: 'ğŸ¦º',
      materials: { food: 2 },
      result: { leather: 1 },
      requires: { knife: 1 },
      tier: 3
    },
    {
      id: 'bow',
      name: 'Luk',
      icon: 'ğŸ¹',
      materials: { stick: 3, rope: 2 },
      result: { bow: 1 },
      tier: 3,
      unlock: 'hunter_entity'
    },
    // ğŸ”¥ FIRE SYSTEM - KÅ™esadlo (Tier 3)
    {
      id: 'start_fire_flint',
      name: 'ZaloÅ¾it oheÅˆ (KÅ™esadlo)',
      icon: 'âš¡',
      materials: { stone: 3 },
      requires: { knife: 1 },
      tier: 3,
      desc: '100% ÃºspÄ›ch',
      isFireStarter: true,
      fireChance: 0.8,
      fireMethod: 'flint_steel'
    },
    
    // ğŸ”¥ FIRE-BASED CRAFTING
    {
      id: 'dried_meat',
      name: 'SuÅ¡enÃ© maso',
      icon: 'ğŸ¥©',
      materials: { food: 5 },
      requiresFire: true,
      result: { dried_meat: 3 },
      tier: 3,
      desc: 'VydrÅ¾Ã­ pÅ™es zimu, neskazÃ­ se'
    },
    // Tier 4 - Infrastruktura
    {
      id: 'storage',
      name: 'Sklad na zimu',
      icon: 'ğŸ“¦',
      materials: { plank: 5, rope: 3 },
      result: { storage: 1 },
      tier: 4
    },
    {
      id: 'fireplace',
      name: 'Krb',
      icon: 'ğŸ”¥',
      materials: { stone: 8, plank: 3 },
      result: { fireplace: 1 },
      tier: 4,
      desc: 'UmoÅ¾Åˆuje topit dÅ™evem'
    },
    {
      id: 'insulation',
      name: 'TepelnÃ¡ izolace',
      icon: 'ğŸ§±',
      materials: { fiber: 10, plank: 5, leather: 2 },
      result: { insulation: 1 },
      tier: 4,
      desc: 'ZlepÅ¡uje izolaci doupÄ›te'
    },
    {
      id: 'wall',
      name: 'DÅ™evÄ›nÃ¡ hradba',
      icon: 'ğŸ›¡ï¸',
      materials: { plank: 10, stone: 5, rope: 3 },
      result: { wall: 1 },
      tier: 4,
      desc: 'ChrÃ¡nÃ­ kolonii pÅ™ed Ãºtoky'
    },
    {
      id: 'guard_tower',
      name: 'StrÃ¡Å¾nÃ­ vÄ›Å¾',
      icon: 'ğŸ‘ï¸',
      materials: { plank: 8, rope: 4 },
      requires: { bow: 1 },
      result: { guard_tower: 1 },
      tier: 4,
      desc: 'OdhalÃ­ nepÅ™Ã¡tele na dÃ¡lku'
    },
    {
      id: 'medicine_hut',
      name: 'LÃ©kÃ¡rna',
      icon: 'ğŸ’Š',
      materials: { plank: 6, fiber: 12, mushroom: 5 },
      result: { medicine_hut: 1 },
      tier: 4,
      desc: 'LÃ©ÄÃ­ nemoci a zranÄ›nÃ­'
    }
  ],

  // UdÃ¡losti co mÅ¯Å¾ou nastat kaÅ¾dÃ½ den
  randomEvents: [
    {
      id: 'wood_fall',
      chance: 0.4,
      items: { wood: [2, 4] },
      message: 'ğŸŒ³ NÄ›kolik vÄ›tvÃ­ spadlo ze stropu'
    },
    {
      id: 'stone_fall',
      chance: 0.3,
      items: { stone: [1, 3] },
      message: 'â›°ï¸ Kameny se uvolnily ze stÄ›ny'
    },
    {
      id: 'fiber_find',
      chance: 0.35,
      items: { fiber: [3, 5] },
      message: 'ğŸŒ¾ NaÅ¡el jsi svazky vlÃ¡ken'
    },
    {
      id: 'bark_find', // ğŸ”¥ NEW EVENT
      chance: 0.35,
      items: { bark: [2, 6] },
      message: 'ğŸŸ« KÅ¯ra spadla ze stromu'
    },
    {
      id: 'water_drip',
      chance: 0.8,
      items: { water_supply: [6, 12] },
      message: 'ğŸ’§ Voda kape ze stropu do misek'
    },
    {
      id: 'mushroom_find',
      chance: 0.65,
      items: { food: [2, 4] },
      message: 'ğŸ„ NaÅ¡el jsi jedlÃ© houby'
    },
    {
      id: 'seed_find',
      chance: 0.3,
      season: [0], // pouze na jaÅ™e
      items: { seeds: [2, 4] },
      message: 'ğŸŒ± VÃ­tr pÅ™inesl semena'
    },
    {
      id: 'nothing',
      chance: 0.15,
      message: 'â€¦ ticho a prÃ¡zdnota â€¦'
    }
  ],

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ—¡ï¸ ATTACK SYSTEM - PART 1: Attack Events & Defense Items

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ğŸ—¡ï¸ THREATS SYSTEM - Universal Combat Configuration
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  threats: {
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ´â€â˜ ï¸ TIER 3: NÃ¡jezdnÃ­ci (tÄ›Å¾kÃ©)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    bandits: {
      id: 'bandits',
      name: 'NÃ¡jezd banditÅ¯',
      icon: 'ğŸ´â€â˜ ï¸',
      tier: 3,
      seasons: [2, 3], // podzim, zima
      
      intro: 'Banditi objevili doupÄ›! ChtÄ›jÃ­ tvoje zlato a zÃ¡soby.',
      
      playerIcon: 'ğŸ¹',
      enemyIcon: 'ğŸ—¡ï¸',
      aiDifficulty: 'hard',
      boardSize: 8,
      
      onDefeat: {
        gold: -0.5, // 50% zlata
        items: { 
          food: [-30, -50],
          water_supply: [-20, -30] 
        },
        casualties: 0.3, // 30% Å¡ance na smrt entity
        message: 'ğŸ´â€â˜ ï¸ Banditi ukradli zÃ¡soby a zlato!'
      },
      onVictory: {
        gold: [50, 100],
        items: { leather: [3, 6] },
        message: 'ğŸ¹ Banditi poraÅ¾eni! ZabavujeÅ¡ jejich vÃ½bavu.'
      }
    },
  
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸº TIER 3: Vlci (tÄ›Å¾kÃ©, zvlÃ¡Å¡tÄ› v zimÄ›)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    wolves: {
      id: 'wolves',
      name: 'Ãštok vlÄÃ­ smeÄky',
      icon: 'ğŸº',
      tier: 3,
      seasons: [2, 3], // podzim, zima (hladovÃ­)
      
      intro: 'HladovÃ¡ smeÄka vlkÅ¯ vnikla do doupÄ›te!',
      
      playerIcon: 'ğŸ”¥',
      enemyIcon: 'ğŸº',
      aiDifficulty: 'hard',
      boardSize: 7,
      
      onDefeat: {
        items: { 
          food: [-40, -60],
        },
        casualties: 0.4, // 40% Å¡ance
        message: 'ğŸº Vlci zabili obyvatele a ukradli jÃ­dlo!'
      },
      onVictory: {
        items: { 
          leather: [5, 10],
          food: [20, 30]
        },
        message: 'ğŸ”¥ Vlci poraÅ¾eni! ZÃ­skÃ¡vÃ¡Å¡ kÅ¯Å¾e a maso.'
      }
    },
  
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ€ TIER 2: Krysy (stÅ™ednÃ­)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    rats: {
      id: 'rats',
      name: 'ZamoÅ™enÃ­ krysami',
      icon: 'ğŸ€',
      tier: 2,
      seasons: [0, 1, 2], // ne v zimÄ›
      
      intro: 'Horda krys se valÃ­ z tunelÅ¯! ÃštoÄÃ­ na zÃ¡soby.',
      
      playerIcon: 'ğŸª¤',
      enemyIcon: 'ğŸ€',
      aiDifficulty: 'medium',
      boardSize: 6,
      
      onDefeat: {
        items: { 
          food: [-30, -50],
          water_supply: [-20, -30] 
        },
        casualties: 0.2,
        message: 'ğŸ€ Krysy zniÄily zÃ¡soby!'
      },
      onVictory: {
        items: { 
          leather: [2, 5],
          food: [10, 20]
        },
        message: 'ğŸª¤ Krysy poraÅ¾eny! ZÃ­skÃ¡vÃ¡Å¡ kÅ¯Å¾e.'
      }
    },
  
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ¦Ÿ TIER 1: Hmyz (lehkÃ©, obtÃ­Å¾nÃ©)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    bugs: {
      id: 'bugs',
      name: 'Invaze hmyzu',
      icon: 'ğŸª²',
      tier: 1,
      seasons: [0, 1], // jaro, lÃ©to
      
      intro: 'Å tÄ›nice a Å¡vÃ¡bi se rojÃ­ v doupÄ›ti! ObyvatelÃ© nemohou spÃ¡t.',
      
      playerIcon: 'ğŸ’¨',
      enemyIcon: 'ğŸ¦Ÿ',
      aiDifficulty: 'easy',
      boardSize: 5,
      
      onDefeat: {
        items: { 
          food: [-10, -20],
        },
        casualties: 0.1,
        message: 'ğŸª² Hmyz zniÄil ÄÃ¡st zÃ¡sob!'
      },
      onVictory: {
        items: { 
          food: [5, 10] // spÃ¡lenÃ½ hmyz = protein
        },
        message: 'ğŸ’¨ Hmyz vykouÅ™en! ObyvatelÃ© mohou spÃ¡t.'
      }
    },
  
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ’€ TIER 4: Mor (kritickÃ©, kdykoliv)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    plague: {
      id: 'plague',
      name: 'Epidemie moru',
      icon: 'ğŸ’€',
      tier: 4,
      seasons: null, // kdykoliv
      
      intro: 'ZÃ¡hadnÃ¡ nemoc se Å¡Ã­Å™Ã­ koloniÃ­! LidÃ© umÃ­rajÃ­.',
      
      playerIcon: 'ğŸ’Š',
      enemyIcon: 'ğŸ¦ ',
      aiDifficulty: 'medium',
      boardSize: 8,
      
      // MÅ¯Å¾eÅ¡ skipnout pokud mÃ¡Å¡ medicine_hut
      canAvoid: { medicine_hut: 1 },
      avoidMessage: 'ğŸ’Š LÃ©kÃ¡rna zachrÃ¡nila kolonii od epidemie!',
      
      onDefeat: {
        casualties: 0.5, // 50% Å¡ance!
        items: {
          food: [-20, -30]
        },
        message: 'ğŸ’€ Mor zabil ÄÃ¡st kolonie!'
      },
      onVictory: {
        message: 'ğŸ’Š Nemoc zastavena! Kolonie pÅ™eÅ¾ila.'
      }
    }
  },
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ğŸ® COMBAT SYSTEM - PiÅ¡kvorky 8x8
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  combat: {
    board: null,
    size: 8,
    currentThreat: null,
    playerIcon: 'ğŸ¹',
    enemyIcon: 'ğŸ—¡ï¸',
    gameActive: false,
    
    init: function(threat) {
      this.currentThreat = threat;
      this.size = threat.boardSize || 8;
      this.playerIcon = threat.playerIcon;
      this.enemyIcon = threat.enemyIcon;
      this.board = Array(this.size).fill(null).map(function() { return Array(this.size).fill(null); });
      this.gameActive = true;
    },
    
    makeMove: function(row, col) {
      if (!this.gameActive || this.board[row][col]) return false;
      
      this.board[row][col] = 'player';
      
      // Check win
      if (this.checkWin('player')) {
        this.gameActive = false;
        return 'player_win';
      }
      
      // Check draw
      if (this.isBoardFull()) {
        this.gameActive = false;
        return 'draw';
      }
      
      // AI move
      setTimeout(function() {
        this.aiMove();
        
        if (this.checkWin('enemy')) {
          this.gameActive = false;
          game.handleCombatEnd(false);
        } else if (this.isBoardFull()) {
          this.gameActive = false;
          game.handleCombatEnd(true); // draw = player win
        }
      }, 500);
      
      return true;
    },
    
    aiMove: function() {
      var difficulty = this.currentThreat.aiDifficulty;
      var move = null;
      
      switch(difficulty) {
        case 'easy':
          move = this.findRandomMove();
          break;
        case 'medium':
          move = this.findBlockingMove() || this.findWinningMove() || this.findRandomMove();
          break;
        case 'hard':
          move = this.findWinningMove() || this.findBlockingMove() || this.findStrategicMove();
          break;
        case 'expert':
          move = this.findBestMove();
          break;
      }
      
      if (move) {
        this.board[move.row][move.col] = 'enemy';
        game.renderCombatBoard();
      }
    },
    
    findWinningMove: function() {
      // Find move that wins for AI
      for (var r = 0; r < this.size; r++) {
        for (var c = 0; c < this.size; c++) {
          if (!this.board[r][c]) {
            this.board[r][c] = 'enemy';
            if (this.checkWin('enemy')) {
              this.board[r][c] = null;
              return { row: r, col: c };
            }
            this.board[r][c] = null;
          }
        }
      }
      return null;
    },
    
    findBlockingMove: function() {
      // Find move that blocks player from winning
      for (var r = 0; r < this.size; r++) {
        for (var c = 0; c < this.size; c++) {
          if (!this.board[r][c]) {
            this.board[r][c] = 'player';
            if (this.checkWin('player')) {
              this.board[r][c] = null;
              return { row: r, col: c };
            }
            this.board[r][c] = null;
          }
        }
      }
      return null;
    },
    
    findStrategicMove: function() {
      // Prefer center, then adjacent to existing pieces
      var center = Math.floor(this.size / 2);
      
      // Try center
      if (!this.board[center][center]) {
        return { row: center, col: center };
      }
      
      // Try near existing pieces
      for (var r = 0; r < this.size; r++) {
        for (var c = 0; c < this.size; c++) {
          if (this.board[r][c] && this.hasEmptyNeighbor(r, c)) {
            var empty = this.getEmptyNeighbor(r, c);
            if (empty) return empty;
          }
        }
      }
      
      return this.findRandomMove();
    },
    
    findRandomMove: function() {
      var empty = [];
      for (var r = 0; r < this.size; r++) {
        for (var c = 0; c < this.size; c++) {
          if (!this.board[r][c]) empty.push({ row: r, col: c });
        }
      }
      return empty.length > 0 ? empty[Math.floor(Math.random() * empty.length)] : null;
    },
    
    findBestMove: function() {
      // Expert AI - look ahead 2 moves
      var bestScore = -Infinity;
      var bestMove = null;
      
      for (var r = 0; r < this.size; r++) {
        for (var c = 0; c < this.size; c++) {
          if (!this.board[r][c]) {
            this.board[r][c] = 'enemy';
            var score = this.minimax(1, false, -Infinity, Infinity);
            this.board[r][c] = null;
            
            if (score > bestScore) {
              bestScore = score;
              bestMove = { row: r, col: c };
            }
          }
        }
      }
      
      return bestMove || this.findRandomMove();
    },
    
    minimax: function(depth, isMaximizing, alpha, beta) {
      if (this.checkWin('enemy')) return 10 - depth;
      if (this.checkWin('player')) return depth - 10;
      if (this.isBoardFull() || depth > 2) return 0;
      
      if (isMaximizing) {
        var maxScore = -Infinity;
        for (var r = 0; r < this.size; r++) {
          for (var c = 0; c < this.size; c++) {
            if (!this.board[r][c]) {
              this.board[r][c] = 'enemy';
              var score = this.minimax(depth + 1, false, alpha, beta);
              this.board[r][c] = null;
              maxScore = Math.max(score, maxScore);
              alpha = Math.max(alpha, score);
              if (beta <= alpha) break;
            }
          }
        }
        return maxScore;
      } else {
        var minScore = Infinity;
        for (var r = 0; r < this.size; r++) {
          for (var c = 0; c < this.size; c++) {
            if (!this.board[r][c]) {
              this.board[r][c] = 'player';
              var score = this.minimax(depth + 1, true, alpha, beta);
              this.board[r][c] = null;
              minScore = Math.min(score, minScore);
              beta = Math.min(beta, score);
              if (beta <= alpha) break;
            }
          }
        }
        return minScore;
      }
    },
    
    hasEmptyNeighbor: function(r, c) {
      var dirs = [[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];
      return dirs.somefunction(([dr,dc]) {
        var nr = r + dr, nc = c + dc;
        return nr >= 0 && nr < this.size && nc >= 0 && nc < this.size && !this.board[nr][nc];
      });
    },
    
    getEmptyNeighbor: function(r, c) {
      var dirs = [[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];
      for (var [dr, dc] of dirs) {
        var nr = r + dr, nc = c + dc;
        if (nr >= 0 && nr < this.size && nc >= 0 && nc < this.size && !this.board[nr][nc]) {
          return { row: nr, col: nc };
        }
      }
      return null;
    },
    
    checkWin: function(player) {
      // Check 5 in a row (horizontal, vertical, diagonal)
      for (var r = 0; r < this.size; r++) {
        for (var c = 0; c < this.size; c++) {
          if (this.board[r][c] === player) {
            // Check all 4 directions
            if (this.checkDirection(r, c, 0, 1, player) || // horizontal
                this.checkDirection(r, c, 1, 0, player) || // vertical
                this.checkDirection(r, c, 1, 1, player) || // diagonal \
                this.checkDirection(r, c, 1, -1, player)) { // diagonal /
              return true;
            }
          }
        }
      }
      return false;
    },
    
    checkDirection: function(r, c, dr, dc, player) {
      var count = 0;
      for (var i = 0; i < 5; i++) {
        var nr = r + i * dr;
        var nc = c + i * dc;
        if (nr < 0 || nr >= this.size || nc < 0 || nc >= this.size || this.board[nr][nc] !== player) {
          return false;
        }
        count++;
      }
      return count === 5;
    },
    
    isBoardFull: function() {
      return this.board.every(function(row) { return row.every(function(cell) { return cell !== null; }); });
    }
  },

  entityTypes: [
    {
      id: 'gatherer',
      name: 'SbÄ›raÄ',
      icon: 'ğŸ‘¤',
      actions: [
        {
          name: 'ğŸ”ªSbÃ­rat materiÃ¡ly',
          duration: 1,
          requires: { knife: 1 },
          result: function() {
            var items = ['wood', 'stone', 'fiber', 'mushroom'];
            var item = items[Math.floor(Math.random() * items.length)];
            return { [item]: Math.floor(Math.random() * 3) + 8 };
          }
        },
        {
          name: 'ğŸ§ºSbÃ­rat bobule',
          duration: 1,
          requires: { basket: 1 },
          result: function() { return (; }{ 
            food: Math.floor(Math.random() * 3) + 3,
            water_supply: Math.random() > 0.5 ? Math.floor(Math.random() * 2) + 6 : 0
          })
        },
        {
          name: 'ğŸ•¸ï¸NastraÅ¾it past',
          duration: 2,
          requires: { trap: 1 },
          result: function() { return (; }{ 
            food: Math.floor(Math.random() * 5) + 4
          })
        },
        {
          name: 'ğŸ¥£SbÃ­rat vodu',
          duration: 1,
          requires: { bowl: 1 },
          result: function() { return (; }{ water_supply: Math.floor(Math.random() * 5) + 10 })
        },
        {
          name: 'ğŸŒ³Topit v krbu',
          icon: 'ğŸŒ³',
          duration: 1,
          requires: { fireplace: 1 },
          isHeating: true,
          result: function() { return (; }{ heating: 1 })
        },
        // ğŸ”¥ NEW ACTION - PÅ™iloÅ¾it do ohnÄ›
        {
          name: 'ğŸŒ³PÅ™iloÅ¾it do ohnÄ›',
          duration: 1,
          requiresFire: true,
          isFuelAction: true,
          result: function() { return (; }{ fireFuel: 2 })
        },
        {
          name: 'âš”ï¸HlÃ­dat doupÄ›',
          duration: 1,
          isGuarding: true,
          result: function() { return (; }{ })
        }
      ]
     },
     {
      id: 'hunter',
      name: 'Lovec',
      icon: 'ğŸ¹',
      unlockRequires: { bow: 1 },
      actions: [
        {
          name: 'Lovit',
          duration: 2,
          requires: { bow: 1 },
          result: function() { return (; }{ 
            food: Math.floor(Math.random() * 6) + 5,
            leather: Math.random() > 0.5 ? 1 : 0
          })
        }
      ]
     }
 ],

  // Google Analytics 4 - Server-Side Tracking
  track: function(eventName, params) {
    params = params || {};
    // Server-side tracking pÅ™es Google Apps Script backend
    // Measurement Protocol API zajiÅ¡Å¥uje spolehlivÃ© mÄ›Å™enÃ­ bez cookies/iframe omezenÃ­
    try {
      var clientId = this.state.playerId; // PouÅ¾ij player ID jako client_id
      
      if (clientId) {
        // Use hybrid backend adapter
        this.backend('trackEvent', { clientId, eventName, params })
          .then(function() {
            // Success - tichÃ© logovÃ¡nÃ­ (neruÅ¡Ã­ hrÃ¡Äe)
            console.log('âœ“ GA4 tracked:', eventName);
          })
          .catch(function(error) {
            // Failure - tichÃ© logovÃ¡nÃ­ (tracking nesmÃ­ crashnout hru)
            console.warn('GA4 tracking failed:', error);
          });
      }
    } catch(e) {
      // Catch any errors - tracking nesmÃ­ nikdy crashnout hru
      console.warn('GA4 tracking error:', e);
    }
  },

  calculateTemperature: function() {
    var season = this.seasons[this.state.season];
    var targetTemp;
    
    // Use real weather if available
    if (this.state.weatherMode !== 'game' && this.state.weatherData && this.state.weatherData.temperature !== null) {
      targetTemp = this.state.weatherData.temperature;
    } else {
      // Game mode - nÃ¡hodnÃ¡ teplota podle sezÃ³ny
      var variance = (Math.random() - 0.5) * 2 * season.tempVariance;
      targetTemp = season.baseTemp + variance;
    }
    
    // Heating bonus (kaÅ¾dÃ© topenÃ­ = +5Â°C, max 3 dny)
    var heatingBonus = Math.min(this.state.heating, 3) * 5;
    
    // Shelter bonus (lepÅ¡Ã­ izolace = menÅ¡Ã­ rozdÃ­l od ideÃ¡lnÃ­ teploty)
    var insulations = this.state.inventory.insulation || 0;
    var shelterLevel = 1 + (insulations * 0.5);
    
    // Pokud je venku moc chladno/teplo, shelter pomÃ¡hÃ¡
    var idealTemp = 15;
    var diff = targetTemp - idealTemp;
    var shelteredDiff = diff / shelterLevel;
    
    targetTemp = idealTemp + shelteredDiff + heatingBonus;
    
    this.state.temperature = Math.round(targetTemp * 10) / 10;
    this.state.shelterLevel = shelterLevel;
  },

  getTemperatureEmoji: function(temp) {
    if (temp < -5) return 'ğŸ¥¶';
    if (temp < 5) return 'â„ï¸';
    if (temp < 12) return 'ğŸŒ¡ï¸';
    if (temp < 20) return 'ğŸŒ¤ï¸';
    if (temp < 28) return 'â˜€ï¸';
    return 'ğŸ”¥';
  },

  getTemperatureEffects: function() {
    var temp = this.state.temperature;
    var hungerMultiplier = 1;
    var waterMultiplier = 1;
    var efficiency = 1;
    
    // PÅ™Ã­liÅ¡ chladno
    if (temp < 5) {
      hungerMultiplier = 1.5;
      efficiency = 0.7;
    } else if (temp < 10) {
      hungerMultiplier = 1.2;
      efficiency = 0.85;
    }
    
    // PÅ™Ã­liÅ¡ teplo
    if (temp > 28) {
      waterMultiplier = 1.5;
      efficiency = 0.7;
    } else if (temp > 23) {
      waterMultiplier = 1.2;
      efficiency = 0.85;
    }
    
    // IdeÃ¡lnÃ­ teplota (10-20Â°C)
    if (temp >= 10 && temp <= 20) {
      efficiency = 1.1; // bonus!
    }
    
    return { hungerMultiplier, waterMultiplier, efficiency };
  },
  // ğŸ”¥ UPDATE FIRE INDICATOR UI
  updateFireIndicator: function() {
    var indicator = document.getElementById('fire-indicator');
    var statusText = indicator.querySelector('.fire-status');
    
    if (this.state.fireActive && this.state.fireFuel > 0) {
      indicator.classList.remove('inactive');
      indicator.classList.add('active');
      statusText.textContent = 'HoÅ™Ã­ (' + (this.state.fireFuel) + 'd)';
    } else {
      indicator.classList.remove('active');
      indicator.classList.add('inactive');
      statusText.textContent = 'Bez ohnÄ›';
    }
  },
  
  // ğŸ“Š UPDATE FOOTER STATS
  updateFooterStats: function() {
    var population = this.state.entities.length + 1; // +1 for player
    var bestRun = this.state.bestRun;
    
    document.getElementById('footer-stats').innerHTML = 
      'Kolonie: ' + (population) + ' ğŸ‘¥ | Rekord: <span id="footer-best-run">' + (bestRun) + '</span>d';
  },
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ğŸŒ¤ï¸ WEATHER MODE SYSTEM
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  setWeatherMode: function(mode) {
    var self = this;
    var previousMode = this.state.weatherMode;
    this.state.weatherMode = mode;
    localStorage.setItem('doupe_weather_mode', mode);
    
    // Update button states
    var buttons = document.querySelectorAll('.weather-mode-btn');
    buttons.forEach(function(btn) {
      btn.classList.toggle('active', btn.dataset.mode === mode);
    });
    
    // Reset weather data JEN kdyÅ¾ se ZMÄšNÃ mÃ³d (ne pÅ™i opakovanÃ©m kliknutÃ­)
    if (previousMode !== mode) {
      console.log('ğŸ”„ Weather mode changed: ' + (previousMode) + ' â†’ ' + (mode) + '');
      this.state.lastWeatherFetch = 0;
      this.state.weatherData = null;
    } else {
      console.log('ğŸ“¦ Weather mode already active: ' + (mode) + ' (keeping cache)');
    }
    
    // Update widget
    if (mode === 'game') {
      this.updateWeatherWidgetGame();
      // Immediate update for game mode
      this.calculateTemperature();
      this.render();
    } else {
      // Wait for weather data before calculating temperature
      this.fetchWeather().then(function() {
        // Now calculate with fresh data
        self.calculateTemperature();
        self.render();
      });
    }
    
    // Log change (only if actually changed)
    if (previousMode !== mode) {
      var modeName = mode === 'game' ? 'HernÃ­ mÃ³d' : mode === 'openmeteo' ? 'Open-Meteo' : 'WeatherXM';
      this.log('ğŸŒ¤ï¸ Weather mode: ' + (modeName) + '', 'info');
      this.showNotification('ğŸŒ¤ï¸ ' + (modeName) + '');
    }
  },
  
  updateWeatherWidgetGame: function() {
    var widget = document.getElementById('weather-widget');
    if (!widget) return;
    
    // Safety check - pokud seasons jeÅ¡tÄ› nenÃ­ inicializovanÃ½
    if (!this.seasons || !this.seasons[this.state.season]) {
      widget.innerHTML = '<span class="weather-icon">ğŸŒ</span><span class="weather-info">NaÄÃ­tÃ¡m...</span>';
      return;
    }
    
    var season = this.seasons[this.state.season];
    widget.innerHTML = '<span class="weather-icon">' + (season.icon) + '</span><span class="weather-info">' + (season.name) + ': ' + (season.desc) + '</span>';
    widget.style.cursor = 'default';
    widget.onclick = null;
  },
  
  // â„¹ï¸ SHOW ABOUT MODAL
  showAbout: function() {
    this.openModal();
    
    var modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.id = 'about-modal';
    
    modal.innerHTML = '
      <div class="modal-content">
        <div class="modal-title">â„¹ï¸ O HÅ˜E DOUPÄš</div>
        
        <div style="text-align: left; color: #b89968; line-height: 1.6; margin: 20px 0;">
          <p style="margin-bottom: 15px;">
            <strong style="color: #d4a574;">DoupÄ› v2.0</strong> je survival crafting hra 
            o pÅ™eÅ¾itÃ­ kolonie v drsnÃ©m prostÅ™edÃ­.
          </p>
          
          <p style="margin-bottom: 15px;">
            ğŸ¯ <strong>CÃ­l:</strong> UdrÅ¾et kolonii naÅ¾ivu co nejdÃ©le. 
            SbÃ­rej suroviny, craftuj nÃ¡stroje, pÅ™ijÃ­mej obyvatele a pÅ™ekonÃ¡vej roÄnÃ­ obdobÃ­.
          </p>
          
          <b><p>v. 2.12m</p></b>
            ğŸ”¥ <strong>NovÃ© features</strong><br>
            â€¢ PotvrzenÃ­ restartu hry a stats<br>
            â€¢ Hrozby a souboje - piÅ¡kvorky<br>
            â€¢ PÅ™idÃ¡na atmosferickÃ¡ hudba a controls, device recognition w. sample rate adjust<br>
            â€¢ PÅ™epÃ­nÃ¡nÃ­ mezi mody poÄasÃ­ s ovlivnÄ›nÃ­m hry<br>
            â€¢ NovÃ¡ patiÄka
          <b><p>v. 2.0m</p></b>
          <p style="margin-bottom: 15px;">
            ğŸ”¥ <strong>Mechaniky:</strong><br>
            â€¢ SezÃ³nnÃ­ zmÄ›ny kaÅ¾dÃ½ch 15 dnÃ­<br>
            â€¢ SystÃ©m teploty a vytÃ¡pÄ›nÃ­<br>
            â€¢ OheÅˆ a suÅ¡enÃ­ masa<br>
            â€¢ Ekonomika - prodÃ¡vej a nakupuj<br>
            â€¢ Å½ebÅ™Ã­Äek nejlepÅ¡Ã­ch koloniÃ­
          </p>
          
          <p style="margin-bottom: 15px;">
            ğŸ‘¤ <strong>Autor:</strong> Ondrex's Ember ğŸ”¥<br>
            ğŸ“… <strong>Verze:</strong> 2.0 (Ãšnor 2026)<br>
            ğŸ”§ <strong>Tech:</strong> Google Apps Script + Sheets<br>
            ğŸ“¬ <strong>Bugs</strong> Opinions? Hate? Contact me by mail: ondrex@gmail.com
          </p>
          
          <p style="font-size: 11px; opacity: 0.7; margin-top: 20px;">
            ğŸ’¡ Tip: NejlepÅ¡Ã­ strategie je vyvÃ¡Å¾it craftovÃ¡nÃ­ nÃ¡strojÅ¯, 
            budovÃ¡nÃ­ infrastruktury a udrÅ¾ovÃ¡nÃ­ zÃ¡sob. NezapomeÅˆ na zimu!
          </p>
        </div>
        
        <div class="modal-buttons">
          <button class="modal-btn modal-btn-primary" onclick="game.closeModal('about-modal')">
            ğŸ‘ RozumÃ­m
          </button>
        </div>
      </div>
    ';
    
    document.body.appendChild(modal);
  },
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // âš ï¸ CRITICAL FUNCTION - GAME INITIALIZATION
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  /**
   * ğŸ® INIT GAME
   * 
   * Inicializuje hru - nastavÃ­ player ID, naÄte best run, vytvoÅ™Ã­ poÄÃ¡teÄnÃ­ state,
   * detekuje environment (Apps Script vs standalone), spustÃ­ GA4 tracking,
   * zobrazÃ­ ÃºvodnÃ­ log messages.
   * 
   * âš ï¸ MUSÃ bÃ½t volÃ¡no pÅ™i naÄtenÃ­ strÃ¡nky!
   * 
   * @returns {void}
   * @fires game.render() - Initial render
   * @fires game.track() - GA4 tracking events
   * @sideeffects Creates player ID, loads localStorage data, logs to game log
   * 
   * @example
   * window.onload = function() { return game.init(); }; // VolÃ¡ se automaticky
   * 
   * @tested âœ… 2026-02-08 - Works in both modes
   */
  init: function() {
    // Player ID systÃ©m
    var playerId = localStorage.getItem('doupe_player_id');
    if (!playerId) {
      playerId = 'player_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      localStorage.setItem('doupe_player_id', playerId);
    }
    this.state.playerId = playerId;
    
    // NaÄti best run a nickname
    this.state.bestRun = parseInt(localStorage.getItem('doupe_best_run') || '0');
    this.state.playerNickname = localStorage.getItem('doupe_nickname') || null;
    
    this.state.inventory = { 
      wood: 5,
      fiber: 8,
      food: 60,
      water_supply: 60
    };
    this.state.season = 0; // Jaro
    this.state.day = 1;
    this.state.entities = [];
    this.state.gold = 0;
    this.state.temperature = 15;
    this.state.shelterLevel = 1;
    this.state.heating = 0;
    this.state.guaranteedStones = 0;
    this.state.fireActive = false; // ğŸ”¥
    this.state.fireFuel = 0; // ğŸ”¥
    this.state.weatherMode = localStorage.getItem('doupe_weather_mode') || 'game'; // ğŸŒ¤ï¸
    this.state.weatherData = null;
    this.state.lastWeatherFetch = 0;
    this.state.lastSeasonalThreat = 0;
    this.state.randomThreatCount = 0;
    this.state.maxRandomThreats = 3;
    this.state.threatCooldown = 3;
    this.state.unlockedRecipes = ['stick', 'rope', 'bowl', 'trap', 'basket'];
    
    // ğŸŒ Environment Detection
    var environment = this.isAppsScript() ? 'Apps Script (Full Features)' : 'Standalone (Local Save)';
    console.log('ğŸ® DoupÄ› 2 - Running in: ' + (environment) + '');
    
    // GA4 Tracking - Page View
    this.track('page_view', {
      page_title: 'DoupÄ› - Survival Crafting',
      page_location: window.location.href,
      engagement_time_msec: '100',
      environment: environment
    });
    
    // GA4 Tracking - Game Start
    this.track('game_start', {
      starting_food: 60,
      starting_water: 60,
      starting_temperature: 15,
      is_returning_player: this.state.bestRun > 0,
      environment: environment
    });
    
    // AtmosfÃ©rickÃ½ Ãºvod
    this.log('ğŸŒ² ProbouzÃ­Å¡ se v tichÃ©m doupÄ›ti, kdesi hluboko v temnÃ½ch vlaÅ¾nÃ½ch lesÃ­ch... VÃ­Å¡, Å¾e kolem to vÅ™e, ale tobÄ› je pÅ™Ã­jemnÄ› chladno.', 'info');
    this.log('Vzduch je ale tÄ›Å¾kÃ½. Kolonie strÃ¡dÃ¡ a nachÃ¡zÃ­ se na pokraji zÃ¡niku. Hlad, Å¾Ã­zeÅˆ, mrÃ¡z - tvoji vÄ›ÄnÃ­ nepÅ™Ã¡telÃ©.', 'warning');
    this.log('LÃ©ta sucha vysuÅ¡ila prameny. Zimy jsou krutÃ©, jÃ­dlo vzÃ¡cnÃ©. PÅ™eÅ¾itÃ­ nenÃ­ zaruÄeno. SpÃ­Å¡e vyvrÃ¡ceno. MÃ¡Å¡ na to?', 'warning');
    this.log('', 'info');
    this.log('ğŸ’¡ JAK ZAÄŒÃT: VytvoÅ™ si nÃ¡stroje (hÅ¯l, provaz, misku). Postavte past na zvÄ›Å™. Tvoje role je tvoÅ™it vÄ›ci. Pro kolonii. ObchodnÃ­ci je rÃ¡di vykoupÃ­, nebo pomohou kolonii k pÅ™eÅ¾itÃ­. VÃ½hodnou je, Å¾e je mÅ¯Å¾eÅ¡ prodat. A za penÃ­ze pak mÅ¯Å¾eÅ¡ podpoÅ™it jÃ­dlem a vodou celou kolonii. ZajistÃ­Å¡ si i tak svÃ© pÅ™eÅ¾itÃ­? Ven se ti moc zatÃ­m nechce, ani na to nemÃ¡Å¡ prÃ¡vo, tvoje role je craftovÃ¡nÃ­.', 'success');
    this.log('ğŸ’¡ PRVNÃ KROKY: Craftuj nÅ¯Å¾ â†’ pÅ™ijde obyvatel â†’ pÅ™iÅ™aÄ mu prÃ¡ci.', 'success');
    this.log('ğŸ’¡ KLÃÄŒ K PÅ˜EÅ½ITÃ: Sledujte zÃ¡soby kolonie! ObdobÃ­ se mÄ›nÃ­ kaÅ¾dÃ½ch 15 dnÃ­ a jejich dopady jsou nemilosrdnÃ©.', 'danger');
    this.log('ğŸ’¡ TEPLOTA: V lÃ©tÄ› je vedro k omdlenÃ­. V mrazu spotÅ™ebujete vÃ­c jÃ­dla. RozdÄ›lejte oheÅˆ, postavte krb, zatopte, nebo budete mrznout. MoÅ¾nÃ¡ pÅ™eÅ¾ijete zimu a dalÅ¡Ã­ bude lehÄÃ­?', 'danger');
    this.log('ğŸ”¥ OHEÅ‡: Luk â†’ Bow Drill (80%) nebo KÅ™esadlo (100%). PotÅ™ebnÃ½ pro suÅ¡enÃ­ masa! PÅ Å Å Å T "a dost!", ".. yes my master!"', 'success');
    this.log('ğŸ’° EKONOMIKA: ProdÃ¡vej suroviny ğŸŸ¡ za zlato â†’ Kup jÃ­dlo/vodu ğŸ·ï¸. Risk vs. reward!', 'success');
    
    // Environment indicator
    if (!this.isAppsScript()) {
      this.log('âš ï¸ Public message: Save/Load games funguje. NovÃ© features. PlnÃ© funkce, enjoy:-).', 'warning');
    }
    
    this.log('', 'info');
    
    // ğŸŒ¤ï¸ WEATHER: Inicializuj widget PÅ˜ED render (game mode potÅ™ebuje seasons)
    if (this.state.weatherMode === 'game') {
      this.updateWeatherWidgetGame();
    }
    
    this.render();
    
    // ğŸ“‚ AUTO-LOAD: NabÃ­dni naÄtenÃ­ uloÅ¾enÃ© hry
    this.checkAutoLoad();
    
    // ğŸŒ¤ï¸ WEATHER: NaÄti externÃ­ data (async)
    if (this.state.weatherMode !== 'game') {
      setTimeout(function() {
        this.fetchWeather();
      }, 100);
    }
  },

  /**
   * ğŸ“‚ CHECK AUTO-LOAD
   * 
   * Zkontroluje jestli existuje uloÅ¾enÃ¡ hra a pokud ano,
   * automaticky zobrazÃ­ modal pro naÄtenÃ­ pÅ™i startu.
   * 
   * @returns {void}
   * @sideeffects May call loadGame() to show modal
   * 
   * @tested âœ… 2026-02-08
   */
  checkAutoLoad: function() {
    // PoÄkej aÅ¾ se UI vykreslÃ­
    setTimeout(function() {
      // Zkontroluj jestli existuje save
      var hasSave = false;
      var saveData = null;
      
      if (this.isAppsScript()) {
        // V Apps Script reÅ¾imu zkontroluj backend
        // (zatÃ­m nechÃ¡me na manuÃ¡lnÃ­m naÄtenÃ­, protoÅ¾e async)
        console.log('ğŸŒ Apps Script mode - auto-load skipped (use manual load)');
        return;
      } else {
        // Standalone - zkontroluj localStorage
        var saved = localStorage.getItem('doupe_save');
        if (saved) {
          try {
            saveData = JSON.parse(saved);
            hasSave = true;
          } catch(e) {
            console.error('Invalid save data:', e);
          }
        }
      }
      
      // Pokud existuje save a nenÃ­ to den 1, nabÃ­dni naÄtenÃ­
      if (hasSave && saveData && saveData.day > 1) {
        console.log('ğŸ“‚ Auto-load: Found save on day', saveData.day);
        this.loadGame();
      } else {
        console.log('ğŸ“‚ Auto-load: No valid save found or day 1');
      }
    }, 500); // PoÄkej 500ms aby se UI stihlo vyrenderovat
  },

  /**
   * ğŸŒ¤ï¸ FETCH WEATHER
   * 
   * NaÄte poÄasÃ­ podle mÃ³du:
   * - game: zobrazÃ­ hernÃ­ sezÃ³nu
   * - openmeteo: Open-Meteo API (client-side, 10min local cache)
   * - weatherxm: WeatherXM PRO backend (server-side GLOBÃLNÃ cache 3h pro vÅ¡echny uÅ¾ivatele)
   * 
   * @returns {Promise<void>}
   * @sideeffects Updates #weather-widget DOM element
   * 
   * @api Open-Meteo (free, no API key needed)
   * @api WeatherXM PRO (limit 500 calls/mÄ›sÃ­c, GLOBÃLNÃ CACHE na serveru)
   * @tested âœ… 2026-02-10
   */
  async fetchWeather() {
    var mode = this.state.weatherMode || 'game';
    
    // Game mode - zobraz hernÃ­ sezÃ³nu
    if (mode === 'game') {
      this.updateWeatherWidgetGame();
      return;
    }
    
    // ğŸ“¦ ZOBRAZ LOADING STATE
    var widget = document.getElementById('weather-widget');
    if (widget) {
      widget.innerHTML = '
        <span class="weather-icon">â³</span>
        <span class="weather-info">NaÄÃ­tÃ¡m poÄasÃ­...</span>
      ';
    }
    
    var now = Date.now();
    
    try {
      if (mode === 'openmeteo') {
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸŒ OPEN-METEO (client-side, local cache 10min)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // Local cache check (neomezenÃ© calls, takÅ¾e 10min je OK)
        if (this.state.weatherData && this.state.weatherData.source === 'openmeteo') {
          if ((now - this.state.lastWeatherFetch) < 600000) { // 10 min
            console.log('ğŸ“¦ Using cached openmeteo data (' + (Math.round((now - this.state.lastWeatherFetch) / 60000)) + ' min old)');
            this.updateWeatherWidgetExternal();
            return;
          }
        }
        
        console.log('ğŸŒ Fetching Open-Meteo data (client-side)...');
        
        var lat = 50.7667;
        var lon = 14.5333;
        var url = 'https://api.open-meteo.com/v1/forecast?latitude=' + (lat) + '&longitude=' + (lon) + '&current=temperature_2m,weather_code,wind_speed_10m&timezone=Europe/Prague';
        
        var response = await fetch(url);
        var data = await response.json();
        
        this.state.weatherData = {
          source: 'openmeteo',
          temperature: Math.round(data.current.temperature_2m),
          weatherCode: data.current.weather_code,
          windSpeed: Math.round(data.current.wind_speed_10m),
          timestamp: new Date().toISOString(),
          rawData: data
        };
        
        console.log('âœ… Open-Meteo data loaded:', this.state.weatherData);
        
      } else if (mode === 'weatherxm') {
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ“¡ WEATHERXM PRO (server-side, GLOBÃLNÃ cache 3h)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        console.log('ğŸ“¡ Calling WeatherXM backend (global cache)...');
        var response = await this.backend('fetchWeatherXM');
        
        console.log('ğŸ“¡ Backend response:', response);
        
        if (!response) {
          throw new Error('Backend vrÃ¡til null response');
        }
        
        if (!response.success) {
          throw new Error(response.error || 'Backend returned success: false');
        }
        
        if (!response.data) {
          throw new Error('Backend response missing data field');
        }
        
        // Validace dat
        if (response.data.temperature === null || response.data.temperature === undefined) {
          console.warn('âš ï¸ Temperature is null/undefined:', response.data);
        }
        
        this.state.weatherData = {
          source: 'weatherxm',
          temperature: response.data.temperature,
          humidity: response.data.humidity,
          pressure: response.data.pressure,
          windSpeed: response.data.windSpeed,
          windDirection: response.data.windDirection,
          precipitation: response.data.precipitation,
          timestamp: response.data.timestamp,
          stationName: response.data.stationName,
          stationQuality: response.data.stationQuality
        };
        
        console.log('âœ… Weather Station data loaded:', this.state.weatherData);
      }
      
      this.state.lastWeatherFetch = now;
      this.updateWeatherWidgetExternal();
      
    } catch(error) {
      console.error('âŒ Weather fetch failed:', error);
      console.error('âŒ Error details:', {
        mode: mode,
        message: error.message,
        stack: error.stack
      });
      
      var widget = document.getElementById('weather-widget');
      if (widget) {
        widget.innerHTML = '
          <span class="weather-icon">âŒ</span>
          <span class="weather-info">Chyba: ' + (error.message) + '</span>
        ';
      }
    }
  },
  
  updateWeatherWidgetExternal: function() {
    var widget = document.getElementById('weather-widget');
    if (!widget || !this.state.weatherData) return;
    
    var data = this.state.weatherData;
    
    if (data.source === 'openmeteo') {
      var weatherInfo = this.getWeatherInfo(data.weatherCode);
      widget.innerHTML = '
        <span class="weather-icon">' + (weatherInfo.icon) + '</span>
        <span class="weather-info">
          NovÃ½ Bor: ' + (data.temperature) + 'Â°C, ' + (weatherInfo.desc) + '' + (data.windSpeed > 20 ? ' ğŸ’¨' : '') + '
        </span>
      ';
    } else if (data.source === 'weatherxm') {
      var temp = data.temperature !== null ? Math.round(data.temperature) : '?';
      var humidity = data.humidity !== null ? Math.round(data.humidity) : '?';
      var stationName = data.stationName || 'WeatherXM';
      widget.innerHTML = '
        <span class="weather-icon">ğŸ“¡</span>
        <span class="weather-info">
          ' + (stationName) + ': ' + (temp) + 'Â°C, ' + (humidity) + '%
        </span>
      ';
    }
    
    widget.style.cursor = 'pointer';
    widget.onclick = function() { return this.showWeatherDetail(); };
  },

  /**
   * â° GET TIME AGO
   * 
   * PÅ™evede timestamp na ÄitelnÃ½ "pÅ™ed X minutami/hodinami"
   * 
   * @param {string} timestamp - ISO timestamp
   * @returns {string} ÄŒitelnÃ½ Äas (napÅ™. "pÅ™ed 2 hodinami")
   */
  getTimeAgo: function(timestamp) {
    var now = Date.now();
    var then = new Date(timestamp).getTime();
    var diffMs = now - then;
    var diffMin = Math.floor(diffMs / 60000);
    
    if (diffMin < 1) return 'prÃ¡vÄ› teÄ';
    if (diffMin === 1) return 'pÅ™ed minutou';
    if (diffMin < 60) return 'pÅ™ed ' + (diffMin) + ' minutami';
    
    var diffHours = Math.floor(diffMin / 60);
    if (diffHours === 1) return 'pÅ™ed hodinou';
    if (diffHours < 24) return 'pÅ™ed ' + (diffHours) + ' hodinami';
    
    var diffDays = Math.floor(diffHours / 24);
    if (diffDays === 1) return 'vÄera';
    return 'pÅ™ed ' + (diffDays) + ' dny';
  },

  /**
   * ğŸŒ¦ï¸ GET WEATHER INFO
   * 
   * PÅ™evede WMO weather code na emoji ikonu a ÄeskÃ½ popis.
   * 
   * @param {number} code - WMO weather code
   * @returns {Object} {icon: string, desc: string}
   * 
   * @see https://open-meteo.com/en/docs
   */
  getWeatherInfo: function(code) {
    // WMO Weather interpretation codes
    var weatherMap = {
      0: { icon: 'â˜€ï¸', desc: 'jasno' },
      1: { icon: 'ğŸŒ¤ï¸', desc: 'pÅ™evÃ¡Å¾nÄ› jasno' },
      2: { icon: 'â›…', desc: 'polojasno' },
      3: { icon: 'â˜ï¸', desc: 'zataÅ¾eno' },
      45: { icon: 'ğŸŒ«ï¸', desc: 'mlha' },
      48: { icon: 'ğŸŒ«ï¸', desc: 'jinovatka' },
      51: { icon: 'ğŸŒ¦ï¸', desc: 'mrholenÃ­' },
      53: { icon: 'ğŸŒ§ï¸', desc: 'mrholenÃ­' },
      55: { icon: 'ğŸŒ§ï¸', desc: 'silnÃ© mrholenÃ­' },
      61: { icon: 'ğŸŒ§ï¸', desc: 'dÃ©Å¡Å¥' },
      63: { icon: 'ğŸŒ§ï¸', desc: 'dÃ©Å¡Å¥' },
      65: { icon: 'â›ˆï¸', desc: 'silnÃ½ dÃ©Å¡Å¥' },
      71: { icon: 'ğŸŒ¨ï¸', desc: 'snÄ›Å¾enÃ­' },
      73: { icon: 'ğŸŒ¨ï¸', desc: 'snÄ›Å¾enÃ­' },
      75: { icon: 'â„ï¸', desc: 'silnÃ© snÄ›Å¾enÃ­' },
      77: { icon: 'ğŸŒ¨ï¸', desc: 'snÄ›hovÃ© vloÄky' },
      80: { icon: 'ğŸŒ¦ï¸', desc: 'pÅ™ehÃ¡Åˆky' },
      81: { icon: 'â›ˆï¸', desc: 'pÅ™ehÃ¡Åˆky' },
      82: { icon: 'â›ˆï¸', desc: 'silnÃ© pÅ™ehÃ¡Åˆky' },
      85: { icon: 'ğŸŒ¨ï¸', desc: 'snÄ›hovÃ© pÅ™ehÃ¡Åˆky' },
      86: { icon: 'â„ï¸', desc: 'silnÃ© snÄ›hovÃ© pÅ™ehÃ¡Åˆky' },
      95: { icon: 'â›ˆï¸', desc: 'bouÅ™ka' },
      96: { icon: 'â›ˆï¸', desc: 'bouÅ™ka s krupobitÃ­m' },
      99: { icon: 'â›ˆï¸', desc: 'silnÃ¡ bouÅ™ka' }
    };
    
    return weatherMap[code] || { icon: 'ğŸŒ¤ï¸', desc: 'promÄ›nlivÃ©' };
  },

  /**
   * ğŸ“Š SHOW WEATHER DETAIL
   * 
   * ZobrazÃ­ detailnÃ­ modal s rozÅ¡Ã­Å™enÃ½mi informacemi o poÄasÃ­.
   * 
   * @param {Object} data - Weather data from API
   * @returns {void}
   */
  showWeatherDetail: function() {
    var data = this.state.weatherData;
    if (!data) return;
    
    this.openModal();
    
    var modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.id = 'weather-modal';
    
    var content = '';
    
    if (data.source === 'openmeteo') {
      var weatherInfo = this.getWeatherInfo(data.weatherCode);
      content = '
        <div class="modal-content">
          <div class="modal-title">ğŸŒ OPEN-METEO</div>
          
          <div style="text-align: center; margin: 30px 0;">
            <div style="font-size: 64px; margin-bottom: 10px;">
              ' + (weatherInfo.icon) + '
            </div>
            <div style="font-size: 48px; font-weight: 700; color: #d4a574; margin-bottom: 5px;">
              ' + (data.temperature) + 'Â°C
            </div>
            <div style="font-size: 18px; color: #b89968; text-transform: capitalize;">
              ' + (weatherInfo.desc) + '
            </div>
          </div>
          
          <div style="text-align: left; color: #b89968; line-height: 1.8; margin: 20px 0;">
            <p style="margin-bottom: 8px;">
              ğŸ’¨ <strong>VÃ­tr:</strong> ' + (data.windSpeed) + ' km/h
            </p>
            <p style="margin-bottom: 8px;">
              ğŸ“ <strong>Lokace:</strong> NovÃ½ Bor, ÄŒeskÃ¡ republika
            </p>
            <p style="font-size: 11px; opacity: 0.7; margin-top: 15px;">
              Data z Open-Meteo API â€¢ ' + (this.getTimeAgo(data.timestamp)) + '
            </p>
            ' + (this.state.lastWeatherFetch > 0 ? '
              <p style="font-size: 10px; opacity: 0.6; margin-top: 5px; color: #7bc876;">
                ğŸ“¦ DalÅ¡Ã­ aktualizace za ' + (Math.round((600000 - (Date.now() - this.state.lastWeatherFetch)) / 60000)) + ' min (cache: 10min)
              </p>
            ' : '') + '
          </div>
          
          <div class="modal-buttons">
            <button class="modal-btn modal-btn-secondary" onclick="game.closeModal('weather-modal')">
              ZavÅ™Ã­t
            </button>
          </div>
        </div>
      ';
    } else if (data.source === 'weatherxm') {
      var temp = data.temperature !== null ? Math.round(data.temperature) : 'N/A';
      var humidity = data.humidity !== null ? Math.round(data.humidity) : 'N/A';
      var pressure = data.pressure !== null ? Math.round(data.pressure) : 'N/A';
      var windSpeed = data.windSpeed !== null ? Math.round(data.windSpeed) : 'N/A';
      var windDir = data.windDirection !== null ? Math.round(data.windDirection) : 'N/A';
      var precip = data.precipitation !== null ? data.precipitation.toFixed(1) : 'N/A';
      var stationName = data.stationName || 'WeatherXM Station';
      var quality = data.stationQuality !== null ? Math.round(data.stationQuality * 100) : null;
      
      content = '
        <div class="modal-content">
          <div class="modal-title">ğŸ“¡ WEATHER STATION</div>
          
          <div style="text-align: center; margin: 30px 0;">
            <div style="font-size: 64px; margin-bottom: 10px;">
              ğŸ“¡
            </div>
            <div style="font-size: 48px; font-weight: 700; color: #d4a574; margin-bottom: 5px;">
              ' + (temp) + 'Â°C
            </div>
            <div style="font-size: 16px; color: #b89968;">
              ' + (stationName) + '
            </div>
            ' + (quality !== null ? '
              <div style="font-size: 12px; color: #7bc876; margin-top: 5px;">
                ğŸ“Š Kvalita dat: ' + (quality) + '%
              </div>
            ' : '') + '
          </div>
          
          <div style="text-align: left; color: #b89968; line-height: 1.8; margin: 20px 0;">
            <p style="margin-bottom: 10px;">
              ğŸŒ¡ï¸ <strong>Teplota:</strong> ' + (temp) + 'Â°C
            </p>
            <p style="margin-bottom: 10px;">
              ğŸ’§ <strong>Vlhkost:</strong> ' + (humidity) + '%
            </p>
            <p style="margin-bottom: 10px;">
              ğŸ”½ <strong>Tlak:</strong> ' + (pressure) + ' hPa
            </p>
            <p style="margin-bottom: 10px;">
              ğŸ’¨ <strong>VÃ­tr:</strong> ' + (windSpeed) + ' km/h (' + (windDir) + 'Â°)
            </p>
            <p style="margin-bottom: 10px;">
              ğŸŒ§ï¸ <strong>SrÃ¡Å¾ky:</strong> ' + (precip) + ' mm/h
            </p>
            <p style="font-size: 11px; opacity: 0.7; margin-top: 15px;">
              Data z Weather Station â€¢ ' + (this.getTimeAgo(data.timestamp)) + '
            </p>
            ' + (this.state.lastWeatherFetch > 0 ? '
              <p style="font-size: 10px; opacity: 0.6; margin-top: 5px; color: #7bc876;">
                ğŸ“¦ DalÅ¡Ã­ aktualizace za ' + (Math.round((10800000 - (Date.now() - this.state.lastWeatherFetch)) / 60000)) + ' min (cache: 3h)
              </p>
            ' : '') + '
          </div>
          
          <div class="modal-buttons">
            <button class="modal-btn modal-btn-secondary" onclick="game.closeModal('weather-modal')">
              ZavÅ™Ã­t
            </button>
          </div>
        </div>
      ';
    }
    
    modal.innerHTML = content;
    document.body.appendChild(modal);
  },

  log: function(text, type) {
    type = type || 'info';
    var div = document.createElement('div');
    div.className = 'log-entry log-' + (type) + '';
    div.textContent = text;
    var logEl = document.getElementById('log');
    logEl.appendChild(div);
    logEl.scrollTop = logEl.scrollHeight;
  },

  showNotification: function(text) {
    var notif = document.createElement('div');
    notif.className = 'event-notification';
    notif.textContent = text;
    document.body.appendChild(notif);
    
    setTimeout(function() {
      notif.style.animation = 'slideIn 0.5s ease-out reverse';
      setTimeout(function() {
    }, 3000);
  },

  // ğŸ’° ECONOMY: Sell Item
  sellItem: function(itemId, quantity) {
    quantity = quantity || 1;
    var item = this.items[itemId];
    if (!item) return;
    
    var have = this.state.inventory[itemId] || 0;
    if (have < quantity) {
      this.log('âŒ NemÃ¡Å¡ dost na prodej', 'warning');
      return;
    }
    
    if (!item.sellPrice) {
      this.log('âŒ Toto nelze prodat', 'warning');
      return;
    }
    
    var goldEarned = item.sellPrice * quantity;
    
    // Update state
    this.removeItem(itemId, quantity);
    this.state.gold += goldEarned;
    
    if (soundEffects) soundEffects.playSound('sell');
    this.log('ğŸŸ¡ Prodal jsi ' + (item.icon) + ' ' + (item.name) + ' Ã—' + (quantity) + ' za ' + (goldEarned) + 'g', 'success');
    this.showNotification('ğŸŸ¡ +' + (goldEarned) + 'g');
    
    // GA4 Tracking
    this.track('item_sold', {
      item_id: itemId,
      item_name: item.name,
      quantity: quantity,
      gold_earned: goldEarned,
      new_gold_balance: this.state.gold,
      day: this.state.day
    });
    
    // Backend transaction logging (fire & forget)
    this.backend('logTransaction', {
      playerId: this.state.playerId,
      type: 'sell',
      itemId: itemId,
      itemName: item.name,
      quantity: quantity,
      goldAmount: goldEarned,
      newBalance: this.state.gold,
      day: this.state.day
    }).catch(function(error) {
      console.warn('Transaction log failed:', error);
    });
    
    this.render();
  },

  // ğŸ’° ECONOMY: Buy Item
  buyItem: function(itemId, quantity) {
    quantity = quantity || 1;
    var item = this.items[itemId];
    if (!item) return;
    
    if (!item.buyPrice) {
      this.log('âŒ Toto nelze koupit', 'warning');
      return;
    }
    
    var goldNeeded = item.buyPrice * quantity;
    
    if (this.state.gold < goldNeeded) {
      this.log('âŒ NemÃ¡Å¡ dost zlata (potÅ™eba ' + (goldNeeded) + 'g)', 'warning');
      return;
    }
    
    // Update state
    this.state.gold -= goldNeeded;
    this.addItem(itemId, quantity);
    
    if (soundEffects) soundEffects.playSound('buy');
    this.log('ğŸ·ï¸ Koupil jsi ' + (item.icon) + ' ' + (item.name) + ' Ã—' + (quantity) + ' za ' + (goldNeeded) + 'g', 'success');
    this.showNotification('ğŸ·ï¸ -' + (goldNeeded) + 'g');
    
    // GA4 Tracking
    this.track('item_bought', {
      item_id: itemId,
      item_name: item.name,
      quantity: quantity,
      gold_spent: goldNeeded,
      new_gold_balance: this.state.gold,
      day: this.state.day
    });
    
    // Backend transaction logging (fire & forget)
    this.backend('logTransaction', {
      playerId: this.state.playerId,
      type: 'buy',
      itemId: itemId,
      itemName: item.name,
      quantity: quantity,
      goldAmount: goldNeeded,
      newBalance: this.state.gold,
      day: this.state.day
    }).catch(function(error) {
      console.warn('Transaction log failed:', error);
    });
    
    this.render();
  },

  hasMaterials: function(materials) {
    return Object.entries(materials).every(function(
      ([id, count]) (this.state.inventory[id] || 0) >= count
    );
  },

  hasTools: function(tools) {
    if (!tools) return true;
    return Object.entries(tools).every(function(
      ([id, count]) (this.state.inventory[id] || 0) >= count
    );
  },

  addItem: function(id, count) {
    this.state.inventory[id] = (this.state.inventory[id] || 0) + count;
  },

  removeItem: function(id, count) {
    this.state.inventory[id] = (this.state.inventory[id] || 0) - count;
    if (this.state.inventory[id] <= 0) delete this.state.inventory[id];
  },

  craft: function(recipeId) {
    var recipe = this.recipes.find(function(r) { return r.id === recipeId); };
    if (!recipe) return;

    if (!this.hasMaterials(recipe.materials)) {
      this.log('âŒ NemÃ¡Å¡ dost materiÃ¡lÅ¯', 'warning');
      return;
    }

    if (recipe.requires && !this.hasTools(recipe.requires)) {
      this.log('âŒ PotÅ™ebujeÅ¡ sprÃ¡vnÃ© nÃ¡stroje', 'warning');
      return;
    }

    // ğŸ”¥ Check fire requirement
    if (recipe.requiresFire && !this.state.fireActive) {
      this.log('âŒ PotÅ™ebujeÅ¡ hoÅ™Ã­cÃ­ oheÅˆ', 'warning');
      return;
    }

    // ğŸ”¥ FIRE STARTER RECIPES (special handling)
    if (recipe.isFireStarter) {
      // OdeÄti materiÃ¡ly
      for (var [id, count] of Object.entries(recipe.materials)) {
        this.removeItem(id, count);
      }

      // RNG roll
      if (Math.random() < recipe.fireChance) {
        this.state.fireActive = true;
        this.state.fireFuel = 0; // Start with 0, need to add wood
        this.log('ğŸ”¥ OheÅˆ vzplanul! (' + (recipe.fireMethod) + ')', 'success');
        this.showNotification('ğŸ”¥ OheÅˆ hoÅ™Ã­!');
        
        // GA tracking
        this.track('fire_started', {
          method: recipe.fireMethod,
          day: this.state.day,
          chance: recipe.fireChance
        });
      } else {
        this.log('ğŸ’¨ NepodaÅ™ilo se... zkus znovu', 'warning');
        
        // GA tracking failure
        this.track('fire_failed', {
          method: recipe.fireMethod,
          day: this.state.day
        });
      }
      
      this.render();
      return;
    }

    // NORMAL CRAFTING (not fire starter)
    // OdeÄti materiÃ¡ly
    for (var [id, count] of Object.entries(recipe.materials)) {
      this.removeItem(id, count);
    }

    // PÅ™idej vÃ½sledek
    for (var [id, count] of Object.entries(recipe.result)) {
      this.addItem(id, count);
    }

    if (soundEffects) soundEffects.playSound('craft');
    this.log('âœ… VytvoÅ™il jsi ' + (recipe.icon) + ' ' + (recipe.name) + '', 'success');

    // GA Tracking - Craft Item
    this.track('craft_item', {
      item_name: recipe.name,
      item_id: recipe.id,
      item_tier: recipe.tier,
      day: this.state.day,
      season: this.seasons[this.state.season].name
    });

    // Unlock mechaniky
    if (recipe.unlock === 'first_entity' && this.state.entities.length === 0) {
      this.spawnEntity('gatherer');
      this.log('ğŸ‘¤ Do doupÄ›te dorazil prvnÃ­ obyvatel - SbÄ›raÄ!', 'success');
      this.showNotification('ğŸ‰ NovÃ½ obyvatel se pÅ™ipojil!');
    }

    if (recipe.unlock === 'hunter_entity') {
      var hasHunter = this.state.entities.some(function(e) { return e.type === 'hunter'); };
      if (!hasHunter) {
        this.spawnEntity('hunter');
        this.log('ğŸ¹ Lovec se pÅ™ipojil k doupÄ›ti!', 'success');
        this.showNotification('ğŸ‰ Lovec se pÅ™ipojil!');
      }
    }

    this.render();
  },

  spawnEntity: function(typeId) {
    var type = this.entityTypes.find(function(t) { return t.id === typeId); };
    if (!type) return;

    var entity = {
      id: Date.now(),
      type: typeId,
      name: type.name,
      icon: type.icon,
      status: 'idle',
      action: null,
      daysLeft: 0
    };

    this.state.entities.push(entity);
    
    // GA Tracking - Entity Joined
    this.track('entity_joined', {
      entity_type: typeId,
      entity_name: type.name,
      day: this.state.day,
      total_entities: this.state.entities.length
    });
  },

  assignAction: function(entityId, actionIndex) {
    var entity = this.state.entities.find(function(e) { return e.id === entityId); };
    if (!entity) return;

    var type = this.entityTypes.find(function(t) { return t.id === entity.type); };
    var action = type.actions[actionIndex];

    if (!this.hasTools(action.requires)) {
      this.log('âŒ Entita nemÃ¡ potÅ™ebnÃ© nÃ¡stroje', 'warning');
      return;
    }
    // ğŸ”¥ Check fire requirement for fuel action
    if (action.requiresFire && !this.state.fireActive) {
      this.log('âŒ NenÃ­ zaloÅ¾enÃ½ oheÅˆ', 'warning');
      return;
    }
    entity.status = 'working';
    entity.action = action;
    entity.daysLeft = action.duration;

    if (soundEffects) soundEffects.playSound('gather');
    this.log('' + (entity.icon) + ' ' + (entity.name) + ' zaÄal: ' + (action.name) + '', 'info');
    
    // GA Tracking - Entity Action
    this.track('entity_action', {
      entity_type: entity.type,
      action_name: action.name,
      action_duration: action.duration,
      day: this.state.day
    });
    
    this.render();
  },

  processEntities: function() {
    this.state.entities.forEach(function(entity) {
      if (entity.status === 'working' && entity.daysLeft > 0) {
        entity.daysLeft--;

        if (entity.daysLeft === 0) {
          // ğŸ”¥ FUEL ACTION (special handling)
          if (entity.action.isFuelAction) {
            var woodAvailable = this.state.inventory.wood || 0;
            if (woodAvailable >= 3) {
              this.removeItem('wood', 3);
              this.state.fireFuel += 3; // 3 wood = 2 days fuel
              this.log('' + (entity.icon) + ' ' + (entity.name) + ' pÅ™iloÅ¾il do ohnÄ› (+2 dny, -3 ğŸªµ)', 'success');
              
              // GA Tracking - Fuel Added
              this.track('fire_fueled', {
                wood_used: 3,
                fuel_added: 2,
                total_fuel: this.state.fireFuel,
                day: this.state.day
              });
            } else {
              this.log('' + (entity.icon) + ' ' + (entity.name) + ' nemÃ¡ dÅ™evo (potÅ™eba 3)', 'warning');
            }
            entity.status = 'idle';
            entity.action = null;
            return;
          }

          // SpeciÃ¡lnÃ­ zpracovÃ¡nÃ­ heating akce
          if (entity.action.isHeating) {
            var woodAvailable = this.state.inventory.wood || 0;
            if (woodAvailable >= 3) {
              this.removeItem('wood', 3);
              this.state.heating = Math.min(this.state.heating + 1, 3);
              this.log('' + (entity.icon) + ' ' + (entity.name) + ' zatopil v krbu (+5Â°C po 1 den)', 'success');
              
              // GA Tracking - Heating
              this.track('heating_action', {
                success: true,
                heating_level: this.state.heating,
                temperature: this.state.temperature,
                day: this.state.day
              });
            } else {
              this.log('' + (entity.icon) + ' ' + (entity.name) + ' nemÃ¡ dÅ™evo na topenÃ­ (potÅ™eba 3)', 'warning');
              
              // GA Tracking - Heating Failed
              this.track('heating_action', {
                success: false,
                wood_available: woodAvailable,
                temperature: this.state.temperature,
                day: this.state.day
              });
            }
            entity.status = 'idle';
            entity.action = null;
            return;
          }
          
          // Akce dokonÄena - normÃ¡lnÃ­ result
          var result = entity.action.result();
          
          var resultText = [];
          for (var [itemId, count] of Object.entries(result)) {
            if (count > 0) {
              this.addItem(itemId, count);
              var item = this.items[itemId];
              resultText.push('' + (item.icon) + ' ' + (item.name) + ' Ã—' + (count) + '');
            }
          }

          if (resultText.length > 0) {
            this.log('' + (entity.icon) + ' ' + (entity.name) + ' pÅ™inesl: ' + (resultText.join(', ')) + '', 'item');
          } else {
            this.log('' + (entity.icon) + ' ' + (entity.name) + ' se vrÃ¡til s prÃ¡zdnou', 'warning');
          }

          entity.status = 'idle';
          entity.action = null;
        }
      }
    });
  },

  triggerRandomEvent: function() {
    var currentSeason = this.seasons[this.state.season];
    
    // Filtruj udÃ¡losti podle sezÃ³ny
    var availableEvents = this.randomEvents.filter(function(event) {
      if (event.season && !event.season.includes(this.state.season)) {
        return false;
      }
      return true;
    });

    // NÃ¡hodnÃ¡ Å¡ance na udÃ¡lost
    if (Math.random() > this.state.eventChance) return;
    if (soundEffects) soundEffects.playSound('alert');

    // Vyber udÃ¡lost podle vah
    var totalChance = availableEvents.reducefunction((sum, e) sum + e.chance, 0);
    var roll = Math.random() * totalChance;

    for (var event of availableEvents) {
      roll -= event.chance;
      if (roll <= 0) {
        if (event.items) {
          for (var [itemId, range] of Object.entries(event.items)) {
            var count = Math.floor(Math.random() * (range[1] - range[0] + 1)) + range[0];
            this.addItem(itemId, count);
            var item = this.items[itemId];
            this.log(event.message + ' (+' + (count) + ' ' + (item.icon) + ')', 'item');
          }
        } else {
          this.log(event.message, 'info');
        }
        break;
      }
    }
  },

  nextDay: function() {
    if (this.state.dead) return;

    if (soundEffects) soundEffects.playSound('nextDay');
    
    this.state.day++;
    
    // ğŸµ AUTO-START MUSIC if not already playing
    if (window.atmosphericMusic && !window.atmosphericMusic.isPlaying) {
      var musicEnabled = localStorage.getItem('musicEnabled') !== 'false';
      if (musicEnabled) {
        console.log('ğŸµ Auto-starting music (not playing)');
        window.atmosphericMusic.play(this.state.season, true); // forceFirstTrack = true
        document.getElementById('music-toggle-btn').textContent = 'ğŸ”Š';
      }
    }

    // ZmÄ›na sezÃ³ny kaÅ¾dÃ½ch 15 dnÃ­
    var newSeason = Math.floor((this.state.day - 1) / 15) % 4;
    if (newSeason !== this.state.season) {
      this.state.season = newSeason;
      var season = this.seasons[this.state.season];
      this.log('' + (season.icon) + ' NastÃ¡vÃ¡ ' + (season.name) + '! ' + (season.desc) + '', 'warning');
      this.showNotification('' + (season.icon) + ' ' + (season.name) + ' zaÄÃ­nÃ¡!');
      
      // GA Tracking - Season Change
      this.track('season_change', {
        new_season: season.name,
        day: this.state.day,
        population: this.state.entities.length + 1,
        food_reserves: this.state.inventory.food || 0,
        water_reserves: this.state.inventory.water_supply || 0
      });
    }

    // GA Tracking - Day Milestones
    if (this.state.day % 10 === 0) {
      this.track('milestone_reached', {
        days_survived: this.state.day,
        season: this.seasons[this.state.season].name,
        population: this.state.entities.length + 1,
        temperature: this.state.temperature,
        food_supply: this.state.inventory.food || 0,
        water_supply: this.state.inventory.water_supply || 0
      });
    }

    var season = this.seasons[this.state.season];

    this.log('--- Den ' + (this.state.day) + ' ---', 'info');
    // ğŸ”¥ FIRE DECAY
    if (this.state.fireFuel > 0) {
      this.state.fireFuel--;
      if (this.state.fireFuel === 0) {
        this.state.fireActive = false;
        this.log('ğŸŒ«ï¸ OheÅˆ vyhasl!', 'warning');
        this.showNotification('ğŸ’¨ OheÅˆ vyhasl!');
        
        // GA Tracking - Fire Extinguished
        this.track('fire_extinguished', {
          day: this.state.day,
          reason: 'no_fuel'
        });
      } else {
        this.log('ğŸ”¥ OheÅˆ hoÅ™Ã­ (zbÃ½vÃ¡ ' + (this.state.fireFuel) + ' dnÃ­)', 'info');
      }
    }
    // VÃ½poÄet teploty
    this.calculateTemperature();
    var tempEffects = this.getTemperatureEffects();
    var tempEmoji = this.getTemperatureEmoji(this.state.temperature);
    
    // Temperature warning
    if (this.state.temperature < 5) {
      this.log('' + (tempEmoji) + ' Je mrazivÄ›! (' + (this.state.temperature) + 'Â°C) SpotÅ™eba jÃ­dla +50%', 'danger');
      // GA Tracking - Extreme Cold
      this.track('extreme_temperature', {
        type: 'freezing',
        temperature: this.state.temperature,
        day: this.state.day,
        heating_active: this.state.heating > 0
      });
    } else if (this.state.temperature < 10) {
      this.log('' + (tempEmoji) + ' Je chladno (' + (this.state.temperature) + 'Â°C) SpotÅ™eba jÃ­dla +20%', 'warning');
    } else if (this.state.temperature > 28) {
      this.log('' + (tempEmoji) + ' Je vedro! (' + (this.state.temperature) + 'Â°C) SpotÅ™eba vody +50%', 'danger');
      // GA Tracking - Extreme Heat
      this.track('extreme_temperature', {
        type: 'heatwave',
        temperature: this.state.temperature,
        day: this.state.day
      });
    } else if (this.state.temperature > 23) {
      this.log('' + (tempEmoji) + ' Je horko (' + (this.state.temperature) + 'Â°C) SpotÅ™eba vody +20%', 'warning');
    } else if (this.state.temperature >= 10 && this.state.temperature <= 20) {
      this.log('' + (tempEmoji) + ' PÅ™Ã­jemnÃ¡ teplota (' + (this.state.temperature) + 'Â°C) Efektivita +10%!', 'success');
    } else {
      this.log('' + (tempEmoji) + ' Teplota: ' + (this.state.temperature) + 'Â°C', 'info');
    }
    
    // Heating decay
    if (this.state.heating > 0) {
      this.state.heating--;
      if (this.state.heating === 0) {
        this.log('ğŸ”¥ Krb vychladl', 'info');
      }
    }

    // Zpracuj entity
    this.processEntities();

    // GarantovanÃ© kameny prvnÃ­ch 5 dnÃ­ (min 2, max 3)
    if (this.state.day <= 5) {
      var stonesGiven = this.state.guaranteedStones || 0;
      
      if (stonesGiven < 2) {
        // JeÅ¡tÄ› nemÃ¡me 2 â†’ zagarantovat 1 kÃ¡men
        this.addItem('stone', 1);
        this.log('â›°ï¸ NaÅ¡el jsi kÃ¡men! (+1)', 'item');
        this.state.guaranteedStones = stonesGiven + 1;
      } else if (stonesGiven === 2 && Math.random() < 0.5) {
        // MÃ¡me 2, Å¡ance 50% na 3.
        this.addItem('stone', 1);
        this.log('â›°ï¸ NaÅ¡el jsi kÃ¡men! (+1)', 'item');
        this.state.guaranteedStones = 3;
      }
    }

    // NÃ¡hodnÃ¡ udÃ¡lost
    this.triggerRandomEvent();

    // ğŸ—¡ï¸ Check for threats
    this.checkThreats();

    // DennÃ­ spotÅ™eba podle sezÃ³ny + POPULATION SCALING + TEMPERATURE EFFECTS
    // PrvnÃ­ entita je "free" (zÃ¡kladnÃ­ spotÅ™eba), kaÅ¾dÃ¡ dalÅ¡Ã­ +40%
    var effectivePopulation = Math.max(0, this.state.entities.length - 1);
    var populationMultiplier = 1 + (effectivePopulation * 0.4);
    
    var hungerNeeded = Math.ceil(season.hungerDrain * populationMultiplier * tempEffects.hungerMultiplier);
    var waterNeeded = Math.ceil(season.waterDrain * populationMultiplier * tempEffects.waterMultiplier);
    
    var foodAvailable = this.state.inventory.food || 0;
    var waterAvailable = this.state.inventory.water_supply || 0;

    // Info o populaci
    if (this.state.entities.length > 0) {
      this.log('ğŸ‘¥ Kolonie: ' + (this.state.entities.length + 1) + ' obyvatel (spotÅ™eba: Ã—' + (populationMultiplier.toFixed(1)) + ')', 'info');
    }

    // SpotÅ™ebuj jÃ­dlo
    if (foodAvailable >= hungerNeeded) {
      this.removeItem('food', hungerNeeded);
      this.log('ğŸ– SpotÅ™ebovÃ¡no ' + (hungerNeeded) + ' jÃ­dla', 'info');
    } else {
      if (foodAvailable > 0) {
        this.removeItem('food', foodAvailable);
        this.log('âš ï¸ SpotÅ™ebovÃ¡no jen ' + (foodAvailable) + ' jÃ­dla, chybÃ­ ' + (hungerNeeded - foodAvailable) + '', 'warning');
      }
      this.gameOver('ğŸ– Kolonie umÅ™ela hlady');
      return;
    }

    // Po zmÄ›nÄ› sezÃ³ny
    if (this.state.day % 15 === 0) {
    if (window.atmosphericMusic) {
    window.atmosphericMusic.changeSeason(this.state.season);
    }
    }

    // SpotÅ™ebuj vodu
    if (waterAvailable >= waterNeeded) {
      this.removeItem('water_supply', waterNeeded);
      this.log('ğŸ’§ SpotÅ™ebovÃ¡no ' + (waterNeeded) + ' vody', 'info');
    } else {
      if (waterAvailable > 0) {
        this.removeItem('water_supply', waterAvailable);
        this.log('âš ï¸ SpotÅ™ebovÃ¡na jen ' + (waterAvailable) + ' voda, chybÃ­ ' + (waterNeeded - waterAvailable) + '', 'warning');
      }
      this.gameOver('ğŸ’§ Kolonie umÅ™ela Å¾Ã­znÃ­');
      return;
    }

    this.render();
  },

  gameOver: function(reason) {
    this.state.dead = true;
    reason = reason || 'NepÅ™eÅ¾il jsi';
    
    // Zkontroluj jestli je to novÃ½ osobnÃ­ rekord
    var isNewBestRun = this.state.day > this.state.bestRun;
    
    // GA Tracking - Game Over (detailed)
    this.track('game_over', {
      death_reason: reason,
      days_survived: this.state.day,
      final_season: this.seasons[this.state.season].name,
      population: this.state.entities.length + 1,
      final_temperature: this.state.temperature,
      food_remaining: this.state.inventory.food || 0,
      water_remaining: this.state.inventory.water_supply || 0,
      had_fireplace: (this.state.inventory.fireplace || 0) > 0,
      had_insulation: (this.state.inventory.insulation || 0) > 0,
      shelter_level: this.state.shelterLevel,
      fire_was_active: this.state.fireActive, // ğŸ”¥
      is_new_best: isNewBestRun
    });
    
    // Pokud je novÃ½ rekord, zobraz nickname modal mÃ­sto bÄ›Å¾nÃ©ho game over
    if (isNewBestRun) {
      this.showNicknameModal(reason);
      return;
    }
    
    // BÄ›Å¾nÃ½ game over screen
    var overlay = document.createElement('div');
    overlay.style.cssText = '
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      animation: fadeIn 0.5s ease-out;
    ';
    overlay.innerHTML = '
      <div style="
        background: linear-gradient(145deg, #1a1410, #2d2416);
        padding: 50px;
        border-radius: 24px;
        text-align: center;
        border: 2px solid rgba(192, 80, 77, 0.5);
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.9);
        animation: scaleIn 0.5s ease-out 0.2s both;
      ">
        <h1 style="
          color: #e67e7b;
          font-size: 48px;
          margin-bottom: 20px;
          font-family: 'Space Mono', monospace;
          text-shadow: 0 4px 12px rgba(230, 126, 123, 0.5);
        ">ğŸ’€ GAME OVER</h1>
        <p style="
          color: #d4a574;
          font-size: 20px;
          margin-bottom: 30px;
          font-family: 'Crimson Pro', serif;
        ">' + (reason) + '</p>
        <p style="
          color: #9a8670;
          font-size: 16px;
          margin-bottom: 30px;
          font-family: 'Space Mono', monospace;
        ">PÅ™eÅ¾il jsi ' + (this.state.day) + ' dnÃ­</p>
        <button onclick="game.confirmReset()" style="
          padding: 16px 32px;
          font-size: 18px;
          background: linear-gradient(135deg, #8b5a2b, #a67c52);
          color: white;
          border: none;
          border-radius: 12px;
          cursor: pointer;
          font-family: 'Space Mono', monospace;
          font-weight: 700;
          box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
        ">ğŸ”„ Zkusit znovu</button>
      </div>
    ';
    
    var style = document.createElement('style');
    style.textContent = '
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      @keyframes scaleIn {
        from { transform: scale(0.8); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
      }
    ';
    document.head.appendChild(style);
    
    document.body.appendChild(overlay);
  },

  showNicknameModal: function(reason) {
    // Lock scroll
    this.openModal();
    
    var modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.id = 'nickname-modal';
    
    modal.innerHTML = '
      <div class="modal-content">
        <div class="modal-title">ğŸ‰ NOVÃ OSOBNÃ REKORD!</div>
        <p class="nickname-info">PÅ™eÅ¾il jsi <strong>' + (this.state.day) + ' dnÃ­</strong></p>
        <p class="nickname-info" style="font-size: 12px; color: #9a8670; margin-top: -5px;">
          PÅ™edchozÃ­ rekord: ' + (this.state.bestRun) + ' dnÃ­
        </p>
        <p class="nickname-info" style="margin-top: 15px;">Zadej svou pÅ™ezdÃ­vku pro Å¾ebÅ™Ã­Äek:</p>
        <input 
          type="text" 
          class="nickname-input" 
          id="nickname-input"
          placeholder="Tvoje pÅ™ezdÃ­vka..." 
          maxlength="20"
          value="' + (this.state.playerNickname || '') + '"
        />
        <div class="modal-buttons">
          <button class="modal-btn modal-btn-primary" onclick="game.saveHighScoreToSheet()">
            ğŸ’¾ UloÅ¾it do Å¾ebÅ™Ã­Äku
          </button>
          <button class="modal-btn modal-btn-secondary" onclick="game.skipNickname()">
            PÅ™eskoÄit
          </button>
        </div>
      </div>
    ';
    
    document.body.appendChild(modal);
    
    // Focus na input
    setTimeout(function() {
      document.getElementById('nickname-input').focus();
    }, 100);
    
    // Enter key = save
    document.getElementById('nickname-input').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        this.saveHighScoreToSheet();
      }
    });
  },

  saveHighScoreToSheet: function() {
    var nicknameInput = document.getElementById('nickname-input');
    var nickname = nicknameInput.value.trim() || 'Anonymous';
    
    // UloÅ¾ nickname do localStorage
    this.state.playerNickname = nickname;
    localStorage.setItem('doupe_nickname', nickname);
    
    // UloÅ¾ best run
    this.state.bestRun = this.state.day;
    localStorage.setItem('doupe_best_run', this.state.day.toString());
    
    // OdeÅ¡li do Google Sheets
    var data = {
      playerId: this.state.playerId,
      nickname: nickname,
      days: this.state.day,
      season: this.seasons[this.state.season].name,
      population: this.state.entities.length + 1,
      temperature: this.state.temperature,
      foodLeft: this.state.inventory.food || 0,
      waterLeft: this.state.inventory.water_supply || 0
    };
    
    // Zobraz loading
    nicknameInput.disabled = true;
    nicknameInput.value = 'UklÃ¡dÃ¡m...';
    
    this.backend('saveHighScore', data)
      .then(function(response) {
        if (response.success) {
          console.log('High score saved:', response);
          this.closeModal('nickname-modal');
          this.showGameOverScreen('ğŸ† ' + (response.message) + '');
        } else if (response.standalone) {
          // Standalone mode - save locally only
          console.log('Standalone mode - saved locally');
          this.closeModal('nickname-modal');
          this.showGameOverScreen('ğŸ’€ GAME OVER (Local save)');
        } else {
          throw new Error(response.message || 'Unknown error');
        }
      })
      .catch(function(error) {
        console.error('Error saving high score:', error);
        alert('Chyba pÅ™i uklÃ¡dÃ¡nÃ­: ' + (error.message || error));
        nicknameInput.disabled = false;
        nicknameInput.value = nickname;
      });
  },

  skipNickname: function() {
    // UloÅ¾ best run bez odeslÃ¡nÃ­ do sheets
    this.state.bestRun = this.state.day;
    localStorage.setItem('doupe_best_run', this.state.day.toString());
    
    this.closeModal('nickname-modal');
    this.showGameOverScreen('ğŸ’€ GAME OVER');
  },

  showGameOverScreen: function(title) {
    var overlay = document.createElement('div');
    overlay.style.cssText = '
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      animation: fadeIn 0.5s ease-out;
    ';
    overlay.innerHTML = '
      <div style="
        background: linear-gradient(145deg, #1a1410, #2d2416);
        padding: 50px;
        border-radius: 24px;
        text-align: center;
        border: 2px solid rgba(192, 80, 77, 0.5);
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.9);
        animation: scaleIn 0.5s ease-out 0.2s both;
      ">
        <h1 style="
          color: #e67e7b;
          font-size: 48px;
          margin-bottom: 20px;
          font-family: 'Space Mono', monospace;
          text-shadow: 0 4px 12px rgba(230, 126, 123, 0.5);
        ">' + (title) + '</h1>
        <p style="
          color: #9a8670;
          font-size: 16px;
          margin-bottom: 30px;
          font-family: 'Space Mono', monospace;
        ">PÅ™eÅ¾il jsi ' + (this.state.day) + ' dnÃ­</p>
        <button onclick="game.confirmReset()" style="
          padding: 16px 32px;
          font-size: 18px;
          background: linear-gradient(135deg, #8b5a2b, #a67c52);
          color: white;
          border: none;
          border-radius: 12px;
          cursor: pointer;
          font-family: 'Space Mono', monospace;
          font-weight: 700;
          box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
        ">ğŸ”„ Zkusit znovu</button>
      </div>
    ';
    
    document.body.appendChild(overlay);
  },

  showLeaderboard: function() {
    // Lock scroll
    this.openModal();
    
    // Zobraz loading
    var loadingModal = document.createElement('div');
    loadingModal.className = 'modal-overlay';
    loadingModal.id = 'leaderboard-modal';
    loadingModal.innerHTML = '
      <div class="modal-content">
        <div class="modal-title">ğŸ† Å½EBÅ˜ÃÄŒEK</div>
        <p class="nickname-info">NaÄÃ­tÃ¡m data...</p>
      </div>
    ';
    document.body.appendChild(loadingModal);
    
    // NaÄti data z Sheets (pÅ™es API)
    this.backend('getLeaderboard')
      .then(function(response) {
        if (response.success) {
          this.renderLeaderboard(response.data);
        } else {
          // API failed - show error or standalone
          console.error('Leaderboard load failed:', response);
          alert('Chyba pÅ™i naÄÃ­tÃ¡nÃ­ Å¾ebÅ™Ã­Äku: ' + (response.message || response.error));
          this.closeModal('leaderboard-modal');
        }
      })
      .catch(function(error) {
        console.error('Leaderboard error:', error);
        alert('Chyba pÅ™i naÄÃ­tÃ¡nÃ­ Å¾ebÅ™Ã­Äku: ' + error.message);
        this.closeModal('leaderboard-modal');
      });
  },

  renderLeaderboard: function(data) {
    var modal = document.getElementById('leaderboard-modal');
    
    var tableRows = '';
    if (data.length === 0) {
      tableRows = '<tr><td colspan="4" style="text-align: center; padding: 30px; color: #9a8670;">Å½ebÅ™Ã­Äek je zatÃ­m prÃ¡zdnÃ½...</td></tr>';
    } else {
      tableRows = data.map(function(entry) {
        var rankClass = entry.rank <= 3 ? 'rank-' + (entry.rank) + '' : 'rank-other';
        var isYou = entry.playerId === this.state.playerId;
        var rowClass = isYou ? 'your-rank' : '';
        
        return '
          <tr class="' + (rowClass) + '">
            <td><span class="rank-badge ' + (rankClass) + '">' + (entry.rank) + '</span></td>
            <td>' + (entry.nickname) + '' + (isYou ? ' <strong>(ty)</strong>' : '') + '</td>
            <td><strong>' + (entry.days) + 'd</strong></td>
            <td>' + (this.getSeasonIcon(entry.season)) + ' ' + (entry.population) + 'ğŸ‘¥</td>
          </tr>
        ';
      }).join('');
    }
    
    modal.innerHTML = '
      <div class="modal-content">
        <div class="modal-title">ğŸ† TOP 10 KOLONIÃ</div>
        <table class="leaderboard-table">
          <thead>
            <tr>
              <th>#</th>
              <th>JmÃ©no</th>
              <th>Dny</th>
              <th>Info</th>
            </tr>
          </thead>
          <tbody>
            ' + (tableRows) + '
          </tbody>
        </table>
        <div class="modal-buttons">
          <button class="modal-btn modal-btn-secondary" onclick="game.closeModal('leaderboard-modal')">
            ZavÅ™Ã­t
          </button>
        </div>
      </div>
    ';
  },

  getSeasonIcon: function(seasonName) {
    var icons = {
      'Jaro': 'ğŸŒ±',
      'LÃ©to': 'â˜€ï¸',
      'Podzim': 'ğŸ‚',
      'Zima': 'â„ï¸'
    };
    return icons[seasonName] || 'ğŸŒ';
  },

  // ğŸ’¾ SAVE & LOAD GAME
  saveGame: function() {
    try {
      var saveData = JSON.stringify(this.state);
      
      // Save via backend (Apps Script) or localStorage (standalone)
      if (this.isAppsScript()) {
        this.backend('saveGameState', saveData)
          .then(function(response) {
            if (response.success) {
              this.log('ğŸ’¾ ' + response.message, 'success');
              this.showNotification('ğŸ’¾ Hra uloÅ¾ena!');
            } else {
              throw new Error(response.message);
            }
          })
          .catch(function(error) {
            this.log('âŒ Chyba pÅ™i uklÃ¡dÃ¡nÃ­: ' + error, 'danger');
          });
      } else {
        // Standalone - localStorage
        localStorage.setItem('doupe_save', saveData);
        this.log('ğŸ’¾ Hra uloÅ¾ena (lokÃ¡lnÄ›)', 'success');
        this.showNotification('ğŸ’¾ Hra uloÅ¾ena!');
      }
      
      // GA Tracking
      this.track('game_saved', {
        day: this.state.day,
        season: this.seasons[this.state.season].name,
        population: this.state.entities.length + 1
      });
      
    } catch(e) {
      this.log('âŒ NepodaÅ™ilo se uloÅ¾it hru', 'danger');
      console.error('Save error:', e);
    }
  },

  /**
   * ğŸ“‚ LOAD GAME
   * 
   * NaÄte uloÅ¾enou hru a zobrazÃ­ modal s preview (den, sezÃ³na, zÃ¡soby).
   * âš ï¸ MUSÃ zobrazit modal - ne pÅ™Ã­mo naÄÃ­st!
   * User mÅ¯Å¾e potvrdit nebo zruÅ¡it naÄtenÃ­.
   * 
   * @returns {void}
   * @fires game.openModal - Locks body scroll
   * @fires game.showLoadConfirmModal - Displays preview modal
   * @fires game.backend - In Apps Script mode
   * @sideeffects Adds modal to DOM, locks scroll
   * 
   * @example
   * game.loadGame(); // ZobrazÃ­ modal s preview
   * 
   * @see confirmLoad() - Actual load happens here after confirmation
   * @tested âœ… 2026-02-08 - Modal displays correctly
   */
  loadGame: function() {
    console.log('ğŸ”„ loadGame() called');
    
    // Lock scroll
    this.openModal();
    console.log('âœ… Modal locked');
    
    // Show loading modal first
    var loadingModal = document.createElement('div');
    loadingModal.className = 'modal-overlay';
    loadingModal.id = 'load-modal';
    loadingModal.innerHTML = '
      <div class="modal-content">
        <div class="modal-title">ğŸ“‚ NAÄŒÃST HRU</div>
        <p class="nickname-info">NaÄÃ­tÃ¡m uloÅ¾enou hru...</p>
      </div>
    ';
    document.body.appendChild(loadingModal);
    console.log('âœ… Loading modal added to DOM');
    
    // Load save data
    var loadSaveData = function() {
      if (this.isAppsScript()) {
        console.log('ğŸŒ Apps Script mode - calling backend');
        return this.backend('loadGameState');
      } else {
        console.log('ğŸ’¾ Standalone mode - checking localStorage');
        // Standalone - localStorage
        var saved = localStorage.getItem('doupe_save');
        if (saved) {
          console.log('âœ… Save found in localStorage');
          return Promise.resolve({ success: true, data: saved });
        } else {
          console.log('âŒ No save in localStorage');
          return Promise.resolve({ success: false, message: 'Å½Ã¡dnÃ¡ uloÅ¾enÃ¡ hra' });
        }
      }
    };
    
    loadSaveData()
      .then(function(response) {
        console.log('ğŸ“¦ Response:', response);
        if (response.success && response.data) {
          var saveState = JSON.parse(response.data);
          console.log('âœ… Save state parsed:', saveState);
          this.showLoadConfirmModal(saveState);
        } else {
          // No save found
          console.log('âŒ No save found - closing modal');
          this.closeModal('load-modal');
          this.log('âŒ Å½Ã¡dnÃ¡ uloÅ¾enÃ¡ hra nenalezena', 'warning');
          this.showNotification('âŒ Å½Ã¡dnÃ¡ uloÅ¾enÃ¡ hra');
        }
      })
      .catch(function(error) {
        console.error('âŒ Error loading save:', error);
        this.closeModal('load-modal');
        this.log('âŒ Chyba pÅ™i naÄÃ­tÃ¡nÃ­: ' + error, 'danger');
        alert('Chyba pÅ™i naÄÃ­tÃ¡nÃ­: ' + error.message);
      });
  },

  // ğŸ“‚ SHOW LOAD CONFIRM MODAL - zobrazÃ­ preview save a potvrzenÃ­
  showLoadConfirmModal: function(saveState) {
    var modal = document.getElementById('load-modal');
    
    if (!modal) {
      console.error('Load modal not found!');
      return;
    }
    
    // BezpeÄnÃ© naÄtenÃ­ sezÃ³ny
    var seasonIndex = saveState.season || 0;
    var season = this.seasons[seasonIndex] || this.seasons[0];
    var population = ((saveState.entities && saveState.entities.length) || 0) + 1;
    
    // BezpeÄnÃ½ vÃ½poÄet dnÃ­ (pokud drain je 0, nastav "âˆ")
    var hungerDrain = season.hungerDrain || 1;
    var waterDrain = season.waterDrain || 1;
    var foodDays = Math.floor(((saveState.inventory && saveState.inventory.food) || 0) / hungerDrain);
    var waterDays = Math.floor(((saveState.inventory && saveState.inventory.water_supply) || 0) / waterDrain);
    
    modal.innerHTML = '
      <div class="modal-content">
        <div class="modal-title">ğŸ“‚ NAÄŒÃST ULOÅ½ENOU HRU?</div>
        
        <div style="text-align: left; color: #b89968; line-height: 1.6; margin: 20px 0; background: rgba(20, 16, 12, 0.6); padding: 20px; border-radius: 12px; border: 1px solid rgba(139, 90, 43, 0.3);">
          <p style="margin-bottom: 12px; font-size: 16px; color: #d4a574;">
            <strong>ğŸ“Š Informace o uloÅ¾enÃ© hÅ™e:</strong>
          </p>
          
          <p style="margin-bottom: 8px;">
            ğŸ“… <strong>Den:</strong> ' + (saveState.day || 1) + ' (' + (season.icon) + ' ' + (season.name) + ')
          </p>
          
          <p style="margin-bottom: 8px;">
            ğŸ‘¥ <strong>Kolonie:</strong> ' + (population) + ' obyvatel
          </p>
          
          <p style="margin-bottom: 8px;">
            ğŸ– <strong>JÃ­dlo:</strong> ' + ((saveState.inventory && saveState.inventory.food) || 0) + ' (' + (foodDays) + 'd)
          </p>
          
          <p style="margin-bottom: 8px;">
            ğŸ’§ <strong>Voda:</strong> ' + ((saveState.inventory && saveState.inventory.water_supply) || 0) + ' (' + (waterDays) + 'd)
          </p>
          
          <p style="margin-bottom: 8px;">
            ğŸŒ¡ï¸ <strong>Teplota:</strong> ' + (saveState.temperature || 15) + 'Â°C
          </p>
          
          <p style="margin-bottom: 8px;">
            ğŸ’° <strong>Zlato:</strong> ' + (saveState.gold || 0) + 'g
          </p>
          
          ' + (saveState.fireActive ? '<p style="margin-bottom: 8px; color: #ff9944;">ğŸ”¥ <strong>OheÅˆ hoÅ™Ã­!</strong></p>' : '') + '
        </div>
        
        <p class="nickname-info" style="color: #e67e7b; font-size: 13px; margin-top: -10px;">
          âš ï¸ SouÄasnÃ½ postup bude ztracen!
        </p>
        
        <div class="modal-buttons">
          <button class="modal-btn modal-btn-primary" onclick="game.confirmLoad()">
            âœ… NaÄÃ­st tuto hru
          </button>
          <button class="modal-btn modal-btn-secondary" onclick="game.closeModal('load-modal')">
            âŒ ZruÅ¡it
          </button>
        </div>
      </div>
    ';
    
    // Store save state for confirmLoad
    this._pendingSaveState = saveState;
  },

  // âœ… CONFIRM LOAD - potvrzenÃ­ a naÄtenÃ­ hry
  confirmLoad: function() {
    if (!this._pendingSaveState) return;
    
    try {
      // Load the saved state
      this.state = this._pendingSaveState;
      delete this._pendingSaveState;
      
      // Close modal
      this.closeModal('load-modal');
      
      // Success feedback
      this.log('ğŸ“‚ Hra ÃºspÄ›Å¡nÄ› naÄtena!', 'success');
      this.showNotification('ğŸ“‚ Hra naÄtena!');
      
      // GA Tracking
      this.track('game_loaded', {
        day: this.state.day,
        season: this.seasons[this.state.season].name,
        population: this.state.entities.length + 1
      });
      
      // ğŸµ AUTO-START MUSIC after loading game
      if (window.atmosphericMusic && !window.atmosphericMusic.isPlaying) {
        var musicEnabled = localStorage.getItem('musicEnabled') !== 'false';
        if (musicEnabled) {
          console.log('ğŸµ Auto-starting music after Load Game');
          window.atmosphericMusic.play(this.state.season, true); // forceFirstTrack = true
          document.getElementById('music-toggle-btn').textContent = 'ğŸ”Š';
        }
      }
      
      // Re-render everything
      this.render();
      
    } catch(e) {
      this.closeModal('load-modal');
      this.log('âŒ Chyba pÅ™i naÄÃ­tÃ¡nÃ­ hry', 'danger');
      console.error('Load error:', e);
    }
  },

  reset: function() {
    // If player is alive (not in game over), show warning modal
    if (!this.state.dead) {
      this.showResetWarningModal();
      return;
    }
    
    // If dead, reset immediately (from game over screen)
    this.confirmReset();
  },

  // âš ï¸ RESET WARNING MODAL - zobrazÃ­ pÅ™ed resetem Å¾ivÃ© hry
  showResetWarningModal: function() {
    // Lock scroll
    this.openModal();
    
    var modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.id = 'reset-warning-modal';
    
    // Calculate current stats
    var season = this.seasons[this.state.season];
    var population = this.state.entities.length + 1;
    var foodLeft = this.state.inventory.food || 0;
    var waterLeft = this.state.inventory.water_supply || 0;
    var goldLeft = this.state.gold || 0;
    
    // Days remaining calculation
    var hungerDrain = season.hungerDrain || 1;
    var waterDrain = season.waterDrain || 1;
    var foodDays = Math.floor(foodLeft / hungerDrain);
    var waterDays = Math.floor(waterLeft / waterDrain);
    var survivalDays = Math.min(foodDays, waterDays);
    
    // Count valuable items
    var storage = this.state.inventory.storage || 0;
    var fireplace = this.state.inventory.fireplace || 0;
    var insulation = this.state.inventory.insulation || 0;
    var wall = this.state.inventory.wall || 0;
    var hasInfrastructure = storage > 0 || fireplace > 0 || insulation > 0 || wall > 0;
    
    modal.innerHTML = '
      <div class="modal-content" style="max-width: 600px;">
        <div class="modal-title" style="color: #e67e7b;">âš ï¸ OPRAVDU CHCEÅ  ZAÄŒÃT ZNOVU?</div>
        
        <div style="text-align: left; color: #b89968; line-height: 1.8; margin: 25px 0;">
          
          <!-- Main Warning Message -->
          <div style="background: rgba(192, 80, 77, 0.15); padding: 20px; border-radius: 12px; border: 2px solid rgba(192, 80, 77, 0.4); margin-bottom: 20px;">
            <p style="font-size: 16px; font-weight: 700; color: #e67e7b; margin-bottom: 12px;">
              âš ï¸ Kolonie stÃ¡le zÃ¡visÃ­ na tvÃ©m Å¾ivotÄ›!
            </p>
            <p style="font-size: 14px; color: #d4a574; margin-bottom: 8px;">
              ğŸ“ Postupuj ve hÅ™e tlaÄÃ­tkem <strong>Next Day</strong>. PÅ™eci si nepÅ™ejete zaÄÃ­nat zcela znovu.
            </p>
            <p style="font-size: 14px; color: #d4a574;">
              ğŸ’¾ NezapomeÅˆte si <strong>uklÃ¡dat hru pÅ™i hranÃ­</strong> - vÃ¡Å¡ pokrok je cennÃ½!
            </p>
          </div>

          <!-- Current Stats -->
          <div style="background: rgba(20, 16, 12, 0.6); padding: 20px; border-radius: 12px; border: 1px solid rgba(139, 90, 43, 0.3); margin-bottom: 20px;">
            <p style="font-size: 15px; font-weight: 700; color: #d4a574; margin-bottom: 15px;">
              ğŸ“Š CO ZTRATÃÅ  RESETEM:
            </p>
            
            <div style="display: grid; gap: 10px; font-size: 13px;">
              <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(139, 90, 43, 0.2);">
                <span>ğŸ“… PÅ™eÅ¾itÃ© dny:</span>
                <strong style="color: #d4a574;">' + (this.state.day) + ' dnÃ­</strong>
              </div>
              
              <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(139, 90, 43, 0.2);">
                <span>' + (season.icon) + ' SezÃ³na:</span>
                <strong style="color: #d4a574;">' + (season.name) + '</strong>
              </div>
              
              <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(139, 90, 43, 0.2);">
                <span>ğŸ‘¥ Populace:</span>
                <strong style="color: #d4a574;">' + (population) + ' obyvatel</strong>
              </div>
              
              <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(139, 90, 43, 0.2);">
                <span>ğŸ– JÃ­dlo:</span>
                <strong style="color: ' + (foodLeft < 20 ? '#e67e7b' : '#7bc876') + ';">' + (foodLeft) + ' (' + (foodDays) + 'd)</strong>
              </div>
              
              <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(139, 90, 43, 0.2);">
                <span>ğŸ’§ Voda:</span>
                <strong style="color: ' + (waterLeft < 20 ? '#e67e7b' : '#7bc876') + ';">' + (waterLeft) + ' (' + (waterDays) + 'd)</strong>
              </div>
              
              <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(139, 90, 43, 0.2);">
                <span>ğŸŸ¡ Zlato:</span>
                <strong style="color: #f4d03f;">' + (goldLeft) + 'g</strong>
              </div>
              
              <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(139, 90, 43, 0.2);">
                <span>ğŸŒ¡ï¸ Teplota:</span>
                <strong style="color: ' + (this.state.temperature < 10 ? '#7bc9ff' : this.state.temperature > 23 ? '#e67e7b' : '#7bc876') + ';">' + (this.state.temperature) + 'Â°C</strong>
              </div>
              
              ' + (hasInfrastructure ? '
              <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(139, 90, 43, 0.2);">
                <span>ğŸ—ï¸ Infrastruktura:</span>
                <strong style="color: #d4a574;">
                  ' + (storage > 0 ? 'ğŸ“¦ ' : '') + '' + (fireplace > 0 ? 'ğŸ”¥ ' : '') + '' + (insulation > 0 ? 'ğŸ§± ' : '') + '' + (wall > 0 ? 'ğŸ›¡ï¸ ' : '') + '
                </strong>
              </div>
              ' : '') + '
              
              <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                <span>â° PÅ™eÅ¾ijeÅ¡ jeÅ¡tÄ›:</span>
                <strong style="color: ' + (survivalDays < 5 ? '#e67e7b' : survivalDays < 15 ? '#f4d03f' : '#7bc876') + ';">
                  ~' + (survivalDays) + ' dnÃ­
                </strong>
              </div>
            </div>
          </div>

          <!-- Final Warning -->
          <div style="text-align: center; padding: 15px; background: rgba(192, 80, 77, 0.1); border-radius: 8px; border: 1px solid rgba(192, 80, 77, 0.3);">
            <p style="font-size: 13px; color: #e67e7b; font-weight: 700;">
              ğŸ’€ Resetem zniÄÃ­Å¡ celÃ½ tento svÄ›t a zaÄneÅ¡ od zaÄÃ¡tku!
            </p>
          </div>
        </div>
        
        <div class="modal-buttons">
          <button class="modal-btn modal-btn-secondary" onclick="game.closeModal('reset-warning-modal')">
            âœ‹ ZruÅ¡it - PokraÄovat ve hÅ™e
          </button>
          <button class="modal-btn modal-btn-danger" onclick="game.confirmReset()" style="background: linear-gradient(135deg, #c0504d, #e67e7b); border-color: rgba(230, 126, 123, 0.5);">
            ğŸ’€ Opravdu Resetovat
          </button>
        </div>
      </div>
    ';
    
    document.body.appendChild(modal);
  },

  // ğŸ”„ CONFIRM RESET - samotnÃ½ reset po potvrzenÃ­
  confirmReset: function() {
    // Close any modals
    this.closeModal('reset-warning-modal');
    
    // OdstraÅˆ game over overlay pokud existuje
    var overlay = document.querySelector('div[style*="position: fixed"]');
    if (overlay) overlay.remove();
    
    // OdstraÅˆ modals
    var modal = document.getElementById('leaderboard-modal') || document.getElementById('nickname-modal');
    if (modal) modal.remove();

    // GA Tracking - Game Reset
    var wasDead = this.state.dead;
    var finalDay = this.state.day;
    
    this.track('game_reset', {
      was_dead: wasDead,
      previous_days: finalDay,
      reset_type: wasDead ? 'after_death' : 'manual_restart'
    });
    
    // Zachovej player data
    var savedPlayerId = this.state.playerId;
    var savedNickname = this.state.playerNickname;
    var savedBestRun = this.state.bestRun;

    this.state = {
      day: 1,
      season: 0,
      dead: false,
      inventory: {},
      entities: [],
      unlockedRecipes: [],
      eventChance: 0.5,
      temperature: 15,
      shelterLevel: 1,
      heating: 0,
      guaranteedStones: 0,
      playerId: savedPlayerId,
      playerNickname: savedNickname,
      bestRun: savedBestRun,
      fireActive: false,
      fireFuel: 0,
      gold: 0,
      weatherMode: 'game',
      weatherData: null,
      lastWeatherFetch: 0
    };

    document.getElementById('log').innerHTML = '';
    this.init();
  },

  renderInventory: function() {
    var el = document.getElementById('inventory');
    el.innerHTML = '';

    var entries = Object.entries(this.state.inventory ?? {});

    if (entries.length === 0) {
      el.innerHTML = '<div class="empty-state">InventÃ¡Å™ je prÃ¡zdnÃ½...</div>';
      return;
    }

    entries.forEachfunction(([id, count]) {
      var item = this.items[id];
      if (!item) return;

      var card = document.createElement('div');
      card.className = 'item-card';
      
      // ğŸ’° ECONOMY: Sell button (pro vÅ¡echno kromÄ› food/water)
      var actionButton = '';
      if (item.sellPrice && id !== 'food' && id !== 'water_supply') {
        actionButton = '
          <button class="item-action-btn item-sell-btn" onclick="game.sellItem('' + (id) + '', 1)">
            ğŸŸ¡ ' + (item.sellPrice) + 'g
          </button>
        ';
      }
      
      // ğŸ’° ECONOMY: Buy button (jen pro food/water)
      if (item.buyPrice && (id === 'food' || id === 'water_supply')) {
        actionButton = '
          <button class="item-action-btn item-buy-btn" onclick="game.buyItem('' + (id) + '', 1)">
            ğŸ·ï¸ ' + (item.buyPrice) + 'g
          </button>
        ';
      }
      
      card.innerHTML = '
        <div class="item-icon">' + (item.icon) + '</div>
        <div class="item-details">
          <div class="item-name">' + (item.name) + '</div>
          <div class="item-desc">' + (item.desc) + '</div>
        </div>
        <div class="item-count">Ã—' + (count) + '</div>
        ' + (actionButton) + '
      ';

      el.appendChild(card);
    });
  },

  renderRecipes: function() {
    var el = document.getElementById('recipes');
    el.innerHTML = '';

    // Zobraz jen odemÄenÃ© recepty
    var availableRecipes = this.recipes.filter(function(r) { return this.state.unlockedRecipes.includes(r.id)
    ); };

    if (availableRecipes.length === 0) {
      el.innerHTML = '<div class="empty-state">ZatÃ­m Å¾Ã¡dnÃ© recepty...</div>';
      return;
    }

    availableRecipes.forEach(function(recipe) {
      var canCraft = this.hasMaterials(recipe.materials) && 
                       this.hasTools(recipe.requires);

      var card = document.createElement('div');
      card.className = 'recipe-card ' + (canCraft ? 'can-craft' : 'cannot-craft') + '';

      var mats = Object.entries(recipe.materials)
        .mapfunction(([id, needed]) {
          var have = this.state.inventory[id] || 0;
          var item = this.items[id];
          return '' + (item.icon) + ' ' + (have) + '/' + (needed) + '';
        })
        .join(' â€¢ ');

      var requiresText = '';
      if (recipe.requires) {
        requiresText = ' | VyÅ¾aduje: ' + Object.keys(recipe.requires)
          .map(function(id) { return this.items[id].icon; })
          .join(' ');
      }

      card.innerHTML = '
        <div class="recipe-header">
          <div class="recipe-icon">' + (recipe.icon) + '</div>
          <div class="recipe-name">' + (recipe.name) + '</div>
        </div>
        <div class="recipe-materials">' + (mats) + '' + (requiresText) + '</div>
      ';

      if (canCraft) {
        card.onclick = function() { return this.craft(recipe.id); };
      }

      el.appendChild(card);
    });
  },

  renderEntities: function() {
    var section = document.getElementById('entities-section');
    var el = document.getElementById('entities');

    if (this.state.entities.length === 0) {
      section.style.display = 'none';
      return;
    }

    section.style.display = 'block';
    el.innerHTML = '';

    this.state.entities.forEach(function(entity) {
      var type = this.entityTypes.find(function(t) { return t.id === entity.type); };
      
      var card = document.createElement('div');
      card.className = 'entity-card';

      var statusText = 'NeÄinnÃ½';
      if (entity.status === 'working') {
        statusText = '' + (entity.action.name) + ' (' + (entity.daysLeft) + ' dnÃ­)';
      }

      card.innerHTML = '
        <div class="entity-header">
          <div class="entity-icon">' + (entity.icon) + '</div>
          <div class="entity-info">
            <div class="entity-name">' + (entity.name) + '</div>
            <div class="entity-status">' + (statusText) + '</div>
          </div>
        </div>
      ';

      if (entity.status === 'idle') {
        var actionsDiv = document.createElement('div');
        actionsDiv.className = 'entity-actions';

        type.actions.forEachfunction((action, index) {
          var canDo = this.hasTools(action.requires);
          var btn = document.createElement('button');
          btn.className = 'entity-action-btn';
          btn.textContent = action.name;
          btn.disabled = !canDo;
          btn.onclick = function() { return this.assignAction(entity.id, index); };
          actionsDiv.appendChild(btn);
        });

        card.appendChild(actionsDiv);
      }

      el.appendChild(card);
    });
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // âš ï¸ CRITICAL FUNCTION - MAIN RENDER
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  /**
   * ğŸ¨ RENDER GAME
   * 
   * Aktualizuje celÃ© UI podle aktuÃ¡lnÃ­ho stavu (this.state).
   * VolÃ¡ vÅ¡echny sub-render funkce (renderInventory, renderRecipes, atd.).
   * 
   * âš ï¸ MUSÃ bÃ½t volÃ¡no po kaÅ¾dÃ© zmÄ›nÄ› stavu!
   * 
   * @returns {void}
   * @fires renderInventory() - Updates inventory display
   * @fires renderRecipes() - Updates recipe cards
   * @fires renderEntities() - Updates entities section
   * @fires updateFireIndicator() - Updates fire status
   * @fires updateFooterStats() - Updates footer statistics
   * @fires autoUnlockRecipes() - Checks for new recipes to unlock
   * @sideeffects Updates entire DOM based on game state
   * 
   * @example
   * game.state.day++;
   * game.render(); // Update UI
   * 
   * @tested âœ… 2026-02-08 - All sections update correctly
   */
  render: function() {
    document.getElementById('day').textContent = this.state.day;
    var season = this.seasons[this.state.season];
    document.getElementById('season').textContent = season.name;

    // Population multiplier + temperature effects pro consumption
    var effectivePopulation = Math.max(0, this.state.entities.length - 1);
    var populationMultiplier = 1 + (effectivePopulation * 0.4);
    var tempEffects = this.getTemperatureEffects();

    // ZobrazÃ­me kolik mÃ¡Å¡ vs. kolik potÅ™ebujeÅ¡ na dalÅ¡Ã­ den
    var hungerNeeded = Math.ceil(season.hungerDrain * populationMultiplier * tempEffects.hungerMultiplier);
    var waterNeeded = Math.ceil(season.waterDrain * populationMultiplier * tempEffects.waterMultiplier);
    
    var foodHave = this.state.inventory.food || 0;
    var waterHave = this.state.inventory.water_supply || 0;
    
    // VypoÄÃ­tej kolik dnÃ­ ti to vydrÅ¾Ã­
    var foodDays = hungerNeeded > 0 ? Math.floor(foodHave / hungerNeeded) : 0;
    var waterDays = waterNeeded > 0 ? Math.floor(waterHave / waterNeeded) : 0;
    
    // Bar ukazuje kolik dnÃ­ ti to vydrÅ¾Ã­ (max 20 dnÃ­ = 100%)
    var hungerPercent = Math.min(100, (foodDays / 20) * 100);
    var waterPercent = Math.min(100, (waterDays / 20) * 100);

    document.getElementById('hunger-fill').style.width = hungerPercent + '%';
    document.getElementById('hunger-fill').textContent = '' + (foodHave) + ' (' + (foodDays) + 'd)';

    document.getElementById('water-fill').style.width = waterPercent + '%';
    document.getElementById('water-fill').textContent = '' + (waterHave) + ' (' + (waterDays) + 'd)';

    // Temperature bar
    var temp = this.state.temperature;
    var tempEmoji = this.getTemperatureEmoji(temp);
    document.getElementById('temp-emoji').textContent = tempEmoji;
    
    // Temperature bar width: -10Â°C = 0%, +40Â°C = 100% (range 50Â°C)
    var tempPercent = Math.max(0, Math.min(100, ((temp + 10) / 50) * 100));
    document.getElementById('temp-fill').style.width = tempPercent + '%';
    
    var tempText = '' + (temp) + 'Â°C';
    if (this.state.heating > 0) {
      tempText += ' ğŸ”¥Ã—' + (this.state.heating) + '';
    }
    if (this.state.shelterLevel > 1) {
      tempText += ' ğŸ§±Ã—' + (Math.round((this.state.shelterLevel - 1) * 2)) + '';
    }
    document.getElementById('temp-fill').textContent = tempText;

    this.renderInventory();
    this.renderRecipes();
    this.renderEntities();

    // Auto-unlock receptÅ¯ podle inventÃ¡Å™e
    this.autoUnlockRecipes();
    // ğŸ”¥ Update fire indicator
    this.updateFireIndicator();
    // ğŸ’° Update gold display
    document.getElementById('gold-amount').textContent = this.state.gold;
    
    // ğŸ“Š Update footer stats
    this.updateFooterStats();
  },

  autoUnlockRecipes: function() {
    var unlocked = false;
    
    this.recipes.forEach(function(recipe) {
      if (this.state.unlockedRecipes.includes(recipe.id)) return;
      
      // Zkontroluj jestli mÃ¡Å¡ materiÃ¡ly na tento recept
      var hasSomeMaterials = Object.keys(recipe.materials).some(
        function: function(matId) {
      ); };

      // Tier 1-2: unlock kdyÅ¾ mÃ¡Å¡ materiÃ¡ly
      if (hasSomeMaterials && recipe.tier <= 2) {
        this.state.unlockedRecipes.push(recipe.id);
        unlocked = true;
      }

      // Tier 3+: unlock kdyÅ¾ mÃ¡Å¡ required tools
      if (recipe.tier >= 3 && recipe.requires) {
        if (this.hasTools(recipe.requires)) {
          this.state.unlockedRecipes.push(recipe.id);
          unlocked = true;
        }
      }
      
      // Tier 3+ BEZ requires: unlock kdyÅ¾ mÃ¡Å¡ materiÃ¡ly (luk, fireplace, insulation)
      if (recipe.tier >= 3 && !recipe.requires && hasSomeMaterials) {
        this.state.unlockedRecipes.push(recipe.id);
        unlocked = true;
      }
    });

    if (unlocked) {
      this.renderRecipes();
    }
  },
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ğŸ² THREAT TRIGGER SYSTEM
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  // Add to state in init():
  state: {
    // ... existing state
    lastSeasonalThreat: 0,
    randomThreatCount: 0,
    maxRandomThreats: 3, // nastavitelnÃ©
    threatCooldown: 3, // min 3 dny mezi hrozbami
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ğŸ¯ CHECK THREATS (volat v nextDay())
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  checkThreats: function() {
    var daysSinceLastThreat = this.state.day - (this.state.lastSeasonalThreat || 0);

    // Cooldown check
    if (daysSinceLastThreat < this.state.threatCooldown) {
      return;
    }

    // ğŸ Konec obdobÃ­ = garantovanÃ½ seasonal threat
    if (this.state.day % 15 === 0 && this.state.day > 0) {
      this.triggerSeasonalThreat();
      return;
    }

    // ğŸ² Random threat (pouze od 5. dne)
    if (this.state.day >= 5 && this.state.randomThreatCount < this.state.maxRandomThreats) {
      var chance = 0.10; // 10% per day
      if (Math.random() < chance) {
        this.triggerRandomThreat();
      }
    }
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ğŸŒ SEASONAL THREAT (konec obdobÃ­)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  triggerSeasonalThreat: function() {
    var currentSeason = this.state.season;

    // Filter threats by season
    var seasonalThreats = Object.values(this.threats).filter(function(t) { return t.seasons && t.seasons.includes(currentSeason)
    ); };

    if (seasonalThreats.length === 0) {
      // Fallback to any threat
      var allThreats = Object.values(this.threats).filter(function(t) { return t.seasons); };
      if (allThreats.length > 0) {
        var threat = allThreats[Math.floor(Math.random() * allThreats.length)];
        this.triggerThreat(threat, true);
      }
      return;
    }

    // Weighted random (tier = weight)
    var totalWeight = seasonalThreats.reducefunction((sum, t) sum + t.tier, 0);
    var roll = Math.random() * totalWeight;

    for (var threat of seasonalThreats) {
      roll -= threat.tier;
      if (roll <= 0) {
        this.triggerThreat(threat, true);
        return;
      }
    }
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ğŸ² RANDOM THREAT (kdykoliv)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  triggerRandomThreat: function() {
    var allThreats = Object.values(this.threats);
    var threat = allThreats[Math.floor(Math.random() * allThreats.length)];

    this.triggerThreat(threat, false);
    this.state.randomThreatCount++;
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // âš”ï¸ TRIGGER THREAT (main)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  triggerThreat: function(threat, isSeasonal) {
    this.state.lastSeasonalThreat = this.state.day;

    // Check if can avoid (medicine_hut for plague)
    if (threat.canAvoid) {
      var canAvoid = Object.entries(threat.canAvoid).everyfunction(([item, count]) (this.state.inventory[item] || 0) >= count
      );

      if (canAvoid) {
        this.log(threat.avoidMessage, 'success');
        this.showNotification('ğŸ’Š Hrozba odvrÃ¡cena!');

        // GA4 tracking
        this.track('threat_avoided', {
          threat_id: threat.id,
          threat_name: threat.name,
          day: this.state.day
        });

        return;
      }
    }

    // Show combat modal
    this.showCombatModal(threat);

    // GA4 tracking
    this.track('threat_triggered', {
      threat_id: threat.id,
      threat_name: threat.name,
      threat_tier: threat.tier,
      is_seasonal: isSeasonal,
      day: this.state.day
    });
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ğŸ¨ COMBAT UI - Modal & Rendering
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ğŸ“‹ SHOW COMBAT MODAL
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  showCombatModal: function(threat) {
    this.openModal();

    // Init combat system
    this.combat.init(threat);

    var modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.id = 'combat-modal';

    var seasonName = this.seasons[this.state.season].name;

    modal.innerHTML = '
      <div class="modal-content" style="max-width: 600px;">
        <div style="text-align: center; margin-bottom: 20px;">
          <div style="font-size: 48px; margin-bottom: 10px;">' + (threat.icon) + '</div>
          <h2 style="color: #e74c3c; font-size: 24px; margin-bottom: 10px;">
            ' + (threat.name) + '
          </h2>
          <p style="color: #b89968; font-size: 20px; line-height: 1.6;">
            ' + (threat.intro) + '
          </p>
          <div style="margin-top: 10px; padding: 14px; background: rgba(231, 76, 60, 0.1); border-radius: 4px;">
            <span style="color: #e8d5b7; font-size: 12px;">
              ' + (seasonName) + ' | Den ' + (this.state.day) + ' | ObtÃ­Å¾nost: ' + (threat.aiDifficulty.toUpperCase()) + '
            </span>
          </div>
        </div>

        <div id="combat-board-container" style="margin: 20px 0; text-align: center;">
          ' + (this.renderCombatBoardHTML()) + '
        </div>

        <div id="combat-status" style="text-align: center; margin: 18px 0; color: #4ec9b0; font-size: 14px; font-weight: 600;">
          TvÅ¯j tah: ' + (threat.playerIcon) + '
        </div>

        <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">
          <button class="modal-btn modal-btn-secondary" onclick="game.fleeCombat()" style="flex: 1; max-width: 200px;">
            ğŸƒ UtÃ©ct (50% ztrÃ¡t)
          </button>
        </div>

        <div style="margin-top: 15px; padding: 10px; background: rgba(20, 16, 12, 0.3); border-radius: 4px; font-size: 12px; color: #9ca3af;">
          <strong style="color: #e8d5b7;">Pravidla:</strong> Sestav 5 symbolÅ¯ v Å™adÄ› (vodorovnÄ›, svisle nebo diagonÃ¡lnÄ›).
        </div>
      </div>
    ';

    document.body.appendChild(modal);
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ğŸ® RENDER COMBAT BOARD
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  renderCombatBoardHTML: function() {
    var size = this.combat.size;
    var html = '<div style="display: inline-block; background: #1a1410; padding: 10px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);">';

    for (var r = 0; r < size; r++) {
      html += '<div style="display: flex;">';
      for (var c = 0; c < size; c++) {
        var cell = this.combat.board[r][c];
        var icon = cell === 'player' ? this.combat.playerIcon : 
                     cell === 'enemy' ? this.combat.enemyIcon : '';

        html += '
          <div 
            onclick="game.handleCombatClick(' + (r) + ', ' + (c) + ')" 
            style="
              width: 50px; 
              height: 50px; 
              border: 1px solid rgba(232, 213, 183, 0.2); 
              display: flex; 
              align-items: center; 
              justify-content: center; 
              cursor: pointer;
              font-size: 24px;
              background: ' + (cell ? 'rgba(232, 213, 183, 0.05)' : 'transparent') + ';
              transition: all 0.2s;
            "
            onmouseover="if (!this.innerHTML.trim()) this.style.background='rgba(78, 200, 176, 0.1)'"
            onmouseout="if (!this.innerHTML.trim()) this.style.background='transparent'"
          >
            ' + (icon) + '
          </div>
        ';
      }
      html += '</div>';
    }

    html += '</div>';
    return html;
  },

  renderCombatBoard: function() {
    var container = document.getElementById('combat-board-container');
    if (container) {
      container.innerHTML = this.renderCombatBoardHTML();
    }
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ğŸ–±ï¸ HANDLE COMBAT CLICK
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  handleCombatClick: function(row, col) {
    if (!this.combat.gameActive) return;

    var result = this.combat.makeMove(row, col);

    if (result === 'player_win') {
      setTimeout(function() {
    } else if (result === 'draw') {
      setTimeout(function() {
    } else if (result) {
      this.renderCombatBoard();
      document.getElementById('combat-status').innerHTML = 
        'NepÅ™Ã­tel pÅ™emÃ½Å¡lÃ­... ' + (this.combat.enemyIcon) + '';
    }
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ğŸ† HANDLE COMBAT END
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  handleCombatEnd: function(playerWon) {
    var threat = this.combat.currentThreat;
    var outcome = playerWon ? threat.onVictory : threat.onDefeat;
    if (playerWon) {
    if (soundEffects) soundEffects.playSound('win');
    } else {
    if (soundEffects) soundEffects.playSound('lose');
    }

    // Apply consequences
    if (outcome.items) {
      for (var [itemId, value] of Object.entries(outcome.items)) {
        if (Array.isArray(value)) {
          // Range [min, max]
          var amount = Math.floor(Math.random() * (value[1] - value[0] + 1)) + value[0];
          if (amount > 0) {
            this.addItem(itemId, amount);
          } else {
            this.removeItem(itemId, Math.abs(amount));
          }
        } else {
          if (value > 0) {
            this.addItem(itemId, value);
          } else {
            this.removeItem(itemId, Math.abs(value));
          }
        }
      }
    }

    if (outcome.gold) {
      if (Array.isArray(outcome.gold)) {
        var amount = Math.floor(Math.random() * (outcome.gold[1] - outcome.gold[0] + 1)) + outcome.gold[0];
        this.state.gold += amount;
      } else if (outcome.gold < 1 && outcome.gold > -1) {
        // Percentage
        this.state.gold = Math.floor(this.state.gold * (1 + outcome.gold));
      } else {
        this.state.gold += outcome.gold;
      }
    }

    if (outcome.casualties && this.state.entities.length > 0) {
      if (Math.random() < outcome.casualties) {
        var victim = this.state.entities[Math.floor(Math.random() * this.state.entities.length)];
        this.state.entities = this.state.entities.filter(function(e) { return e.id !== victim.id); };
        this.log('ğŸ’€ ' + (victim.name) + ' zahynul v boji!', 'danger');

        // GA4 tracking
        this.track('entity_death', {
          entity_type: victim.type,
          entity_name: victim.name,
          cause: 'combat',
          threat_id: threat.id,
          day: this.state.day
        });
      }
    }

    // Show result
    var resultModal = document.createElement('div');
    resultModal.className = 'modal-overlay';
    resultModal.style.zIndex = '10001';

    resultModal.innerHTML = '
      <div class="modal-content" style="max-width: 400px; text-align: center;">
        <div style="font-size: 72px; margin-bottom: 20px;">
          ' + (playerWon ? 'ğŸ‰' : 'ğŸ’€') + '
        </div>
        <h2 style="color: ' + (playerWon ? '#4ec9b0' : '#e74c3c') + '; font-size: 28px; margin-bottom: 15px;">
          ' + (playerWon ? 'VÃ­tÄ›zstvÃ­!' : 'PorÃ¡Å¾ka!') + '
        </h2>
        <p style="color: #e8d5b7; font-size: 16px; line-height: 1.6; margin-bottom: 20px;">
          ' + (outcome.message) + '
        </p>
        <button class="modal-btn modal-btn-primary" onclick="game.closeCombatResult()">
          PokraÄovat
        </button>
      </div>
    ';

    document.body.appendChild(resultModal);

    // Log
    this.log(outcome.message, playerWon ? 'success' : 'danger');

    // GA4 tracking
    this.track('combat_ended', {
      threat_id: threat.id,
      threat_name: threat.name,
      outcome: playerWon ? 'victory' : 'defeat',
      day: this.state.day
    });

    // Close combat modal
    this.closeModal('combat-modal');

    // Render updates
    this.render();
  },

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ğŸƒ FLEE COMBAT
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  fleeCombat: function() {
    if (!confirm('Opravdu chceÅ¡ utÃ©ct? UtrpÃ­Å¡ 50% ztrÃ¡t z porÃ¡Å¾ky!')) return;

    var threat = this.combat.currentThreat;
    var outcome = threat.onDefeat;

    // Apply 50% of defeat consequences
    if (outcome.items) {
      for (var [itemId, value] of Object.entries(outcome.items)) {
        if (Array.isArray(value)) {
          var amount = Math.floor((Math.random() * (value[1] - value[0] + 1)) + value[0]) * 0.5;
          this.removeItem(itemId, Math.ceil(Math.abs(amount)));
        } else if (value < 0) {
          this.removeItem(itemId, Math.ceil(Math.abs(value) * 0.5));
        }
      }
    }

    if (outcome.casualties && this.state.entities.length > 0) {
      if (Math.random() < (outcome.casualties * 0.5)) {
        var victim = this.state.entities[Math.floor(Math.random() * this.state.entities.length)];
        this.state.entities = this.state.entities.filter(function(e) { return e.id !== victim.id); };
        this.log('ğŸ’€ ' + (victim.name) + ' zahynul pÅ™i ÃºtÄ›ku!', 'danger');
      }
    }

    this.log('ğŸƒ Uprchl jsi z boje! Ale s tÄ›Å¾kÃ½mi ztrÃ¡tami...', 'warning');

    // GA4 tracking
    this.track('combat_fled', {
      threat_id: threat.id,
      threat_name: threat.name,
      day: this.state.day
    });

    this.closeModal('combat-modal');
    this.render();
  },

  closeCombatResult: function() {
    var modals = document.querySelectorAll('.modal-overlay');
    modals.forEach(function(m) { return m.remove()); };
    this.closeModal('combat-modal');
  },

};

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸµ ATMOSPHERIC MUSIC SYSTEM with Seasonal Tracks
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // âš ï¸ MUSIC SYSTEM DISABLED (ES6 class not supported in Apps Script)
    

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ”Š SOUND EFFECTS SYSTEM
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // SoundEffects class removed
    
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸµ INITIALIZE GAME & MUSIC SYSTEM
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ” DEBUG: Verify game object was created
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log('ğŸ” GAME OBJECT VERIFICATION (before window.onload)');
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log('typeof game:', typeof game);
    console.log('game is defined:', typeof game !== 'undefined');
    
    if (typeof game !== 'undefined') {
      console.log('âœ… game object EXISTS at script execution time');
      console.log('   game.state:', typeof game.state);
      console.log('   game.init:', typeof game.init);
      console.log('   game.render:', typeof game.render);
    } else {
      console.error('âŒ game object DOES NOT EXIST at script execution time!');
      console.error('   This means there is a syntax error in the game object definition');
    }
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');

    var soundEffects = null;
    window.onload = function() {
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ›¡ï¸ DEFENSIVE CHECK - Verify game object exists
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      if (typeof game === 'undefined') {
        console.error('âŒ CRITICAL: game object was NOT created!');
        console.error('   This should never happen - check for syntax errors above.');
        document.body.innerHTML = '<div style="color: red; padding: 20px; font-family: monospace;">' +
          '<h1>âŒ Game Object Error</h1>' +
          '<p>The game object failed to initialize. Check console for details.</p>' +
          '</div>';
        return; // Stop execution
      }
      
      console.log('âœ… game object exists:', typeof game);
      console.log('   Has init method:', typeof game.init === 'function');
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ® SAFE INITIALIZATION with try-catch
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      try {
        // Initialize game
        game.init();
        console.log('âœ… game.init() completed successfully');
      } catch (initError) {
        console.error('âŒ ERROR in game.init():', initError);
        console.error('   Stack:', initError.stack);
        
        // Show error to user
        alert('Game initialization failed. Please refresh the page.\n\nError: ' + initError.message);
        return; // Stop further initialization
      }

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸµ INITIALIZE MUSIC SYSTEM (after game init succeeds)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      try {
        window.atmosphericMusic = null; // Disabled for ES5
        soundEffects = null; // Disabled for ES5
        console.log('âœ… Music system initialized');
      } catch (musicError) {
        console.error('âš ï¸ Music system failed (non-critical):', musicError);
        // Continue - music is not critical
      }

      // Set button state based on localStorage
      try {
        var musicEnabled = localStorage.getItem('musicEnabled') !== 'false';
        var musicBtn = document.getElementById('music-toggle-btn');
        if (musicBtn) {
          musicBtn.textContent = musicEnabled ? 'ğŸ”Š' : 'ğŸ”‡';
        }
      } catch (storageError) {
        console.error('âš ï¸ localStorage access failed (non-critical):', storageError);
      }
      
      // DON'T auto-play on load - var user start with Next Day or toggle button
      console.log('âœ… Game fully initialized and ready to play!');
    }
    </script>  <!-- KONEC JavaScriptu -->


</body>
</html>

<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <!-- SEO Meta Tags -->
<title>üè† Doupƒõ 2 - Survival Crafting</title>
<meta name="description" content="Ondrex's Ember Nidus - Doupe. Survival crafting game with real world assets features">
<meta name="keywords" content="doupe, doupƒõ, survival crafting game, ondrex, ondrex ember">
<meta name="author" content="Ondrex Ember">
<meta name="robots" content="index, follow">
<link rel="canonical" href="https://ondrex-ember.github.io/doupe-2/">

<link rel="icon" href="favicon.ico">
  
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-SZJL9L81VE"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-SZJL9L81VE');
</script>
<!-- Google Analytics -->
<!-- 
  ‚ö†Ô∏è CLIENT-SIDE GA4 NEFUNGUJE V APPS SCRIPT (iframe + cross-origin issues)
  Pou≈æ√≠v√°me SERVER-SIDE tracking p≈ôes Measurement Protocol API
  viz kod.gs -> trackEvent() funkce
-->
<!-- End Google Analytics -->

<script type="text/javascript">
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "vct90i7r4t");
</script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600;700&family=Space+Mono:wght@400;700&display=swap');

* { 
  box-sizing: border-box; 
  margin: 0; 
  padding: 0; 
  -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
  -webkit-touch-callout: none;
}

html {
  /* Prevent iOS zoom on input focus */
  -webkit-text-size-adjust: 100%;
  text-size-adjust: 100%;
  /* Smooth scrolling for better UX */
  scroll-behavior: smooth;
  /* iOS safe area support */
  padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
}

body {
  margin: 0;
  background: linear-gradient(135deg, #1a1410 0%, #2d2416 50%, #1a1410 100%);
  font-family: 'Crimson Pro', serif;
  color: #e8d5b7;
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  min-height: -webkit-fill-available; /* iOS Safari fix */
  padding: 20px;
  position: relative;
  overflow-x: hidden;
  /* Better touch scrolling on iOS */
  -webkit-overflow-scrolling: touch;
  /* Prevent pull-to-refresh on mobile */
  overscroll-behavior-y: contain;
}

/* Prevent body scroll when modal is open */
body.modal-open {
  overflow: hidden;
  position: fixed;
  width: 100%;
  height: 100%;
}

@media (max-width: 768px) {
  body {
    padding: 10px 5px;
    align-items: flex-start;
    padding-top: 20px;
  }
}

body::before {
  content: '';
  position: fixed;
  inset: 0;
  background: 
    radial-gradient(circle at 20% 30%, rgba(139, 90, 43, 0.1) 0%, transparent 50%),
    radial-gradient(circle at 80% 70%, rgba(87, 62, 38, 0.1) 0%, transparent 50%);
  pointer-events: none;
  animation: ambientGlow 15s ease-in-out infinite;
}

@keyframes ambientGlow {
  0%, 100% { opacity: 0.5; }
  50% { opacity: 0.8; }
}

/* üî• EMBER LINK STYLING */
a {
  color: #d4a574;
  text-decoration: none;
  transition: all 0.3s ease;
  text-shadow: 0 0 8px rgba(255, 120, 40, 0.3);
  position: relative;
}

a:hover {
  color: #ff9944;
  text-shadow: 0 0 12px rgba(255, 120, 40, 0.8);
  animation: emberLinkGlow 1.5s ease-in-out infinite;
}

a:active {
  color: #ff7828;
}

@keyframes emberLinkGlow {
  0%, 100% { 
    text-shadow: 0 0 12px rgba(255, 120, 40, 0.8);
  }
  50% { 
    text-shadow: 0 0 16px rgba(255, 100, 20, 1);
  }
}

#game-container {
  width: 100%;
  max-width: 1000px;
  background: linear-gradient(145deg, rgba(44, 35, 25, 0.95), rgba(55, 42, 30, 0.95));
  border-radius: 24px;
  padding: 24px;
  box-shadow: 
    0 30px 80px rgba(0, 0, 0, 0.8),
    inset 0 1px 0 rgba(255, 255, 255, 0.05);
  border: 2px solid rgba(139, 90, 43, 0.3);
  position: relative;
  z-index: 1;
  animation: containerAppear 0.6s ease-out;
  /* Better touch handling */
  touch-action: pan-y;
  -webkit-tap-highlight-color: transparent;
}

@media (max-width: 768px) {
  #game-container {
    padding: 16px;
    border-radius: 16px;
    max-width: 100%;
    margin: 0 10px;
    /* Ensure proper touch scrolling */
    -webkit-overflow-scrolling: touch;
  }
}

@keyframes containerAppear {
  from {
    opacity: 0;
    transform: translateY(30px) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

#header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 2px solid rgba(139, 90, 43, 0.3);
  padding-bottom: 12px;
  margin-bottom: 16px;
}

@media (max-width: 768px) {
  #header {
    flex-wrap: wrap;
    gap: 10px;
  }
  
  #header h2 {
    font-size: 20px !important;
  }
  
  #header h3 {
    font-size: 11px !important;
    order: 3;
    flex-basis: 100%;
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   FOOTER - Patiƒçka (mirror of header)
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

#footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-top: 2px solid rgba(139, 90, 43, 0.3);
  padding-top: 12px;
  margin-top: 16px;
}

@media (max-width: 768px) {
  #footer {
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
    text-align: center;
  }
  
  #footer .footer-info {
    order: 3;
    flex-basis: 100%;
  }
}

.footer-title {
  font-family: 'Space Mono', monospace;
  font-size: 14px;
  color: #d4a574;
  letter-spacing: 1px;
}

@media (max-width: 768px) {
  .footer-title {
    font-size: 13px;
  }
}

.footer-version {
  font-family: 'Crimson Pro', serif;
  font-size: 12px;
  color: #9a8670;
  font-style: italic;
}

@media (max-width: 768px) {
  .footer-version {
    font-size: 11px;
  }
}

.footer-info {
  text-align: right;
  font-family: 'Space Mono', monospace;
  font-size: 11px;
  color: #9a8670;
}

@media (max-width: 768px) {
  .footer-info {
    text-align: center;
    font-size: 10px;
  }
}

.footer-link {
  color: #d4a574;
  text-decoration: none;
  transition: color 0.2s ease;
  cursor: pointer;
}

.footer-link:hover {
  color: #e8c547;
  text-decoration: underline;
}

/* üå§Ô∏è WEATHER WIDGET */
.weather-widget {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  margin-top: 8px;
  padding: 6px 12px;
  border-radius: 12px;
  font-size: 12px;
  font-family: 'Space Mono', monospace;
  background: rgba(111, 180, 197, 0.15);
  border: 1px solid rgba(111, 180, 197, 0.3);
  transition: all 0.3s ease;
}

.weather-widget:hover {
  background: rgba(111, 180, 197, 0.25);
  transform: translateY(-1px);
}

.weather-icon {
  font-size: 16px;
  animation: weatherPulse 4s ease-in-out infinite;
}

@keyframes weatherPulse {
  0%, 100% { 
    opacity: 1;
    transform: scale(1);
  }
  50% { 
    opacity: 0.9;
    transform: scale(1.05);
  }
}

.weather-info {
  color: #b89968;
  font-size: 11px;
  font-weight: 600;
}

@media (max-width: 768px) {
  .weather-widget {
    font-size: 11px;
    padding: 5px 10px;
    margin-top: 6px;
  }
  
  .weather-icon {
    font-size: 14px;
  }
  
  .weather-info {
    font-size: 10px;
  }
}

/* Weather mode selector - minim√°ln√≠ styl */
.weather-mode-selector{display:inline-flex;gap:3px;margin-left:8px;padding:2px 4px;border-radius:6px;background:rgba(139,90,43,0.1);border:1px solid rgba(139,90,43,0.2)}
.weather-mode-btn{padding:3px 6px;border:none;border-radius:4px;background:transparent;color:#9a8670;font-size:16px;cursor:pointer;transition:all .2s;opacity:.5}
.weather-mode-btn:hover{opacity:.8;background:rgba(139,90,43,0.15)}
.weather-mode-btn.active{opacity:1;background:rgba(139,90,43,0.25)}
@media(max-width:768px){.weather-mode-selector{margin-left:4px;padding:2px 3px}.weather-mode-btn{font-size:14px;padding:2px 4px}}

#header h2 {
  font-family: 'Space Mono', monospace;
  font-size: 24px;
  color: #d4a574;
  text-shadow: 0 2px 8px rgba(212, 165, 116, 0.3);
  letter-spacing: 2px;
}

#header h3 {
  font-family: 'Crimson Pro', serif;
  font-size: 14px;
  color: #9a8670;
  font-style: italic;
  display: flex;
  align-items: center;
  gap: 6px;
}

.ember-icon {
  width: 28px;
  height: 28px;
  object-fit: contain;
  filter: drop-shadow(0 0 8px rgba(255, 120, 40, 0.6));
  animation: emberGlow 3s ease-in-out infinite;
}

@keyframes emberGlow {
  0%, 100% { filter: drop-shadow(0 0 8px rgba(255, 120, 40, 0.6)); }
  50% { filter: drop-shadow(0 0 12px rgba(255, 100, 20, 0.9)); }
}

.ember-icon-small {
  display: inline-block;
  font-size: 14px;
  filter: drop-shadow(0 0 6px rgba(255, 120, 40, 0.6));
  animation: emberGlow 3s ease-in-out infinite;
}

@media (max-width: 768px) {
  .ember-icon-small {
    font-size: 13px;
  }
}

#season-info {
  text-align: right;
  font-family: 'Space Mono', monospace;
}

@media (max-width: 768px) {
  #season-info {
    text-align: center;
  }
  
  #season-info .big {
    font-size: 18px !important;
  }
  
  #season-info .small {
    font-size: 11px !important;
  }
}

#season-info .big {
  font-size: 20px;
  font-weight: 700;
  color: #d4a574;
  display: block;
}

#season-info .small {
  font-size: 12px;
  color: #a08060;
  opacity: 0.8;
}
/* üî• FIRE INDICATOR STYLES */
.fire-indicator {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  margin-top: 6px;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 11px;
  font-family: 'Space Mono', monospace;
  transition: all 0.3s ease;
}

.fire-indicator.active {
  background: rgba(255, 120, 40, 0.2);
  border: 1px solid rgba(255, 120, 40, 0.4);
}

.fire-indicator.active .fire-icon {
  animation: fireFlicker 1.5s ease-in-out infinite;
  filter: drop-shadow(0 0 6px rgba(255, 120, 40, 0.8));
}

.fire-indicator.active .fire-status {
  color: #ff9944;
  font-weight: 700;
}

.fire-indicator.inactive {
  background: rgba(60, 50, 40, 0.3);
  border: 1px solid rgba(100, 80, 60, 0.2);
  opacity: 0.5;
}

.fire-indicator.inactive .fire-icon {
  filter: grayscale(100%) brightness(0.7);
}

.fire-indicator.inactive .fire-status {
  color: #6a5d4f;
}

@keyframes fireFlicker {
  0%, 100% { 
    opacity: 1; 
    transform: scale(1);
  }
  50% { 
    opacity: 0.85;
    transform: scale(1.05);
  }
}

@media (max-width: 768px) {
  .fire-indicator {
    font-size: 10px;
    padding: 3px 8px;
  }
}

/* üí∞ GOLD DISPLAY STYLES */
.gold-display {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  margin-top: 6px;
  padding: 5px 12px;
  border-radius: 12px;
  font-size: 12px;
  font-family: 'Space Mono', monospace;
  background: rgba(212, 165, 116, 0.15);
  border: 1px solid rgba(212, 165, 116, 0.4);
  transition: all 0.3s ease;
}

.gold-display:hover {
  background: rgba(212, 165, 116, 0.25);
  transform: translateY(-1px);
}

.gold-icon {
  font-size: 14px;
  animation: goldShine 3s ease-in-out infinite;
}

@keyframes goldShine {
  0%, 100% { 
    filter: drop-shadow(0 0 4px rgba(255, 215, 0, 0.6));
  }
  50% { 
    filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.9));
  }
}

.gold-amount {
  color: #d4a574;
  font-weight: 700;
  font-size: 13px;
}

@media (max-width: 768px) {
  .gold-display {
    font-size: 11px;
    padding: 4px 10px;
  }
  
  .gold-amount {
    font-size: 12px;
  }
}

#status-bars {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 12px;
  margin: 16px 0;
}

@media (max-width: 768px) {
  #status-bars {
    grid-template-columns: 1fr;
  }
}

.bar {
  background: rgba(30, 24, 18, 0.6);
  border-radius: 10px;
  padding: 10px 12px;
  border: 1px solid rgba(139, 90, 43, 0.2);
  transition: all 0.3s ease;
}

.bar:hover {
  border-color: rgba(139, 90, 43, 0.4);
  transform: translateY(-2px);
}

.bar-label {
  font-size: 13px;
  margin-bottom: 6px;
  font-weight: 600;
  color: #b89968;
}

@media (max-width: 768px) {
  .bar-label {
    font-size: 14px;
  }
  
  .bar {
    padding: 12px 14px !important;
  }
  
  .fill-container {
    height: 28px !important;
  }
  
  .fill {
    font-size: 13px !important;
  }
}

.fill-container {
  background: rgba(0, 0, 0, 0.3);
  border-radius: 8px;
  height: 24px;
  overflow: hidden;
  position: relative;
  box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.4);
}

.fill {
  height: 100%;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  font-family: 'Space Mono', monospace;
}

.fill::after {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(180deg, rgba(255, 255, 255, 0.2) 0%, transparent 50%);
  border-radius: 6px;
}

.hunger {
  background: linear-gradient(90deg, #c0504d 0%, #e67e7b 100%);
  color: #fff;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
}

.water {
  background: linear-gradient(90deg, #4a90a4 0%, #6fb4c5 100%);
  color: #fff;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
}

.temperature {
  background: linear-gradient(90deg, #4a90e4 0%, #6fb4c5 35%, #7bc876 50%, #e8c547 65%, #e67e7b 100%);
  color: #fff;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
  font-weight: 700;
}

#log {
  background: rgba(20, 16, 12, 0.7);
  border-radius: 12px;
  padding: 12px;
  height: 140px;
  overflow-y: auto;
  margin-bottom: 16px;
  border: 1px solid rgba(139, 90, 43, 0.2);
  font-family: 'Space Mono', monospace;
  font-size: 12px;
  line-height: 1.5;
  box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.5);
  /* Better touch scrolling */
  -webkit-overflow-scrolling: touch;
  overscroll-behavior: contain;
}

@media (max-width: 768px) {
  #log {
    height: 120px;
    font-size: 11px;
    padding: 10px;
    /* Ensure smooth scrolling on touch */
    scroll-behavior: smooth;
  }
}

#log::-webkit-scrollbar {
  width: 8px;
}

#log::-webkit-scrollbar-track {
  background: rgba(0, 0, 0, 0.2);
  border-radius: 4px;
}

#log::-webkit-scrollbar-thumb {
  background: rgba(139, 90, 43, 0.4);
  border-radius: 4px;
}

#log::-webkit-scrollbar-thumb:hover {
  background: rgba(139, 90, 43, 0.6);
}

.log-entry {
  margin-bottom: 6px;
  padding: 3px 6px;
  border-radius: 3px;
  animation: logAppear 0.3s ease-out;
}

@keyframes logAppear {
  from {
    opacity: 0;
    transform: translateX(-10px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

.log-info { color: #b8b0a0; background: rgba(184, 176, 160, 0.05); }
.log-warning { color: #e8c547; background: rgba(232, 197, 71, 0.1); }
.log-danger { color: #e67e7b; background: rgba(230, 126, 123, 0.1); }
.log-item { color: #6fb4c5; background: rgba(111, 180, 197, 0.1); }
.log-success { color: #7bc876; background: rgba(123, 200, 118, 0.1); }

.two-column-layout {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 15px;
  margin-bottom: 15px;
}

.two-column-layout .section {
  margin-bottom: 0;
}

@media (max-width: 768px) {
  .two-column-layout {
    grid-template-columns: 1fr;
  }
}

.section {
  background: rgba(40, 32, 24, 0.5);
  border-radius: 12px;
  padding: 12px;
  margin-bottom: 15px;
  border: 1px solid rgba(139, 90, 43, 0.2);
}

.section-title {
  font-size: 16px;
  font-weight: 700;
  color: #d4a574;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 6px;
}

@media (max-width: 768px) {
  .section-title {
    font-size: 17px;
  }
  
  .section {
    padding: 14px !important;
  }
}

.section-title .icon {
  font-size: 18px;
}

.section-content {
  display: grid;
  gap: 6px;
}

/* Crafting recipes: 3-column tile layout */
#recipes {
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
}

@media (max-width: 1024px) {
  #recipes {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (max-width: 768px) {
  #recipes {
    /* üé® MOBILE: 3 dla≈ædice vedle sebe m√≠sto 1 sloupce */
    grid-template-columns: repeat(3, 1fr);
    gap: 8px; /* Men≈°√≠ mezery na mobilu */
  }
}

/* üì± EXTRA SMALL: Pro velmi mal√© displeje (iPhone SE, atd.) */
@media (max-width: 375px) {
  #recipes {
    grid-template-columns: repeat(2, 1fr); /* 2 sloupce na mini displej√≠ch */
    gap: 6px;
  }
}

.item-card {
  display: flex;
  align-items: center;
  gap: 10px;
  background: rgba(20, 16, 12, 0.6);
  padding: 10px 12px;
  border-radius: 8px;
  border: 1px solid rgba(139, 90, 43, 0.15);
  transition: all 0.2s ease;
  animation: itemAppear 0.4s ease-out;
}

@media (max-width: 768px) {
  .item-card {
    padding: 12px 14px;
    gap: 12px;
  }
  
  .item-icon {
    font-size: 28px !important;
  }
  
  .item-name {
    font-size: 15px !important;
  }
  
  .item-count {
    font-size: 16px !important;
  }
}

@keyframes itemAppear {
  from {
    opacity: 0;
    transform: scale(0.95);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

.item-card:hover {
  border-color: rgba(139, 90, 43, 0.4);
  transform: translateX(4px);
  background: rgba(30, 24, 18, 0.7);
}

.item-icon {
  font-size: 24px;
  line-height: 1;
  flex-shrink: 0;
}

.item-details {
  flex: 1;
  min-width: 0;
}

.item-name {
  font-weight: 700;
  font-size: 14px;
  color: #d4a574;
  margin-bottom: 2px;
}

.item-desc {
  font-size: 11px;
  color: #9a8670;
  font-style: italic;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.item-count {
  font-weight: 700;
  font-size: 15px;
  color: #b89968;
  font-family: 'Space Mono', monospace;
  margin-left: auto;
  flex-shrink: 0;
}

/* üí∞ ECONOMY: Sell & Buy Buttons */
.item-action-btn {
  padding: 5px 10px;
  font-size: 11px;
  font-weight: 700;
  font-family: 'Space Mono', monospace;
  border: none;
  border-radius: 6px;
  margin-left: 8px;
  transition: all 0.2s ease;
  cursor: pointer;
  flex-shrink: 0;
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
}

.item-sell-btn {
  background: linear-gradient(135deg, #d4a574, #c9a576);
  color: #1a1410;
  border: 1px solid rgba(212, 165, 116, 0.6);
  box-shadow: 0 2px 4px rgba(212, 165, 116, 0.3);
}

.item-sell-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(212, 165, 116, 0.5);
}

.item-sell-btn:active {
  transform: translateY(0);
  opacity: 0.8;
}

.item-buy-btn {
  background: linear-gradient(135deg, #7bc876, #6fb865);
  color: #fff;
  border: 1px solid rgba(123, 200, 118, 0.6);
  box-shadow: 0 2px 4px rgba(123, 200, 118, 0.3);
}

.item-buy-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(123, 200, 118, 0.5);
}

.item-buy-btn:active {
  transform: translateY(0);
  opacity: 0.8;
}

.item-action-btn:disabled {
  opacity: 0.3;
  cursor: not-allowed;
  transform: none;
}

.item-action-btn .price-tag {
  font-size: 10px;
  opacity: 0.9;
}

@media (max-width: 768px) {
  .item-action-btn {
    padding: 6px 12px;
    font-size: 12px;
    min-height: 32px;
  }
}

.recipe-card {
  background: rgba(20, 16, 12, 0.6);
  padding: 12px;
  border-radius: 10px;
  border: 1px solid rgba(139, 90, 43, 0.15);
  transition: all 0.2s ease;
  cursor: pointer;
  min-height: 90px;
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  justify-content: space-between;
}

@media (max-width: 768px) {
  .recipe-card {
    padding: 8px 6px; /* Kompaktnƒõj≈°√≠ padding */
    min-height: 90px; /* Zachovat min v√Ω≈°ku */
    font-size: 11px; /* Men≈°√≠ text */
  }
  
  .recipe-icon {
    font-size: 24px !important; /* Vƒõt≈°√≠ ikona pro lep≈°√≠ ƒçitelnost */
  }
  
  .recipe-name {
    font-size: 11px !important; /* Men≈°√≠ n√°zev */
    line-height: 1.2;
  }
  
  .recipe-materials {
    font-size: 9px !important; /* Men≈°√≠ materi√°ly */
    line-height: 1.3;
  }
}

.recipe-card.can-craft {
  border-color: rgba(123, 200, 118, 0.4);
}

.recipe-card.can-craft:hover {
  border-color: rgba(123, 200, 118, 0.6);
  transform: translateY(-3px) scale(1.02);
  background: rgba(123, 200, 118, 0.1);
  box-shadow: 0 6px 12px rgba(123, 200, 118, 0.2);
}

.recipe-card.cannot-craft {
  opacity: 0.4;
  cursor: default;
}

.recipe-header {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 6px;
  margin-bottom: 6px;
}

.recipe-icon {
  font-size: 24px;
  flex-shrink: 0;
}

.recipe-name {
  font-weight: 700;
  font-size: 13px;
  color: #d4a574;
}

.recipe-materials {
  font-size: 10px;
  color: #9a8670;
  font-family: 'Space Mono', monospace;
  padding: 0;
  margin-top: auto;
}

.entity-card {
  background: rgba(20, 16, 12, 0.6);
  padding: 12px;
  border-radius: 8px;
  border: 1px solid rgba(139, 90, 43, 0.15);
  animation: entityAppear 0.5s ease-out;
}

@keyframes entityAppear {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.entity-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 8px;
}

.entity-icon {
  font-size: 28px;
  flex-shrink: 0;
}

.entity-info {
  flex: 1;
  min-width: 0;
}

.entity-name {
  font-weight: 700;
  font-size: 15px;
  color: #d4a574;
}

.entity-status {
  font-size: 11px;
  color: #9a8670;
  font-family: 'Space Mono', monospace;
}

.entity-actions {
  display: flex;
  gap: 6px;
  margin-top: 8px;
}

.entity-action-btn {
  flex: 1;
  padding: 5px 10px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 11px;
  font-family: 'Space Mono', monospace;
  font-weight: 700;
  transition: all 0.2s ease;
  background: rgba(139, 90, 43, 0.3);
  color: #d4a574;
  border: 1px solid rgba(139, 90, 43, 0.4);
}

@media (max-width: 768px) {
  .entity-action-btn {
    padding: 10px 12px;
    font-size: 12px;
    min-height: 42px;
  }
  
  .entity-actions {
    flex-wrap: wrap;
    gap: 8px !important;
  }
  
  .entity-action-btn {
    flex: 1 1 calc(50% - 4px);
    min-width: 120px;
  }
}

.entity-action-btn:hover {
  background: rgba(139, 90, 43, 0.5);
  transform: translateY(-2px);
}

.entity-action-btn:disabled {
  opacity: 0.3;
  cursor: not-allowed;
  transform: none;
}

.controls {
  display: flex;
  gap: 12px;
  justify-content: center;
  margin-top: 15px;
  flex-wrap: wrap;
}

@media (max-width: 768px) {
  .controls {
    gap: 8px;
  }
  
  .controls button {
    flex: 1 1 auto;
    min-width: 140px;
  }
}

button {
  padding: 12px 22px;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 700;
  font-family: 'Space Mono', monospace;
  transition: all 0.2s ease;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  /* Better touch handling */
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
  user-select: none;
  -webkit-user-select: none;
}

@media (max-width: 768px) {
  button {
    padding: 14px 20px;
    font-size: 15px;
    min-height: 48px;
    /* Increase touch target size */
    min-width: 48px;
  }
}

button:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
}

button:active {
  transform: translateY(-1px);
  /* Visual feedback on touch */
  opacity: 0.8;
}

.primary {
  background: linear-gradient(135deg, #8b5a2b 0%, #a67c52 100%);
  color: #fff;
  border: 1px solid rgba(212, 165, 116, 0.3);
}

.primary:hover {
  background: linear-gradient(135deg, #a67c52 0%, #c9a576 100%);
}

.danger {
  background: linear-gradient(135deg, #c0504d 0%, #e67e7b 100%);
  color: #fff;
  border: 1px solid rgba(230, 126, 123, 0.3);
}

.danger:hover {
  background: linear-gradient(135deg, #e67e7b 0%, #f29b98 100%);
}

.event-notification {
  position: fixed;
  top: 20px;
  right: 20px;
  background: linear-gradient(135deg, rgba(139, 90, 43, 0.95), rgba(166, 124, 82, 0.95));
  border-radius: 12px;
  padding: 16px 20px;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
  border: 2px solid rgba(212, 165, 116, 0.4);
  animation: slideIn 0.5s ease-out;
  z-index: 1000;
  max-width: 300px;
  font-family: 'Space Mono', monospace;
  font-size: 14px;
  color: #fff;
}

@media (max-width: 768px) {
  .event-notification {
    top: 10px;
    right: 10px;
    left: 10px;
    max-width: none;
    font-size: 13px;
    padding: 12px 16px;
  }
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateX(100%);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

.empty-state {
  text-align: center;
  padding: 15px;
  color: #6a5d4f;
  font-style: italic;
  font-size: 13px;
}

.season-indicator {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 700;
  margin-left: 8px;
}

.season-spring { background: rgba(123, 200, 118, 0.2); color: #7bc876; }
.season-summer { background: rgba(232, 197, 71, 0.2); color: #e8c547; }
.season-autumn { background: rgba(212, 165, 116, 0.2); color: #d4a574; }
.season-winter { background: rgba(111, 180, 197, 0.2); color: #6fb4c5; }

/* Leaderboard & Nickname Modals */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.9);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  animation: fadeIn 0.3s ease-out;
  /* Prevent scroll behind modal */
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  /* Prevent body scroll leak */
  overscroll-behavior: contain;
}

.modal-content {
  background: linear-gradient(145deg, #2c231a, #372a1e);
  border-radius: 20px;
  padding: 30px;
  max-width: 600px;
  width: 90%;
  border: 2px solid rgba(139, 90, 43, 0.4);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.9);
  animation: scaleIn 0.4s ease-out;
  max-height: 90vh;
  overflow-y: auto;
  /* Better scrolling on touch devices */
  -webkit-overflow-scrolling: touch;
  /* Prevent margin collapse */
  position: relative;
}

@media (max-width: 768px) {
  .modal-content {
    padding: 20px;
    width: 95%;
    border-radius: 16px;
  }
  
  .modal-title {
    font-size: 22px !important;
  }
  
  .leaderboard-table {
    font-size: 13px !important;
  }
  
  .leaderboard-table th,
  .leaderboard-table td {
    padding: 8px 6px !important;
  }
  
  .rank-badge {
    width: 26px !important;
    height: 26px !important;
    line-height: 26px !important;
    font-size: 12px !important;
  }
  
  .modal-btn {
    padding: 12px 18px !important;
    font-size: 13px !important;
  }
  
  .nickname-input {
    font-size: 15px !important;
  }
}

.modal-title {
  font-family: 'Space Mono', monospace;
  font-size: 28px;
  color: #d4a574;
  text-align: center;
  margin-bottom: 20px;
  text-shadow: 0 2px 8px rgba(212, 165, 116, 0.3);
}

.nickname-input {
  width: 100%;
  padding: 12px 16px;
  font-size: 16px; /* iOS needs 16px+ to prevent auto-zoom */
  font-family: 'Crimson Pro', serif;
  background: rgba(20, 16, 12, 0.8);
  border: 2px solid rgba(139, 90, 43, 0.3);
  border-radius: 10px;
  color: #e8d5b7;
  margin: 15px 0;
  transition: border-color 0.2s;
}

.nickname-input:focus {
  outline: none;
  border-color: rgba(139, 90, 43, 0.6);
}

.nickname-info {
  text-align: center;
  color: #b89968;
  font-size: 14px;
  margin: 10px 0;
}

.leaderboard-table {
  width: 100%;
  border-collapse: collapse;
  margin: 20px 0;
}

.leaderboard-table th {
  background: rgba(139, 90, 43, 0.2);
  padding: 12px;
  text-align: left;
  font-family: 'Space Mono', monospace;
  font-size: 13px;
  color: #d4a574;
  border-bottom: 2px solid rgba(139, 90, 43, 0.3);
}

.leaderboard-table td {
  padding: 10px 12px;
  border-bottom: 1px solid rgba(139, 90, 43, 0.1);
  font-size: 14px;
}

.leaderboard-table tr:hover {
  background: rgba(139, 90, 43, 0.1);
}

.rank-badge {
  display: inline-block;
  width: 30px;
  height: 30px;
  line-height: 30px;
  text-align: center;
  border-radius: 50%;
  font-weight: 700;
  font-family: 'Space Mono', monospace;
}

.rank-1 { background: linear-gradient(135deg, #FFD700, #FFA500); color: #000; }
.rank-2 { background: linear-gradient(135deg, #C0C0C0, #808080); color: #000; }
.rank-3 { background: linear-gradient(135deg, #CD7F32, #8B4513); color: #fff; }
.rank-other { background: rgba(139, 90, 43, 0.2); color: #b89968; }

.modal-buttons {
  display: flex;
  gap: 12px;
  justify-content: center;
  margin-top: 20px;
}

.modal-btn {
  padding: 12px 24px;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 700;
  font-family: 'Space Mono', monospace;
  transition: all 0.2s ease;
}

.modal-btn-primary {
  background: linear-gradient(135deg, #8b5a2b, #a67c52);
  color: #fff;
  border: 1px solid rgba(212, 165, 116, 0.3);
}

.modal-btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
}
.modal-btn-secondary {
  background: rgba(139, 90, 43, 0.2);
  color: #d4a574;
  border: 1px solid rgba(139, 90, 43, 0.3);
}

.modal-btn-secondary:hover {
  background: rgba(139, 90, 43, 0.3);
}

.your-rank {
  background: rgba(123, 200, 118, 0.2) !important;
  border-left: 3px solid #7bc876;
}
</style>
</head>

<body>
<div id="game-container">

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       ‚ö†Ô∏è CRITICAL SECTION - HEADER
       Hlaviƒçka s n√°zvem, sez√≥nou, fire indicator a gold display
       Required: day, season, fire-indicator, gold-display
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="header">
    <h1>üè† DOUPƒö</h1>
    <h3></h3>
    <div id="season-info">
      <span class="big">Den <span id="day">1</span></span>
      <span class="small"><span id="season">Jaro</span></span>
      <!-- Weather mode selector -->
      <span class="weather-mode-selector">
        <button class="weather-mode-btn active" data-mode="game" onclick="game.setWeatherMode('game')" title="Hra">üéÆ</button>
        <button class="weather-mode-btn" data-mode="openmeteo" onclick="game.setWeatherMode('openmeteo')" title="Open-Meteo">üåç</button>
        <button class="weather-mode-btn" data-mode="weatherxm" onclick="game.setWeatherMode('weatherxm')" title="WeatherXM">üì°</button>
      </span>
      <!-- üî• FIRE INDICATOR -->
      <span class="fire-indicator inactive" id="fire-indicator">
        <span class="fire-icon">üî•</span>
        <span class="fire-status">Bez ohnƒõ</span>
      </span>
      <!-- üí∞ GOLD DISPLAY -->
      <span class="gold-display" id="gold-display">
        <span class="gold-icon">üí∞</span>
        <span class="gold-amount" id="gold-amount">0</span>
      </span>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       ‚ö†Ô∏è CRITICAL SECTION - STATUS BARS
       Z√°soby j√≠dla, vody a teplota - CORE gameplay mechanic
       Required: hunger-fill, water-fill, temp-fill
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="status-bars">
    <div class="bar">
      <div class="bar-label">üçñ Z√°soby j√≠dla</div>
      <div class="fill-container">
        <div class="fill hunger" id="hunger-fill" style="width: 100%;">50 (10d)</div>
      </div>
    </div>
    <div class="bar">
      <div class="bar-label">üíß Z√°soby vody</div>
      <div class="fill-container">
        <div class="fill water" id="water-fill" style="width: 100%;">50 (16d)</div>
      </div>
    </div>
    <div class="bar">
      <div class="bar-label"><span id="temp-emoji">üå°Ô∏è</span> Teplota doupƒõte</div>
      <div class="fill-container">
        <div class="fill temperature" id="temp-fill" style="width: 50%;">15¬∞C</div>
      </div>
    </div>
  </div>

  <div id="log"></div>

  <div class="two-column-layout">
    <div class="section">
      <div class="section-title">
        <span class="icon">üì¶</span>
        <span>Invent√°≈ô</span>
      </div>
      <div class="section-content" id="inventory"></div>
    </div>

    <div class="section">
      <div class="section-title">
        <span class="icon">üî®</span>
        <span>Crafting recepty</span>
      </div>
      <div class="section-content" id="recipes"></div>
    </div>
  </div>

  <div class="section" id="entities-section" style="display: none;">
    <div class="section-title">
      <span class="icon">üë•</span>
      <span>Obyvatel√© doupƒõte</span>
    </div>
    <div class="section-content" id="entities"></div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       ‚ö†Ô∏è CRITICAL SECTION - MAIN CONTROLS
       Hlavn√≠ hern√≠ tlaƒç√≠tka - NESM√ç ZMIZET!
       Required: nextDay, saveGame, showLeaderboard, reset
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="controls">
    <button class="primary" onclick="game.nextDay()">‚è∞ Dal≈°√≠ den</button>
    <button class="primary" onclick="game.saveGame()">üíæ Ulo≈æit hru</button>
    <button class="primary" onclick="game.showLeaderboard()">üèÜ ≈Ωeb≈ô√≠ƒçek</button>
    <button class="danger" onclick="game.reset()">üîÑ Nov√Ω zaƒç√°tek</button>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       ‚ö†Ô∏è CRITICAL SECTION - FOOTER
       Patiƒçka s live statistikami a d≈Øle≈æit√Ωmi odkazy
       Required: footer-stats, loadGame, showLeaderboard, showAbout
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="footer">
    <div>
      <span class="footer-title">üè† DOUPƒö v2.0</span>
      <br>
      <!-- üå§Ô∏è WEATHER WIDGET -->
      <span class="weather-widget" id="weather-widget">
        <span class="weather-icon">üå§Ô∏è</span>
        <span class="weather-info">Naƒç√≠t√°m poƒças√≠...</span>
      </span>
      <p></p>
      <span class="footer-version"> ‚Ä¢ by Ondrex's <a href="https://www.ember-pa.cz">Ember<span class="ember-icon-small">üî•</span></a></span>
      <br>
      <span class="footer-version"><a href="https://ondrex-ember.github.io/tech-1000-piv/"> ‚Ä¢ Tƒõch 1000 piv üç∫ s Ondrexem</a></span>
    </div>
    <div class="footer-info">
      <span id="footer-stats">Kolonie: 1 üë• | Rekord: <span id="footer-best-run">0</span>d</span>
      <br>
      <span class="footer-link" onclick="game.loadGame()">üìÇ Naƒç√≠st</span>
      <span style="opacity: 0.5;"> ‚Ä¢ </span>
      <span class="footer-link" onclick="game.showLeaderboard()">üìä ≈Ωeb≈ô√≠ƒçek</span>
      <span style="opacity: 0.5;"> ‚Ä¢ </span>
      <span class="footer-link" onclick="game.showAbout()">‚ÑπÔ∏è O h≈ôe</span>
    </div>
  </div>

</div>

<script>
const game = {

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // ‚ö†Ô∏è CRITICAL FUNCTION - MODAL MANAGEMENT
  // V≈°echny modal funkce MUS√ç volat openModal() a closeModal()!
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  /**
   * üîí OPEN MODAL
   * 
   * Zamkne body scroll a ulo≈æ√≠ pozici scrollu.
   * ‚ö†Ô∏è MUS√ç b√Ωt vol√°no p≈ôed zobrazen√≠m ka≈æd√©ho modalu!
   * 
   * @returns {void}
   * @sideeffects Adds 'modal-open' class, locks scroll, stores scroll position
   * 
   * @example
   * game.openModal(); // V≈ædy prvn√≠ ≈ô√°dek v show*Modal() funkci
   * 
   * @see closeModal() - Pro odemknut√≠ scrollu
   */
  openModal() {
    // Lock body scroll when modal opens
    document.body.classList.add('modal-open');
    // Store scroll position
    this._scrollY = window.scrollY;
    document.body.style.top = `-${this._scrollY}px`;
  },

  /**
   * üîì CLOSE MODAL
   * 
   * Odstran√≠ modal z DOM a odemkne body scroll.
   * ‚ö†Ô∏è MUS√ç b√Ωt vol√°no p≈ôi zav√≠r√°n√≠ ka≈æd√©ho modalu!
   * 
   * @param {string} modalId - ID modalu k odstranƒõn√≠ (bez #)
   * @returns {void}
   * @sideeffects Removes modal, unlocks scroll, restores scroll position
   * 
   * @example
   * game.closeModal('leaderboard-modal');
   * 
   * @see openModal() - Pro zamknut√≠ scrollu
   */
  closeModal(modalId) {
    // Remove modal
    const modal = document.getElementById(modalId);
    if (modal) modal.remove();
    
    // Unlock body scroll
    document.body.classList.remove('modal-open');
    document.body.style.top = '';
    
    // Restore scroll position
    if (this._scrollY !== undefined) {
      window.scrollTo(0, this._scrollY);
      this._scrollY = undefined;
    }
  },

  // üåê HYBRID BACKEND ADAPTER
  // Automatically detects environment and uses appropriate backend method
  
  // ‚ö†Ô∏è IMPORTANT: Replace with your actual Apps Script Web App URL
  BACKEND_API_URL: 'https://script.google.com/macros/s/AKfycbwWqpMUKiT6iS6NwVYP7GM2MBD1IqCMhLToAhVVPtsl2IIvuk6IoHuFlzlTtVVY551v/exec',
  
  get isAppsScript() {
    // Check if we're running in Apps Script environment
    return typeof google !== 'undefined' && 
           google.script && 
           google.script.run;
  },

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üîß UPDATED BACKEND FUNCTION - Pou≈æij GET m√≠sto POST (CORS fix)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Najdi v index.html funkci backend() (cca ≈ô√°dek 1360)
// a NAHRAƒé JI t√≠mto:

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üîß UPDATED BACKEND FUNCTION - JSONP pro CORS fix
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// V index.html najdi funkci backend() a NAHRAƒé JI celou t√≠mto:

async backend(functionName, data = null) {
  // Apps Script environment - use google.script.run (direct)
  if (this.isAppsScript) {
    return new Promise((resolve, reject) => {
      try {
        const runner = google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject);
        
        if (data !== null) {
          runner[functionName](data);
        } else {
          runner[functionName]();
        }
      } catch(error) {
        reject(error);
      }
    });
  }
  
  // GitHub environment - USE JSONP (CORS workaround)
  return new Promise((resolve, reject) => {
    try {
      console.log(`üåê JSONP call: ${functionName}`, data ? `with data` : 'no data');
      
      // Timeout pro detekci zatuhl√©ho vol√°n√≠
      const timeout = setTimeout(() => {
        console.error(`‚è±Ô∏è JSONP timeout after 30s: ${functionName}`);
        cleanup();
        reject(new Error(`API timeout after 30s: ${functionName}`));
      }, 30000); // 30s timeout
      
      // Generate unique callback name
      const callbackName = 'jsonp_callback_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      
      let script;
      
      const cleanup = () => {
        clearTimeout(timeout);
        if (window[callbackName]) {
          delete window[callbackName];
        }
        if (script && script.parentNode) {
          document.body.removeChild(script);
        }
      };
      
      // Create global callback function
      window[callbackName] = function(response) {
        console.log(`‚úÖ JSONP response from ${functionName}:`, response);
        cleanup();
        resolve(response);
      };
      
      // Build URL with params
      const params = new URLSearchParams({
        action: functionName,
        data: JSON.stringify(data || {}),
        callback: callbackName
      });
      
      const url = `${this.BACKEND_API_URL}?${params}`;
      console.log(`üì° JSONP URL:`, url.substring(0, 150) + '...');
      
      // Create script tag for JSONP
      script = document.createElement('script');
      script.src = url;
      script.onerror = function(e) {
        console.error(`‚ùå JSONP script load failed: ${functionName}`, e);
        cleanup();
        
        // Return mock success for non-critical functions
        if (functionName === 'trackEvent') {
          resolve({ success: true, message: 'Tracking skipped (API unavailable)' });
        } else if (functionName === 'logTransaction') {
          resolve({ success: true, message: 'Transaction logging skipped (API unavailable)' });
        } else {
          reject(new Error(`JSONP script load failed: ${functionName}`));
        }
      };
      
      // Add script to page
      document.body.appendChild(script);
      
    } catch(error) {
      console.error(`‚ùå JSONP call exception:`, error);
      reject(error);
    }
  });
},
  state: {
    day: 1,
    season: 0,
    dead: false,
    inventory: {},
    entities: [],
    unlockedRecipes: [],
    eventChance: 0.5,
    temperature: 15,
    shelterLevel: 1,
    heating: 0,
    guaranteedStones: 0,
    playerId: null,
    playerNickname: null,
    bestRun: 0,
    // üî• FIRE SYSTEM
    fireActive: false,
    fireFuel: 0,
    // üí∞ ECONOMY SYSTEM
    gold: 0,
    // üå§Ô∏è WEATHER MODE
    weatherMode: 'game',
    weatherData: null,
    lastWeatherFetch: 0
  },

  seasons: [
    { 
      name: 'Jaro', 
      hungerDrain: 4, 
      waterDrain: 3,
      baseTemp: 15,
      tempVariance: 5,
      icon: 'üå±',
      desc: 'ƒåas r≈Østu a sbƒõru. V√≠c materi√°l≈Ø, m√©nƒõ j√≠dla.'
    },
    { 
      name: 'L√©to', 
      hungerDrain: 3, 
      waterDrain: 6,
      baseTemp: 26,
      tempVariance: 4,
      icon: '‚òÄÔ∏è',
      desc: 'Horko a sucho. Voda je vz√°cn√°!'
    },
    { 
      name: 'Podzim', 
      hungerDrain: 6, 
      waterDrain: 4,
      baseTemp: 10,
      tempVariance: 6,
      icon: 'üçÇ',
      desc: 'ƒåas skliznƒõ. P≈ôiprav se na zimu.'
    },
    { 
      name: 'Zima', 
      hungerDrain: 10, 
      waterDrain: 3,
      baseTemp: -5,
      tempVariance: 8,
      icon: '‚ùÑÔ∏è',
      desc: 'Drsn√° zima. P≈ôe≈æije≈° jen s dostatkem z√°sob.'
    }
  ],

  items: {
    // üí∞ ECONOMY: sellPrice = co dostanu za prodej, buyPrice = co mus√≠m zaplatit
    wood: { name: 'D≈ôevo', icon: 'üå≥', desc: 'Z√°kladn√≠ stavebn√≠ materi√°l', sellPrice: 2 },
    stone: { name: 'K√°men', icon: '‚õ∞Ô∏è', desc: 'Tvrd√Ω materi√°l pro n√°stroje', sellPrice: 3 },
    fiber: { name: 'Vl√°kna', icon: 'üåæ', desc: 'Pro v√Ωrobu provaz≈Ø', sellPrice: 1 },
    mushroom: { name: 'Houba', icon: 'üçÑ', desc: 'Jedl√° nebo nejedl√°', sellPrice: 4 },
    bark: { name: 'K≈Øra', icon: 'üü´', desc: 'Such√° k≈Øra na zap√°len√≠', sellPrice: 2 },
    stick: { name: 'H≈Øl', icon: 'ü¶Ø', desc: 'U≈æiteƒçn√° tyƒç', sellPrice: 4 },
    rope: { name: 'Provaz', icon: '‚û∞', desc: 'Pevn√© vl√°kno', sellPrice: 6 },
    trap: { name: 'Past', icon: 'üêÄ', desc: 'Chyt√° zvƒõ≈ô', sellPrice: 15 },
    basket: { name: 'Ko≈°', icon: 'üß∫', desc: 'Pro sbƒõr bobul√≠', sellPrice: 12 },
    knife: { name: 'N≈Ø≈æ', icon: 'üî™', desc: 'Z√°kladn√≠ n√°stroj pro ≈ôez√°n√≠', sellPrice: 30 },
    axe: { name: 'Sekyrka', icon: 'ü™ì', desc: 'Pro k√°cen√≠ d≈ôeva', sellPrice: 45 },
    bowl: { name: 'Miska', icon: 'ü•£', desc: 'N√°doba na vodu', sellPrice: 8 },
    leather: { name: 'K≈Ø≈æe', icon: 'ü¶∫', desc: 'Zpracovan√° k≈Ø≈æe', sellPrice: 20 },
    plank: { name: 'Prkno', icon: 'üìè', desc: 'Opracovan√© d≈ôevo', sellPrice: 5 },
    bow: { name: 'Luk', icon: 'üèπ', desc: 'Pro lov', sellPrice: 60 },
    seeds: { name: 'Semena', icon: 'üå±', desc: 'Pro pƒõstov√°n√≠ j√≠dla', sellPrice: 3 },
    food: { name: 'J√≠dlo', icon: 'üçñ', desc: 'Udr≈æuje ≈æivot', buyPrice: 5 },
    water_supply: { name: 'Voda', icon: 'üíß', desc: 'Udr≈æuje ≈æivot', buyPrice: 4 },
    storage: { name: 'Sklad', icon: 'üì¶', desc: 'Uchov√°v√° z√°soby p≈ôes zimu', sellPrice: 50 },
    insulation: { name: 'Izolace', icon: 'üß±', desc: 'Zlep≈°uje tepelnou izolaci', sellPrice: 80 },
    fireplace: { name: 'Krb', icon: 'üî•', desc: 'Vyt√°p√≠ doupƒõ', sellPrice: 100 },
    dried_meat: { name: 'Su≈°en√© maso', icon: 'ü•©', desc: 'Vydr≈æ√≠ p≈ôes zimu', sellPrice: 25 },
    wall: { name: 'D≈ôevƒõn√° hradba', icon: 'üõ°Ô∏è', desc: 'Chr√°n√≠ p≈ôed √∫toky', sellPrice: 120 },
    guard_tower: { name: 'Str√°≈æn√≠ vƒõ≈æ', icon: 'üëÅÔ∏è', desc: 'Odhal√≠ nep≈ô√°tele', sellPrice: 100 },
    medicine_hut: { name: 'L√©k√°rna', icon: 'üíä', desc: 'L√©ƒç√≠ zranƒõn√≠', sellPrice: 80 },
    },

  recipes: [
    // Tier 1 - Z√°klady
    {
      id: 'stick',
      name: 'H≈Øl',
      icon: 'ü¶Ø',
      materials: { wood: 1 },
      result: { stick: 2 },
      tier: 1
    },
    {
      id: 'rope',
      name: 'Provaz',
      icon: '‚û∞',
      materials: { fiber: 3 },
      result: { rope: 1 },
      tier: 1
    },
    {
      id: 'bowl',
      name: 'Miska',
      icon: 'ü•£',
      materials: { wood: 2 },
      result: { bowl: 1 },
      tier: 1
    },
    {
      id: 'trap',
      name: 'Past na zvƒõ≈ô',
      icon: 'üêÄ',
      materials: { rope: 2, stick: 3 },
      result: { trap: 1 },
      tier: 1,
      desc: 'Chyt√° malou zvƒõ≈ô p≈ôes noc'
    },
    {
      id: 'basket',
      name: 'Sbƒõrac√≠ ko≈°',
      icon: 'üß∫',
      materials: { fiber: 5, stick: 2 },
      result: { basket: 1 },
      tier: 1,
      desc: 'Pro sbƒõr bobul√≠ a hub'
    },
    
    // Tier 2 - Z√°kladn√≠ n√°stroje
    {
      id: 'knife',
      name: 'Kamenn√Ω n≈Ø≈æ',
      icon: 'üî™',
      materials: { stone: 2, stick: 1 },
      result: { knife: 1 },
      tier: 2,
      unlock: 'first_entity'
    },
    {
      id: 'axe',
      name: 'Sekyrka',
      icon: 'ü™ì',
      materials: { stone: 3, stick: 2, rope: 1 },
      result: { axe: 1 },
      tier: 2,
      unlock: 'first_entity'
    },
    // üî• FIRE SYSTEM - Bow Drill (Tier 2)
    {
      id: 'start_fire_drill',
      name: 'Zalo≈æit ohe≈à (Bow Drill)',
      icon: 'üî•',
      materials: { stick: 2, fiber: 3, bark: 1 },
      requires: { bow: 1 },
      tier: 2,
      desc: '80% ≈°ance na √∫spƒõch',
      isFireStarter: true,
      fireChance: 0.8,
      fireMethod: 'bow_drill'
    },

    // Tier 3 - Pokroƒçil√©
    {
      id: 'plank',
      name: 'Prkno',
      icon: 'üìè',
      materials: { wood: 2 },
      result: { plank: 1 },
      requires: { axe: 1 },
      tier: 3
    },
    {
      id: 'leather',
      name: 'K≈Ø≈æe',
      icon: 'ü¶∫',
      materials: { food: 2 },
      result: { leather: 1 },
      requires: { knife: 1 },
      tier: 3
    },
    {
      id: 'bow',
      name: 'Luk',
      icon: 'üèπ',
      materials: { stick: 3, rope: 2 },
      result: { bow: 1 },
      tier: 3,
      unlock: 'hunter_entity'
    },
    // üî• FIRE SYSTEM - K≈ôesadlo (Tier 3)
    {
      id: 'start_fire_flint',
      name: 'Zalo≈æit ohe≈à (K≈ôesadlo)',
      icon: '‚ö°',
      materials: { stone: 3 },
      requires: { knife: 1 },
      tier: 3,
      desc: '100% √∫spƒõch',
      isFireStarter: true,
      fireChance: 0.8,
      fireMethod: 'flint_steel'
    },
    
    // üî• FIRE-BASED CRAFTING
    {
      id: 'dried_meat',
      name: 'Su≈°en√© maso',
      icon: 'ü•©',
      materials: { food: 5 },
      requiresFire: true,
      result: { dried_meat: 3 },
      tier: 3,
      desc: 'Vydr≈æ√≠ p≈ôes zimu, neskaz√≠ se'
    },
    // Tier 4 - Infrastruktura
    {
      id: 'storage',
      name: 'Sklad na zimu',
      icon: 'üì¶',
      materials: { plank: 5, rope: 3 },
      result: { storage: 1 },
      tier: 4
    },
    {
      id: 'fireplace',
      name: 'Krb',
      icon: 'üî•',
      materials: { stone: 8, plank: 3 },
      result: { fireplace: 1 },
      tier: 4,
      desc: 'Umo≈æ≈àuje topit d≈ôevem'
    },
    {
      id: 'insulation',
      name: 'Tepeln√° izolace',
      icon: 'üß±',
      materials: { fiber: 10, plank: 5, leather: 2 },
      result: { insulation: 1 },
      tier: 4,
      desc: 'Zlep≈°uje izolaci doupƒõte'
    },
    {
      id: 'wall',
      name: 'D≈ôevƒõn√° hradba',
      icon: 'üõ°Ô∏è',
      materials: { plank: 10, stone: 5, rope: 3 },
      result: { wall: 1 },
      tier: 4,
      desc: 'Chr√°n√≠ kolonii p≈ôed √∫toky'
    },
    {
      id: 'guard_tower',
      name: 'Str√°≈æn√≠ vƒõ≈æ',
      icon: 'üëÅÔ∏è',
      materials: { plank: 8, rope: 4 },
      requires: { bow: 1 },
      result: { guard_tower: 1 },
      tier: 4,
      desc: 'Odhal√≠ nep≈ô√°tele na d√°lku'
    },
    {
      id: 'medicine_hut',
      name: 'L√©k√°rna',
      icon: 'üíä',
      materials: { plank: 6, fiber: 12, mushroom: 5 },
      result: { medicine_hut: 1 },
      tier: 4,
      desc: 'L√©ƒç√≠ nemoci a zranƒõn√≠'
    }
  ],

  // Ud√°losti co m≈Ø≈æou nastat ka≈æd√Ω den
  randomEvents: [
    {
      id: 'wood_fall',
      chance: 0.4,
      items: { wood: [2, 4] },
      message: 'üå≥ Nƒõkolik vƒõtv√≠ spadlo ze stropu'
    },
    {
      id: 'stone_fall',
      chance: 0.3,
      items: { stone: [1, 3] },
      message: '‚õ∞Ô∏è Kameny se uvolnily ze stƒõny'
    },
    {
      id: 'fiber_find',
      chance: 0.35,
      items: { fiber: [3, 5] },
      message: 'üåæ Na≈°el jsi svazky vl√°ken'
    },
    {
      id: 'bark_find', // üî• NEW EVENT
      chance: 0.35,
      items: { bark: [2, 6] },
      message: 'üü´ K≈Øra spadla ze stromu'
    },
    {
      id: 'water_drip',
      chance: 0.8,
      items: { water_supply: [6, 12] },
      message: 'üíß Voda kape ze stropu do misek'
    },
    {
      id: 'mushroom_find',
      chance: 0.65,
      items: { food: [2, 4] },
      message: 'üçÑ Na≈°el jsi jedl√© houby'
    },
    {
      id: 'seed_find',
      chance: 0.3,
      season: [0], // pouze na ja≈ôe
      items: { seeds: [2, 4] },
      message: 'üå± V√≠tr p≈ôinesl semena'
    },
    {
      id: 'nothing',
      chance: 0.15,
      message: '...ticho a pr√°zdnota...'
    }
  ],

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // üó°Ô∏è ATTACK SYSTEM - PART 1: Attack Events & Defense Items

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üó°Ô∏è THREATS SYSTEM - Universal Combat Configuration
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  
  threats: {
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // üè¥‚Äç‚ò†Ô∏è TIER 3: N√°jezdn√≠ci (tƒõ≈æk√©)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    bandits: {
      id: 'bandits',
      name: 'N√°jezd bandit≈Ø',
      icon: 'üè¥‚Äç‚ò†Ô∏è',
      tier: 3,
      seasons: [2, 3], // podzim, zima
      
      intro: 'Banditi objevili doupƒõ! Chtƒõj√≠ tvoje zlato a z√°soby.',
      
      playerIcon: 'üèπ',
      enemyIcon: 'üó°Ô∏è',
      aiDifficulty: 'hard',
      boardSize: 8,
      
      onDefeat: {
        gold: -0.5, // 50% zlata
        items: { 
          food: [-30, -50],
          water_supply: [-20, -30] 
        },
        casualties: 0.3, // 30% ≈°ance na smrt entity
        message: 'üè¥‚Äç‚ò†Ô∏è Banditi ukradli z√°soby a zlato!'
      },
      onVictory: {
        gold: [50, 100],
        items: { leather: [3, 6] },
        message: 'üèπ Banditi pora≈æeni! Zabavuje≈° jejich v√Ωbavu.'
      }
    },
  
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // üê∫ TIER 3: Vlci (tƒõ≈æk√©, zvl√°≈°tƒõ v zimƒõ)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    wolves: {
      id: 'wolves',
      name: '√ötok vlƒç√≠ smeƒçky',
      icon: 'üê∫',
      tier: 3,
      seasons: [2, 3], // podzim, zima (hladov√≠)
      
      intro: 'Hladov√° smeƒçka vlk≈Ø vnikla do doupƒõte!',
      
      playerIcon: 'üî•',
      enemyIcon: 'üê∫',
      aiDifficulty: 'hard',
      boardSize: 7,
      
      onDefeat: {
        items: { 
          food: [-40, -60],
        },
        casualties: 0.4, // 40% ≈°ance
        message: 'üê∫ Vlci zabili obyvatele a ukradli j√≠dlo!'
      },
      onVictory: {
        items: { 
          leather: [5, 10],
          food: [20, 30]
        },
        message: 'üî• Vlci pora≈æeni! Z√≠sk√°v√°≈° k≈Ø≈æe a maso.'
      }
    },
  
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // üêÄ TIER 2: Krysy (st≈ôedn√≠)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    rats: {
      id: 'rats',
      name: 'Zamo≈ôen√≠ krysami',
      icon: 'üêÄ',
      tier: 2,
      seasons: [0, 1, 2], // ne v zimƒõ
      
      intro: 'Horda krys se val√≠ z tunel≈Ø! √ötoƒç√≠ na z√°soby.',
      
      playerIcon: 'ü™§',
      enemyIcon: 'üêÄ',
      aiDifficulty: 'medium',
      boardSize: 6,
      
      onDefeat: {
        items: { 
          food: [-30, -50],
          water_supply: [-20, -30] 
        },
        casualties: 0.2,
        message: 'üêÄ Krysy zniƒçily z√°soby!'
      },
      onVictory: {
        items: { 
          leather: [2, 5],
          food: [10, 20]
        },
        message: 'ü™§ Krysy pora≈æeny! Z√≠sk√°v√°≈° k≈Ø≈æe.'
      }
    },
  
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ü¶ü TIER 1: Hmyz (lehk√©, obt√≠≈æn√©)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    bugs: {
      id: 'bugs',
      name: 'Invaze hmyzu',
      icon: 'ü™≤',
      tier: 1,
      seasons: [0, 1], // jaro, l√©to
      
      intro: '≈†tƒõnice a ≈°v√°bi se roj√≠ v doupƒõti! Obyvatel√© nemohou sp√°t.',
      
      playerIcon: 'üí®',
      enemyIcon: 'ü¶ü',
      aiDifficulty: 'easy',
      boardSize: 5,
      
      onDefeat: {
        items: { 
          food: [-10, -20],
        },
        casualties: 0.1,
        message: 'ü™≤ Hmyz zniƒçil ƒç√°st z√°sob!'
      },
      onVictory: {
        items: { 
          food: [5, 10] // sp√°len√Ω hmyz = protein
        },
        message: 'üí® Hmyz vykou≈ôen! Obyvatel√© mohou sp√°t.'
      }
    },
  
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // üíÄ TIER 4: Mor (kritick√©, kdykoliv)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    plague: {
      id: 'plague',
      name: 'Epidemie moru',
      icon: 'üíÄ',
      tier: 4,
      seasons: null, // kdykoliv
      
      intro: 'Z√°hadn√° nemoc se ≈°√≠≈ô√≠ koloni√≠! Lid√© um√≠raj√≠.',
      
      playerIcon: 'üíä',
      enemyIcon: 'ü¶†',
      aiDifficulty: 'medium',
      boardSize: 8,
      
      // M≈Ø≈æe≈° skipnout pokud m√°≈° medicine_hut
      canAvoid: { medicine_hut: 1 },
      avoidMessage: 'üíä L√©k√°rna zachr√°nila kolonii od epidemie!',
      
      onDefeat: {
        casualties: 0.5, // 50% ≈°ance!
        items: {
          food: [-20, -30]
        },
        message: 'üíÄ Mor zabil ƒç√°st kolonie!'
      },
      onVictory: {
        message: 'üíä Nemoc zastavena! Kolonie p≈ôe≈æila.'
      }
    }
  },
  
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üéÆ COMBAT SYSTEM - Pi≈°kvorky 8x8
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  
  combat: {
    board: null,
    size: 8,
    currentThreat: null,
    playerIcon: 'üèπ',
    enemyIcon: 'üó°Ô∏è',
    gameActive: false,
    
    init(threat) {
      this.currentThreat = threat;
      this.size = threat.boardSize || 8;
      this.playerIcon = threat.playerIcon;
      this.enemyIcon = threat.enemyIcon;
      this.board = Array(this.size).fill(null).map(() => Array(this.size).fill(null));
      this.gameActive = true;
    },
    
    makeMove(row, col) {
      if (!this.gameActive || this.board[row][col]) return false;
      
      this.board[row][col] = 'player';
      
      // Check win
      if (this.checkWin('player')) {
        this.gameActive = false;
        return 'player_win';
      }
      
      // Check draw
      if (this.isBoardFull()) {
        this.gameActive = false;
        return 'draw';
      }
      
      // AI move
      setTimeout(() => {
        this.aiMove();
        
        if (this.checkWin('enemy')) {
          this.gameActive = false;
          game.handleCombatEnd(false);
        } else if (this.isBoardFull()) {
          this.gameActive = false;
          game.handleCombatEnd(true); // draw = player win
        }
      }, 500);
      
      return true;
    },
    
    aiMove() {
      const difficulty = this.currentThreat.aiDifficulty;
      let move = null;
      
      switch(difficulty) {
        case 'easy':
          move = this.findRandomMove();
          break;
        case 'medium':
          move = this.findBlockingMove() || this.findWinningMove() || this.findRandomMove();
          break;
        case 'hard':
          move = this.findWinningMove() || this.findBlockingMove() || this.findStrategicMove();
          break;
        case 'expert':
          move = this.findBestMove();
          break;
      }
      
      if (move) {
        this.board[move.row][move.col] = 'enemy';
        game.renderCombatBoard();
      }
    },
    
    findWinningMove() {
      // Find move that wins for AI
      for (let r = 0; r < this.size; r++) {
        for (let c = 0; c < this.size; c++) {
          if (!this.board[r][c]) {
            this.board[r][c] = 'enemy';
            if (this.checkWin('enemy')) {
              this.board[r][c] = null;
              return { row: r, col: c };
            }
            this.board[r][c] = null;
          }
        }
      }
      return null;
    },
    
    findBlockingMove() {
      // Find move that blocks player from winning
      for (let r = 0; r < this.size; r++) {
        for (let c = 0; c < this.size; c++) {
          if (!this.board[r][c]) {
            this.board[r][c] = 'player';
            if (this.checkWin('player')) {
              this.board[r][c] = null;
              return { row: r, col: c };
            }
            this.board[r][c] = null;
          }
        }
      }
      return null;
    },
    
    findStrategicMove() {
      // Prefer center, then adjacent to existing pieces
      const center = Math.floor(this.size / 2);
      
      // Try center
      if (!this.board[center][center]) {
        return { row: center, col: center };
      }
      
      // Try near existing pieces
      for (let r = 0; r < this.size; r++) {
        for (let c = 0; c < this.size; c++) {
          if (this.board[r][c] && this.hasEmptyNeighbor(r, c)) {
            const empty = this.getEmptyNeighbor(r, c);
            if (empty) return empty;
          }
        }
      }
      
      return this.findRandomMove();
    },
    
    findRandomMove() {
      const empty = [];
      for (let r = 0; r < this.size; r++) {
        for (let c = 0; c < this.size; c++) {
          if (!this.board[r][c]) empty.push({ row: r, col: c });
        }
      }
      return empty.length > 0 ? empty[Math.floor(Math.random() * empty.length)] : null;
    },
    
    findBestMove() {
      // Expert AI - look ahead 2 moves
      let bestScore = -Infinity;
      let bestMove = null;
      
      for (let r = 0; r < this.size; r++) {
        for (let c = 0; c < this.size; c++) {
          if (!this.board[r][c]) {
            this.board[r][c] = 'enemy';
            const score = this.minimax(1, false, -Infinity, Infinity);
            this.board[r][c] = null;
            
            if (score > bestScore) {
              bestScore = score;
              bestMove = { row: r, col: c };
            }
          }
        }
      }
      
      return bestMove || this.findRandomMove();
    },
    
    minimax(depth, isMaximizing, alpha, beta) {
      if (this.checkWin('enemy')) return 10 - depth;
      if (this.checkWin('player')) return depth - 10;
      if (this.isBoardFull() || depth > 2) return 0;
      
      if (isMaximizing) {
        let maxScore = -Infinity;
        for (let r = 0; r < this.size; r++) {
          for (let c = 0; c < this.size; c++) {
            if (!this.board[r][c]) {
              this.board[r][c] = 'enemy';
              const score = this.minimax(depth + 1, false, alpha, beta);
              this.board[r][c] = null;
              maxScore = Math.max(score, maxScore);
              alpha = Math.max(alpha, score);
              if (beta <= alpha) break;
            }
          }
        }
        return maxScore;
      } else {
        let minScore = Infinity;
        for (let r = 0; r < this.size; r++) {
          for (let c = 0; c < this.size; c++) {
            if (!this.board[r][c]) {
              this.board[r][c] = 'player';
              const score = this.minimax(depth + 1, true, alpha, beta);
              this.board[r][c] = null;
              minScore = Math.min(score, minScore);
              beta = Math.min(beta, score);
              if (beta <= alpha) break;
            }
          }
        }
        return minScore;
      }
    },
    
    hasEmptyNeighbor(r, c) {
      const dirs = [[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];
      return dirs.some(([dr,dc]) => {
        const nr = r + dr, nc = c + dc;
        return nr >= 0 && nr < this.size && nc >= 0 && nc < this.size && !this.board[nr][nc];
      });
    },
    
    getEmptyNeighbor(r, c) {
      const dirs = [[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];
      for (const [dr, dc] of dirs) {
        const nr = r + dr, nc = c + dc;
        if (nr >= 0 && nr < this.size && nc >= 0 && nc < this.size && !this.board[nr][nc]) {
          return { row: nr, col: nc };
        }
      }
      return null;
    },
    
    checkWin(player) {
      // Check 5 in a row (horizontal, vertical, diagonal)
      for (let r = 0; r < this.size; r++) {
        for (let c = 0; c < this.size; c++) {
          if (this.board[r][c] === player) {
            // Check all 4 directions
            if (this.checkDirection(r, c, 0, 1, player) || // horizontal
                this.checkDirection(r, c, 1, 0, player) || // vertical
                this.checkDirection(r, c, 1, 1, player) || // diagonal \
                this.checkDirection(r, c, 1, -1, player)) { // diagonal /
              return true;
            }
          }
        }
      }
      return false;
    },
    
    checkDirection(r, c, dr, dc, player) {
      let count = 0;
      for (let i = 0; i < 5; i++) {
        const nr = r + i * dr;
        const nc = c + i * dc;
        if (nr < 0 || nr >= this.size || nc < 0 || nc >= this.size || this.board[nr][nc] !== player) {
          return false;
        }
        count++;
      }
      return count === 5;
    },
    
    isBoardFull() {
      return this.board.every(row => row.every(cell => cell !== null));
    }
  },
  
  entityTypes: [
    {
      id: 'gatherer',
      name: 'Sbƒõraƒç',
      icon: 'üë§',
      actions: [
        {
          name: 'üî™Sb√≠rat materi√°ly',
          duration: 1,
          requires: { knife: 1 },
          result: () => {
            const items = ['wood', 'stone', 'fiber', 'mushroom'];
            const item = items[Math.floor(Math.random() * items.length)];
            return { [item]: Math.floor(Math.random() * 3) + 8 };
          }
        },
        {
          name: 'üß∫Sb√≠rat bobule',
          duration: 1,
          requires: { basket: 1 },
          result: () => ({ 
            food: Math.floor(Math.random() * 3) + 3,
            water_supply: Math.random() > 0.5 ? Math.floor(Math.random() * 2) + 6 : 0
          })
        },
        {
          name: 'üï∏Ô∏èNastra≈æit past',
          duration: 2,
          requires: { trap: 1 },
          result: () => ({ 
            food: Math.floor(Math.random() * 5) + 4
          })
        },
        {
          name: 'ü•£Sb√≠rat vodu',
          duration: 1,
          requires: { bowl: 1 },
          result: () => ({ water_supply: Math.floor(Math.random() * 5) + 10 })
        },
        {
          name: 'üå≥Topit v krbu',
          icon: 'üå≥',
          duration: 1,
          requires: { fireplace: 1 },
          isHeating: true,
          result: () => ({ heating: 1 })
        },
        // üî• NEW ACTION - P≈ôilo≈æit do ohnƒõ
        {
          name: 'üå≥P≈ôilo≈æit do ohnƒõ',
          duration: 1,
          requiresFire: true,
          isFuelAction: true,
          result: () => ({ fireFuel: 2 })
        },
        {
          name: '‚öîÔ∏èHl√≠dat doupƒõ',
          duration: 1,
          isGuarding: true,
          result: () => ({ })
        }
      ]
     },
     {
      id: 'hunter',
      name: 'Lovec',
      icon: 'üèπ',
      unlockRequires: { bow: 1 },
      actions: [
        {
          name: 'Lovit',
          duration: 2,
          requires: { bow: 1 },
          result: () => ({ 
            food: Math.floor(Math.random() * 6) + 5,
            leather: Math.random() > 0.5 ? 1 : 0
          })
        }
      ]
     }
   ],

  // Google Analytics 4 - Server-Side Tracking
  track(eventName, params = {}) {
    // Server-side tracking p≈ôes Google Apps Script backend
    // Measurement Protocol API zaji≈°≈•uje spolehliv√© mƒõ≈ôen√≠ bez cookies/iframe omezen√≠
    try {
      const clientId = this.state.playerId; // Pou≈æij player ID jako client_id
      
      if (clientId) {
        // Use hybrid backend adapter
        this.backend('trackEvent', { clientId, eventName, params })
          .then(() => {
            // Success - tich√© logov√°n√≠ (neru≈°√≠ hr√°ƒçe)
            console.log('‚úì GA4 tracked:', eventName);
          })
          .catch((error) => {
            // Failure - tich√© logov√°n√≠ (tracking nesm√≠ crashnout hru)
            console.warn('GA4 tracking failed:', error);
          });
      }
    } catch(e) {
      // Catch any errors - tracking nesm√≠ nikdy crashnout hru
      console.warn('GA4 tracking error:', e);
    }
  },

  calculateTemperature() {
    const season = this.seasons[this.state.season];
    let targetTemp;
    
    // Use real weather if available
    if (this.state.weatherMode !== 'game' && this.state.weatherData && this.state.weatherData.temperature !== null) {
      targetTemp = this.state.weatherData.temperature;
    } else {
      // Game mode - n√°hodn√° teplota podle sez√≥ny
      const variance = (Math.random() - 0.5) * 2 * season.tempVariance;
      targetTemp = season.baseTemp + variance;
    }
    
    // Heating bonus (ka≈æd√© topen√≠ = +5¬∞C, max 3 dny)
    const heatingBonus = Math.min(this.state.heating, 3) * 5;
    
    // Shelter bonus (lep≈°√≠ izolace = men≈°√≠ rozd√≠l od ide√°ln√≠ teploty)
    const insulations = this.state.inventory.insulation || 0;
    const shelterLevel = 1 + (insulations * 0.5);
    
    // Pokud je venku moc chladno/teplo, shelter pom√°h√°
    const idealTemp = 15;
    const diff = targetTemp - idealTemp;
    const shelteredDiff = diff / shelterLevel;
    
    targetTemp = idealTemp + shelteredDiff + heatingBonus;
    
    this.state.temperature = Math.round(targetTemp * 10) / 10;
    this.state.shelterLevel = shelterLevel;
  },

  getTemperatureEmoji(temp) {
    if (temp < -5) return 'ü•∂';
    if (temp < 5) return '‚ùÑÔ∏è';
    if (temp < 12) return 'üå°Ô∏è';
    if (temp < 20) return 'üå§Ô∏è';
    if (temp < 28) return '‚òÄÔ∏è';
    return 'üî•';
  },

  getTemperatureEffects() {
    const temp = this.state.temperature;
    let hungerMultiplier = 1;
    let waterMultiplier = 1;
    let efficiency = 1;
    
    // P≈ô√≠li≈° chladno
    if (temp < 5) {
      hungerMultiplier = 1.5;
      efficiency = 0.7;
    } else if (temp < 10) {
      hungerMultiplier = 1.2;
      efficiency = 0.85;
    }
    
    // P≈ô√≠li≈° teplo
    if (temp > 28) {
      waterMultiplier = 1.5;
      efficiency = 0.7;
    } else if (temp > 23) {
      waterMultiplier = 1.2;
      efficiency = 0.85;
    }
    
    // Ide√°ln√≠ teplota (10-20¬∞C)
    if (temp >= 10 && temp <= 20) {
      efficiency = 1.1; // bonus!
    }
    
    return { hungerMultiplier, waterMultiplier, efficiency };
  },
  // üî• UPDATE FIRE INDICATOR UI
  updateFireIndicator() {
    const indicator = document.getElementById('fire-indicator');
    const statusText = indicator.querySelector('.fire-status');
    
    if (this.state.fireActive && this.state.fireFuel > 0) {
      indicator.classList.remove('inactive');
      indicator.classList.add('active');
      statusText.textContent = `Ho≈ô√≠ (${this.state.fireFuel}d)`;
    } else {
      indicator.classList.remove('active');
      indicator.classList.add('inactive');
      statusText.textContent = 'Bez ohnƒõ';
    }
  },
  
  // üìä UPDATE FOOTER STATS
  updateFooterStats() {
    const population = this.state.entities.length + 1; // +1 for player
    const bestRun = this.state.bestRun;
    
    document.getElementById('footer-stats').innerHTML = 
      `Kolonie: ${population} üë• | Rekord: <span id="footer-best-run">${bestRun}</span>d`;
  },
  
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üå§Ô∏è WEATHER MODE SYSTEM
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  
  setWeatherMode(mode) {
    const previousMode = this.state.weatherMode;
    this.state.weatherMode = mode;
    localStorage.setItem('doupe_weather_mode', mode);
    
    // Update button states
    const buttons = document.querySelectorAll('.weather-mode-btn');
    buttons.forEach(btn => {
      btn.classList.toggle('active', btn.dataset.mode === mode);
    });
    
    // Reset weather data JEN kdy≈æ se ZMƒöN√ç m√≥d (ne p≈ôi opakovan√©m kliknut√≠)
    if (previousMode !== mode) {
      console.log(`üîÑ Weather mode changed: ${previousMode} ‚Üí ${mode}`);
      this.state.lastWeatherFetch = 0;
      this.state.weatherData = null;
    } else {
      console.log(`üì¶ Weather mode already active: ${mode} (keeping cache)`);
    }
    
    // Update widget
    if (mode === 'game') {
      this.updateWeatherWidgetGame();
    } else {
      this.fetchWeather();
    }
    
    // Log change (only if actually changed)
    if (previousMode !== mode) {
      const modeName = mode === 'game' ? 'Hern√≠ m√≥d' : mode === 'openmeteo' ? 'Open-Meteo' : 'WeatherXM';
      this.log(`üå§Ô∏è Weather mode: ${modeName}`, 'info');
      this.showNotification(`üå§Ô∏è ${modeName}`);
    }
    
    // Recalculate temperature and update UI
    this.calculateTemperature();
    this.render();
  },
  
  updateWeatherWidgetGame() {
    const widget = document.getElementById('weather-widget');
    if (!widget) return;
    
    // Safety check - pokud seasons je≈°tƒõ nen√≠ inicializovan√Ω
    if (!this.seasons || !this.seasons[this.state.season]) {
      widget.innerHTML = `<span class="weather-icon">üåç</span><span class="weather-info">Naƒç√≠t√°m...</span>`;
      return;
    }
    
    const season = this.seasons[this.state.season];
    widget.innerHTML = `<span class="weather-icon">${season.icon}</span><span class="weather-info">${season.name}: ${season.desc}</span>`;
    widget.style.cursor = 'default';
    widget.onclick = null;
  },
  
  // ‚ÑπÔ∏è SHOW ABOUT MODAL
  showAbout() {
    this.openModal();
    
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.id = 'about-modal';
    
    modal.innerHTML = `
      <div class="modal-content">
        <div class="modal-title">‚ÑπÔ∏è O H≈òE DOUPƒö</div>
        
        <div style="text-align: left; color: #b89968; line-height: 1.6; margin: 20px 0;">
          <p style="margin-bottom: 15px;">
            <strong style="color: #d4a574;">Doupƒõ v2.0</strong> je survival crafting hra 
            o p≈ôe≈æit√≠ kolonie v drsn√©m prost≈ôed√≠.
          </p>
          
          <p style="margin-bottom: 15px;">
            üéØ <strong>C√≠l:</strong> Udr≈æet kolonii na≈æivu co nejd√©le. 
            Sb√≠rej suroviny, craftuj n√°stroje, p≈ôij√≠mej obyvatele a p≈ôekon√°vej roƒçn√≠ obdob√≠.
          </p>
          
          <p style="margin-bottom: 15px;">
            üî• <strong>Mechaniky:</strong><br>
            ‚Ä¢ Sez√≥nn√≠ zmƒõny ka≈æd√Ωch 15 dn√≠<br>
            ‚Ä¢ Syst√©m teploty a vyt√°pƒõn√≠<br>
            ‚Ä¢ Ohe≈à a su≈°en√≠ masa<br>
            ‚Ä¢ Ekonomika - prod√°vej a nakupuj<br>
            ‚Ä¢ ≈Ωeb≈ô√≠ƒçek nejlep≈°√≠ch koloni√≠
          </p>
          
          <p style="margin-bottom: 15px;">
            üë§ <strong>Autor:</strong> Ondrex's Ember üî•<br>
            üìÖ <strong>Verze:</strong> 2.0 (√önor 2026)<br>
            üîß <strong>Tech:</strong> Google Apps Script + Sheets
          </p>
          
          <p style="font-size: 11px; opacity: 0.7; margin-top: 20px;">
            üí° Tip: Nejlep≈°√≠ strategie je vyv√°≈æit craftov√°n√≠ n√°stroj≈Ø, 
            budov√°n√≠ infrastruktury a udr≈æov√°n√≠ z√°sob. Nezapome≈à na zimu!
          </p>
        </div>
        
        <div class="modal-buttons">
          <button class="modal-btn modal-btn-primary" onclick="game.closeModal('about-modal')">
            üëç Rozum√≠m
          </button>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
  },
  
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // ‚ö†Ô∏è CRITICAL FUNCTION - GAME INITIALIZATION
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  
  /**
   * üéÆ INIT GAME
   * 
   * Inicializuje hru - nastav√≠ player ID, naƒçte best run, vytvo≈ô√≠ poƒç√°teƒçn√≠ state,
   * detekuje environment (Apps Script vs standalone), spust√≠ GA4 tracking,
   * zobraz√≠ √∫vodn√≠ log messages.
   * 
   * ‚ö†Ô∏è MUS√ç b√Ωt vol√°no p≈ôi naƒçten√≠ str√°nky!
   * 
   * @returns {void}
   * @fires game.render() - Initial render
   * @fires game.track() - GA4 tracking events
   * @sideeffects Creates player ID, loads localStorage data, logs to game log
   * 
   * @example
   * window.onload = () => game.init(); // Vol√° se automaticky
   * 
   * @tested ‚úÖ 2026-02-08 - Works in both modes
   */
  init() {
    // Player ID syst√©m
    let playerId = localStorage.getItem('doupe_player_id');
    if (!playerId) {
      playerId = 'player_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      localStorage.setItem('doupe_player_id', playerId);
    }
    this.state.playerId = playerId;
    
    // Naƒçti best run a nickname
    this.state.bestRun = parseInt(localStorage.getItem('doupe_best_run') || '0');
    this.state.playerNickname = localStorage.getItem('doupe_nickname') || null;
    
    this.state.inventory = { 
      wood: 5,
      fiber: 8,
      food: 60,
      water_supply: 60
    };
    this.state.season = 0; // Jaro
    this.state.day = 1;
    this.state.entities = [];
    this.state.gold = 0;
    this.state.temperature = 15;
    this.state.shelterLevel = 1;
    this.state.heating = 0;
    this.state.guaranteedStones = 0;
    this.state.fireActive = false; // üî•
    this.state.fireFuel = 0; // üî•
    this.state.weatherMode = localStorage.getItem('doupe_weather_mode') || 'game'; // üå§Ô∏è
    this.state.weatherData = null;
    this.state.lastWeatherFetch = 0;
    this.state.lastSeasonalThreat = 0;
    this.state.randomThreatCount = 0;
    this.state.maxRandomThreats = 3;
    this.state.threatCooldown = 3;
    this.state.unlockedRecipes = ['stick', 'rope', 'bowl', 'trap', 'basket'];
    
    // üåê Environment Detection
    const environment = this.isAppsScript ? 'Apps Script (Full Features)' : 'Standalone (Local Save)';
    console.log(`üéÆ Doupƒõ 2 - Running in: ${environment}`);
    
    // GA4 Tracking - Page View
    this.track('page_view', {
      page_title: 'Doupƒõ - Survival Crafting',
      page_location: window.location.href,
      engagement_time_msec: '100',
      environment: environment
    });
    
    // GA4 Tracking - Game Start
    this.track('game_start', {
      starting_food: 60,
      starting_water: 60,
      starting_temperature: 15,
      is_returning_player: this.state.bestRun > 0,
      environment: environment
    });
    
    // Atmosf√©rick√Ω √∫vod
    this.log('üå≤ Probouz√≠≈° se v tich√©m doupƒõti, kdesi hluboko v temn√Ωch vla≈æn√Ωch les√≠ch... V√≠≈°, ≈æe kolem to v≈ôe, ale tobƒõ je p≈ô√≠jemnƒõ chladno.', 'info');
    this.log('Vzduch je ale tƒõ≈æk√Ω. Kolonie str√°d√° a nach√°z√≠ se na pokraji z√°niku. Hlad, ≈æ√≠ze≈à, mr√°z - tvoji vƒõƒçn√≠ nep≈ô√°tel√©.', 'warning');
    this.log('L√©ta sucha vysu≈°ila prameny. Zimy jsou krut√©, j√≠dlo vz√°cn√©. P≈ôe≈æit√≠ nen√≠ zaruƒçeno. Sp√≠≈°e vyvr√°ceno. M√°≈° na to?', 'warning');
    this.log('', 'info');
    this.log('üí° JAK ZAƒå√çT: Vytvo≈ô si n√°stroje (h≈Øl, provaz, misku). Postavte past na zvƒõ≈ô. Tvoje role je tvo≈ôit vƒõci. Pro kolonii. Obchodn√≠ci je r√°di vykoup√≠, nebo pomohou kolonii k p≈ôe≈æit√≠. V√Ωhodnou je, ≈æe je m≈Ø≈æe≈° prodat. A za pen√≠ze pak m≈Ø≈æe≈° podpo≈ôit j√≠dlem a vodou celou kolonii. Zajist√≠≈° si i tak sv√© p≈ôe≈æit√≠? Ven se ti moc zat√≠m nechce, ani na to nem√°≈° pr√°vo, tvoje role je craftov√°n√≠.', 'success');
    this.log('üí° PRVN√ç KROKY: Craftuj n≈Ø≈æ ‚Üí p≈ôijde obyvatel ‚Üí p≈ôi≈ôaƒè mu pr√°ci.', 'success');
    this.log('üí° KL√çƒå K P≈òE≈ΩIT√ç: Sledujte z√°soby kolonie! Obdob√≠ se mƒõn√≠ ka≈æd√Ωch 15 dn√≠ a jejich dopady jsou nemilosrdn√©.', 'danger');
    this.log('üí° TEPLOTA: V l√©tƒõ je vedro k omdlen√≠. V mrazu spot≈ôebujete v√≠c j√≠dla. Rozdƒõlejte ohe≈à, postavte krb, zatopte, nebo budete mrznout. Mo≈æn√° p≈ôe≈æijete zimu a dal≈°√≠ bude lehƒç√≠?', 'danger');
    this.log('üî• OHE≈á: Luk ‚Üí Bow Drill (80%) nebo K≈ôesadlo (100%). Pot≈ôebn√Ω pro su≈°en√≠ masa! P≈†≈†≈†≈†T "a dost!", ".. yes my master!"', 'success');
    this.log('üí∞ EKONOMIKA: Prod√°vej suroviny üü° za zlato ‚Üí Kup j√≠dlo/vodu üè∑Ô∏è. Risk vs. reward!', 'success');
    
    // Environment indicator
    if (!this.isAppsScript) {
      this.log('‚ö†Ô∏è Public message: Save/Load games funguje. Nov√© features. Pln√© funkce, enjoy:-).', 'warning');
    }
    
    this.log('', 'info');
    
    // üå§Ô∏è WEATHER: Inicializuj widget P≈òED render (game mode pot≈ôebuje seasons)
    if (this.state.weatherMode === 'game') {
      this.updateWeatherWidgetGame();
    }
    
    this.render();
    
    // üìÇ AUTO-LOAD: Nab√≠dni naƒçten√≠ ulo≈æen√© hry
    this.checkAutoLoad();
    
    // üå§Ô∏è WEATHER: Naƒçti extern√≠ data (async)
    if (this.state.weatherMode !== 'game') {
      setTimeout(() => {
        this.fetchWeather();
      }, 100);
    }
  },

  /**
   * üìÇ CHECK AUTO-LOAD
   * 
   * Zkontroluje jestli existuje ulo≈æen√° hra a pokud ano,
   * automaticky zobraz√≠ modal pro naƒçten√≠ p≈ôi startu.
   * 
   * @returns {void}
   * @sideeffects May call loadGame() to show modal
   * 
   * @tested ‚úÖ 2026-02-08
   */
  checkAutoLoad() {
    // Poƒçkej a≈æ se UI vykresl√≠
    setTimeout(() => {
      // Zkontroluj jestli existuje save
      let hasSave = false;
      let saveData = null;
      
      if (this.isAppsScript) {
        // V Apps Script re≈æimu zkontroluj backend
        // (zat√≠m nech√°me na manu√°ln√≠m naƒçten√≠, proto≈æe async)
        console.log('üåê Apps Script mode - auto-load skipped (use manual load)');
        return;
      } else {
        // Standalone - zkontroluj localStorage
        const saved = localStorage.getItem('doupe_save');
        if (saved) {
          try {
            saveData = JSON.parse(saved);
            hasSave = true;
          } catch(e) {
            console.error('Invalid save data:', e);
          }
        }
      }
      
      // Pokud existuje save a nen√≠ to den 1, nab√≠dni naƒçten√≠
      if (hasSave && saveData && saveData.day > 1) {
        console.log('üìÇ Auto-load: Found save on day', saveData.day);
        this.loadGame();
      } else {
        console.log('üìÇ Auto-load: No valid save found or day 1');
      }
    }, 500); // Poƒçkej 500ms aby se UI stihlo vyrenderovat
  },

  /**
   * üå§Ô∏è FETCH WEATHER
   * 
   * Naƒçte poƒças√≠ podle m√≥du:
   * - game: zobraz√≠ hern√≠ sez√≥nu
   * - openmeteo: Open-Meteo API (client-side, 10min local cache)
   * - weatherxm: WeatherXM PRO backend (server-side GLOB√ÅLN√ç cache 3h pro v≈°echny u≈æivatele)
   * 
   * @returns {Promise<void>}
   * @sideeffects Updates #weather-widget DOM element
   * 
   * @api Open-Meteo (free, no API key needed)
   * @api WeatherXM PRO (limit 500 calls/mƒõs√≠c, GLOB√ÅLN√ç CACHE na serveru)
   * @tested ‚úÖ 2026-02-10
   */
  async fetchWeather() {
    const mode = this.state.weatherMode || 'game';
    
    // Game mode - zobraz hern√≠ sez√≥nu
    if (mode === 'game') {
      this.updateWeatherWidgetGame();
      return;
    }
    
    // üì¶ ZOBRAZ LOADING STATE
    const widget = document.getElementById('weather-widget');
    if (widget) {
      widget.innerHTML = `
        <span class="weather-icon">‚è≥</span>
        <span class="weather-info">Naƒç√≠t√°m poƒças√≠...</span>
      `;
    }
    
    const now = Date.now();
    
    try {
      if (mode === 'openmeteo') {
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üåç OPEN-METEO (client-side, local cache 10min)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        // Local cache check (neomezen√© calls, tak≈æe 10min je OK)
        if (this.state.weatherData && this.state.weatherData.source === 'openmeteo') {
          if ((now - this.state.lastWeatherFetch) < 600000) { // 10 min
            console.log(`üì¶ Using cached openmeteo data (${Math.round((now - this.state.lastWeatherFetch) / 60000)} min old)`);
            this.updateWeatherWidgetExternal();
            return;
          }
        }
        
        console.log('üåç Fetching Open-Meteo data (client-side)...');
        
        const lat = 50.7667;
        const lon = 14.5333;
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code,wind_speed_10m&timezone=Europe/Prague`;
        
        const response = await fetch(url);
        const data = await response.json();
        
        this.state.weatherData = {
          source: 'openmeteo',
          temperature: Math.round(data.current.temperature_2m),
          weatherCode: data.current.weather_code,
          windSpeed: Math.round(data.current.wind_speed_10m),
          timestamp: new Date().toISOString(),
          rawData: data
        };
        
        console.log('‚úÖ Open-Meteo data loaded:', this.state.weatherData);
        
      } else if (mode === 'weatherxm') {
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üì° WEATHERXM PRO (server-side, GLOB√ÅLN√ç cache 3h)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        console.log('üì° Calling WeatherXM backend (global cache)...');
        const response = await this.backend('fetchWeatherXM');
        
        console.log('üì° Backend response:', response);
        
        if (!response) {
          throw new Error('Backend vr√°til null response');
        }
        
        if (!response.success) {
          throw new Error(response.error || 'Backend returned success: false');
        }
        
        if (!response.data) {
          throw new Error('Backend response missing data field');
        }
        
        // Validace dat
        if (response.data.temperature === null || response.data.temperature === undefined) {
          console.warn('‚ö†Ô∏è Temperature is null/undefined:', response.data);
        }
        
        this.state.weatherData = {
          source: 'weatherxm',
          temperature: response.data.temperature,
          humidity: response.data.humidity,
          pressure: response.data.pressure,
          windSpeed: response.data.windSpeed,
          windDirection: response.data.windDirection,
          precipitation: response.data.precipitation,
          timestamp: response.data.timestamp,
          stationName: response.data.stationName,
          stationQuality: response.data.stationQuality
        };
        
        console.log('‚úÖ WeatherXM data loaded:', this.state.weatherData);
      }
      
      this.state.lastWeatherFetch = now;
      this.updateWeatherWidgetExternal();
      
    } catch(error) {
      console.error('‚ùå Weather fetch failed:', error);
      console.error('‚ùå Error details:', {
        mode: mode,
        message: error.message,
        stack: error.stack
      });
      
      const widget = document.getElementById('weather-widget');
      if (widget) {
        widget.innerHTML = `
          <span class="weather-icon">‚ùå</span>
          <span class="weather-info">Chyba: ${error.message}</span>
        `;
      }
    }
  },
  
  updateWeatherWidgetExternal() {
    const widget = document.getElementById('weather-widget');
    if (!widget || !this.state.weatherData) return;
    
    const data = this.state.weatherData;
    
    if (data.source === 'openmeteo') {
      const weatherInfo = this.getWeatherInfo(data.weatherCode);
      widget.innerHTML = `
        <span class="weather-icon">${weatherInfo.icon}</span>
        <span class="weather-info">
          Nov√Ω Bor: ${data.temperature}¬∞C, ${weatherInfo.desc}${data.windSpeed > 20 ? ' üí®' : ''}
        </span>
      `;
    } else if (data.source === 'weatherxm') {
      const temp = data.temperature !== null ? Math.round(data.temperature) : '?';
      const humidity = data.humidity !== null ? Math.round(data.humidity) : '?';
      const stationName = data.stationName || 'WeatherXM';
      widget.innerHTML = `
        <span class="weather-icon">üì°</span>
        <span class="weather-info">
          ${stationName}: ${temp}¬∞C, ${humidity}%
        </span>
      `;
    }
    
    widget.style.cursor = 'pointer';
    widget.onclick = () => this.showWeatherDetail();
  },

  /**
   * ‚è∞ GET TIME AGO
   * 
   * P≈ôevede timestamp na ƒçiteln√Ω "p≈ôed X minutami/hodinami"
   * 
   * @param {string} timestamp - ISO timestamp
   * @returns {string} ƒåiteln√Ω ƒças (nap≈ô. "p≈ôed 2 hodinami")
   */
  getTimeAgo(timestamp) {
    const now = Date.now();
    const then = new Date(timestamp).getTime();
    const diffMs = now - then;
    const diffMin = Math.floor(diffMs / 60000);
    
    if (diffMin < 1) return 'pr√°vƒõ teƒè';
    if (diffMin === 1) return 'p≈ôed minutou';
    if (diffMin < 60) return `p≈ôed ${diffMin} minutami`;
    
    const diffHours = Math.floor(diffMin / 60);
    if (diffHours === 1) return 'p≈ôed hodinou';
    if (diffHours < 24) return `p≈ôed ${diffHours} hodinami`;
    
    const diffDays = Math.floor(diffHours / 24);
    if (diffDays === 1) return 'vƒçera';
    return `p≈ôed ${diffDays} dny`;
  },

  /**
   * üå¶Ô∏è GET WEATHER INFO
   * 
   * P≈ôevede WMO weather code na emoji ikonu a ƒçesk√Ω popis.
   * 
   * @param {number} code - WMO weather code
   * @returns {Object} {icon: string, desc: string}
   * 
   * @see https://open-meteo.com/en/docs
   */
  getWeatherInfo(code) {
    // WMO Weather interpretation codes
    const weatherMap = {
      0: { icon: '‚òÄÔ∏è', desc: 'jasno' },
      1: { icon: 'üå§Ô∏è', desc: 'p≈ôev√°≈ænƒõ jasno' },
      2: { icon: '‚õÖ', desc: 'polojasno' },
      3: { icon: '‚òÅÔ∏è', desc: 'zata≈æeno' },
      45: { icon: 'üå´Ô∏è', desc: 'mlha' },
      48: { icon: 'üå´Ô∏è', desc: 'jinovatka' },
      51: { icon: 'üå¶Ô∏è', desc: 'mrholen√≠' },
      53: { icon: 'üåßÔ∏è', desc: 'mrholen√≠' },
      55: { icon: 'üåßÔ∏è', desc: 'siln√© mrholen√≠' },
      61: { icon: 'üåßÔ∏è', desc: 'd√©≈°≈•' },
      63: { icon: 'üåßÔ∏è', desc: 'd√©≈°≈•' },
      65: { icon: '‚õàÔ∏è', desc: 'siln√Ω d√©≈°≈•' },
      71: { icon: 'üå®Ô∏è', desc: 'snƒõ≈æen√≠' },
      73: { icon: 'üå®Ô∏è', desc: 'snƒõ≈æen√≠' },
      75: { icon: '‚ùÑÔ∏è', desc: 'siln√© snƒõ≈æen√≠' },
      77: { icon: 'üå®Ô∏è', desc: 'snƒõhov√© vloƒçky' },
      80: { icon: 'üå¶Ô∏è', desc: 'p≈ôeh√°≈àky' },
      81: { icon: '‚õàÔ∏è', desc: 'p≈ôeh√°≈àky' },
      82: { icon: '‚õàÔ∏è', desc: 'siln√© p≈ôeh√°≈àky' },
      85: { icon: 'üå®Ô∏è', desc: 'snƒõhov√© p≈ôeh√°≈àky' },
      86: { icon: '‚ùÑÔ∏è', desc: 'siln√© snƒõhov√© p≈ôeh√°≈àky' },
      95: { icon: '‚õàÔ∏è', desc: 'bou≈ôka' },
      96: { icon: '‚õàÔ∏è', desc: 'bou≈ôka s krupobit√≠m' },
      99: { icon: '‚õàÔ∏è', desc: 'siln√° bou≈ôka' }
    };
    
    return weatherMap[code] || { icon: 'üå§Ô∏è', desc: 'promƒõnliv√©' };
  },

  /**
   * üìä SHOW WEATHER DETAIL
   * 
   * Zobraz√≠ detailn√≠ modal s roz≈°√≠≈ôen√Ωmi informacemi o poƒças√≠.
   * 
   * @param {Object} data - Weather data from API
   * @returns {void}
   */
  showWeatherDetail() {
    const data = this.state.weatherData;
    if (!data) return;
    
    this.openModal();
    
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.id = 'weather-modal';
    
    let content = '';
    
    if (data.source === 'openmeteo') {
      const weatherInfo = this.getWeatherInfo(data.weatherCode);
      content = `
        <div class="modal-content">
          <div class="modal-title">üåç OPEN-METEO</div>
          
          <div style="text-align: center; margin: 30px 0;">
            <div style="font-size: 64px; margin-bottom: 10px;">
              ${weatherInfo.icon}
            </div>
            <div style="font-size: 48px; font-weight: 700; color: #d4a574; margin-bottom: 5px;">
              ${data.temperature}¬∞C
            </div>
            <div style="font-size: 18px; color: #b89968; text-transform: capitalize;">
              ${weatherInfo.desc}
            </div>
          </div>
          
          <div style="text-align: left; color: #b89968; line-height: 1.8; margin: 20px 0;">
            <p style="margin-bottom: 8px;">
              üí® <strong>V√≠tr:</strong> ${data.windSpeed} km/h
            </p>
            <p style="margin-bottom: 8px;">
              üìç <strong>Lokace:</strong> Nov√Ω Bor, ƒåesk√° republika
            </p>
            <p style="font-size: 11px; opacity: 0.7; margin-top: 15px;">
              Data z Open-Meteo API ‚Ä¢ ${this.getTimeAgo(data.timestamp)}
            </p>
            ${this.state.lastWeatherFetch > 0 ? `
              <p style="font-size: 10px; opacity: 0.6; margin-top: 5px; color: #7bc876;">
                üì¶ Dal≈°√≠ aktualizace za ${Math.round((600000 - (Date.now() - this.state.lastWeatherFetch)) / 60000)} min (cache: 10min)
              </p>
            ` : ''}
          </div>
          
          <div class="modal-buttons">
            <button class="modal-btn modal-btn-secondary" onclick="game.closeModal('weather-modal')">
              Zav≈ô√≠t
            </button>
          </div>
        </div>
      `;
    } else if (data.source === 'weatherxm') {
      const temp = data.temperature !== null ? Math.round(data.temperature) : 'N/A';
      const humidity = data.humidity !== null ? Math.round(data.humidity) : 'N/A';
      const pressure = data.pressure !== null ? Math.round(data.pressure) : 'N/A';
      const windSpeed = data.windSpeed !== null ? Math.round(data.windSpeed) : 'N/A';
      const windDir = data.windDirection !== null ? Math.round(data.windDirection) : 'N/A';
      const precip = data.precipitation !== null ? data.precipitation.toFixed(1) : 'N/A';
      const stationName = data.stationName || 'WeatherXM Station';
      const quality = data.stationQuality !== null ? Math.round(data.stationQuality * 100) : null;
      
      content = `
        <div class="modal-content">
          <div class="modal-title">üì° WEATHERXM PRO</div>
          
          <div style="text-align: center; margin: 30px 0;">
            <div style="font-size: 64px; margin-bottom: 10px;">
              üì°
            </div>
            <div style="font-size: 48px; font-weight: 700; color: #d4a574; margin-bottom: 5px;">
              ${temp}¬∞C
            </div>
            <div style="font-size: 16px; color: #b89968;">
              ${stationName}
            </div>
            ${quality !== null ? `
              <div style="font-size: 12px; color: #7bc876; margin-top: 5px;">
                üìä Kvalita dat: ${quality}%
              </div>
            ` : ''}
          </div>
          
          <div style="text-align: left; color: #b89968; line-height: 1.8; margin: 20px 0;">
            <p style="margin-bottom: 8px;">
              üå°Ô∏è <strong>Teplota:</strong> ${temp}¬∞C
            </p>
            <p style="margin-bottom: 8px;">
              üíß <strong>Vlhkost:</strong> ${humidity}%
            </p>
            <p style="margin-bottom: 8px;">
              üîΩ <strong>Tlak:</strong> ${pressure} hPa
            </p>
            <p style="margin-bottom: 8px;">
              üí® <strong>V√≠tr:</strong> ${windSpeed} km/h (${windDir}¬∞)
            </p>
            <p style="margin-bottom: 8px;">
              üåßÔ∏è <strong>Sr√°≈æky:</strong> ${precip} mm/h
            </p>
            <p style="font-size: 11px; opacity: 0.7; margin-top: 15px;">
              Data z WeatherXM PRO ‚Ä¢ ${this.getTimeAgo(data.timestamp)}
            </p>
            ${this.state.lastWeatherFetch > 0 ? `
              <p style="font-size: 10px; opacity: 0.6; margin-top: 5px; color: #7bc876;">
                üì¶ Dal≈°√≠ aktualizace za ${Math.round((10800000 - (Date.now() - this.state.lastWeatherFetch)) / 60000)} min (cache: 3h)
              </p>
            ` : ''}
          </div>
          
          <div class="modal-buttons">
            <button class="modal-btn modal-btn-secondary" onclick="game.closeModal('weather-modal')">
              Zav≈ô√≠t
            </button>
          </div>
        </div>
      `;
    }
    
    modal.innerHTML = content;
    document.body.appendChild(modal);
  },

  log(text, type = 'info') {
    const div = document.createElement('div');
    div.className = `log-entry log-${type}`;
    div.textContent = text;
    const logEl = document.getElementById('log');
    logEl.appendChild(div);
    logEl.scrollTop = logEl.scrollHeight;
  },

  showNotification(text) {
    const notif = document.createElement('div');
    notif.className = 'event-notification';
    notif.textContent = text;
    document.body.appendChild(notif);
    
    setTimeout(() => {
      notif.style.animation = 'slideIn 0.5s ease-out reverse';
      setTimeout(() => notif.remove(), 500);
    }, 3000);
  },

  // üí∞ ECONOMY: Sell Item
  sellItem(itemId, quantity = 1) {
    const item = this.items[itemId];
    if (!item) return;
    
    const have = this.state.inventory[itemId] || 0;
    if (have < quantity) {
      this.log('‚ùå Nem√°≈° dost na prodej', 'warning');
      return;
    }
    
    if (!item.sellPrice) {
      this.log('‚ùå Toto nelze prodat', 'warning');
      return;
    }
    
    const goldEarned = item.sellPrice * quantity;
    
    // Update state
    this.removeItem(itemId, quantity);
    this.state.gold += goldEarned;
    
    this.log(`üü° Prodal jsi ${item.icon} ${item.name} √ó${quantity} za ${goldEarned}g`, 'success');
    this.showNotification(`üü° +${goldEarned}g`);
    
    // GA4 Tracking
    this.track('item_sold', {
      item_id: itemId,
      item_name: item.name,
      quantity: quantity,
      gold_earned: goldEarned,
      new_gold_balance: this.state.gold,
      day: this.state.day
    });
    
    // Backend transaction logging (fire & forget)
    this.backend('logTransaction', {
      playerId: this.state.playerId,
      type: 'sell',
      itemId: itemId,
      itemName: item.name,
      quantity: quantity,
      goldAmount: goldEarned,
      newBalance: this.state.gold,
      day: this.state.day
    }).catch((error) => {
      console.warn('Transaction log failed:', error);
    });
    
    this.render();
  },

  // üí∞ ECONOMY: Buy Item
  buyItem(itemId, quantity = 1) {
    const item = this.items[itemId];
    if (!item) return;
    
    if (!item.buyPrice) {
      this.log('‚ùå Toto nelze koupit', 'warning');
      return;
    }
    
    const goldNeeded = item.buyPrice * quantity;
    
    if (this.state.gold < goldNeeded) {
      this.log(`‚ùå Nem√°≈° dost zlata (pot≈ôeba ${goldNeeded}g)`, 'warning');
      return;
    }
    
    // Update state
    this.state.gold -= goldNeeded;
    this.addItem(itemId, quantity);
    
    this.log(`üè∑Ô∏è Koupil jsi ${item.icon} ${item.name} √ó${quantity} za ${goldNeeded}g`, 'success');
    this.showNotification(`üè∑Ô∏è -${goldNeeded}g`);
    
    // GA4 Tracking
    this.track('item_bought', {
      item_id: itemId,
      item_name: item.name,
      quantity: quantity,
      gold_spent: goldNeeded,
      new_gold_balance: this.state.gold,
      day: this.state.day
    });
    
    // Backend transaction logging (fire & forget)
    this.backend('logTransaction', {
      playerId: this.state.playerId,
      type: 'buy',
      itemId: itemId,
      itemName: item.name,
      quantity: quantity,
      goldAmount: goldNeeded,
      newBalance: this.state.gold,
      day: this.state.day
    }).catch((error) => {
      console.warn('Transaction log failed:', error);
    });
    
    this.render();
  },

  hasMaterials(materials) {
    return Object.entries(materials).every(
      ([id, count]) => (this.state.inventory[id] || 0) >= count
    );
  },

  hasTools(tools) {
    if (!tools) return true;
    return Object.entries(tools).every(
      ([id, count]) => (this.state.inventory[id] || 0) >= count
    );
  },

  addItem(id, count) {
    this.state.inventory[id] = (this.state.inventory[id] || 0) + count;
  },

  removeItem(id, count) {
    this.state.inventory[id] = (this.state.inventory[id] || 0) - count;
    if (this.state.inventory[id] <= 0) delete this.state.inventory[id];
  },

  craft(recipeId) {
    const recipe = this.recipes.find(r => r.id === recipeId);
    if (!recipe) return;

    if (!this.hasMaterials(recipe.materials)) {
      this.log('‚ùå Nem√°≈° dost materi√°l≈Ø', 'warning');
      return;
    }

    if (recipe.requires && !this.hasTools(recipe.requires)) {
      this.log('‚ùå Pot≈ôebuje≈° spr√°vn√© n√°stroje', 'warning');
      return;
    }

    // üî• Check fire requirement
    if (recipe.requiresFire && !this.state.fireActive) {
      this.log('‚ùå Pot≈ôebuje≈° ho≈ô√≠c√≠ ohe≈à', 'warning');
      return;
    }

    // üî• FIRE STARTER RECIPES (special handling)
    if (recipe.isFireStarter) {
      // Odeƒçti materi√°ly
      for (const [id, count] of Object.entries(recipe.materials)) {
        this.removeItem(id, count);
      }

      // RNG roll
      if (Math.random() < recipe.fireChance) {
        this.state.fireActive = true;
        this.state.fireFuel = 0; // Start with 0, need to add wood
        this.log(`üî• Ohe≈à vzplanul! (${recipe.fireMethod})`, 'success');
        this.showNotification('üî• Ohe≈à ho≈ô√≠!');
        
        // GA tracking
        this.track('fire_started', {
          method: recipe.fireMethod,
          day: this.state.day,
          chance: recipe.fireChance
        });
      } else {
        this.log('üí® Nepoda≈ôilo se... zkus znovu', 'warning');
        
        // GA tracking failure
        this.track('fire_failed', {
          method: recipe.fireMethod,
          day: this.state.day
        });
      }
      
      this.render();
      return;
    }

    // NORMAL CRAFTING (not fire starter)
    // Odeƒçti materi√°ly
    for (const [id, count] of Object.entries(recipe.materials)) {
      this.removeItem(id, count);
    }

    // P≈ôidej v√Ωsledek
    for (const [id, count] of Object.entries(recipe.result)) {
      this.addItem(id, count);
    }

    this.log(`‚úÖ Vytvo≈ôil jsi ${recipe.icon} ${recipe.name}`, 'success');

    // GA Tracking - Craft Item
    this.track('craft_item', {
      item_name: recipe.name,
      item_id: recipe.id,
      item_tier: recipe.tier,
      day: this.state.day,
      season: this.seasons[this.state.season].name
    });

    // Unlock mechaniky
    if (recipe.unlock === 'first_entity' && this.state.entities.length === 0) {
      this.spawnEntity('gatherer');
      this.log('üë§ Do doupƒõte dorazil prvn√≠ obyvatel - Sbƒõraƒç!', 'success');
      this.showNotification('üéâ Nov√Ω obyvatel se p≈ôipojil!');
    }

    if (recipe.unlock === 'hunter_entity') {
      const hasHunter = this.state.entities.some(e => e.type === 'hunter');
      if (!hasHunter) {
        this.spawnEntity('hunter');
        this.log('üèπ Lovec se p≈ôipojil k doupƒõti!', 'success');
        this.showNotification('üéâ Lovec se p≈ôipojil!');
      }
    }

    this.render();
  },

  spawnEntity(typeId) {
    const type = this.entityTypes.find(t => t.id === typeId);
    if (!type) return;

    const entity = {
      id: Date.now(),
      type: typeId,
      name: type.name,
      icon: type.icon,
      status: 'idle',
      action: null,
      daysLeft: 0
    };

    this.state.entities.push(entity);
    
    // GA Tracking - Entity Joined
    this.track('entity_joined', {
      entity_type: typeId,
      entity_name: type.name,
      day: this.state.day,
      total_entities: this.state.entities.length
    });
  },

  assignAction(entityId, actionIndex) {
    const entity = this.state.entities.find(e => e.id === entityId);
    if (!entity) return;

    const type = this.entityTypes.find(t => t.id === entity.type);
    const action = type.actions[actionIndex];

    if (!this.hasTools(action.requires)) {
      this.log('‚ùå Entita nem√° pot≈ôebn√© n√°stroje', 'warning');
      return;
    }
    // üî• Check fire requirement for fuel action
    if (action.requiresFire && !this.state.fireActive) {
      this.log('‚ùå Nen√≠ zalo≈æen√Ω ohe≈à', 'warning');
      return;
    }
    entity.status = 'working';
    entity.action = action;
    entity.daysLeft = action.duration;

    this.log(`${entity.icon} ${entity.name} zaƒçal: ${action.name}`, 'info');
    
    // GA Tracking - Entity Action
    this.track('entity_action', {
      entity_type: entity.type,
      action_name: action.name,
      action_duration: action.duration,
      day: this.state.day
    });
    
    this.render();
  },

  processEntities() {
    this.state.entities.forEach(entity => {
      if (entity.status === 'working' && entity.daysLeft > 0) {
        entity.daysLeft--;

        if (entity.daysLeft === 0) {
          // üî• FUEL ACTION (special handling)
          if (entity.action.isFuelAction) {
            const woodAvailable = this.state.inventory.wood || 0;
            if (woodAvailable >= 3) {
              this.removeItem('wood', 3);
              this.state.fireFuel += 3; // 3 wood = 2 days fuel
              this.log(`${entity.icon} ${entity.name} p≈ôilo≈æil do ohnƒõ (+2 dny, -3 ü™µ)`, 'success');
              
              // GA Tracking - Fuel Added
              this.track('fire_fueled', {
                wood_used: 3,
                fuel_added: 2,
                total_fuel: this.state.fireFuel,
                day: this.state.day
              });
            } else {
              this.log(`${entity.icon} ${entity.name} nem√° d≈ôevo (pot≈ôeba 3)`, 'warning');
            }
            entity.status = 'idle';
            entity.action = null;
            return;
          }

          // Speci√°ln√≠ zpracov√°n√≠ heating akce
          if (entity.action.isHeating) {
            const woodAvailable = this.state.inventory.wood || 0;
            if (woodAvailable >= 3) {
              this.removeItem('wood', 3);
              this.state.heating = Math.min(this.state.heating + 1, 3);
              this.log(`${entity.icon} ${entity.name} zatopil v krbu (+5¬∞C po 1 den)`, 'success');
              
              // GA Tracking - Heating
              this.track('heating_action', {
                success: true,
                heating_level: this.state.heating,
                temperature: this.state.temperature,
                day: this.state.day
              });
            } else {
              this.log(`${entity.icon} ${entity.name} nem√° d≈ôevo na topen√≠ (pot≈ôeba 3)`, 'warning');
              
              // GA Tracking - Heating Failed
              this.track('heating_action', {
                success: false,
                wood_available: woodAvailable,
                temperature: this.state.temperature,
                day: this.state.day
              });
            }
            entity.status = 'idle';
            entity.action = null;
            return;
          }
          
          // Akce dokonƒçena - norm√°ln√≠ result
          const result = entity.action.result();
          
          let resultText = [];
          for (const [itemId, count] of Object.entries(result)) {
            if (count > 0) {
              this.addItem(itemId, count);
              const item = this.items[itemId];
              resultText.push(`${item.icon} ${item.name} √ó${count}`);
            }
          }

          if (resultText.length > 0) {
            this.log(`${entity.icon} ${entity.name} p≈ôinesl: ${resultText.join(', ')}`, 'item');
          } else {
            this.log(`${entity.icon} ${entity.name} se vr√°til s pr√°zdnou`, 'warning');
          }

          entity.status = 'idle';
          entity.action = null;
        }
      }
    });
  },

  triggerRandomEvent() {
    const currentSeason = this.seasons[this.state.season];
    
    // Filtruj ud√°losti podle sez√≥ny
    const availableEvents = this.randomEvents.filter(event => {
      if (event.season && !event.season.includes(this.state.season)) {
        return false;
      }
      return true;
    });

    // N√°hodn√° ≈°ance na ud√°lost
    if (Math.random() > this.state.eventChance) return;

    // Vyber ud√°lost podle vah
    const totalChance = availableEvents.reduce((sum, e) => sum + e.chance, 0);
    let roll = Math.random() * totalChance;

    for (const event of availableEvents) {
      roll -= event.chance;
      if (roll <= 0) {
        if (event.items) {
          for (const [itemId, range] of Object.entries(event.items)) {
            const count = Math.floor(Math.random() * (range[1] - range[0] + 1)) + range[0];
            this.addItem(itemId, count);
            const item = this.items[itemId];
            this.log(event.message + ` (+${count} ${item.icon})`, 'item');
          }
        } else {
          this.log(event.message, 'info');
        }
        break;
      }
    }
  },

  nextDay() {
    if (this.state.dead) return;

    this.state.day++;

    // Zmƒõna sez√≥ny ka≈æd√Ωch 15 dn√≠
    const newSeason = Math.floor((this.state.day - 1) / 15) % 4;
    if (newSeason !== this.state.season) {
      this.state.season = newSeason;
      const season = this.seasons[this.state.season];
      this.log(`${season.icon} Nast√°v√° ${season.name}! ${season.desc}`, 'warning');
      this.showNotification(`${season.icon} ${season.name} zaƒç√≠n√°!`);
      
      // GA Tracking - Season Change
      this.track('season_change', {
        new_season: season.name,
        day: this.state.day,
        population: this.state.entities.length + 1,
        food_reserves: this.state.inventory.food || 0,
        water_reserves: this.state.inventory.water_supply || 0
      });
    }

    // GA Tracking - Day Milestones
    if (this.state.day % 10 === 0) {
      this.track('milestone_reached', {
        days_survived: this.state.day,
        season: this.seasons[this.state.season].name,
        population: this.state.entities.length + 1,
        temperature: this.state.temperature,
        food_supply: this.state.inventory.food || 0,
        water_supply: this.state.inventory.water_supply || 0
      });
    }

    const season = this.seasons[this.state.season];

    this.log(`--- Den ${this.state.day} ---`, 'info');
    // üî• FIRE DECAY
    if (this.state.fireFuel > 0) {
      this.state.fireFuel--;
      if (this.state.fireFuel === 0) {
        this.state.fireActive = false;
        this.log('üå´Ô∏è Ohe≈à vyhasl!', 'warning');
        this.showNotification('üí® Ohe≈à vyhasl!');
        
        // GA Tracking - Fire Extinguished
        this.track('fire_extinguished', {
          day: this.state.day,
          reason: 'no_fuel'
        });
      } else {
        this.log(`üî• Ohe≈à ho≈ô√≠ (zb√Ωv√° ${this.state.fireFuel} dn√≠)`, 'info');
      }
    }
    // V√Ωpoƒçet teploty
    this.calculateTemperature();
    const tempEffects = this.getTemperatureEffects();
    const tempEmoji = this.getTemperatureEmoji(this.state.temperature);
    
    // Temperature warning
    if (this.state.temperature < 5) {
      this.log(`${tempEmoji} Je mrazivƒõ! (${this.state.temperature}¬∞C) Spot≈ôeba j√≠dla +50%`, 'danger');
      // GA Tracking - Extreme Cold
      this.track('extreme_temperature', {
        type: 'freezing',
        temperature: this.state.temperature,
        day: this.state.day,
        heating_active: this.state.heating > 0
      });
    } else if (this.state.temperature < 10) {
      this.log(`${tempEmoji} Je chladno (${this.state.temperature}¬∞C) Spot≈ôeba j√≠dla +20%`, 'warning');
    } else if (this.state.temperature > 28) {
      this.log(`${tempEmoji} Je vedro! (${this.state.temperature}¬∞C) Spot≈ôeba vody +50%`, 'danger');
      // GA Tracking - Extreme Heat
      this.track('extreme_temperature', {
        type: 'heatwave',
        temperature: this.state.temperature,
        day: this.state.day
      });
    } else if (this.state.temperature > 23) {
      this.log(`${tempEmoji} Je horko (${this.state.temperature}¬∞C) Spot≈ôeba vody +20%`, 'warning');
    } else if (this.state.temperature >= 10 && this.state.temperature <= 20) {
      this.log(`${tempEmoji} P≈ô√≠jemn√° teplota (${this.state.temperature}¬∞C) Efektivita +10%!`, 'success');
    } else {
      this.log(`${tempEmoji} Teplota: ${this.state.temperature}¬∞C`, 'info');
    }
    
    // Heating decay
    if (this.state.heating > 0) {
      this.state.heating--;
      if (this.state.heating === 0) {
        this.log('üî• Krb vychladl', 'info');
      }
    }

    // Zpracuj entity
    this.processEntities();

    // Garantovan√© kameny prvn√≠ch 5 dn√≠ (min 2, max 3)
    if (this.state.day <= 5) {
      const stonesGiven = this.state.guaranteedStones || 0;
      
      if (stonesGiven < 2) {
        // Je≈°tƒõ nem√°me 2 ‚Üí zagarantovat 1 k√°men
        this.addItem('stone', 1);
        this.log(`‚õ∞Ô∏è Na≈°el jsi k√°men! (+1)`, 'item');
        this.state.guaranteedStones = stonesGiven + 1;
      } else if (stonesGiven === 2 && Math.random() < 0.5) {
        // M√°me 2, ≈°ance 50% na 3.
        this.addItem('stone', 1);
        this.log(`‚õ∞Ô∏è Na≈°el jsi k√°men! (+1)`, 'item');
        this.state.guaranteedStones = 3;
      }
    }

    // N√°hodn√° ud√°lost
    this.triggerRandomEvent();

    // üó°Ô∏è Check for threats
    this.checkThreats();

    // Denn√≠ spot≈ôeba podle sez√≥ny + POPULATION SCALING + TEMPERATURE EFFECTS
    // Prvn√≠ entita je "free" (z√°kladn√≠ spot≈ôeba), ka≈æd√° dal≈°√≠ +40%
    const effectivePopulation = Math.max(0, this.state.entities.length - 1);
    const populationMultiplier = 1 + (effectivePopulation * 0.4);
    
    const hungerNeeded = Math.ceil(season.hungerDrain * populationMultiplier * tempEffects.hungerMultiplier);
    const waterNeeded = Math.ceil(season.waterDrain * populationMultiplier * tempEffects.waterMultiplier);
    
    const foodAvailable = this.state.inventory.food || 0;
    const waterAvailable = this.state.inventory.water_supply || 0;

    // Info o populaci
    if (this.state.entities.length > 0) {
      this.log(`üë• Kolonie: ${this.state.entities.length + 1} obyvatel (spot≈ôeba: √ó${populationMultiplier.toFixed(1)})`, 'info');
    }

    // Spot≈ôebuj j√≠dlo
    if (foodAvailable >= hungerNeeded) {
      this.removeItem('food', hungerNeeded);
      this.log(`üçñ Spot≈ôebov√°no ${hungerNeeded} j√≠dla`, 'info');
    } else {
      if (foodAvailable > 0) {
        this.removeItem('food', foodAvailable);
        this.log(`‚ö†Ô∏è Spot≈ôebov√°no jen ${foodAvailable} j√≠dla, chyb√≠ ${hungerNeeded - foodAvailable}`, 'warning');
      }
      this.gameOver('üçñ Kolonie um≈ôela hlady');
      return;
    }

    // Spot≈ôebuj vodu
    if (waterAvailable >= waterNeeded) {
      this.removeItem('water_supply', waterNeeded);
      this.log(`üíß Spot≈ôebov√°no ${waterNeeded} vody`, 'info');
    } else {
      if (waterAvailable > 0) {
        this.removeItem('water_supply', waterAvailable);
        this.log(`‚ö†Ô∏è Spot≈ôebov√°na jen ${waterAvailable} voda, chyb√≠ ${waterNeeded - waterAvailable}`, 'warning');
      }
      this.gameOver('üíß Kolonie um≈ôela ≈æ√≠zn√≠');
      return;
    }

    this.render();
  },

  gameOver(reason = 'Nep≈ôe≈æil jsi') {
    this.state.dead = true;
    
    // Zkontroluj jestli je to nov√Ω osobn√≠ rekord
    const isNewBestRun = this.state.day > this.state.bestRun;
    
    // GA Tracking - Game Over (detailed)
    this.track('game_over', {
      death_reason: reason,
      days_survived: this.state.day,
      final_season: this.seasons[this.state.season].name,
      population: this.state.entities.length + 1,
      final_temperature: this.state.temperature,
      food_remaining: this.state.inventory.food || 0,
      water_remaining: this.state.inventory.water_supply || 0,
      had_fireplace: (this.state.inventory.fireplace || 0) > 0,
      had_insulation: (this.state.inventory.insulation || 0) > 0,
      shelter_level: this.state.shelterLevel,
      fire_was_active: this.state.fireActive, // üî•
      is_new_best: isNewBestRun
    });
    
    // Pokud je nov√Ω rekord, zobraz nickname modal m√≠sto bƒõ≈æn√©ho game over
    if (isNewBestRun) {
      this.showNicknameModal(reason);
      return;
    }
    
    // Bƒõ≈æn√Ω game over screen
    const overlay = document.createElement('div');
    overlay.style.cssText = `
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      animation: fadeIn 0.5s ease-out;
    `;
    overlay.innerHTML = `
      <div style="
        background: linear-gradient(145deg, #1a1410, #2d2416);
        padding: 50px;
        border-radius: 24px;
        text-align: center;
        border: 2px solid rgba(192, 80, 77, 0.5);
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.9);
        animation: scaleIn 0.5s ease-out 0.2s both;
      ">
        <h1 style="
          color: #e67e7b;
          font-size: 48px;
          margin-bottom: 20px;
          font-family: 'Space Mono', monospace;
          text-shadow: 0 4px 12px rgba(230, 126, 123, 0.5);
        ">üíÄ GAME OVER</h1>
        <p style="
          color: #d4a574;
          font-size: 20px;
          margin-bottom: 30px;
          font-family: 'Crimson Pro', serif;
        ">${reason}</p>
        <p style="
          color: #9a8670;
          font-size: 16px;
          margin-bottom: 30px;
          font-family: 'Space Mono', monospace;
        ">P≈ôe≈æil jsi ${this.state.day} dn√≠</p>
        <button onclick="game.reset()" style="
          padding: 16px 32px;
          font-size: 18px;
          background: linear-gradient(135deg, #8b5a2b, #a67c52);
          color: white;
          border: none;
          border-radius: 12px;
          cursor: pointer;
          font-family: 'Space Mono', monospace;
          font-weight: 700;
          box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
        ">üîÑ Zkusit znovu</button>
      </div>
    `;
    
    const style = document.createElement('style');
    style.textContent = `
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      @keyframes scaleIn {
        from { transform: scale(0.8); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
      }
    `;
    document.head.appendChild(style);
    
    document.body.appendChild(overlay);
  },

  showNicknameModal(reason) {
    // Lock scroll
    this.openModal();
    
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.id = 'nickname-modal';
    
    modal.innerHTML = `
      <div class="modal-content">
        <div class="modal-title">üéâ NOV√ù OSOBN√ç REKORD!</div>
        <p class="nickname-info">P≈ôe≈æil jsi <strong>${this.state.day} dn√≠</strong></p>
        <p class="nickname-info" style="font-size: 12px; color: #9a8670; margin-top: -5px;">
          P≈ôedchoz√≠ rekord: ${this.state.bestRun} dn√≠
        </p>
        <p class="nickname-info" style="margin-top: 15px;">Zadej svou p≈ôezd√≠vku pro ≈æeb≈ô√≠ƒçek:</p>
        <input 
          type="text" 
          class="nickname-input" 
          id="nickname-input"
          placeholder="Tvoje p≈ôezd√≠vka..." 
          maxlength="20"
          value="${this.state.playerNickname || ''}"
        />
        <div class="modal-buttons">
          <button class="modal-btn modal-btn-primary" onclick="game.saveHighScoreToSheet()">
            üíæ Ulo≈æit do ≈æeb≈ô√≠ƒçku
          </button>
          <button class="modal-btn modal-btn-secondary" onclick="game.skipNickname()">
            P≈ôeskoƒçit
          </button>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    // Focus na input
    setTimeout(() => {
      document.getElementById('nickname-input').focus();
    }, 100);
    
    // Enter key = save
    document.getElementById('nickname-input').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        this.saveHighScoreToSheet();
      }
    });
  },

  saveHighScoreToSheet() {
    const nicknameInput = document.getElementById('nickname-input');
    const nickname = nicknameInput.value.trim() || 'Anonymous';
    
    // Ulo≈æ nickname do localStorage
    this.state.playerNickname = nickname;
    localStorage.setItem('doupe_nickname', nickname);
    
    // Ulo≈æ best run
    this.state.bestRun = this.state.day;
    localStorage.setItem('doupe_best_run', this.state.day.toString());
    
    // Ode≈°li do Google Sheets
    const data = {
      playerId: this.state.playerId,
      nickname: nickname,
      days: this.state.day,
      season: this.seasons[this.state.season].name,
      population: this.state.entities.length + 1,
      temperature: this.state.temperature,
      foodLeft: this.state.inventory.food || 0,
      waterLeft: this.state.inventory.water_supply || 0
    };
    
    // Zobraz loading
    nicknameInput.disabled = true;
    nicknameInput.value = 'Ukl√°d√°m...';
    
    this.backend('saveHighScore', data)
      .then((response) => {
        if (response.success) {
          console.log('High score saved:', response);
          this.closeModal('nickname-modal');
          this.showGameOverScreen(`üèÜ ${response.message}`);
        } else if (response.standalone) {
          // Standalone mode - save locally only
          console.log('Standalone mode - saved locally');
          this.closeModal('nickname-modal');
          this.showGameOverScreen('üíÄ GAME OVER (Local save)');
        } else {
          throw new Error(response.message || 'Unknown error');
        }
      })
      .catch((error) => {
        console.error('Error saving high score:', error);
        alert('Chyba p≈ôi ukl√°d√°n√≠: ' + (error.message || error));
        nicknameInput.disabled = false;
        nicknameInput.value = nickname;
      });
  },

  skipNickname() {
    // Ulo≈æ best run bez odesl√°n√≠ do sheets
    this.state.bestRun = this.state.day;
    localStorage.setItem('doupe_best_run', this.state.day.toString());
    
    this.closeModal('nickname-modal');
    this.showGameOverScreen('üíÄ GAME OVER');
  },

  showGameOverScreen(title) {
    const overlay = document.createElement('div');
    overlay.style.cssText = `
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      animation: fadeIn 0.5s ease-out;
    `;
    overlay.innerHTML = `
      <div style="
        background: linear-gradient(145deg, #1a1410, #2d2416);
        padding: 50px;
        border-radius: 24px;
        text-align: center;
        border: 2px solid rgba(192, 80, 77, 0.5);
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.9);
        animation: scaleIn 0.5s ease-out 0.2s both;
      ">
        <h1 style="
          color: #e67e7b;
          font-size: 48px;
          margin-bottom: 20px;
          font-family: 'Space Mono', monospace;
          text-shadow: 0 4px 12px rgba(230, 126, 123, 0.5);
        ">${title}</h1>
        <p style="
          color: #9a8670;
          font-size: 16px;
          margin-bottom: 30px;
          font-family: 'Space Mono', monospace;
        ">P≈ôe≈æil jsi ${this.state.day} dn√≠</p>
        <button onclick="game.reset()" style="
          padding: 16px 32px;
          font-size: 18px;
          background: linear-gradient(135deg, #8b5a2b, #a67c52);
          color: white;
          border: none;
          border-radius: 12px;
          cursor: pointer;
          font-family: 'Space Mono', monospace;
          font-weight: 700;
          box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
        ">üîÑ Zkusit znovu</button>
      </div>
    `;
    
    document.body.appendChild(overlay);
  },

  showLeaderboard() {
    // Lock scroll
    this.openModal();
    
    // Zobraz loading
    const loadingModal = document.createElement('div');
    loadingModal.className = 'modal-overlay';
    loadingModal.id = 'leaderboard-modal';
    loadingModal.innerHTML = `
      <div class="modal-content">
        <div class="modal-title">üèÜ ≈ΩEB≈ò√çƒåEK</div>
        <p class="nickname-info">Naƒç√≠t√°m data...</p>
      </div>
    `;
    document.body.appendChild(loadingModal);
    
    // Naƒçti data z Sheets (p≈ôes API)
    this.backend('getLeaderboard')
      .then((response) => {
        if (response.success) {
          this.renderLeaderboard(response.data);
        } else {
          // API failed - show error or standalone
          console.error('Leaderboard load failed:', response);
          alert('Chyba p≈ôi naƒç√≠t√°n√≠ ≈æeb≈ô√≠ƒçku: ' + (response.message || response.error));
          this.closeModal('leaderboard-modal');
        }
      })
      .catch((error) => {
        console.error('Leaderboard error:', error);
        alert('Chyba p≈ôi naƒç√≠t√°n√≠ ≈æeb≈ô√≠ƒçku: ' + error.message);
        this.closeModal('leaderboard-modal');
      });
  },

  renderLeaderboard(data) {
    const modal = document.getElementById('leaderboard-modal');
    
    let tableRows = '';
    if (data.length === 0) {
      tableRows = '<tr><td colspan="4" style="text-align: center; padding: 30px; color: #9a8670;">≈Ωeb≈ô√≠ƒçek je zat√≠m pr√°zdn√Ω...</td></tr>';
    } else {
      tableRows = data.map(entry => {
        const rankClass = entry.rank <= 3 ? `rank-${entry.rank}` : 'rank-other';
        const isYou = entry.playerId === this.state.playerId;
        const rowClass = isYou ? 'your-rank' : '';
        
        return `
          <tr class="${rowClass}">
            <td><span class="rank-badge ${rankClass}">${entry.rank}</span></td>
            <td>${entry.nickname}${isYou ? ' <strong>(ty)</strong>' : ''}</td>
            <td><strong>${entry.days}d</strong></td>
            <td>${this.getSeasonIcon(entry.season)} ${entry.population}üë•</td>
          </tr>
        `;
      }).join('');
    }
    
    modal.innerHTML = `
      <div class="modal-content">
        <div class="modal-title">üèÜ TOP 10 KOLONI√ç</div>
        <table class="leaderboard-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Jm√©no</th>
              <th>Dny</th>
              <th>Info</th>
            </tr>
          </thead>
          <tbody>
            ${tableRows}
          </tbody>
        </table>
        <div class="modal-buttons">
          <button class="modal-btn modal-btn-secondary" onclick="game.closeModal('leaderboard-modal')">
            Zav≈ô√≠t
          </button>
        </div>
      </div>
    `;
  },

  getSeasonIcon(seasonName) {
    const icons = {
      'Jaro': 'üå±',
      'L√©to': '‚òÄÔ∏è',
      'Podzim': 'üçÇ',
      'Zima': '‚ùÑÔ∏è'
    };
    return icons[seasonName] || 'üåç';
  },

  // üíæ SAVE & LOAD GAME
  saveGame() {
    try {
      const saveData = JSON.stringify(this.state);
      
      // Save via backend (Apps Script) or localStorage (standalone)
      if (this.isAppsScript) {
        this.backend('saveGameState', saveData)
          .then((response) => {
            if (response.success) {
              this.log('üíæ ' + response.message, 'success');
              this.showNotification('üíæ Hra ulo≈æena!');
            } else {
              throw new Error(response.message);
            }
          })
          .catch((error) => {
            this.log('‚ùå Chyba p≈ôi ukl√°d√°n√≠: ' + error, 'danger');
          });
      } else {
        // Standalone - localStorage
        localStorage.setItem('doupe_save', saveData);
        this.log('üíæ Hra ulo≈æena (lok√°lnƒõ)', 'success');
        this.showNotification('üíæ Hra ulo≈æena!');
      }
      
      // GA Tracking
      this.track('game_saved', {
        day: this.state.day,
        season: this.seasons[this.state.season].name,
        population: this.state.entities.length + 1
      });
      
    } catch(e) {
      this.log('‚ùå Nepoda≈ôilo se ulo≈æit hru', 'danger');
      console.error('Save error:', e);
    }
  },

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // ‚ö†Ô∏è CRITICAL FUNCTION - SAVE/LOAD SYSTEM
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  /**
   * üíæ SAVE GAME
   * 
   * Ukl√°d√° aktu√°ln√≠ stav hry (this.state) do backend nebo localStorage.
   * Funguje v Apps Script re≈æimu (backend API) i standalone (localStorage).
   * Zobrazuje notification a loguje √∫spƒõch/chybu.
   * 
   * @returns {void}
   * @fires game.backend - V Apps Script re≈æimu
   * @fires game.track - GA4 tracking event 'game_saved'
   * @sideeffects Ukl√°d√° do localStorage nebo vol√° backend API
   * 
   * @example
   * game.saveGame(); // Ulo≈æ√≠ souƒçasn√Ω stav
   * 
   * @tested ‚úÖ 2026-02-08 - Works in both modes
   */
  saveGame() {
    try {
      const saveData = JSON.stringify(this.state);
      
      // Save via backend (Apps Script) or localStorage (standalone)
      if (this.isAppsScript) {
        this.backend('saveGameState', saveData)
          .then((response) => {
            if (response.success) {
              this.log('üíæ ' + response.message, 'success');
              this.showNotification('üíæ Hra ulo≈æena!');
            } else {
              throw new Error(response.message);
            }
          })
          .catch((error) => {
            this.log('‚ùå Chyba p≈ôi ukl√°d√°n√≠: ' + error, 'danger');
          });
      } else {
        // Standalone - localStorage
        localStorage.setItem('doupe_save', saveData);
        this.log('üíæ Hra ulo≈æena (lok√°lnƒõ)', 'success');
        this.showNotification('üíæ Hra ulo≈æena!');
      }
      
      // GA Tracking
      this.track('game_saved', {
        day: this.state.day,
        season: this.seasons[this.state.season].name,
        population: this.state.entities.length + 1
      });
      
    } catch(e) {
      this.log('‚ùå Nepoda≈ôilo se ulo≈æit hru', 'danger');
      console.error('Save error:', e);
    }
  },

  /**
   * üìÇ LOAD GAME
   * 
   * Naƒçte ulo≈æenou hru a zobraz√≠ modal s preview (den, sez√≥na, z√°soby).
   * ‚ö†Ô∏è MUS√ç zobrazit modal - ne p≈ô√≠mo naƒç√≠st!
   * User m≈Ø≈æe potvrdit nebo zru≈°it naƒçten√≠.
   * 
   * @returns {void}
   * @fires game.openModal - Locks body scroll
   * @fires game.showLoadConfirmModal - Displays preview modal
   * @fires game.backend - In Apps Script mode
   * @sideeffects Adds modal to DOM, locks scroll
   * 
   * @example
   * game.loadGame(); // Zobraz√≠ modal s preview
   * 
   * @see confirmLoad() - Actual load happens here after confirmation
   * @tested ‚úÖ 2026-02-08 - Modal displays correctly
   */
  loadGame() {
    console.log('üîÑ loadGame() called');
    
    // Lock scroll
    this.openModal();
    console.log('‚úÖ Modal locked');
    
    // Show loading modal first
    const loadingModal = document.createElement('div');
    loadingModal.className = 'modal-overlay';
    loadingModal.id = 'load-modal';
    loadingModal.innerHTML = `
      <div class="modal-content">
        <div class="modal-title">üìÇ NAƒå√çST HRU</div>
        <p class="nickname-info">Naƒç√≠t√°m ulo≈æenou hru...</p>
      </div>
    `;
    document.body.appendChild(loadingModal);
    console.log('‚úÖ Loading modal added to DOM');
    
    // Load save data
    const loadSaveData = () => {
      if (this.isAppsScript) {
        console.log('üåê Apps Script mode - calling backend');
        return this.backend('loadGameState');
      } else {
        console.log('üíæ Standalone mode - checking localStorage');
        // Standalone - localStorage
        const saved = localStorage.getItem('doupe_save');
        if (saved) {
          console.log('‚úÖ Save found in localStorage');
          return Promise.resolve({ success: true, data: saved });
        } else {
          console.log('‚ùå No save in localStorage');
          return Promise.resolve({ success: false, message: '≈Ω√°dn√° ulo≈æen√° hra' });
        }
      }
    };
    
    loadSaveData()
      .then((response) => {
        console.log('üì¶ Response:', response);
        if (response.success && response.data) {
          const saveState = JSON.parse(response.data);
          console.log('‚úÖ Save state parsed:', saveState);
          this.showLoadConfirmModal(saveState);
        } else {
          // No save found
          console.log('‚ùå No save found - closing modal');
          this.closeModal('load-modal');
          this.log('‚ùå ≈Ω√°dn√° ulo≈æen√° hra nenalezena', 'warning');
          this.showNotification('‚ùå ≈Ω√°dn√° ulo≈æen√° hra');
        }
      })
      .catch((error) => {
        console.error('‚ùå Error loading save:', error);
        this.closeModal('load-modal');
        this.log('‚ùå Chyba p≈ôi naƒç√≠t√°n√≠: ' + error, 'danger');
        alert('Chyba p≈ôi naƒç√≠t√°n√≠: ' + error.message);
      });
  },

  // üìÇ SHOW LOAD CONFIRM MODAL - zobraz√≠ preview save a potvrzen√≠
  showLoadConfirmModal(saveState) {
    const modal = document.getElementById('load-modal');
    
    if (!modal) {
      console.error('Load modal not found!');
      return;
    }
    
    // Bezpeƒçn√© naƒçten√≠ sez√≥ny
    const seasonIndex = saveState.season || 0;
    const season = this.seasons[seasonIndex] || this.seasons[0];
    const population = (saveState.entities?.length || 0) + 1;
    
    // Bezpeƒçn√Ω v√Ωpoƒçet dn√≠ (pokud drain je 0, nastav "‚àû")
    const hungerDrain = season.hungerDrain || 1;
    const waterDrain = season.waterDrain || 1;
    const foodDays = Math.floor((saveState.inventory?.food || 0) / hungerDrain);
    const waterDays = Math.floor((saveState.inventory?.water_supply || 0) / waterDrain);
    
    modal.innerHTML = `
      <div class="modal-content">
        <div class="modal-title">üìÇ NAƒå√çST ULO≈ΩENOU HRU?</div>
        
        <div style="text-align: left; color: #b89968; line-height: 1.6; margin: 20px 0; background: rgba(20, 16, 12, 0.6); padding: 20px; border-radius: 12px; border: 1px solid rgba(139, 90, 43, 0.3);">
          <p style="margin-bottom: 12px; font-size: 16px; color: #d4a574;">
            <strong>üìä Informace o ulo≈æen√© h≈ôe:</strong>
          </p>
          
          <p style="margin-bottom: 8px;">
            üìÖ <strong>Den:</strong> ${saveState.day || 1} (${season.icon} ${season.name})
          </p>
          
          <p style="margin-bottom: 8px;">
            üë• <strong>Kolonie:</strong> ${population} obyvatel
          </p>
          
          <p style="margin-bottom: 8px;">
            üçñ <strong>J√≠dlo:</strong> ${saveState.inventory?.food || 0} (${foodDays}d)
          </p>
          
          <p style="margin-bottom: 8px;">
            üíß <strong>Voda:</strong> ${saveState.inventory?.water_supply || 0} (${waterDays}d)
          </p>
          
          <p style="margin-bottom: 8px;">
            üå°Ô∏è <strong>Teplota:</strong> ${saveState.temperature || 15}¬∞C
          </p>
          
          <p style="margin-bottom: 8px;">
            üí∞ <strong>Zlato:</strong> ${saveState.gold || 0}g
          </p>
          
          ${saveState.fireActive ? '<p style="margin-bottom: 8px; color: #ff9944;">üî• <strong>Ohe≈à ho≈ô√≠!</strong></p>' : ''}
        </div>
        
        <p class="nickname-info" style="color: #e67e7b; font-size: 13px; margin-top: -10px;">
          ‚ö†Ô∏è Souƒçasn√Ω postup bude ztracen!
        </p>
        
        <div class="modal-buttons">
          <button class="modal-btn modal-btn-primary" onclick="game.confirmLoad()">
            ‚úÖ Naƒç√≠st tuto hru
          </button>
          <button class="modal-btn modal-btn-secondary" onclick="game.closeModal('load-modal')">
            ‚ùå Zru≈°it
          </button>
        </div>
      </div>
    `;
    
    // Store save state for confirmLoad
    this._pendingSaveState = saveState;
  },

  // ‚úÖ CONFIRM LOAD - potvrzen√≠ a naƒçten√≠ hry
  confirmLoad() {
    if (!this._pendingSaveState) return;
    
    try {
      // Load the saved state
      this.state = this._pendingSaveState;
      delete this._pendingSaveState;
      
      // Close modal
      this.closeModal('load-modal');
      
      // Success feedback
      this.log('üìÇ Hra √∫spƒõ≈°nƒõ naƒçtena!', 'success');
      this.showNotification('üìÇ Hra naƒçtena!');
      
      // GA Tracking
      this.track('game_loaded', {
        day: this.state.day,
        season: this.seasons[this.state.season].name,
        population: this.state.entities.length + 1
      });
      
      // Re-render everything
      this.render();
      
    } catch(e) {
      this.closeModal('load-modal');
      this.log('‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ hry', 'danger');
      console.error('Load error:', e);
    }
  },

  reset() {
    // Odstra≈à game over overlay pokud existuje
    const overlay = document.querySelector('div[style*="position: fixed"]');
    if (overlay) overlay.remove();
    
    // Odstra≈à modals
    const modal = document.getElementById('leaderboard-modal') || document.getElementById('nickname-modal');
    if (modal) modal.remove();

    // GA Tracking - Game Reset
    const wasDead = this.state.dead;
    const finalDay = this.state.day;
    
    this.track('game_reset', {
      was_dead: wasDead,
      previous_days: finalDay,
      reset_type: wasDead ? 'after_death' : 'manual_restart'
    });
    
    // Zachovej player data
    const savedPlayerId = this.state.playerId;
    const savedNickname = this.state.playerNickname;
    const savedBestRun = this.state.bestRun;

    this.state = {
      day: 1,
      season: 0,
      dead: false,
      inventory: {},
      entities: [],
      unlockedRecipes: [],
      eventChance: 0.5,
      temperature: 15,
      shelterLevel: 1,
      heating: 0,
      guaranteedStones: 0,
      playerId: savedPlayerId,
      playerNickname: savedNickname,
      bestRun: savedBestRun,
      fireActive: false,
      fireFuel: 0,
      gold: 0
    };

    document.getElementById('log').innerHTML = '';
    this.init();
  },

  renderInventory() {
    const el = document.getElementById('inventory');
    el.innerHTML = '';

    const entries = Object.entries(this.state.inventory ?? {});

    if (entries.length === 0) {
      el.innerHTML = '<div class="empty-state">Invent√°≈ô je pr√°zdn√Ω...</div>';
      return;
    }

    entries.forEach(([id, count]) => {
      const item = this.items[id];
      if (!item) return;

      const card = document.createElement('div');
      card.className = 'item-card';
      
      // üí∞ ECONOMY: Sell button (pro v≈°echno kromƒõ food/water)
      let actionButton = '';
      if (item.sellPrice && id !== 'food' && id !== 'water_supply') {
        actionButton = `
          <button class="item-action-btn item-sell-btn" onclick="game.sellItem('${id}', 1)">
            üü° ${item.sellPrice}g
          </button>
        `;
      }
      
      // üí∞ ECONOMY: Buy button (jen pro food/water)
      if (item.buyPrice && (id === 'food' || id === 'water_supply')) {
        actionButton = `
          <button class="item-action-btn item-buy-btn" onclick="game.buyItem('${id}', 1)">
            üè∑Ô∏è ${item.buyPrice}g
          </button>
        `;
      }
      
      card.innerHTML = `
        <div class="item-icon">${item.icon}</div>
        <div class="item-details">
          <div class="item-name">${item.name}</div>
          <div class="item-desc">${item.desc}</div>
        </div>
        <div class="item-count">√ó${count}</div>
        ${actionButton}
      `;

      el.appendChild(card);
    });
  },

  renderRecipes() {
    const el = document.getElementById('recipes');
    el.innerHTML = '';

    // Zobraz jen odemƒçen√© recepty
    const availableRecipes = this.recipes.filter(r => 
      this.state.unlockedRecipes.includes(r.id)
    );

    if (availableRecipes.length === 0) {
      el.innerHTML = '<div class="empty-state">Zat√≠m ≈æ√°dn√© recepty...</div>';
      return;
    }

    availableRecipes.forEach(recipe => {
      const canCraft = this.hasMaterials(recipe.materials) && 
                       this.hasTools(recipe.requires);

      const card = document.createElement('div');
      card.className = `recipe-card ${canCraft ? 'can-craft' : 'cannot-craft'}`;

      const mats = Object.entries(recipe.materials)
        .map(([id, needed]) => {
          const have = this.state.inventory[id] || 0;
          const item = this.items[id];
          return `${item.icon} ${have}/${needed}`;
        })
        .join(' ‚Ä¢ ');

      let requiresText = '';
      if (recipe.requires) {
        requiresText = ' | Vy≈æaduje: ' + Object.keys(recipe.requires)
          .map(id => this.items[id].icon)
          .join(' ');
      }

      card.innerHTML = `
        <div class="recipe-header">
          <div class="recipe-icon">${recipe.icon}</div>
          <div class="recipe-name">${recipe.name}</div>
        </div>
        <div class="recipe-materials">${mats}${requiresText}</div>
      `;

      if (canCraft) {
        card.onclick = () => this.craft(recipe.id);
      }

      el.appendChild(card);
    });
  },

  renderEntities() {
    const section = document.getElementById('entities-section');
    const el = document.getElementById('entities');

    if (this.state.entities.length === 0) {
      section.style.display = 'none';
      return;
    }

    section.style.display = 'block';
    el.innerHTML = '';

    this.state.entities.forEach(entity => {
      const type = this.entityTypes.find(t => t.id === entity.type);
      
      const card = document.createElement('div');
      card.className = 'entity-card';

      let statusText = 'Neƒçinn√Ω';
      if (entity.status === 'working') {
        statusText = `${entity.action.name} (${entity.daysLeft} dn√≠)`;
      }

      card.innerHTML = `
        <div class="entity-header">
          <div class="entity-icon">${entity.icon}</div>
          <div class="entity-info">
            <div class="entity-name">${entity.name}</div>
            <div class="entity-status">${statusText}</div>
          </div>
        </div>
      `;

      if (entity.status === 'idle') {
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'entity-actions';

        type.actions.forEach((action, index) => {
          const canDo = this.hasTools(action.requires);
          const btn = document.createElement('button');
          btn.className = 'entity-action-btn';
          btn.textContent = action.name;
          btn.disabled = !canDo;
          btn.onclick = () => this.assignAction(entity.id, index);
          actionsDiv.appendChild(btn);
        });

        card.appendChild(actionsDiv);
      }

      el.appendChild(card);
    });
  },

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // ‚ö†Ô∏è CRITICAL FUNCTION - MAIN RENDER
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  /**
   * üé® RENDER GAME
   * 
   * Aktualizuje cel√© UI podle aktu√°ln√≠ho stavu (this.state).
   * Vol√° v≈°echny sub-render funkce (renderInventory, renderRecipes, atd.).
   * 
   * ‚ö†Ô∏è MUS√ç b√Ωt vol√°no po ka≈æd√© zmƒõnƒõ stavu!
   * 
   * @returns {void}
   * @fires renderInventory() - Updates inventory display
   * @fires renderRecipes() - Updates recipe cards
   * @fires renderEntities() - Updates entities section
   * @fires updateFireIndicator() - Updates fire status
   * @fires updateFooterStats() - Updates footer statistics
   * @fires autoUnlockRecipes() - Checks for new recipes to unlock
   * @sideeffects Updates entire DOM based on game state
   * 
   * @example
   * game.state.day++;
   * game.render(); // Update UI
   * 
   * @tested ‚úÖ 2026-02-08 - All sections update correctly
   */
  render() {
    document.getElementById('day').textContent = this.state.day;
    const season = this.seasons[this.state.season];
    document.getElementById('season').textContent = season.name;

    // Population multiplier + temperature effects pro consumption
    const effectivePopulation = Math.max(0, this.state.entities.length - 1);
    const populationMultiplier = 1 + (effectivePopulation * 0.4);
    const tempEffects = this.getTemperatureEffects();

    // Zobraz√≠me kolik m√°≈° vs. kolik pot≈ôebuje≈° na dal≈°√≠ den
    const hungerNeeded = Math.ceil(season.hungerDrain * populationMultiplier * tempEffects.hungerMultiplier);
    const waterNeeded = Math.ceil(season.waterDrain * populationMultiplier * tempEffects.waterMultiplier);
    
    const foodHave = this.state.inventory.food || 0;
    const waterHave = this.state.inventory.water_supply || 0;
    
    // Vypoƒç√≠tej kolik dn√≠ ti to vydr≈æ√≠
    const foodDays = hungerNeeded > 0 ? Math.floor(foodHave / hungerNeeded) : 0;
    const waterDays = waterNeeded > 0 ? Math.floor(waterHave / waterNeeded) : 0;
    
    // Bar ukazuje kolik dn√≠ ti to vydr≈æ√≠ (max 20 dn√≠ = 100%)
    const hungerPercent = Math.min(100, (foodDays / 20) * 100);
    const waterPercent = Math.min(100, (waterDays / 20) * 100);

    document.getElementById('hunger-fill').style.width = hungerPercent + '%';
    document.getElementById('hunger-fill').textContent = `${foodHave} (${foodDays}d)`;

    document.getElementById('water-fill').style.width = waterPercent + '%';
    document.getElementById('water-fill').textContent = `${waterHave} (${waterDays}d)`;

    // Temperature bar
    const temp = this.state.temperature;
    const tempEmoji = this.getTemperatureEmoji(temp);
    document.getElementById('temp-emoji').textContent = tempEmoji;
    
    // Temperature bar width: -10¬∞C = 0%, +40¬∞C = 100% (range 50¬∞C)
    const tempPercent = Math.max(0, Math.min(100, ((temp + 10) / 50) * 100));
    document.getElementById('temp-fill').style.width = tempPercent + '%';
    
    let tempText = `${temp}¬∞C`;
    if (this.state.heating > 0) {
      tempText += ` üî•√ó${this.state.heating}`;
    }
    if (this.state.shelterLevel > 1) {
      tempText += ` üß±√ó${Math.round((this.state.shelterLevel - 1) * 2)}`;
    }
    document.getElementById('temp-fill').textContent = tempText;

    this.renderInventory();
    this.renderRecipes();
    this.renderEntities();

    // Auto-unlock recept≈Ø podle invent√°≈ôe
    this.autoUnlockRecipes();
    // üî• Update fire indicator
    this.updateFireIndicator();
    // üí∞ Update gold display
    document.getElementById('gold-amount').textContent = this.state.gold;
    
    // üìä Update footer stats
    this.updateFooterStats();
  },

  autoUnlockRecipes() {
    let unlocked = false;
    
    this.recipes.forEach(recipe => {
      if (this.state.unlockedRecipes.includes(recipe.id)) return;
      
      // Zkontroluj jestli m√°≈° materi√°ly na tento recept
      const hasSomeMaterials = Object.keys(recipe.materials).some(
        matId => (this.state.inventory[matId] || 0) > 0
      );

      // Tier 1-2: unlock kdy≈æ m√°≈° materi√°ly
      if (hasSomeMaterials && recipe.tier <= 2) {
        this.state.unlockedRecipes.push(recipe.id);
        unlocked = true;
      }

      // Tier 3+: unlock kdy≈æ m√°≈° required tools
      if (recipe.tier >= 3 && recipe.requires) {
        if (this.hasTools(recipe.requires)) {
          this.state.unlockedRecipes.push(recipe.id);
          unlocked = true;
        }
      }
      
      // Tier 3+ BEZ requires: unlock kdy≈æ m√°≈° materi√°ly (luk, fireplace, insulation)
      if (recipe.tier >= 3 && !recipe.requires && hasSomeMaterials) {
        this.state.unlockedRecipes.push(recipe.id);
        unlocked = true;
      }
    });

    if (unlocked) {
      this.renderRecipes();
    }
  },
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üé≤ THREAT TRIGGER SYSTEM
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  // Add to state in init():
  state: {
    // ... existing state
    lastSeasonalThreat: 0,
    randomThreatCount: 0,
    maxRandomThreats: 3, // nastaviteln√©
    threatCooldown: 3, // min 3 dny mezi hrozbami
  },

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üéØ CHECK THREATS (volat v nextDay())
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  checkThreats() {
    const daysSinceLastThreat = this.state.day - (this.state.lastSeasonalThreat || 0);

    // Cooldown check
    if (daysSinceLastThreat < this.state.threatCooldown) {
      return;
    }

    // üèÅ Konec obdob√≠ = garantovan√Ω seasonal threat
    if (this.state.day % 15 === 0 && this.state.day > 0) {
      this.triggerSeasonalThreat();
      return;
    }

    // üé≤ Random threat (pouze od 5. dne)
    if (this.state.day >= 5 && this.state.randomThreatCount < this.state.maxRandomThreats) {
      const chance = 0.10; // 10% per day
      if (Math.random() < chance) {
        this.triggerRandomThreat();
      }
    }
  },

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üåç SEASONAL THREAT (konec obdob√≠)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  triggerSeasonalThreat() {
    const currentSeason = this.state.season;

    // Filter threats by season
    const seasonalThreats = Object.values(this.threats).filter(t => 
      t.seasons && t.seasons.includes(currentSeason)
    );

    if (seasonalThreats.length === 0) {
      // Fallback to any threat
      const allThreats = Object.values(this.threats).filter(t => t.seasons);
      if (allThreats.length > 0) {
        const threat = allThreats[Math.floor(Math.random() * allThreats.length)];
        this.triggerThreat(threat, true);
      }
      return;
    }

    // Weighted random (tier = weight)
    const totalWeight = seasonalThreats.reduce((sum, t) => sum + t.tier, 0);
    let roll = Math.random() * totalWeight;

    for (const threat of seasonalThreats) {
      roll -= threat.tier;
      if (roll <= 0) {
        this.triggerThreat(threat, true);
        return;
      }
    }
  },

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üé≤ RANDOM THREAT (kdykoliv)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  triggerRandomThreat() {
    const allThreats = Object.values(this.threats);
    const threat = allThreats[Math.floor(Math.random() * allThreats.length)];

    this.triggerThreat(threat, false);
    this.state.randomThreatCount++;
  },

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // ‚öîÔ∏è TRIGGER THREAT (main)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  triggerThreat(threat, isSeasonal) {
    this.state.lastSeasonalThreat = this.state.day;

    // Check if can avoid (medicine_hut for plague)
    if (threat.canAvoid) {
      const canAvoid = Object.entries(threat.canAvoid).every(([item, count]) => 
        (this.state.inventory[item] || 0) >= count
      );

      if (canAvoid) {
        this.log(threat.avoidMessage, 'success');
        this.showNotification('üíä Hrozba odvr√°cena!');

        // GA4 tracking
        this.track('threat_avoided', {
          threat_id: threat.id,
          threat_name: threat.name,
          day: this.state.day
        });

        return;
      }
    }

    // Show combat modal
    this.showCombatModal(threat);

    // GA4 tracking
    this.track('threat_triggered', {
      threat_id: threat.id,
      threat_name: threat.name,
      threat_tier: threat.tier,
      is_seasonal: isSeasonal,
      day: this.state.day
    });
  },

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üé® COMBAT UI - Modal & Rendering
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üìã SHOW COMBAT MODAL
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  showCombatModal(threat) {
    this.openModal();

    // Init combat system
    this.combat.init(threat);

    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.id = 'combat-modal';

    const seasonName = this.seasons[this.state.season].name;

    modal.innerHTML = `
      <div class="modal-content" style="max-width: 600px;">
        <div style="text-align: center; margin-bottom: 20px;">
          <div style="font-size: 48px; margin-bottom: 10px;">${threat.icon}</div>
          <h2 style="color: #e74c3c; font-size: 24px; margin-bottom: 10px;">
            ${threat.name}
          </h2>
          <p style="color: #b89968; font-size: 20px; line-height: 1.6;">
            ${threat.intro}
          </p>
          <div style="margin-top: 10px; padding: 14px; background: rgba(231, 76, 60, 0.1); border-radius: 4px;">
            <span style="color: #e8d5b7; font-size: 12px;">
              ${seasonName} | Den ${this.state.day} | Obt√≠≈ænost: ${threat.aiDifficulty.toUpperCase()}
            </span>
          </div>
        </div>

        <div id="combat-board-container" style="margin: 20px 0; text-align: center;">
          ${this.renderCombatBoardHTML()}
        </div>

        <div id="combat-status" style="text-align: center; margin: 18px 0; color: #4ec9b0; font-size: 14px; font-weight: 600;">
          Tv≈Øj tah: ${threat.playerIcon}
        </div>

        <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">
          <button class="modal-btn modal-btn-secondary" onclick="game.fleeCombat()" style="flex: 1; max-width: 200px;">
            üèÉ Ut√©ct (50% ztr√°t)
          </button>
        </div>

        <div style="margin-top: 15px; padding: 10px; background: rgba(20, 16, 12, 0.3); border-radius: 4px; font-size: 12px; color: #9ca3af;">
          <strong style="color: #e8d5b7;">Pravidla:</strong> Sestav 5 symbol≈Ø v ≈ôadƒõ (vodorovnƒõ, svisle nebo diagon√°lnƒõ).
        </div>
      </div>
    `;

    document.body.appendChild(modal);
  },

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üéÆ RENDER COMBAT BOARD
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  renderCombatBoardHTML() {
    const size = this.combat.size;
    let html = '<div style="display: inline-block; background: #1a1410; padding: 10px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);">';

    for (let r = 0; r < size; r++) {
      html += '<div style="display: flex;">';
      for (let c = 0; c < size; c++) {
        const cell = this.combat.board[r][c];
        const icon = cell === 'player' ? this.combat.playerIcon : 
                     cell === 'enemy' ? this.combat.enemyIcon : '';

        html += `
          <div 
            onclick="game.handleCombatClick(${r}, ${c})" 
            style="
              width: 50px; 
              height: 50px; 
              border: 1px solid rgba(232, 213, 183, 0.2); 
              display: flex; 
              align-items: center; 
              justify-content: center; 
              cursor: pointer;
              font-size: 24px;
              background: ${cell ? 'rgba(232, 213, 183, 0.05)' : 'transparent'};
              transition: all 0.2s;
            "
            onmouseover="if (!this.innerHTML.trim()) this.style.background='rgba(78, 200, 176, 0.1)'"
            onmouseout="if (!this.innerHTML.trim()) this.style.background='transparent'"
          >
            ${icon}
          </div>
        `;
      }
      html += '</div>';
    }

    html += '</div>';
    return html;
  },

  renderCombatBoard() {
    const container = document.getElementById('combat-board-container');
    if (container) {
      container.innerHTML = this.renderCombatBoardHTML();
    }
  },

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üñ±Ô∏è HANDLE COMBAT CLICK
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  handleCombatClick(row, col) {
    if (!this.combat.gameActive) return;

    const result = this.combat.makeMove(row, col);

    if (result === 'player_win') {
      setTimeout(() => this.handleCombatEnd(true), 500);
    } else if (result === 'draw') {
      setTimeout(() => this.handleCombatEnd(true), 500);
    } else if (result) {
      this.renderCombatBoard();
      document.getElementById('combat-status').innerHTML = 
        `Nep≈ô√≠tel p≈ôem√Ω≈°l√≠... ${this.combat.enemyIcon}`;
    }
  },

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üèÜ HANDLE COMBAT END
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  handleCombatEnd(playerWon) {
    const threat = this.combat.currentThreat;
    const outcome = playerWon ? threat.onVictory : threat.onDefeat;

    // Apply consequences
    if (outcome.items) {
      for (const [itemId, value] of Object.entries(outcome.items)) {
        if (Array.isArray(value)) {
          // Range [min, max]
          const amount = Math.floor(Math.random() * (value[1] - value[0] + 1)) + value[0];
          if (amount > 0) {
            this.addItem(itemId, amount);
          } else {
            this.removeItem(itemId, Math.abs(amount));
          }
        } else {
          if (value > 0) {
            this.addItem(itemId, value);
          } else {
            this.removeItem(itemId, Math.abs(value));
          }
        }
      }
    }

    if (outcome.gold) {
      if (Array.isArray(outcome.gold)) {
        const amount = Math.floor(Math.random() * (outcome.gold[1] - outcome.gold[0] + 1)) + outcome.gold[0];
        this.state.gold += amount;
      } else if (outcome.gold < 1 && outcome.gold > -1) {
        // Percentage
        this.state.gold = Math.floor(this.state.gold * (1 + outcome.gold));
      } else {
        this.state.gold += outcome.gold;
      }
    }

    if (outcome.casualties && this.state.entities.length > 0) {
      if (Math.random() < outcome.casualties) {
        const victim = this.state.entities[Math.floor(Math.random() * this.state.entities.length)];
        this.state.entities = this.state.entities.filter(e => e.id !== victim.id);
        this.log(`üíÄ ${victim.name} zahynul v boji!`, 'danger');

        // GA4 tracking
        this.track('entity_death', {
          entity_type: victim.type,
          entity_name: victim.name,
          cause: 'combat',
          threat_id: threat.id,
          day: this.state.day
        });
      }
    }

    // Show result
    const resultModal = document.createElement('div');
    resultModal.className = 'modal-overlay';
    resultModal.style.zIndex = '10001';

    resultModal.innerHTML = `
      <div class="modal-content" style="max-width: 400px; text-align: center;">
        <div style="font-size: 72px; margin-bottom: 20px;">
          ${playerWon ? 'üéâ' : 'üíÄ'}
        </div>
        <h2 style="color: ${playerWon ? '#4ec9b0' : '#e74c3c'}; font-size: 28px; margin-bottom: 15px;">
          ${playerWon ? 'V√≠tƒõzstv√≠!' : 'Por√°≈æka!'}
        </h2>
        <p style="color: #e8d5b7; font-size: 16px; line-height: 1.6; margin-bottom: 20px;">
          ${outcome.message}
        </p>
        <button class="modal-btn modal-btn-primary" onclick="game.closeCombatResult()">
          Pokraƒçovat
        </button>
      </div>
    `;

    document.body.appendChild(resultModal);

    // Log
    this.log(outcome.message, playerWon ? 'success' : 'danger');

    // GA4 tracking
    this.track('combat_ended', {
      threat_id: threat.id,
      threat_name: threat.name,
      outcome: playerWon ? 'victory' : 'defeat',
      day: this.state.day
    });

    // Close combat modal
    this.closeModal('combat-modal');

    // Render updates
    this.render();
  },

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üèÉ FLEE COMBAT
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  fleeCombat() {
    if (!confirm('Opravdu chce≈° ut√©ct? Utrp√≠≈° 50% ztr√°t z por√°≈æky!')) return;

    const threat = this.combat.currentThreat;
    const outcome = threat.onDefeat;

    // Apply 50% of defeat consequences
    if (outcome.items) {
      for (const [itemId, value] of Object.entries(outcome.items)) {
        if (Array.isArray(value)) {
          const amount = Math.floor((Math.random() * (value[1] - value[0] + 1)) + value[0]) * 0.5;
          this.removeItem(itemId, Math.ceil(Math.abs(amount)));
        } else if (value < 0) {
          this.removeItem(itemId, Math.ceil(Math.abs(value) * 0.5));
        }
      }
    }

    if (outcome.casualties && this.state.entities.length > 0) {
      if (Math.random() < (outcome.casualties * 0.5)) {
        const victim = this.state.entities[Math.floor(Math.random() * this.state.entities.length)];
        this.state.entities = this.state.entities.filter(e => e.id !== victim.id);
        this.log(`üíÄ ${victim.name} zahynul p≈ôi √∫tƒõku!`, 'danger');
      }
    }

    this.log(`üèÉ Uprchl jsi z boje! Ale s tƒõ≈æk√Ωmi ztr√°tami...`, 'warning');

    // GA4 tracking
    this.track('combat_fled', {
      threat_id: threat.id,
      threat_name: threat.name,
      day: this.state.day
    });

    this.closeModal('combat-modal');
    this.render();
  },

  closeCombatResult() {
    const modals = document.querySelectorAll('.modal-overlay');
    modals.forEach(m => m.remove());
    this.closeModal('combat-modal');
  },

};

window.onload = () => game.init();
</script>
</body>
</html>

